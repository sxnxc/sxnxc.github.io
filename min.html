<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>sonic</title><style type="text/css">*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif;font-size:14px;line-height:1.5}:focus{outline:0}body{margin:0;padding-top:33px}table{border-collapse:collapse;text-align:left;width:100%}table tr{background:#fff;border-bottom:1px solid}table thead{border:1px solid #ddd}table td span{background:#eee;color:#696969;display:none;font-size:10px;font-weight:700;padding:5px;position:absolute;text-transform:uppercase;top:0;left:0}a{text-decoration:none;cursor:pointer}a:hover{text-decoration:underline}button{padding:3px 15px;cursor:pointer;border:1px solid #ddd;background:#fff}button:hover{background:#eee}h1{font-size:1.9em}h1,p{margin:.3em 0}td,th{border:1px solid #ddd;padding:.5em 5px;cursor:pointer}th{text-transform:capitalize;background:#f4f4f4;font-weight:400}.by{float:left;color:#262626;font-weight:600;margin-right:4px}.n{user-select:none;border:1px solid rgba(10,10,10,.1);background:#f5f5f5;position:fixed;width:100%;top:0;z-index:2}.n>div:first-child{padding:5px 15px}.m{position:absolute;top:0;right:0;margin:5px 15px 0 5px;max-width:100px;overflow:hidden;text-overflow:ellipsis}.tn{color:#aaa;width:fit-content;padding-bottom:5px}.tn>a{color:#00e;max-width:400px;font-size:14px;margin-right:10px}.dr a{color:#aaa;cursor:pointer;max-width:50px;display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:-5px;font-size:12px}.dr span:last-child a{max-width:200px}.dr span:only-child a{max-width:400px}.dr span>a:hover{color:#000;max-width:300px}.dr>span+span:before{padding:0;color:#ccc;content:"/ "}.re:before{content:"↩️ "}.nw:before{content:"📢 "}.nw{color:grey}.fx .cs{position:absolute;bottom:68px;max-height:100%;width:100%}.ed .cs{bottom:103px}.e{border:1px solid rgba(10,10,10,.1);position:sticky;width:100%;bottom:0;background:#f9f9f9}.fx .e{position:fixed}.e-c{cursor:text;overflow-y:auto;padding:7px 10px;white-space:pre-wrap;word-wrap:break-word}.e-a{user-select:none;background:#fff;border-bottom:1px solid rgba(10,10,10,.1);overflow:auto;white-space:nowrap}.e-b{background:transparent;border:none;width:30px;height:30px;vertical-align:bottom;margin:0;padding:0}.e-bs{background:#f0f0f0}.e-c[contenteditable]:empty:before{content:"Write a message...";color:#aaa}.e-t{display:none;overflow:hidden;padding:7px 10px;color:grey;white-space:nowrap}.e-t:focus{white-space:normal}.ed .e-t{display:block}.e-t[contenteditable]:empty:before{content:"New topic";color:#aaa}blockquote{width:fit-content;margin:0;padding:10px;background:#eee;border-radius:5px}blockquote:before{content:"\201C"}blockquote:after{content:"\201D"}.c{padding:2px 15px;position:relative;white-space:pre-wrap}.c:hover{background:#f9f9f9}.c.cur{background:#f2f2f2}.c.t{padding-top:5px;margin-top:2px}.c:before{font-size:.9em;position:absolute;margin-top:2px;margin-left:-14px;cursor:pointer;color:#666}.c:hover:before{content:"☆"}.c.star:before{content:"🌟"!important}.pm,.pr{display:none;cursor:pointer;color:#666;position:absolute;right:15px;top:-10px;padding:0 5px;border:1px solid rgba(10,10,10,.1);border-radius:3px;background:#fff;z-index:1;user-select:none}.pm:hover{background:#eee}.pr{right:42px}.c:hover .pm{display:unset}.pu{display:none;position:absolute;border:1px solid rgba(10,10,10,.1);border-radius:3px;background:#fff;z-index:1;user-select:none;right:0;margin-top:1px}.c:last-child .pu{bottom:23px}.pu div{font-size:12px;white-space:nowrap;padding:3px 5px}.pu div:hover{background:#eee}.pm:hover .pu{display:block}.rep{font-size:.85em;color:grey;cursor:pointer;width:fit-content}.ct{border:1px solid hsla(0,0%,100%,0)}.ce{background:#f9f9f9;border:1px solid rgba(10,10,10,.1)}.ntb{position:absolute;right:0;margin-top:2px;margin-right:2px;font-size:12px;padding:3px 5px;border-radius:2px;background:#fff}@media (max-width:600px){.e-t{font-size:12px;padding:5px 10px}.e-b,.e-b b,i,strike,u{font-size:.85em;width:26px;height:26px}.ntb{margin-top:2px;margin-right:0;font-size:12px;padding:2px 3px;border-right:none;border-bottom:none;border-top:none}}.login{border-top:1px solid rgba(10,10,10,.1);padding:10px 15px 30px}.login input{display:block;margin:5px 0;min-width:200px}.bc{padding:0;list-style:none;white-space:nowrap;overflow:hidden;margin:0 40px 0 0}.grid .bc{display:block;padding:8px 15px;border-radius:4px;background-color:#f5f5f5;margin-right:0}.bc>li{cursor:pointer;display:inline-block;overflow:hidden;text-overflow:ellipsis;max-width:100px;margin-bottom:-5px}.bc>li:hover{max-width:unset}.bc>li+li:before{padding:0 0 0 5px;color:#ccc;content:"/\00a0"}.bc>li:last-child{max-width:unset}.bc>li:only-child:after{padding:0 0 0 5px;color:#ccc;content:"/\00a0 .."}ol,ul{margin-top:0}.relative{position:relative}.drop-container:hover .drop{display:block}.drop-container .drop{display:none;position:absolute;top:20px;left:0;min-width:120px;max-width:300px;background:#f5f5f5}.drop-container .drop a{display:block;padding:8px 13px;white-space:nowrap}.list{list-style-type:none;padding-left:0}li{display:list-item}.s{border-top:1px solid rgba(10,10,10,.1);background:#f9f9f9}.s-c{font-size:13px;cursor:text;overflow-y:auto;padding:5px 10px;white-space:pre-wrap;word-wrap:break-word}.s-c[contenteditable]:empty:before{content:"Search keyword...";color:#aaa}.tbl{overflow-y:scroll;max-height:40vh;border-top:1px solid #ddd}table td{border:none;border-bottom:1px solid #ddd;padding:3px;font-size:13px;white-space:nowrap}table tr td:first-child{width:26px}table tr td:last-child{text-align:right;padding-right:15px;width:10px}table td button{padding:1px 10px;font-size:10px;background:#eee}table td button:hover{background:#fff}table tr:hover{background:#f5f5f5}.v{font-size:9px;color:#aaa;float:right;font-family:Menlo,monospace}</style></head><body><script src="https://cdn.jsdelivr.net/npm/zlibjs@0.3.1/bin/zlib.min.js"></script><script>!function(){"use strict";const e=[];function t(t){let n={};return function(){const i=e.slice.call(arguments),o=i.map((e=>{if(r(e)||Array.isArray(e)){let t={};for(let n in e)t[n]=a(e[n]);return t}return a(e)})),s=JSON.stringify(o);let c=n[s];return void 0===c&&(c=t.apply(this,i),c&&11===c.nodeType&&(c=e.slice.call(c.childNodes)),n[s]=c),c}}let n=0;function a(e){return"function"==typeof e||e instanceof Node?(e.$m||(e.$m=++n),{$m:e.$m}):e}function r(e){if("object"!=typeof e||null===e)return!1;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var s,c,l=o((function(e,t){function n(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){void 0===e&&(e=0);var a=null==t?void 0:t.grow;this.grow=a&&isFinite(a)&&n(a)||a||0,this.buffer="number"==typeof e?new Uint8Array(n(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var a=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(a<=this.grow){var r=new Uint8Array(a);r.set(this.buffer),this.buffer=r}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var a=t,r=a>>3,i=128>>a%8,o=this.buffer[r];a<n;a++)e(!!(o&i),a),i=1===i?(o=this.buffer[++r],128):i>>1},e}();t.default=a}(c={path:s,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&c.path)}},c.exports),c.exports));let u,d=[];function h(e){let t=u,n=()=>{};u=n,m(n);let a=e((()=>{p(n),u=void 0}));return u=t,a}function f(e){function t(n){if(0===arguments.length)return u&&!t.__o.has(u)&&(t.__o.add(u),u.u.push(t)),e;e=n;let a=u;return u=void 0,t.o=new Set(t.__o),t.o.forEach((e=>e.i=!1)),t.o.forEach((e=>{e.i||e()})),u=a,e}return t.$o=1,t.__o=new Set,t.t=d,t}function p(e){e.__c.forEach(p),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),m(e)}function m(e){e.u=[],e.__c=[],e.l=[]}const w=(e,t)=>e.reduce(((e,t)=>(e.set(t.id,t),e)),t),y=()=>window.scrollTo(0,document.body.scrollHeight),v=t((e=>t(((t,n)=>h((()=>e(t,n))))))),g=e=>(t,...n)=>()=>v(e())(t,n),b=(e,t)=>{let n=0,a=0;for(;n<e.length;)a>=t.length&&(a=0),e.set([e[n]^t[a]],n),n++,a++},C=(e,t)=>(b(e,t),L(e,t)),E=e=>{let{a:t,k:n}=S(e);return b(t,n),{a:t,k:n}},S=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},L=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},U=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),A=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},T=(e,t=64,n=8)=>C(e,crypto.getRandomValues(new Uint8Array(U(n,t)))),x=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},k=navigator.vendor.includes("Apple")?{transaction:()=>{}}:openDatabase("sonic","1.0","sonic",1073741824);function N(e,t){}function O(e,t){}k.transaction((e=>{e.executeSql("CREATE TABLE IF NOT EXISTS users (\n            id integer NOT NULL PRIMARY KEY,\n            name varchar(50) NOT NULL\n        )",[],N,O),e.executeSql("CREATE TABLE IF NOT EXISTS userchans (\n            id integer NOT NULL PRIMARY KEY\n        )",[],N,O),e.executeSql("CREATE TABLE IF NOT EXISTS chans (\n            id integer NOT NULL PRIMARY KEY,\n            name varchar(50) NOT NULL,\n            fullname varchar(150) NOT NULL,\n            mom integer NOT NULL,\n            by integer NOT NULL,\n            dir text NOT NULL,\n            ispub boolean NOT NULL DEFAULT '0',\n            isprv boolean NOT NULL DEFAULT '0',\n            timestamp datetime NOT NULL DEFAULT CURRENT_TIMESTAMP\n        )",[],N,O),e.executeSql("CREATE TABLE IF NOT EXISTS chats (\n            id integer NOT NULL PRIMARY KEY,\n            txt text NOT NULL,\n            by integer NOT NULL,\n            re integer NOT NULL,\n            nor integer NOT NULL DEFAULT '0',\n            chanid integer NOT NULL,\n            dir text NOT NULL,\n            status integer NOT NULL DEFAULT '0',\n            timestamp datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            star boolean\n        )",[],N,O),e.executeSql("CREATE TABLE IF NOT EXISTS chanchats (\n            chanid integer NOT NULL,\n            chatid integer NOT NULL,\n            PRIMARY KEY (chanid, chatid)\n        )",[],N,O)}));const j=()=>{k.transaction((e=>{e.executeSql("SELECT * FROM sqlite_master WHERE type = 'table' AND name NOT LIKE '\\_%' escape '\\'",[],((e,t)=>{var n,a,r;function i(){}for(a=(n=t.rows).length;a--;)r=n.item(a).name,e.executeSql("DROP TABLE "+r,[],i,console.error)}),console.error)}))};window._qd=j,window._q=(e,t=[])=>{k.transaction((n=>{n.executeSql(e,t,((e,t)=>{}),console.error)}))};var D={date:"1/11/2021, 4:02:17 AM",build:"d862f18",ver:"0.0.50"};const I=x(),M="sonic",R=["session","chats","users","chans","ranges","chanchats","updates"];let _;localStorage.getItem("_")!==D.ver&&(localStorage.setItem("_",D.ver),K(M),j()),window._d=()=>K(M);let P=indexedDB.open(M,1);function K(e){var t=window.indexedDB.deleteDatabase(e);t.onerror=e=>{},t.onsuccess=e=>{}}P.onsuccess=e=>{_=P.result,function(e){let t=e.objectStoreNames;for(const e of R)if(!t.contains(e))return void K(M)}(_),I.complete(_),P.open?P.open():P.open=!0},P.onerror=e=>{I.complete()},P.onblocked=e=>{},P.onupgradeneeded=e=>{_=P.result;let t=_.objectStoreNames;if(!t.contains("session")){_.createObjectStore("session")}if(!t.contains("ranges")){_.createObjectStore("ranges")}if(!t.contains("chats")){let e=_.createObjectStore("chats",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1})}if(!t.contains("users")){_.createObjectStore("users",{keyPath:"id"})}if(!t.contains("chans")){_.createObjectStore("chans",{keyPath:"id"}).createIndex("mom",["mom","id"],{unique:!1})}if(!t.contains("chanchats")){_.createObjectStore("chanchats",{keyPath:["chanid","chatid"]})}if(!t.contains("chanchats")){_.createObjectStore("updates")}for(const e of R)_.objectStoreNames.contains(e)||_.createObjectStore(e)};const B=async(e,t)=>{let n=await I.join();n&&n.transaction(["session"],"readwrite").objectStore("session").put(t,e)},q=async()=>{let e=await I.join();e&&(e.transaction(["session"],"readwrite").objectStore("session").clear(),e.transaction(["chans"],"readwrite").objectStore("chans").clear(),e.transaction(["chats"],"readwrite").objectStore("chats").clear(),e.transaction(["chanchats"],"readwrite").objectStore("chanchats").clear(),e.transaction(["ranges"],"readwrite").objectStore("ranges").clear(),e.transaction(["updates"],"readwrite").objectStore("updates").clear(),e.transaction(["users"],"readwrite").objectStore("users").clear())},H=async(e,t)=>{let n=await I.join();if(!n)return;let a=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>{"string"==typeof e.timestamp&&(e.timestamp=new Date(e.timestamp)),a.put(e).onerror=console.error})),k.transaction((n=>{t.forEach((t=>{let a=Object.keys(t),r=`INSERT OR REPLACE INTO ${e} (${a.join(",")}) VALUES (${Array(a.length).fill("?").join(",")})`;n.executeSql(r,Object.values(t).map((e=>"function"==typeof e?e():e)),N,O)}))}))},F=async(...e)=>{let t=await I.join();t&&(await W(...e),function(e){let n=t.transaction(["chanchats"],"readwrite").objectStore("chanchats");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);n.delete(t).onerror=console.error}))}(e),function(e){let n=t.transaction(["chats"],"readwrite").objectStore("chats"),a=n.index("chanid");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);a.openCursor(t).onsuccess=e=>{var t=e.target.result;t&&(n.delete(t.primaryKey).onerror=console.error,t.continue())}}))}(e.filter((e=>e>0))))},$=async({id:e,dir:t})=>{let n=await I.join();if(!n)return;let a=[0,...t];!function(e,t){t.forEach((async t=>{let n=await G(t);n&&n.includes(e)&&W(t)}))}(e,a),function(e,t){let a=n.transaction(["chanchats"],"readwrite").objectStore("chanchats");t.forEach((t=>{let n=IDBKeyRange.only([t,e]);a.delete(n).onerror=console.error}))}(e,a),function(...e){let t=n.transaction(["chats"],"readwrite").objectStore("chats");e.forEach((e=>{t.delete(e).onerror=console.error}))}(e)},Y=async(e,t)=>{let n=await I.join();n&&(n.transaction([e],"readwrite").objectStore(e).put(t).onerror=console.error,k.transaction((n=>{let a=Object.keys(t),r=`INSERT OR REPLACE INTO ${e} (${a.join(",")}) VALUES (${Array(a.length).fill("?").join(",")})`;n.executeSql(r,Object.values(t).map((e=>"function"==typeof e?e():e)),N,O)})))},V=async(e,t)=>{let n=await I.join();if(!n)return{value:[],missed:t};if(0===t.length)return{value:[],missed:[]};performance.now();let a=[],r=new Set,i=n.transaction([e],"readonly").objectStore(e),o=0;return new Promise((e=>{t.forEach((n=>{let s=i.get(n);s.onerror=console.error,s.onsuccess=i=>{if(s.result?a.push(s.result):r.add(n),++o===t.length){let t={value:a,missed:Array.from(r)};e(t)}}}))}))},J=(e,t,n,a)=>{let r=n?IDBKeyRange.upperBound(n,a):null;if(!t)return[e,r];let i=n||Number.MAX_VALUE;switch(t.tag){case"Chanid":r=IDBKeyRange.bound([t.value],[t.value,i],!1,a)}return[e,r]},X=async(e,t,n=30,a=!0)=>(await(async(e,t,n,a,r,i,o)=>{let s=await I.join();if(!s)return;performance.now();let c=[],l=s.transaction([e],"readonly"),[u,d]=i?i(l.objectStore(e),t,a,r):[l.objectStore(e),null],h=0;return new Promise((e=>{u.openCursor(d,o).onsuccess=t=>{var a=t.target.result;if(a){if(c.push(a.value),++h===n)return e(c);a.continue()}else e(c)}}))})("chanchats",e,n,t,a,J,"prev")).map((e=>e.chatid)),z=async(e,t,n)=>{let a=await I.join();if(!a)return;let r=a.transaction(["ranges"],"readwrite").objectStore("ranges"),i=r.get(e);i.onerror=console.error,i.onsuccess=async a=>{if(i.result){if(n)return r.put([i.result[0],i.result[1],n],e).onerror=console.error;t[0]<i.result[0]&&(t[0]=i.result[0]),t[1]>i.result[0]&&(t[1]=i.result[1])}r.put(t,e).onerror=console.error}},G=e=>Q(e,"ranges"),W=async(...e)=>{let t=await I.join();if(!t)return;let n=t.transaction(["ranges"],"readwrite").objectStore("ranges");e.forEach((e=>n.delete(e).onerror=console.error))},Z=e=>Q(e,"session"),Q=async(e,t)=>{let n=await I.join();if(!n)return;let a=n.transaction([t],"readonly").objectStore(t);return new Promise((t=>{let n=a.get(e);n.onerror=console.error,n.onsuccess=e=>t(n.result)}))},ee=async(e,t,n)=>{let a=await I.join();a&&a.transaction([e],"readwrite").objectStore(e).put(n,t)};var te,ne,ae;!function(e){e.Id=function(e){return{tag:"Id",value:e}},e.Chanid=function(e){return{tag:"Chanid",value:e}}}(te||(te={})),function(e){e.ChatScan=function(e){return{tag:"ChatScan",value:e}},e.ChanScan=function(e){return{tag:"ChanScan",value:e}},e.AddChat=function(e){return{tag:"AddChat",value:e}},e.AddUser=function(e){return{tag:"AddUser",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.Logout=function(e){return{tag:"Logout",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.ChanJoin=function(e){return{tag:"ChanJoin",value:e}},e.ChanLeave=function(e){return{tag:"ChanLeave",value:e}},e.ChanAdd=function(e){return{tag:"ChanAdd",value:e}},e.DelChat=function(e){return{tag:"DelChat",value:e}},e.DelChan=function(e){return{tag:"DelChan",value:e}},e.EditChat=function(e){return{tag:"EditChat",value:e}},e.Update=function(e){return{tag:"Update",value:e}},e.Sink=function(e){return{tag:"Sink",value:e}}}(ne||(ne={})),function(e){e.ChatScan=function(e){return{tag:"ChatScan",value:e}},e.ChanScan=function(e){return{tag:"ChanScan",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chat=function(e){return{tag:"Chat",value:e}},e.Chan=function(e){return{tag:"Chan",value:e}},e.User=function(e){return{tag:"User",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.ChanJoin=function(e){return{tag:"ChanJoin",value:e}},e.DelChat=function(e){return{tag:"DelChat",value:e}},e.DelChan=function(e){return{tag:"DelChan",value:e}},e.EditChat=function(e){return{tag:"EditChat",value:e}},e.Update=function(e){return{tag:"Update",value:e}},e.Updates=function(e){return{tag:"Updates",value:e}},e.UserOn=function(e){return{tag:"UserOn",value:e}},e.UserOff=function(e){return{tag:"UserOff",value:e}},e.OnlineUsers=function(e){return{tag:"OnlineUsers",value:e}},e.Sink=function(e){return{tag:"Sink",value:e}}}(ae||(ae={}));const re=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),ie=(e,t)=>{const{view:{buffer:n},pos:a}=e,r=n.byteLength;if(r-a>t)return e;const i=Math.max(2*r,r+t),o=new Uint8Array(i);return o.set(new Uint8Array(n)),re(o.buffer,a,e.littleEndian)},oe=(e,t)=>{e=ie(e,1);const{view:n,pos:a}=e;return n.setUint8(a,t),e.pos+=1,e},se=(e,t)=>{e=ie(e,4);const{view:n,pos:a,littleEndian:r}=e;return n.setUint32(a,t,r),e.pos+=4,e},ce=(e,t)=>{e=ie(e,2);const{view:n,pos:a,littleEndian:r}=e;return n.setUint16(a,t,r),e.pos+=2,e};function le(e,t){const{view:n,pos:a,littleEndian:r}=e;return n.setUint32(r?a:a+4,t,r),n.setUint32(r?a+4:a,0,r),e.pos+=8,e}const ue=(e,t)=>{e=ie(e,4);const{view:n,pos:a,littleEndian:r}=e;return n.setInt32(a,t,r),e.pos+=4,e},de=new TextEncoder,he="encodeInto"in de?(e,t)=>de.encodeInto(e,t).written:(e,t)=>{const n=de.encode(e);return t.set(n),n.length},fe=(e,t)=>{e=ie(e,3*t.length+8);const n=he(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=le(e,n)).pos+=n,e},pe=(e,t)=>oe(e,t?1:0),me=e=>(t,n)=>n.reduce(e,((e,t)=>le(ie(e,8),t))(t,n.length)),we=e=>(t,n)=>null===n?oe(t,0):e(oe(t,1),n),ye=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},ve=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=2,n.getUint16(t,a)},ge=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getUint32(t,a)},be=e=>{const{view:t,pos:n,littleEndian:a}=e;return e.pos+=8,t.getUint32(a?n:n+4,a)},Ce=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getInt32(t,a)},Ee=e=>1===ye(e),Se=e=>t=>1===ye(t)?e(t):null,Le=e=>t=>{const n=be(t),a=new Array;for(let r=0;r<n;r++)a.push(e(t));return a},Ue=new TextDecoder,Ae=e=>{const t=be(e),{pos:n,view:{buffer:a}}=e,r=Ue.decode(new Uint8Array(a,n,t));return e.pos+=t,r};var Te=me(ue),xe=we((function(e,t){switch(t.tag){case"Id":return ue(se(e,0),t.value);case"Chanid":return ue(se(e,1),t.value)}})),ke=we(fe),Ne=we(ue),Oe=we(oe),je=me(oe),De=function(e,t){var n=t.id,a=t.txt,r=t.by,i=t.re,o=t.nor,s=t.chanid,c=t.dir,l=t.status,u=t.timestamp;return fe(ce(Te(ue(ue(ue(ue(fe(ue(e,n),a),r),i),o),s),c),l),u)},Ie=me(De),Me=function(e,t){var n=t.id,a=t.name,r=t.fullname,i=t.mom,o=t.by,s=t.dir,c=t.ispub,l=t.isprv,u=t.timestamp;return fe(pe(pe(Te(ue(ue(fe(fe(ue(e,n),a),r),i),o),s),c),l),u)},Re=me(Me),_e=me((function(e,t){var n=t.id,a=t.name;return fe(ue(e,n),a)})),Pe=(we(Te),we(De),we(Me),we((function(e,t){var n=t.id,a=t.name,r=t.email,i=t.emailverified,o=t.fullname,s=t.key,c=t.timestamp;return fe(fe(fe(pe(fe(fe(ue(e,n),a),r),i),o),s),c)})),we((function(e,t){var n=t.data,a=t.chans;return Te(je(e,n),a)})),me((function(e,t){var n=t.id,a=t.action,r=t.chatid,i=t.txt;return ke(ue(ce(ue(e,n),a),r),i)})),we((function(e,t){var n=t.chats,a=t.chans,r=t.users;return _e(Re(Ie(e,n),a),r)})),function(e,t){var n=t.filter,a=t.kw,r=t.ub,i=t.lb,o=t.limit;return Oe(Ne(Ne(ke(xe(e,n),a),r),i),o)}),Ke=function(e,t){var n=t.id,a=t.txt;return fe(ue(e,n),a)},Be=function(e,t){switch(t.tag){case"ChatScan":return Pe(se(e,0),t.value);case"ChanScan":return Pe(se(e,1),t.value);case"AddChat":return function(e,t){var n=t.txt,a=t.re,r=t.chname;return ke(Ne(fe(e,n),a),r)}(se(e,2),t.value);case"AddUser":return function(e,t){var n=t.email,a=t.name,r=t.key;return je(fe(fe(e,n),a),r)}(se(e,3),t.value);case"Login":return function(e,t){var n=t.email,a=t.key;return je(fe(e,n),a)}(se(e,4),t.value);case"Logout":return je(se(e,5),t.value);case"Users":return Te(se(e,6),t.value);case"Chans":return Te(se(e,7),t.value);case"Chats":return Te(se(e,8),t.value);case"ChanJoin":return ue(se(e,9),t.value);case"ChanLeave":return ue(se(e,10),t.value);case"ChanAdd":return function(e,t){var n=t.id,a=t.email;return fe(ue(e,n),a)}(se(e,11),t.value);case"DelChat":return ue(se(e,12),t.value);case"DelChan":return ue(se(e,13),t.value);case"EditChat":return Ke(se(e,14),t.value);case"Update":return function(e,t){var n=t.id,a=t.chanid,r=t.chatid;return ue(ue(ue(e,n),a),r)}(se(e,15),t.value);case"Sink":return Pe(se(e,16),t.value)}},qe=Le(Ce),He=(Se((function(e){switch(ge(e)){case 0:return te.Id(Ce(e));case 1:return te.Chanid(Ce(e))}throw new Error("bad variant index for Filter")})),Se(Ae)),Fe=Se(Ce),$e=(Se(ye),Le(ye)),Ye=function(e){return{id:Ce(e),txt:Ae(e),by:Ce(e),re:Ce(e),nor:Ce(e),chanid:Ce(e),dir:qe(e),status:ve(e),timestamp:Ae(e)}},Ve=Le(Ye),Je=function(e){return{id:Ce(e),name:Ae(e),fullname:Ae(e),mom:Ce(e),by:Ce(e),dir:qe(e),ispub:Ee(e),isprv:Ee(e),timestamp:Ae(e)}},Xe=Le(Je),ze=Le((function(e){return{id:Ce(e),name:Ae(e)}})),Ge=Se(qe),We=Se(Ye),Ze=Se(Je),Qe=Se((function(e){return{id:Ce(e),name:Ae(e),email:Ae(e),emailverified:Ee(e),fullname:Ae(e),key:Ae(e),timestamp:Ae(e)}})),et=Se((function(e){return{data:$e(e),chans:qe(e)}})),tt=Le((function(e){return{id:Ce(e),action:ve(e),chatid:Ce(e),txt:He(e)}})),nt=Se((function(e){return{chats:Ve(e),chans:Xe(e),users:ze(e)}})),at=function(e){return{id:Ce(e),txt:Ae(e)}},rt=function(e){switch(ge(e)){case 0:return ae.ChatScan(Ge(e));case 1:return ae.ChanScan(Ge(e));case 2:return ae.Chats(Ve(e));case 3:return ae.Chans(Xe(e));case 4:return ae.Users(ze(e));case 5:return ae.Chat(We(e));case 6:return ae.Chan(Ze(e));case 7:return ae.User(Qe(e));case 8:return ae.Login(et(e));case 9:return ae.ChanJoin(Fe(e));case 10:return ae.DelChat(Ce(e));case 11:return ae.DelChan(Ce(e));case 12:return ae.EditChat(at(e));case 13:return ae.Update(Ce(e));case 14:return ae.Updates(tt(e));case 15:return ae.UserOn(Ce(e));case 16:return ae.UserOff(Ce(e));case 17:return ae.OnlineUsers(qe(e));case 18:return ae.Sink(nt(e))}throw new Error("bad variant index for Response")},it=re(new ArrayBuffer(512)),ot=function(e,t){return it.pos=0,it=t(it,e),new Uint8Array(it.view.buffer).slice(0,it.pos)},st=function(e,t){return t(re(e))},ct=function(e){return st(e.buffer,rt)},lt=function(e){return ot(e,Be)};const ut=e=>new Zlib.Inflate(e).decompress(),dt=e=>new Zlib.Deflate(e).compress(),ht=async(e,t,n)=>await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),ft=async(e,t,n)=>await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e);let pt={},mt=[];function wt(e){return this.t&&this.t[e.type](e)}pt.h=(...e)=>{let t,n=a=>{if(null==a);else if("string"==typeof a)t?pt.add(t,a):t=pt.s?document.createElementNS("http://www.w3.org/2000/svg",a):document.createElement(a);else if(Array.isArray(a))t||(t=document.createDocumentFragment()),a.forEach(n);else if(a instanceof Node)t?pt.add(t,a):t=a;else if("object"==typeof a)pt.property(t,a,null,pt.s);else if("function"==typeof a)if(t){let e=pt.add(t,"");pt.insert(t,a,e)}else t=a.apply(null,e.splice(1));else pt.add(t,""+a)};return e.forEach(n),t},pt.insert=(e,t,n,a,r)=>(e=n&&n.parentNode||e,r=r||a instanceof Node&&a,t===a||(a&&"string"!=typeof a||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?pt.subscribe((()=>{a=pt.insert(e,t.call({el:e,endMark:n}),n,a,r)})):(n?a&&(r||(r=a.o&&a.o.nextSibling||n.previousSibling),pt.rm(e,r,n)):e.textContent="",a=null,t&&!0!==t&&(a=pt.add(e,t,n))):(null!=a&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?pt.add(e,t,n):e.textContent=t,a=t)),a),pt.property=(e,t,n,a,r)=>{if(null!=t)if(!n||"attrs"===n&&(a=!0))for(n in t)pt.property(e,t[n],n,a,r);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?pt.subscribe((()=>{pt.property(e,t.call({el:e,name:n}),n,a,r)})):r?e.style.setProperty(n,t):a||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:pt.property(e,t,null,a,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,wt):e.removeEventListener(t,wt),(e.t||(e.t={}))[t]=n})(e,n,t)},pt.add=(e,t,n)=>{let a=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:pt.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:pt.h(mt,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),a},pt.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},pt.subscribe=function(e){return function(e,t){function n(){let a=u;return u&&u.__c.push(n),p(n),n.i=!0,u=n,t=e(t),u=a,t}function a(){return n.i?u&&n.u.forEach((e=>e())):t=n(),t}e.s=n,m(n),n(),a.$o=1}(e),()=>p(e.s)},pt.cleanup=function(e){return u&&u.l.push(e),e},pt.root=h,pt.sample=function(e){let t=u;u=void 0;let n=e();return u=t,n},pt.hs=(...e)=>{let t=pt.s;pt.s=!0;let n=yt(...e);return pt.s=t,n};let yt=(...e)=>pt.h.apply(pt.h,e);const vt=new Map,gt=(e,t,n=!1)=>{let a=vt.get(e)||[];n?a=[t]:a.push(t),vt.set(e,a)},bt=(e,t)=>vt.has(e)?vt.get(e).forEach((e=>e(t))):void 0,Ct={},Et=e=>(e&&(Object.assign(Ct,e),bt("config",Ct)),Ct),St=f(void 0),Lt={id:f(0),name:f(""),chans:f([])};async function Ut(){let e=await Z("a");if(!e||e.byteLength<53)return;let t=new Uint8Array(e,0,16),n=new Uint8Array(e,16,32);t&&16===t.length&&(Lt.salt=t),n&&32===n.length&&(Lt.sskey=await crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"]));let a=new Uint8Array(e,48,4),r=new Uint8Array(e,52),i=new DataView(a.buffer).getInt32(48,!1),o=(new TextDecoder).decode(r);i&&o&&(Lt.id(i),Lt.name(o));let s=await Z("c");return s&&s instanceof Array&&Lt.chans(s),Lt.salt}async function At(e,t){let n=new TextEncoder,a=await Tt(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",a)}async function Tt(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}const xt=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/);let kt="wss://"+(xt?xt.groups.ip:"ws.yah.vn:443");window._ws=e=>(e&&("string"==typeof e&&(kt="wss://"+e),Vt(!0)),kt),window._ws=()=>Ot,window._pc=()=>Mt,window._dc=()=>Bt;let Nt,Ot,jt,Dt,It,Mt,Rt,_t,Pt,Kt,Bt,qt=500,Ht=0,Ft=new Set,$t={recv:e=>Ft.add(e)};Vt(),Jt();const Yt=x();function Vt(e){Nt=performance.now(),Ot=new WebSocket(kt),Ot.binaryType="arraybuffer",Ot.onopen=()=>{e?Jt():It&&Gt()},Ot.onmessage=async e=>{let t=new Uint8Array(e.data),{a:n,k:a}=E(t);Et((e=>{const t=new l(e);return{z:t.get(0),m:t.get(1),c:t.get(2),d:t.get(3)}})(n));var r,i,o;a=await(r=a,crypto.subtle.importKey("raw",r,{name:"ECDH",namedCurve:"P-256"},!0,[])),Kt=await(i=Dt.privateKey,o=a,crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:o},i,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])),Pt=new Uint8Array(await crypto.subtle.exportKey("raw",Kt));let s=JSON.parse((e=>(new TextDecoder).decode(ut(e)))(n.slice(1))),c=s.answer?s.answer:s;if(await Mt.setRemoteDescription(new RTCSessionDescription(c)),!s.candidate)return;const u=new RTCIceCandidate({candidate:s.candidate,sdpMid:0,sdpMLineIndex:0});await Mt.addIceCandidate(u)},Ot.onclose=e=>{Ht++,qt+=U(0,Ht<16?200:3e3),setTimeout((()=>{Vt(!0)}),qt)},Ot.onerror=e=>{}}function Jt(){Rt=!1,Mt=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]}),Mt.onicecandidate=e=>{e.candidate},Mt.onconnectionstatechange=e=>{Mt.connectionState},Mt.oniceconnectionstatechange=e=>{Mt.iceConnectionState},Bt=Mt.createDataChannel("cu",{}),Bt.binaryType="arraybuffer",$t.send=Xt,Bt.onopen=e=>{Yt.complete(Bt)},Bt.onmessage=zt,Bt.onclose=e=>{},Bt.onerror=e=>{},async function(){const e=async()=>{let e=await Mt.createOffer();return await Mt.setLocalDescription(e),dt((new TextEncoder).encode(Mt.localDescription.sdp))},t=async()=>{if(_t)return _t;Dt=await(async()=>await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"]))();let e=await crypto.subtle.exportKey("raw",Dt.publicKey);return _t=new Uint8Array(e),_t};It=await(async(e,t,n)=>{let[a,r,i]=await Promise.all([e(),t(),n()]);return i?C(C(a,r),i):T(C(a,r),64,24)})(e,t,Ut),1===Ot.readyState&&Gt()}()}async function Xt(e){await Yt.join(),(e=>{e.length||e.byteLength})(e=lt(e));let{z:t,m:n,c:a,d:r}=Et();if(t&&(e=dt(e)),n&&(e=T(e,e.length),b(e,Pt)),a){const t=crypto.getRandomValues(new Uint8Array(12));b(e,t),e=A(t,new Uint8Array(await ht(e,Kt,t)))}if(r){const t=crypto.getRandomValues(new Uint8Array(12));b(e,t),e=A(t,new Uint8Array(await ht(e,Lt.sskey,t)))}Bt.send(e),jt=performance.now()}async function zt(e){let t=new Uint8Array(e.data),n=t.length,{z:a,m:r,c:i,d:o}=Et();if(o){let e=t.subarray(0,12);t=new Uint8Array(await ft(t.subarray(12),Lt.sskey,e)),b(t,e)}if(i){let e=t.subarray(0,12);t=new Uint8Array(await ft(t.subarray(12),Kt,e)),b(t,e)}if(r){b(t,Pt);let{a:e}=E(t);t=new Uint8Array(e)}a&&(t=ut(t));(100*n/t.length).toFixed(2);let s=Wt(t);Ft.forEach((e=>e(s)))}const Gt=()=>{Rt||(Ot.send(It),Rt=!0)},Wt=e=>ct(e);function Zt(e,t,n){const{root:a,subscribe:r,sample:i,cleanup:o}=pt;null==n&&(n=!t.$t);let s=pt.h([]),c=pt.add(s,""),l=new Map,u=new Map,d=new Set;function h(e,r){if(null==e)return;let i=u.get(e);return 1===r?(d.delete(e),i||(i=n?a((n=>(l.set(e,n),t(e.$v||e)))):t(e.$v||e),11===i.nodeType&&(i=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let a=Array.from(t);return{nodeType:111,t:a[0],o:a[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(a[t++])}return e}}})(i)||i),u.set(e,i))):-1===r&&d.add(e),((e,t)=>111===e.nodeType?1/t<0?t?pt.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(i,r)}function f(e){let t=l.get(e);t&&(t(),l.delete(e)),u.delete(e)}return o(r((t=>{let n=e();return i((()=>{d.clear();let e=Array.from(function(e,t,n,a,r){let i,o,s=new Map,c=new Map;for(i=0;i<t.length;i++)s.set(t[i],i);for(i=0;i<n.length;i++)c.set(n[i],i);for(i=o=0;i!==t.length||o!==n.length;){var l=t[i],u=n[o];if(null===l)i++;else if(n.length<=o)e.removeChild(a(t[i],-1)),i++;else if(t.length<=i)e.insertBefore(a(u,1),a(t[i],0)||r),o++;else if(l===u)i++,o++;else{var d=c.get(l),h=s.get(u);void 0===d?(e.removeChild(a(t[i],-1)),i++):void 0===h?(e.insertBefore(a(u,1),a(t[i],0)||r),o++):(e.insertBefore(a(t[h],1),a(t[i],0)||r),t[h]=null,h>i+1&&i++,o++)}}return n}(c.parentNode,t||[],n,h,c));return d.forEach(f),e}))}))),o((function(){l.forEach((e=>e())),l.clear(),u.clear(),d.clear()})),s}window._b=$t;const Qt="0VMZYpdgCGL3iKAzDHwocTt97e1hasO2mJNjExq4PvR6XyWSFbIn-5B_8fUukQlr",en=Qt.split(""),tn=new Array(123);for(let e=0;e<Qt.length;e++)tn[Qt.charCodeAt(e)]=e;const nn=e=>{if(e<0)return"-"+nn(-e);let t=e>>>0,n=e/4294967296>>>0,a="";for(;n>0;)a=en[63&t]+a,t>>>=6,t|=(63&n)<<26,n>>>=6;let r="";do{r=en[63&t]+r,t>>>=6}while(t>0);return r+a};var an={ntob:nn,bton:e=>{let t=0;for(let n=0;n<e.length;n++)t=64*t+tn[e.charCodeAt(n)];return t}};const rn=[0,null,"🏠",0],on=(()=>{let e=f(rn);const t=f([e]),n=t=>e(t);return{path:t=>e()[t],paths:t,len:()=>t().length,setpath:n,same:t=>t===e(),cd:e=>{let a=t();a[e[0]]!==e&&(a[e[0]]=e),a.splice(e[0]+1),t(a),n(e),location.hash=e[0]>0?an.ntob(e[3]):""},update:e=>{t([rn,...e]),n(e[e.length-1]||rn)}}})(),sn=[];function cn(){!function(e){for(const t of sn)t(e)}(document.location.hash.substr(1))}window.addEventListener("hashchange",cn),setTimeout(cn);const ln=30,un=new Map,dn=new Map,hn=new Map,fn=e=>(t,n)=>{if(!t)return e;let a=e.get(t);return n?a?a[n]:void 0:a},pn=f([]),mn=f([]),wn=f(0),yn=f(0),vn=f(0),gn=f(0),bn=f(""),Cn=f(""),En=f(!1),Sn=f(!1),Ln=fn(un),Un=fn(dn),An=fn(hn),Tn=(()=>{const e={},t={};return{create:n=>t[n]=new Promise((t=>e[n]=t)),complete:(t,n)=>e[t]?e[t](n):null,join:e=>t[e],joinall:(...e)=>Promise.all(e.map((e=>t[e]))),select:(...e)=>Promise.race(e.map((e=>t[e])))}})();async function xn(e){let t=e||[],n=wn();if(0===t.length)return En(!0),z(n,null,!0),void Tn.complete("chatscan",t);En(!1),z(n,[t[0],t[t.length-1]]);let a=t.map((e=>({chanid:n,chatid:e})));H("chanchats",a),Tn.complete("chatscan",t)}$t.recv((async e=>{switch(e.tag){case"Sink":if(!e.value)return;w(e.value.chats,Un()),w(e.value.users,An()),w(e.value.chans,Ln()),H("chats",e.value.chats),H("chans",e.value.chans),H("users",e.value.users),xn(e.value.chats.map((e=>e.id)).reverse());break;case"Update":ee("updates",wn(),e.value);break;case"Updates":Tn.complete("updates",e.value);break;case"Login":if(!e.value)return St(void 0),void bt("login",!1);await async function({data:e,chans:t}){let n=new Uint8Array(e.slice(16,20)),a=new Uint8Array(e.slice(20)),r=new DataView(n.buffer).getInt32(0,!1),i=(new TextDecoder).decode(a);Lt.id(r),Lt.name(i),Lt.chans(t),Lt.salt=new Uint8Array(e.slice(0,16)),Lt.sskey=await Tt(St(),Lt.salt),St(void 0);let o=new Uint8Array(await crypto.subtle.exportKey("raw",Lt.sskey)),s=Lt.salt.length,c=new Uint8Array(s+o.length+n.length+a.length);c.set(Lt.salt),c.set(o,s),c.set(n,s+o.length),c.set(a,s+o.length+n.length),B("a",c.buffer),Et({d:!0}),B("c",t),Y("users",{id:r,name:i})}(e.value),bt("login",!0);break;case"Users":H("users",e.value),Tn.complete("users",e.value);break;case"Chans":H("chans",e.value),Tn.complete("chans",e.value);break;case"Chat":let t=mn();if(t.includes(e.value.id))return;let n=window.scrollY+window.innerHeight===document.body.scrollHeight;await Y("chats",e.value);let a=new Set(An().has(e.value.by)?[]:[e.value.by]),r=e.value.dir.filter((e=>!Ln(e))),i=new Set(r);await jn(a,i),e.value.nor=f(0),e.value.star=f(!1),e.value.txt=f(e.value.txt),Un().set(e.value.id,e.value),t.push(e.value.id),mn(t),n&&y();let o=Lt.chans();if(o.includes(e.value.chanid))return;o.push(e.value.chanid),Lt.chans(o),await B("c",o);break;case"Chats":e.value.length>0&&H("chats",e.value),Tn.complete("chats",e.value);break;case"ChatScan":xn(e.value);break;case"ChanScan":let s=e.value||[];s.length>0?(Sn(!1),await In(s)):Sn(!0),Tn.complete("chanscan",s);break;case"ChanJoin":Tn.complete("chanjoin",e.value);break;case"DelChat":qn(e.value);break;case"EditChat":let{id:c,txt:l}=e.value,u=Un(c);u&&u.txt(l),u=await Q(c,"chats"),u&&(u.txt=l,await Y("chats",u))}}));const kn="/"+Qt;(e=>{sn.push(e)})((async e=>{if(!e||!kn.includes(e[0]))return wn(0),Dn([]),document.title="sonic",Bn(),void(document.getElementsByClassName("tbl").length>0&&Pn(0));if("/"===e[0]){let t=an.bton(e.slice(1));yn(t),await On([t]),Bn();let n=Un(t).dir;return await In(n),Dn(n),void(document.title=Ln(wn(),"fullname")+" - sonic")}let t=an.bton(e);if(wn(t),Bn(),await In([t]),!Ln(t))return;let n=Ln(t).dir;await In(n),Dn([...n,t]),document.getElementsByClassName("tbl").length>0&&Pn(on.path(3)),document.title=Ln(wn(),"fullname")+" - sonic"}));const Nn=async(e,t=null)=>{await On(e);let n=e[0],a=new Set,r=new Set,i=mn(),o=new Set;switch(e.forEach((e=>{let t=Un(e);"function"!=typeof t.txt&&(t.txt=f(t.txt),t.nor=f(t.nor),t.star=f(!1)),"string"==typeof t.timestamp&&(t.timestamp=new Date(t.timestamp)),An().has(t.by)||a.add(t.by),t.dir.forEach((e=>{Ln().has(e)||r.add(e)})),o.has(e),o.add(e)})),await jn(a,r),e.reverse(),t){case"re":mn(e);break;case"pre":mn(i.concat(e));break;default:mn(e.concat(i))}o=new Set,mn().forEach((e=>{o.has(e),o.add(e)})),n&&bt("keysloaded",n)},On=async e=>{if(0===(e=e.filter((e=>!Un().has(e)))).length)return;let{value:t,missed:n}=await V("chats",e);if(w(t,Un()),n.length>0){let e=await Tn.create("chats",$t.send(ne.Chats(n)));w(e,Un())}},jn=async(e,t)=>{let n=await V("users",Array.from(e)),a=await V("chans",Array.from(t));w(n.value,An()),w(a.value,Ln()),n.missed.length>0&&Tn.create("users",$t.send(ne.Users(n.missed))),a.missed.length>0&&Tn.create("chans",$t.send(ne.Chans(a.missed)));let[r,i]=await Tn.joinall("users","chans");r&&w(r,An()),i&&w(i,Ln())},Dn=e=>{let t=e.map(((e,t)=>{let n=Ln(e)||{};return[t+1,n.mom,n.name,e]}));on.update(t)},In=async e=>{if(0===(e=e.filter((e=>!Ln().has(e)))).length)return;let{value:t,missed:n}=await V("chans",e);if(w(t,Ln()),n.length>0){let e=await Tn.create("chans",$t.send(ne.Chans(n)));w(e,Ln())}};let Mn=null;const Rn=async(e,t=null,n=null)=>{performance.now();let a=await((e,t=null,n=null,a=null,r=null)=>{t&&Cn(t);let i=ne.ChanScan({filter:_n(e),kw:t,ub:n,lb:a,limit:r});return Tn.create("chanscan",$t.send(i))})(e,t,n);n?0===a.length||pn(pn().concat(a)):(0!==a.length||t||bt("nochan"),pn(a))},_n=e=>(Mn=e,"number"==typeof e?te.Chanid(e):null),Pn=async e=>{Mn!==e&&Rn(e)},Kn=(e=null,t=null,n=null)=>{let a=ne.Sink({filter:yn()>0?te.Id(yn()):wn()>0?te.Chanid(wn()):null,kw:null,ub:e,lb:t,limit:n});return Tn.create("chatscan",$t.send(a))};async function Bn(){En(!1),gn(!1),vn(0);let e=wn();performance.now();let t=await G(e)||[],n=t[0]||null,a=await X(te.Chanid(e),null,ln);await Nn(a,"re"),gn(!0),bt("reloaded"),t[1]&&async function(e,t){let n=await Q(e,"updates");$t.send(ne.Update({id:n,chanid:e,chatid:t}));let a=await Tn.create("updates");if(!a||0===a.length)return;let r=new Set([e]);for(const{action:e,chatid:t,txt:n}of a){let a=await Q(t,"chats");switch(a&&a.dir.forEach((e=>r.add(e))),e){case 2:a&&(a.txt=n,await Y("chats",a)),a=Un(t),a&&n&&a.txt(n);break;case 3:a&&await $(a),a=Un(t),a&&dn.delete(t);let e=mn(),r=e.indexOf(t);r>-1&&(e.splice(r,1),mn(e))}}r.forEach((e=>ee("updates",e,a[0].id)))}(e,t[1]);let r=await Kn(null,n)||[];await Nn(r,r.length!==ln&&0!==a.length&&n?"pre":"re"),bt("reloaded")}async function qn(e){let t=Un(e);t&&dn.delete(e),t=await Q(e,"chats"),t&&await $(t);let n=mn(),a=n.indexOf(e);a>-1&&(n.splice(a,1),mn(n))}window._chn=()=>Array.from(un.values()),window._ch=()=>Array.from(dn.values()),window._us=()=>Array.from(hn.values()),window._chns=()=>pn().map((e=>un.get(e))),window._chs=()=>mn().map((e=>dn.get(e))),window._chnid=wn,window._chid=yn,window._curid=vn,window._curtxt=bn,window._chnkw=Cn;const Hn=()=>{const e=document.createElement("div");e.contentEditable=!0,e.className="s-c",e.oninput=({target:{firstChild:t}})=>{var n,a,r,i;(n=function(){let t=e.textContent;var n;t.length>50||(n=t,Rn(on.path(3),n))},a=100,function(){var e=this,t=arguments,o=function(){i=null,r||n.apply(e,t)},s=r&&!i;clearTimeout(i),i=setTimeout(o,a),s&&n.apply(e,t)})()},e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};const t=(e,t)=>{if(e.stopPropagation(),!Lt.id())return alert("you are not login!");Lt.chans().includes(t)?(async e=>{performance.now();let t=await Tn.create("chanjoin",$t.send(ne.ChanLeave(e)));if(!t)return;let n=Lt.chans();if(!n.includes(t))return;const a=n.indexOf(t);a>-1&&n.splice(a,1),Lt.chans(n),await B("c",n),await F(0,e),Bn()})(t):(async e=>{performance.now();let t=await Tn.create("chanjoin",$t.send(ne.ChanJoin(e)));if(!t)return;let n=Lt.chans();n.includes(t)||(n.push(t),Lt.chans(n),await B("c",n),await F(0),Bn())})(t)},n=(e,t)=>{e.stopPropagation();const n=window.prompt("Enter email to add").trim();n&&(async(e,t)=>{$t.send(ne.ChanAdd({id:e,email:t}))})(t,n)};let a=yt("div",null);setTimeout((function(){new IntersectionObserver((t=>{if(t[0].intersectionRatio<=0)return;let n=pn(),a=n[n.length-1];if(!a||Sn()||n.length<ln)return;let r=e.textContent||null;r&&r.length>50||setTimeout((()=>Rn(on.path(3),r,a)))}),{}).observe(a)}));return yt([yt("div",{class:"s"},e),yt("div",{class:"tbl"},yt("table",null,yt("tbody",null,Zt(pn,(e=>{let a=Ln(e);return yt("tr",{onclick:()=>(async({id:e,mom:t,name:n})=>{await Rn(e),on.cd([on.path(0)+1,t,n,e])})(a)},yt("td",null,yt("button",{onclick:n=>t(n,e)},(()=>Lt.chans().includes(e)?"✅":"➕"))),yt("td",null,a.fullname),yt("td",null,yt("button",{onclick:t=>n(t,e)},"👤➕")))})),(()=>pn().length>0?null:yt("tr",null,yt("td",null,"no result"))),a))),yt("div",{class:"grid"},yt("div",{class:"container"},yt("ol",{class:"bc"},yt("li",null,yt("a",null,"#")," ",yt("a",null,(()=>on.path(2)))))))])};let Fn;async function $n(){await $t.send(ne.Logout(Array.from(Lt.salt))),await q(),Et({d:!1}),Lt.id(0),Lt.name(""),Lt.chans([]),Lt.sskey=void 0,Lt.salt=void 0,location.hash="",Bn(),Rn(on.path(3)),bt("logout")}gt("config",(({d:e})=>Xn(e?Jn:Vn))),gt("login",(e=>{e&&(Bn(),Rn(on.path(3)))}));const Yn=()=>yt("div",{class:"login"},yt(g(Xn),null),yt("div",{class:"v"},D.ver," ",D.build)),Vn=()=>yt([yt("h2",null,"Login"),yt("form",{onsubmit:function(e){e.preventDefault();let{m:t,p:n}=e.target;!async function(e,t){Fn=performance.now(),await q();let n=await At(t,e),a={email:e,key:Array.from(new Uint8Array(n))};St(n),$t.send(ne.Login(a))}(t.value,n.value)}},yt("input",{type:"text",name:"m",placeholder:"email",required:!0,autocomplete:"true"}),yt("input",{type:"password",name:"p",placeholder:"password",required:!0,autocomplete:"true"}),yt("button",{type:"submit"},"Login")),yt("h2",null,"Register"),yt("form",{onsubmit:function(e){e.preventDefault();let{m:t,n:n,p:a}=e.target;!async function(e,t,n){Fn=performance.now(),await q();let a=await At(n,e),r={email:e,name:t,key:Array.from(new Uint8Array(a))};St(a),$t.send(ne.AddUser(r))}(t.value,n.value,a.value)}},yt("input",{type:"text",name:"m",placeholder:"email",required:!0,autocomplete:"true"}),yt("input",{type:"text",name:"n",placeholder:"name",required:!0,autocomplete:"true"}),yt("input",{type:"password",name:"p",placeholder:"password",required:!0,autocomplete:"true"}),yt("button",{type:"submit"},"Register"))]),Jn=()=>yt([yt("div",null,"You have logged in as ",yt("b",null,Lt.name)),yt("button",{onclick:$n},"Logout")]),Xn=f((()=>null));window._v=()=>D;const zn="defaultParagraphSeparator",Gn="formatBlock",Wn=(e,t,n)=>e.addEventListener(t,n),Zn=(e,t)=>e.appendChild(t),Qn=e=>document.createElement(e),ea=e=>document.queryCommandState(e),ta=(e,t=null)=>document.execCommand(e,!1,t),na={bold:{icon:"<b>B</b>",title:"Bold",state:()=>ea("bold"),result:()=>ta("bold")},italic:{icon:"<i>I</i>",title:"Italic",state:()=>ea("italic"),result:()=>ta("italic")},underline:{icon:"<u>U</u>",title:"Underline",state:()=>ea("underline"),result:()=>ta("underline")},strikethrough:{icon:"<strike>S</strike>",title:"Strike-through",state:()=>ea("strikeThrough"),result:()=>ta("strikeThrough")},heading1:{icon:"<b>H1</b>",title:"Heading 1",result:()=>ta(Gn,"<h1>")},heading2:{icon:"<b>H2</b>",title:"Heading 2",result:()=>ta(Gn,"<h2>")},quote:{icon:"&#8220;&#8221;",title:"Quote",result:()=>ta(Gn,"<blockquote>")},olist:{icon:"1.",title:"Ordered List",result:()=>ta("insertOrderedList")},ulist:{icon:"&#8226;",title:"Unordered List",result:()=>ta("insertUnorderedList")},code:{icon:"&lt;&gt;",title:"Code",result:()=>ta(Gn,"<pre>")},line:{icon:"&#8213;",title:"Horizontal Line",result:()=>ta("insertHorizontalRule")},link:{icon:"&#128279;",title:"Link",result:()=>{const e=window.prompt("Enter the link URL");e&&ta("createLink",e)}},image:{icon:"&#128247;",title:"Image",result:()=>{const e=window.prompt("Enter the image URL");e&&ta("insertImage",e)}}},aa={actionbar:"e-a",button:"e-b",content:"e-c",selected:"e-bs",topic:"e-t"};function ra(){return window.scrollY+window.innerHeight===document.body.scrollHeight}const ia=({topic:e,content:t})=>{if(!Lt.id())return alert("you are not login!");if(!t.textContent.trim())return;let n=vn()||mn()[mn().length-1]||null,a=null;if(e.textContent!==bn()){if(a=e.textContent,0===a.trim().length)return alert("topic should not be empty"),!1;n=null}let r=t.innerHTML.trim();$t.send(ne.AddChat({txt:r,re:n,chname:a})),t.textContent="",oa({},{topic:e})},oa=({id:e,txt:t},{topic:n})=>{if(!e||vn()===e)return n.textContent="",bn(""),void vn(0);n.innerHTML=t(),n.textContent=n.textContent,bn(n.textContent),vn(e)};gt("keysloaded",(e=>{document.getElementById(an.ntob(e)).scrollIntoView()})),gt("reloaded",(()=>{setTimeout((()=>{window.innerHeight-document.getElementsByClassName("cs")[0].clientHeight>110?document.body.classList.add("fx"):document.body.classList.remove("fx")}))}));const sa=()=>{const e=(e=>{const t=e.actions?e.actions.map((e=>"string"==typeof e?na[e]:na[e.name]?{...na[e.name],...e}:e)):Object.keys(na).map((e=>na[e])),n={...aa,...e.classes},a=e.defaultParagraphSeparator||"div",r=e.element.topic=Qn("div");r.contentEditable=!0,r.className=n.topic,r.onkeydown=e=>{"Enter"===e.key&&(i.focus(),e.preventDefault())},Zn(e.element,r);const i=e.element.content=Qn("div");i.contentEditable=!0,i.className=n.content,i.oninput=({target:{firstChild:t}})=>{e.oninput(i.innerHTML)},i.onkeydown=t=>{"Enter"===t.key&&(ra()&&setTimeout((()=>y())),t.shiftKey||(e.onsend({topic:r,content:i}),t.preventDefault()))},Zn(e.element,i);const o=Qn("div");o.className=n.actionbar,Zn(e.element,o),t.forEach((e=>{const t=Qn("button");if(t.className=n.button,t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=()=>e.result()&&i.focus(),e.state){const a=()=>t.classList[e.state()?"add":"remove"](n.selected);Wn(i,"keyup",a),Wn(i,"mouseup",a),Wn(t,"click",a)}Zn(o,t)}));const s=Qn("button");return s.className="ntb",s.innerHTML="New topic",s.title="New topic",s.setAttribute("type","button"),s.onclick=()=>{if(document.body.classList.contains("ed"))return void document.body.classList.remove("ed");let e=ra();document.body.classList.add("ed"),e&&setTimeout((()=>y()))},Zn(o,s),e.styleWithCSS&&ta("styleWithCSS"),ta(zn,a),e.element})({element:yt("div",{class:"e"}),oninput:e=>{},onsend:ia}),t=f(0),n=e=>{let{id:n,txt:r,by:o,chanid:c,re:u,star:d,nor:h}=e,f=mn(),p=Ln(c);let m=f[f.indexOf(n)-1],w=Un(m)||{},y=w.by!==o,v=!u||w.chanid!==c,g=an.ntob(n),b=an.ntob(p.id);const C=()=>{l("#/"+g,g)},E=(e,t)=>{l("#"+t,t),e.preventDefault()};return yt("div",{id:g,class:function(){return"c"+(()=>(d()?" star":"")+(v?" t":"")+(vn()===n?" cur":"")).call(this)},onclick:t=>s(t,e),onmouseover:e=>t()!==n&&t(n)},v?yt("div",{class:"tn"+(u?" re":" nw")},yt("a",{href:function(){return"#"+("function"==typeof b?b.call(this):b)},onclick:e=>E(e,b),innerHTML:Ln(p.id,"fullname")}),yt("div",{class:"dr"},Zt((()=>[...p.dir.slice(on.len()-1)]),(e=>{let t=an.ntob(e);return yt("span",null,yt("a",{href:function(){return"#"+("function"==typeof t?t.call(this):t)},onclick:e=>E(e,t),innerHTML:Ln(e,"name")}))})))):null,y||v?yt("div",{class:"by"},An(o).name):null,yt("div",{onclick:e=>e.stopPropagation()},(()=>{let e=h();if(1!==e||n!==Un(mn()[i+1]).re)return e>0?yt([yt("span",{class:"rep",onclick:C},e," ↩️")," "]):void 0}),yt("div",{class:"ct"},(()=>(e=>document.createRange().createContextualFragment(e))(r())))),(()=>t()===n?a(g,e):null))},a=(t,n)=>yt([yt("div",{class:"pm pr",onclick:t=>oa(n,e),title:"reply"},"↩️"),yt("div",{class:"pm"},"💬",yt("div",{class:"pu"},yt("div",{onclick:e=>r(t,n)},"✏️ edit"),yt("div",{onclick:e=>o(n)},"❌ delete")))]),r=(e,t)=>{let n=document.getElementById(e).querySelector(".ct");if("true"==n.contentEditable)return n.contentEditable=!1,n.classList.remove("ce"),void(n.innerHTML=t.txt());n.contentEditable=!0,n.focus(),n.classList.add("ce"),n.oninput=e=>{},n.onkeydown=e=>{if("Escape"===e.key)return n.contentEditable=!1,n.classList.remove("ce"),void(n.innerHTML=t.txt());if("Enter"===e.key){let a=n.innerHTML.trim();e.shiftKey||(e.preventDefault(),n.contentEditable=!1,n.classList.remove("ce"),a!=t.txt()&&function(e,t){$t.send(ne.EditChat({id:e,txt:t}))}(t.id,a))}}},o=({id:e,txt:t})=>{confirm('Do you want to delete this chat? \n"'+t()+'"')&&function(e){$t.send(ne.DelChat(e)),qn(e)}(e)},s=(e,t)=>{e.x<18&&e.offsetY<22&&c(t)},c=({id:e,star:t})=>{const n=mn().filter((t=>t===e))[0],a=Un(n);a.star?a.star(!t()):a.star=f(!1)},l=(e,t)=>{let n=screen.width/2-300,a=screen.height/2-300;window.open(e,t,`toolbar=yes,location=yes,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=600,height=600,top=${a}, left=${n}`)},u=yt("div",null);return setTimeout((function(){new IntersectionObserver((e=>{if(e[0].intersectionRatio<=0)return void(document.body.classList.contains("fx")&&(document.body.classList.remove("fx"),y()));if(!gn())return;!mn()[0]||En()||mn().length<ln||setTimeout((()=>{if(!gn())return;let e=mn()[0];!e||En()||mn().length<ln||(async e=>{let t=wn();performance.now();let n=await G(t)||[];if(n[2]&&e===n[1])return void En(!0);En(!1);let a=await X(te.Chanid(t),e,ln);if(n[2]||a.length===ln)return void await Nn(a);let r=await Kn(e);r.length>0&&await Nn(r)})(e)}))}),{}).observe(u)})),yt([yt("div",{class:"cs"},u,Zt(mn,(e=>n(Un(e))))),e])},ca=()=>{},la=f(ca);document.querySelector("body").append((()=>{gt("login",(e=>e&&la(ca))),gt("logout",(()=>la(ca))),gt("nochan",(()=>la(ca)));return yt([yt("div",{class:"n"},yt("div",null,yt("ol",{class:"bc"},(()=>Zt(on.paths,(e=>yt("li",null,yt("a",{onclick:t=>(e=>{la()!==Hn?e[0]===on.len()-1?la(Hn):on.cd(e):on.same(e)&&la(ca),on.setpath(e),la()===Hn&&Pn(e[3])})(e)},e[2])))))),yt("div",{class:"m"},yt("a",{onclick:e=>{la()===Yn?la(ca):la(Yn)}},(()=>Lt.name()||"login")))),yt(g(la),null)),sa])})())}();</script></body></html>