!function(){"use strict";let e,t=[];function n(n){function r(t){if(0===arguments.length)return e&&!r.__o.has(e)&&(r.__o.add(e),e.u.push(r)),n;n=t;let a=e;return e=void 0,r.o=new Set(r.__o),r.o.forEach((e=>e.i=!1)),r.o.forEach((e=>{e.i||e()})),e=a,n}return r.$o=1,r.__o=new Set,r.t=t,r}function r(e){e.__c.forEach(r),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),a(e)}function a(e){e.u=[],e.__c=[],e.l=[]}let i=(e,t,n,r)=>{let a={};for(let o=1;o<t.length;o++){let u=t[o],s="number"==typeof u?n[u]:u,l=t[++o];if(1===l)r[0]=s;else if(3===l)r[1]=Object.assign(r[1]||{},s);else if(5===l)(r[1]=r[1]||{})[t[++o]]=s;else if(6===l){let e=t[++o],n=(r[1]=r[1]||{})[e],i=a[e];i||"function"!=typeof s&&"function"!=typeof n||(i=n&&[n]||[],r[1][e]=function(){let e="";for(var t=0;t<i.length;t++)e+="function"==typeof i[t]?i[t].call(this):i[t];return e}),i?i.push(s):r[1][e]+=s+""}else if(l){let t=()=>e.apply(null,i(e,s,n,["",null]));r.push("function"==typeof r[0]?t:t())}else r.push(s)}return r},o=function(e){let t,n,r=1,a="",i="",o=[0],u=e=>{1===r&&(e||(a=a.replace(/^\s*\n\s*|\s*\n\s*$/g,"")))?o.push(e||a,0):3===r&&(e||a)?(o.push(e||a,1),r=2):2===r&&"..."===a&&e?o.push(e,3):2===r&&a&&!e?o.push(!0,5,a):r>=5&&((a||!e&&5===r)&&(o.push(a,r,n),r=6),e&&(o.push(e,r,n),r=6)),a=""};for(let s=0;s<e.length;s++){s&&(1===r&&u(),u(s));for(let l=0;l<e[s].length;l++)t=e[s][l],1===r?"<"===t?(u(),o=[o],r=3):a+=t:4===r?"--"===a&&">"===t?(r=1,a=""):a=t+a[0]:i?t===i?i="":a+=t:'"'===t||"'"===t?i=t:">"===t?(u(),r=1):r&&("="===t?(r=5,n=a,a=""):"/"===t&&(r<5||">"===e[s][l+1])?(u(),3===r&&(o=o[0]),r=o,(o=o[0]).push(r,2),r=0):" "===t||"\t"===t||"\n"===t||"\r"===t?(u(),r=2):a+=t),3===r&&"!--"===a&&(r=4,o=o[0])}return u(),o},u=new Map,s=function(e){let t=u.get(this);return t||(t=new Map,u.set(this,t)),t=i(this,t.get(e)||(t.set(e,t=o(e)),t),arguments,[]),t.length>1?t:t[0]},l=function(){let e=s.apply(this,arguments);if(e)return Array.isArray(e)?this(e):"object"==typeof e?e:this([e])};function c(){let e=l.bind(this);return(this.wrap||e).apply(e,arguments)}let d={},f=[];function h(e){return this.t&&this.t[e.type](e)}d.h=(...e)=>{let t,n=r=>{if(null==r);else if("string"==typeof r)t?d.add(t,r):t=d.s?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);else if(Array.isArray(r))t||(t=document.createDocumentFragment()),r.forEach(n);else if(r instanceof Node)t?d.add(t,r):t=r;else if("object"==typeof r)d.property(t,r,null,d.s);else if("function"==typeof r)if(t){let e=d.add(t,"");d.insert(t,r,e)}else t=r.apply(null,e.splice(1));else d.add(t,""+r)};return e.forEach(n),t},d.insert=(e,t,n,r,a)=>(e=n&&n.parentNode||e,a=a||r instanceof Node&&r,t===r||(r&&"string"!=typeof r||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?d.subscribe((()=>{r=d.insert(e,t.call({el:e,endMark:n}),n,r,a)})):(n?r&&(a||(a=r.o&&r.o.nextSibling||n.previousSibling),d.rm(e,a,n)):e.textContent="",r=null,t&&!0!==t&&(r=d.add(e,t,n))):(null!=r&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?d.add(e,t,n):e.textContent=t,r=t)),r),d.property=(e,t,n,r,a)=>{if(null!=t)if(!n||"attrs"===n&&(r=!0))for(n in t)d.property(e,t[n],n,r,a);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?d.subscribe((()=>{d.property(e,t.call({el:e,name:n}),n,r,a)})):a?e.style.setProperty(n,t):r||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:d.property(e,t,null,r,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,h):e.removeEventListener(t,h),(e.t||(e.t={}))[t]=n})(e,n,t)},d.add=(e,t,n)=>{let r=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:d.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:d.h(f,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),r},d.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},d.subscribe=function(t){return function(t,n){function i(){let a=e;return e&&e.__c.push(i),r(i),i.i=!0,e=i,n=t(n),e=a,n}function o(){return i.i?e&&i.u.forEach((e=>e())):n=i(),n}t.s=i,a(i),i(),o.$o=1}(t),()=>r(t.s)},d.cleanup=function(t){return e&&e.l.push(t),t},d.root=function(t){let n=e,i=()=>{};e=i,a(i);let o=t((()=>{r(i),e=void 0}));return e=n,o},d.sample=function(t){let n=e;e=void 0;let r=t();return e=n,r},d.hs=(...e)=>{let t=d.s;d.s=!0;let n=p(...e);return d.s=t,n};let p=(...e)=>d.h.apply(d.h,e),m=(...e)=>c.apply(p,e);var v={};function y(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(v,"__esModule",{value:!0});var g=function(){function e(e,t){void 0===e&&(e=0);var n=null==t?void 0:t.grow;this.grow=n&&isFinite(n)&&y(n)||n||0,this.buffer="number"==typeof e?new Uint8Array(y(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var r=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(r<=this.grow){var a=new Uint8Array(r);a.set(this.buffer),this.buffer=a}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var r=t,a=r>>3,i=128>>r%8,o=this.buffer[a];r<n;r++)e(!!(o&i),r),i=1===i?(o=this.buffer[++a],128):i>>1},e}(),w=v.default=g;function b(e,t,n=!1){var r;return(...a)=>{clearTimeout(r),n&&!r&&e.apply(this,a),r=setTimeout((()=>{r=null,n||e.apply(this,a)}),t)}}function k(){document.execCommand("selectAll",!1,null),document.getSelection().collapseToEnd()}function C(){return document.getSelection().focusOffset}const S=e=>document.getElementById(e);const E=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)||e.set(t.id,t),e)),t),x=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)?"online"in t&&e.get(t.id).online(t.online):e.set(t.id,{...t,online:n(t.online)}),delete t.online,e)),t),_=(e,t)=>e.reduce(((e,t)=>{if(e.has(t.id)){let n=e.get(t.id);n.fullname(t.fullname),n.about(t.about),n.md(t.md)}else e.set(t.id,{...t,fullname:n(t.fullname),about:n(t.about),md:n(t.md)});return e}),t);function A(){window.scrollTo(0,document.documentElement.scrollHeight)}const T=(e,t)=>{let n=0,r=0;for(;n<e.length;)r>=t.length&&(r=0),e.set([e[n]^t[r]],n),n++,r++},U=(e,t)=>N(D(e,t),64,24),M=e=>{let{a:t}=L(e);return L(t)},D=(e,t)=>(T(e,t),O(e,t)),L=e=>{let{a:t,k:n}=P(e);return T(t,n),{a:t,k:n}},P=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},O=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},j=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),I=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},N=(e,t=64,n=8)=>D(e,crypto.getRandomValues(new Uint8Array(j(n,t)))),K=e=>(e=>"hsl("+e%360+",100%,30%)")((e=>{var t=0;if(0==e.length)return t;for(var n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t),t&=t;return t})(e+"#"));function F(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&e.length<70}function z(e){return e.length<2||e.length>30?10:/^[0-9a-z_]+$/.test(e)?0:10}function R(){return window.scrollY+window.innerHeight===document.documentElement.scrollHeight}function B(){let e=Intl.DateTimeFormat().resolvedOptions().timeZone;return e&&e.length>0?e:null}function q(e){if(!/^[a-z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1}function H(e){if(!/^[a-z0-9\_]+$/.test(e.key))return e.preventDefault(),!1}function $(e){e.target.value=e.target.value.toLowerCase().replace(/\s/g,"")}function V(e,t=null){return e.length<6?12:t&&e==t?14:void 0}function W(e,t){return!!t&&(e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate())}const Y=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},G=Y(),X="s",Z=["_t","_p","_e","_h","_r","_c","_s","_u","_n","_d","_m"];let J,Q=indexedDB.open(X,1);function ee(e){var t=window.indexedDB.deleteDatabase(e);t.onerror=e=>{},t.onsuccess=e=>{}}Q.onsuccess=e=>{J=Q.result,function(e){let t=e.objectStoreNames;if(t.length!==Z.length)return void ee(X);for(const e of Z)if(!t.contains(e))return void ee(X)}(J),G.complete(J),Q.open?Q.open():Q.open=!0},Q.onerror=e=>{ee(X),location.reload()},Q.onblocked=e=>{},Q.onupgradeneeded=e=>{J=Q.result;let t=J.objectStoreNames;if(t.contains("_s")||J.createObjectStore("_s"),t.contains("_r")||J.createObjectStore("_r"),t.contains("_e")||J.createObjectStore("_e",{keyPath:"id"}),!t.contains("_t")){let e=J.createObjectStore("_t",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1})}if(!t.contains("_p")){J.createObjectStore("_p",{keyPath:"id",autoIncrement:!0}).createIndex("room",["room","id"],{unique:!1})}if(!t.contains("_h")){let e=J.createObjectStore("_h",{keyPath:"id"});e.createIndex("mom",["mom","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1}),e.createIndex("chatid","chatid",{unique:!1})}t.contains("_c")||J.createObjectStore("_c",{keyPath:["chanid","chatid"]}),t.contains("_u")||J.createObjectStore("_u"),t.contains("_n")||J.createObjectStore("_n"),t.contains("_d")||J.createObjectStore("_d"),t.contains("_m")||J.createObjectStore("_m");for(const e of Z)J.objectStoreNames.contains(e)||J.createObjectStore(e)};const te=async(e,t)=>{let n=await G.join();n&&n.transaction(["_s"],"readwrite").objectStore("_s").put(t,e)},ne=async()=>{let e=await G.join();e&&Z.forEach((t=>e.transaction([t],"readwrite").objectStore(t).clear()))},re=async(e,t)=>{let n=await G.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>{"string"==typeof e.timestamp&&(e.timestamp=new Date(e.timestamp)),r.put(e).onerror=console.error}))},ae=async(...e)=>{let t=await G.join();t&&(await he(...e),function(e){let n=t.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);n.delete(t).onerror=console.error}))}(e),function(e){let n=t.transaction(["_t"],"readwrite").objectStore("_t"),r=n.index("chanid");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);r.openCursor(t).onsuccess=e=>{var t=e.target.result;t&&(n.delete(t.primaryKey).onerror=console.error,t.continue())}}))}(e.filter((e=>e>0))))},ie=async(e,t)=>{let n=await G.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);return new Promise((e=>{let n=r.put(t);n.onsuccess=t=>{e(t.target.result)},n.onerror=console.error}))},oe=async(e,t)=>{let n=await G.join();if(!n)return{value:[],missed:t};if(0===t.length)return{value:[],missed:[]};performance.now();let r=[],a=new Set,i=n.transaction([e],"readonly").objectStore(e),o=0;return new Promise((e=>{t.forEach((n=>{let u=i.get(n);u.onerror=console.error,u.onsuccess=i=>{if(u.result?r.push(u.result):a.add(n),++o===t.length){let t={value:r,missed:Array.from(a)};e(t)}}}))}))},ue=async(e,t,n,r,a,i,o="prev")=>{let u=await G.join();if(!u)return;performance.now();let s=[],l=u.transaction([e],"readonly"),[c,d]=t?t(l.objectStore(e),n,a,i):[l.objectStore(e),null],f=0;return new Promise((e=>{c.openCursor(d,o).onsuccess=t=>{var n=t.target.result;if(n){if(s.push(n.value),r&&++f===r)return e(s);n.continue()}else e(s)}}))},se=(e,t,n,r)=>{let a=n?IDBKeyRange.upperBound(n,r):null;if(!t)return[e,a];let i=n||Number.MAX_VALUE;return e=e.index("room"),a=IDBKeyRange.bound([t.value],[t.value,i],!1,r),[e,a]},le=(e,t,n,r)=>{let a=n?IDBKeyRange.upperBound(n,r):null;if(!t)return[e,a];let i=n||Number.MAX_VALUE;return a=IDBKeyRange.bound([t.value],[t.value,i],!1,r),[e,a]},ce=async(e,t,n=30,r=!0)=>{let a={value:e};return(await ue("_c",le,a,n,t,r,"prev")).map((e=>e.chatid))},de=async(e,t,n)=>{let r=await G.join();if(!r)return;let a=r.transaction(["_r"],"readwrite").objectStore("_r"),i=a.get(e);i.onerror=console.error,i.onsuccess=async r=>{if(i.result){if(n)return a.put([i.result[0],i.result[1],n],e).onerror=console.error;t[0]<i.result[0]&&(t[0]=i.result[0]),t[1]>i.result[0]&&(t[1]=i.result[1])}a.put(t,e).onerror=console.error}},fe=e=>me(e,"_r"),he=async(...e)=>ye("_r",...e),pe=e=>me(e,"_s"),me=async(e,t)=>{let n=await G.join();if(!n)return;let r=n.transaction([t],"readonly").objectStore(t);return new Promise((t=>{let n=r.get(e);n.onerror=console.error,n.onsuccess=e=>t(n.result)}))},ve=async(e,t,n)=>{let r=await G.join();r&&r.transaction([e],"readwrite").objectStore(e).put(n,t)},ye=async(e,...t)=>{let n=await G.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>r.delete(e).onerror=console.error))},ge=(e,t)=>crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:t},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),we=e=>crypto.subtle.importKey("raw",e,{name:"ECDH",namedCurve:"P-256"},!0,[]),be=async()=>await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"]),ke=async(e,t,n)=>await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),Ce=async(e,t,n)=>await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e);function Se(e,t,n,r){return new(n||(n=Promise))((function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,u)}s((r=r.apply(e,t||[])).next())}))}function Ee(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}function xe(e,t){for(var n=0,r=t.length,a=e.length;n<r;n++,a++)e[a]=t[n];return e}const _e=new Map,Ae=(e,t,n=!1)=>{let r=_e.get(e)||[];n?r=[t]:r.push(t),_e.set(e,r)},Te=(e,t)=>_e.has(e)?_e.get(e).forEach((e=>e(t))):void 0;var Ue,Me,De={},Le=function(e){return e&&(Object.assign(De,e),Te("config",De)),De},Pe=n(void 0),Oe={id:n(0),name:n(null),chans:n([])};function je(){return Se(this,void 0,void 0,(function(){var e,t,n,r,a,i,o,u,s,l;return Ee(this,(function(c){switch(c.label){case 0:return[4,pe("a")];case 1:return!(e=c.sent())||e.byteLength<54?[2]:(t=new Uint8Array(e,0,16),n=new Uint8Array(e,16,32),16===t.length&&(Oe.salt=t),32!==n.length?[3,3]:(r=Oe,[4,crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"])]));case 2:r.sskey=c.sent(),c.label=3;case 3:return a=new Uint8Array(e,48,4),i=new Uint8Array(e,52),o=new DataView(a.buffer).getInt32(48,!1),u=(new TextDecoder).decode(i),o&&u&&(Oe.id(o),Oe.name(u)),[4,pe("c")];case 4:return(s=c.sent())&&s instanceof Array&&Oe.chans(s),console.log("[au]",Oe),(l=new Uint8Array(20)).set(t),l.set(a,16),setTimeout(A),[2,l]}}))}))}function Ie(e,t){return Se(this,void 0,void 0,(function(){var n,r;return Ee(this,(function(a){switch(a.label){case 0:return[4,Ke((n=new TextEncoder).encode(e),n.encode(t))];case 1:return r=a.sent(),[4,crypto.subtle.exportKey("raw",r)];case 2:return[2,a.sent()]}}))}))}function Ne(e,t){return Se(this,void 0,void 0,(function(){return Ee(this,(function(n){switch(n.label){case 0:return[4,Ke((new TextEncoder).encode(e),t)];case 1:return[2,n.sent()]}}))}))}function Ke(e,t){return Se(this,void 0,void 0,(function(){var n;return Ee(this,(function(r){switch(r.label){case 0:return[4,crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"])];case 1:return n=r.sent(),[2,crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])]}}))}))}function Fe(e){return Se(this,void 0,void 0,(function(){var t,n,r,a,i,o,u,s,l,c;return Ee(this,(function(d){switch(d.label){case 0:return t=new Uint8Array(e.slice(16,20)),n=new Uint8Array(e.slice(20)),r=new DataView(t.buffer).getInt32(0,!1),a=(new TextDecoder).decode(n),Oe.id(r),Oe.name(a),Oe.salt=new Uint8Array(e.slice(0,16)),i=Oe,[4,Ke(Pe(),Oe.salt)];case 1:return i.sskey=d.sent(),Pe(void 0),u=Uint8Array.bind,[4,crypto.subtle.exportKey("raw",Oe.sskey)];case 2:return o=new(u.apply(Uint8Array,[void 0,d.sent()])),s=Oe.salt.length,(l=new Uint8Array(s+o.length+t.length+n.length)).set(Oe.salt),l.set(o,s),l.set(t,s+o.length),l.set(n,s+o.length+t.length),te("a",l.buffer),c=B(),[2,{id:r,name:a,tz:c}]}}))}))}!function(e){e.Shin=function(e){return{tag:"Shin",value:e}},e.Shan=function(e){return{tag:"Shan",value:e}},e.Tree=function(e){return{tag:"Tree",value:e}},e.NewChat=function(e){return{tag:"NewChat",value:e}},e.NewUser=function(e){return{tag:"NewUser",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.Logout=function(e){return{tag:"Logout",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.MuteChan=function(e){return{tag:"MuteChan",value:e}},e.UnmuteChan=function(e){return{tag:"UnmuteChan",value:e}},e.AddMems=function(e){return{tag:"AddMems",value:e}},e.DelChat=function(e){return{tag:"DelChat",value:e}},e.DelChan=function(e){return{tag:"DelChan",value:e}},e.EditChat=function(e){return{tag:"EditChat",value:e}},e.EditChan=function(e){return{tag:"EditChan",value:e}},e.Mems=function(e){return{tag:"Mems",value:e}},e.FindUsers=function(e){return{tag:"FindUsers",value:e}},e.FindMems=function(e){return{tag:"FindMems",value:e}},e.PushSubs=function(e){return{tag:"PushSubs",value:e}},e.Ons=function(e){return{tag:"Ons",value:e}},e.Unpack=function(e){return{tag:"Unpack",value:e}},e.Tz=function(e){return{tag:"Tz",value:e}},e.Profile={tag:"Profile"},e.EditProfile=function(e){return{tag:"EditProfile",value:e}},e.Pwd=function(e){return{tag:"Pwd",value:e}},e.Email=function(e){return{tag:"Email",value:e}},e.Au=function(e){return{tag:"Au",value:e}},e.Signup=function(e){return{tag:"Signup",value:e}},e.Fp=function(e){return{tag:"Fp",value:e}},e.EditStatus=function(e){return{tag:"EditStatus",value:e}},e.Status=function(e){return{tag:"Status",value:e}},e.ChatThread=function(e){return{tag:"ChatThread",value:e}},e.ChatList=function(e){return{tag:"ChatList",value:e}},e.Star=function(e){return{tag:"Star",value:e}},e.Sdp=function(e){return{tag:"Sdp",value:e}}}(Ue||(Ue={})),function(e){e.Shin=function(e){return{tag:"Shin",value:e}},e.Shan=function(e){return{tag:"Shan",value:e}},e.Tree=function(e){return{tag:"Tree",value:e}},e.Treeid=function(e){return{tag:"Treeid",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chat=function(e){return{tag:"Chat",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.MuteChan=function(e){return{tag:"MuteChan",value:e}},e.UnmuteChan=function(e){return{tag:"UnmuteChan",value:e}},e.DelChan=function(e){return{tag:"DelChan",value:e}},e.Update=function(e){return{tag:"Update",value:e}},e.Updates=function(e){return{tag:"Updates",value:e}},e.ChanUpdates=function(e){return{tag:"ChanUpdates",value:e}},e.MemUpdates=function(e){return{tag:"MemUpdates",value:e}},e.On=function(e){return{tag:"On",value:e}},e.Ons=function(e){return{tag:"Ons",value:e}},e.Mems=function(e){return{tag:"Mems",value:e}},e.Err=function(e){return{tag:"Err",value:e}},e.NewChan=function(e){return{tag:"NewChan",value:e}},e.FindUsers=function(e){return{tag:"FindUsers",value:e}},e.FindMems=function(e){return{tag:"FindMems",value:e}},e.Logout=function(e){return{tag:"Logout",value:e}},e.AddMems=function(e){return{tag:"AddMems",value:e}},e.Unpack=function(e){return{tag:"Unpack",value:e}},e.Profile=function(e){return{tag:"Profile",value:e}},e.Pwd=function(e){return{tag:"Pwd",value:e}},e.Name=function(e){return{tag:"Name",value:e}},e.Signup=function(e){return{tag:"Signup",value:e}},e.Typing=function(e){return{tag:"Typing",value:e}},e.Status=function(e){return{tag:"Status",value:e}},e.ChatThread=function(e){return{tag:"ChatThread",value:e}},e.ChatList=function(e){return{tag:"ChatList",value:e}},e.Sdp=function(e){return{tag:"Sdp",value:e}}}(Me||(Me={}));const ze=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),Re=(e,t)=>{const{view:{buffer:n},pos:r}=e,a=n.byteLength;if(a-r>t)return e;const i=Math.max(2*a,a+t),o=new Uint8Array(i);return o.set(new Uint8Array(n)),ze(o.buffer,r,e.littleEndian)},Be=(e,t)=>{e=Re(e,1);const{view:n,pos:r}=e;return n.setUint8(r,t),e.pos+=1,e},qe=(e,t)=>{e=Re(e,4);const{view:n,pos:r,littleEndian:a}=e;return n.setUint32(r,t,a),e.pos+=4,e},He=(e,t)=>{e=Re(e,2);const{view:n,pos:r,littleEndian:a}=e;return n.setUint16(r,t,a),e.pos+=2,e};function $e(e,t){const{view:n,pos:r,littleEndian:a}=e;return n.setUint32(a?r:r+4,t,a),n.setUint32(a?r+4:r,0,a),e.pos+=8,e}const Ve=(e,t)=>{e=Re(e,4);const{view:n,pos:r,littleEndian:a}=e;return n.setInt32(r,t,a),e.pos+=4,e},We=new TextEncoder,Ye="encodeInto"in We?(e,t)=>We.encodeInto(e,t).written:(e,t)=>{const n=We.encode(e);return t.set(n),n.length},Ge=(e,t)=>{e=Re(e,3*t.length+8);const n=Ye(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=$e(e,n)).pos+=n,e},Xe=(e,t)=>Be(e,t?1:0),Ze=e=>(t,n)=>n.reduce(e,((e,t)=>$e(Re(e,8),t))(t,n.length)),Je=e=>(t,n)=>null===n?Be(t,0):e(Be(t,1),n),Qe=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},et=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=2,n.getUint16(t,r)},tt=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getUint32(t,r)},nt=e=>{const{view:t,pos:n,littleEndian:r}=e;return e.pos+=8,t.getUint32(r?n:n+4,r)},rt=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getInt32(t,r)},at=e=>1===Qe(e),it=e=>t=>1===Qe(t)?e(t):null,ot=e=>t=>{const n=nt(t),r=new Array;for(let a=0;a<n;a++)r.push(e(t));return r},ut=new TextDecoder,st=e=>{const t=nt(e),{pos:n,view:{buffer:r}}=e,a=ut.decode(new Uint8Array(r,n,t));return e.pos+=t,a};var lt=Ze(Ve),ct=Je(Ge),dt=Je(lt),ft=Je(Ve),ht=Je(Xe),pt=Je((function(e,t){var n=t.id,r=t.lo;return Ve(Ve(e,n),r)})),mt=Ze(Ge),vt=Je(mt),yt=Ze(Be),gt=Je(((e,t)=>{e=Re(e,8);const{view:n,pos:r,littleEndian:a}=e;return n.setFloat64(r,t,a),e.pos+=8,e})),wt=Je(yt),bt=Je(He),kt=function(e,t){var n=t.id,r=t.txt,a=t.by,i=t.chanid,o=t.dir,u=t.timestamp,s=t.men,l=t.re,c=t.nor,d=t.star;return ht(ft(ft(dt(Ge(lt(Ve(Ve(Ge(Ve(e,n),r),a),i),o),u),s),l),c),d)},Ct=(Ze(kt),Ze((function(e,t){var n=t.id,r=t.fullname,a=t.mom,i=t.by,o=t.dir,u=t.md,s=t.timestamp,l=t.chatid,c=t.about,d=t.to,f=t.re;return ft(dt(ct(Ve(Ge(He(lt(Ve(Ve(Ge(Ve(e,n),r),a),i),o),u),s),l),c),d),f)})),function(e,t){var n=t.id,r=t.name,a=t.online;return Xe(Ge(Ve(e,n),r),a)}),St=Ze(Ct),Et=(Je((function(e,t){var n=t.data,r=t.chans;return lt(yt(e,n),r)})),function(e,t){var n=t.id,r=t.action,a=t.chatid,i=t.txt;return ct(Ve(He(Ve(e,n),r),a),i)}),xt=(Ze(Et),Ze((function(e,t){var n=t.id,r=t.action,a=t.chanid,i=t.name,o=t.about,u=t.md;return bt(ct(ct(Ve(He(Ve(e,n),r),a),i),o),u)})),Ze((function(e,t){var n=t.id,r=t.action,a=t.chanid,i=t.by;return Ve(Ve(He(Ve(e,n),r),a),i)})),Ze((function(e,t){var n=t.chanid,r=t.users;return St(Ve(e,n),r)})),function(e,t){var n=t.email,r=t.fullname,a=t.about;return ct(ct(ct(e,n),r),a)}),_t=function(e,t){var n=t.i,r=t.ub,a=t.lb,i=t.kw;return ct(ft(ft(Ve(e,n),r),a),i)},At=function(e,t){var n=t.fr,r=t.to,a=t.offer,i=t.sd,o=t.ca;return mt(yt(ht(ft(ft(e,n),r),a),i),o)},Tt=function(e,t){var n=t.txt;return Ge(e,n)},Ut=function(e,t){var n=t.st,r=t.tz;return ct(ct(e,n),r)},Mt=function(e,t){switch(t.tag){case"Shin":return function(e,t){var n=t.chanid,r=t.kw,a=t.lu,i=t.cu,o=t.mu,u=t.ub,s=t.lb;return ft(ft(ft(ft(pt(ct(ft(e,n),r),a),i),o),u),s)}(qe(e,0),t.value);case"Shan":return function(e,t){var n=t.chanid,r=t.kw,a=t.cu,i=t.mu,o=t.ub,u=t.lb;return ft(ft(ft(ft(ct(Ve(e,n),r),a),i),o),u)}(qe(e,1),t.value);case"Tree":return function(e,t){var n=t.kw,r=t.reload;return ht(ct(e,n),r)}(qe(e,2),t.value);case"NewChat":return function(e,t){var n=t.txt,r=t.chanid,a=t.re,i=t.chname,o=t.men,u=t.to,s=t.emails;return vt(dt(dt(ct(ft(Ve(Ge(e,n),r),a),i),o),u),s)}(qe(e,3),t.value);case"NewUser":return function(e,t){var n=t.name,r=t.key,a=t.tz,i=t.tgid,o=t.tgname,u=t.tgfn,s=t.tgln;return ct(ct(ct(gt(ct(yt(Ge(e,n),r),a),i),o),u),s)}(qe(e,4),t.value);case"Login":return function(e,t){var n=t.name,r=t.key,a=t.tz;return ct(yt(Ge(e,n),r),a)}(qe(e,5),t.value);case"Logout":return yt(qe(e,6),t.value);case"Users":return lt(qe(e,7),t.value);case"Chans":return lt(qe(e,8),t.value);case"Chats":return lt(qe(e,9),t.value);case"MuteChan":return Ve(qe(e,10),t.value);case"UnmuteChan":return Ve(qe(e,11),t.value);case"AddMems":return function(e,t){var n=t.chanid,r=t.userids,a=t.emails;return vt(dt(Ve(e,n),r),a)}(qe(e,12),t.value);case"DelChat":return Ve(qe(e,13),t.value);case"DelChan":return Ve(qe(e,14),t.value);case"EditChat":return function(e,t){var n=t.id,r=t.txt;return Ge(Ve(e,n),r)}(qe(e,15),t.value);case"EditChan":return function(e,t){var n=t.id,r=t.name,a=t.about,i=t.md;return bt(ct(ct(Ve(e,n),r),a),i)}(qe(e,16),t.value);case"Mems":return lt(qe(e,17),t.value);case"FindUsers":return Ge(qe(e,18),t.value);case"FindMems":return function(e,t){var n=t.chanid,r=t.kw;return Ge(Ve(e,n),r)}(qe(e,19),t.value);case"PushSubs":return function(e,t){var n=t.endpoint,r=t.auth,a=t.p256dh;return Ge(Ge(Ge(e,n),r),a)}(qe(e,20),t.value);case"Ons":return lt(qe(e,21),t.value);case"Unpack":return Ge(qe(e,22),t.value);case"Tz":return Ge(qe(e,23),t.value);case"Profile":return qe(e,24);case"EditProfile":return xt(qe(e,25),t.value);case"Pwd":return function(e,t){var n=t.key,r=t.okey;return wt(yt(e,n),r)}(qe(e,26),t.value);case"Email":return Ge(qe(e,27),t.value);case"Au":return Ge(qe(e,28),t.value);case"Signup":return Ge(qe(e,29),t.value);case"Fp":return Ge(qe(e,30),t.value);case"EditStatus":return Ut(qe(e,31),t.value);case"Status":return Ve(qe(e,32),t.value);case"ChatThread":return _t(qe(e,33),t.value);case"ChatList":return _t(qe(e,34),t.value);case"Star":return Ve(qe(e,35),t.value);case"Sdp":return At(qe(e,36),t.value)}},Dt=ot(rt),Lt=it(st),Pt=it(Dt),Ot=it(rt),jt=it(at),It=(it((function(e){return{id:rt(e),lo:rt(e)}})),ot(st)),Nt=(it(It),ot(Qe)),Kt=(it((e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=8,n.getFloat64(t,r)})),it(Nt)),Ft=it(et),zt=function(e){return{id:rt(e),txt:st(e),by:rt(e),chanid:rt(e),dir:Dt(e),timestamp:st(e),men:Pt(e),re:Ot(e),nor:Ot(e),star:jt(e)}},Rt=ot(zt),Bt=ot((function(e){return{id:rt(e),fullname:st(e),mom:rt(e),by:rt(e),dir:Dt(e),md:et(e),timestamp:st(e),chatid:rt(e),about:Lt(e),to:Pt(e),re:Ot(e)}})),qt=function(e){return{id:rt(e),name:st(e),online:at(e)}},Ht=ot(qt),$t=it((function(e){return{data:Nt(e),chans:Dt(e)}})),Vt=function(e){return{id:rt(e),action:et(e),chatid:rt(e),txt:Lt(e)}},Wt=ot(Vt),Yt=ot((function(e){return{id:rt(e),action:et(e),chanid:rt(e),name:Lt(e),about:Lt(e),md:Ft(e)}})),Gt=ot((function(e){return{id:rt(e),action:et(e),chanid:rt(e),by:rt(e)}})),Xt=ot((function(e){return{chanid:rt(e),users:Ht(e)}})),Zt=function(e){return{email:Lt(e),fullname:Lt(e),about:Lt(e)}},Jt=function(e){return{fr:Ot(e),to:Ot(e),offer:jt(e),sd:Nt(e),ca:It(e)}},Qt=function(e){return{txt:st(e)}},en=function(e){return{st:Lt(e),tz:Lt(e)}},tn=function(e){switch(tt(e)){case 0:return Me.Shin(function(e){return{chats:Rt(e),chans:Bt(e),users:Ht(e)}}(e));case 1:return Me.Shan(Dt(e));case 2:return Me.Tree(Bt(e));case 3:return Me.Treeid(Dt(e));case 4:return Me.Chats(Rt(e));case 5:return Me.Chans(Bt(e));case 6:return Me.Users(Ht(e));case 7:return Me.Chat(zt(e));case 8:return Me.Login($t(e));case 9:return Me.MuteChan(Ot(e));case 10:return Me.UnmuteChan(Ot(e));case 11:return Me.DelChan(rt(e));case 12:return Me.Update(Vt(e));case 13:return Me.Updates(Wt(e));case 14:return Me.ChanUpdates(Yt(e));case 15:return Me.MemUpdates(Gt(e));case 16:return Me.On(qt(e));case 17:return Me.Ons(Dt(e));case 18:return Me.Mems(Xt(e));case 19:return Me.Err(et(e));case 20:return Me.NewChan(rt(e));case 21:return Me.FindUsers(Ht(e));case 22:return Me.FindMems(Ht(e));case 23:return Me.Logout(at(e));case 24:return Me.AddMems(at(e));case 25:return Me.Unpack(Lt(e));case 26:return Me.Profile(Zt(e));case 27:return Me.Pwd(Kt(e));case 28:return Me.Name(Lt(e));case 29:return Me.Signup(et(e));case 30:return Me.Typing(function(e){return{by:Ot(e),dir:Dt(e),key:Lt(e),keyCode:Ft(e),anchor:et(e),focus:et(e),txt:Lt(e),chname:Lt(e),re:Ot(e)}}(e));case 31:return Me.Status(en(e));case 32:return Me.ChatThread(Dt(e));case 33:return Me.ChatList(Dt(e));case 34:return Me.Sdp(Jt(e))}throw new Error("bad variant index for Response")},nn=ze(new ArrayBuffer(512)),rn=function(e,t){return nn.pos=0,nn=t(nn,e),new Uint8Array(nn.view.buffer).slice(0,nn.pos)},an=function(e,t){return t(ze(e))},on=function(e){return an(e.buffer,tn)},un=function(e){return rn(e,Mt)},sn=function(e){return rn(e,Tt)},ln=function(e){return an(e.buffer,Qt)};const cn=e=>new Zlib.RawInflate(e).decompress(),dn=e=>new Zlib.RawDeflate(e).compress();async function fn(e,t){let n=new Uint8Array(e),r=n.length,{z:a,c:i,d:o}=Le();if(o){let e=n.subarray(0,12);n=new Uint8Array(await Ce(n.subarray(12),Oe.sskey,e)),T(n,e)}if(i){let e=n.subarray(0,12);n=new Uint8Array(await Ce(n.subarray(12),t,e)),T(n,e)}return a&&(n=cn(n)),(100*r/n.length).toFixed(2),function(e){return on(e)}(n)}const hn=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),pn=hn?hn.groups.ip:"mx.hyze.io:9898",mn=Y();let vn,yn,gn,wn=!1,bn=500,kn=0,Cn=()=>{},Sn={recv:e=>Cn=e,send:async function(e){await mn.join(),vn.send(await async function(e,t){((e,t)=>{e.length||e.byteLength})(e=un(e));let{z:n,c:r,d:a}=Le();if(n&&(e=dn(e)),r){const n=crypto.getRandomValues(new Uint8Array(12));T(e,n),e=I(n,new Uint8Array(await ke(e,t,n)))}if(a){const t=crypto.getRandomValues(new Uint8Array(12));T(e,t),e=I(t,new Uint8Array(await ke(e,Oe.sskey,t)))}return performance.now(),e}(e,gn))}};function En(){wn=!0,kn++,bn+=j(0,kn<16?200:3e3),setTimeout(xn,bn)}async function xn(){const e=await async function(){const e=async()=>{yn=await be();let e=await crypto.subtle.exportKey("raw",yn.publicKey);return new Uint8Array(e)};return await(async(e,t)=>{let[n,r]=await Promise.all([e(),t()]);return r?D(n,r):N(n,64,24)})(e,je)}();performance.now(),vn=new WebSocket("wss://"+pn),vn.binaryType="arraybuffer",vn.onopen=async()=>{vn.send(e)},vn.onmessage=_n,vn.onerror=console.error,vn.onclose=En}async function _n({data:e}){let t=new Uint8Array(e);Le((e=>{const t=new w(e);return{z:t.get(0),c:t.get(1),d:t.get(2)}})(t));let n=await we(t.slice(1));gn=await ge(yn.privateKey,n),vn.onmessage=An,mn.complete(),wn&&Te("reconnected"),wn=!1}async function An({data:e}){Cn(await fn(e,gn))}xn();function Tn(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),r=new Uint8Array(n.length);for(let e=0;e<n.length;++e)r[e]=n.charCodeAt(e);return r}async function Un(){let e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(t){let e=JSON.parse(JSON.stringify(t)),n=await pe("s");if(n instanceof ArrayBuffer&&(new TextDecoder).decode(n)==e.keys.auth)return;te("s",(new TextEncoder).encode(e.keys.auth).buffer),Te("subs",e)}else navigator.serviceWorker.getRegistration().then((e=>{e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Tn("BIm2PpzmeMy3pe_VkzyP8Yq-iqG8ay0qLBGcJZNXnq5lOKu1fAyY9xQ2PK2KQjzWulmKu8IzBLmut276h4tIw5k")}).then((e=>{}),(e=>{}))}))}function Mn(e,t,n){const{root:r,subscribe:a,sample:i,cleanup:o}=d;null==n&&(n=!t.$t);let u=d.h([]),s=d.add(u,""),l=new Map,c=new Map,f=new Set;function h(e,a){if(null==e)return;let i=c.get(e);return 1===a?(f.delete(e),i||(i=n?r((n=>(l.set(e,n),t(e.$v||e)))):t(e.$v||e),11===i.nodeType&&(i=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let r=Array.from(t);return{nodeType:111,t:r[0],o:r[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(r[t++])}return e}}})(i)||i),c.set(e,i))):-1===a&&f.add(e),((e,t)=>111===e.nodeType?1/t<0?t?d.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(i,a)}function p(e){let t=l.get(e);t&&(t(),l.delete(e)),c.delete(e)}return o(a((t=>{let n=e();return i((()=>{f.clear();let e=Array.from(function(e,t,n,r,a){let i,o,u=new Map,s=new Map;for(i=0;i<t.length;i++)u.set(t[i],i);for(i=0;i<n.length;i++)s.set(n[i],i);for(i=o=0;i!==t.length||o!==n.length;){var l=t[i],c=n[o];if(null===l)i++;else if(n.length<=o)e.removeChild(r(t[i],-1)),i++;else if(t.length<=i)e.insertBefore(r(c,1),r(t[i],0)||a),o++;else if(l===c)i++,o++;else{var d=s.get(l),f=u.get(c);void 0===d?(e.removeChild(r(t[i],-1)),i++):void 0===f?(e.insertBefore(r(c,1),r(t[i],0)||a),o++):(e.insertBefore(r(t[f],1),r(t[i],0)||a),t[f]=null,f>i+1&&i++,o++)}}return n}(s.parentNode,t||[],n,h,s));return f.forEach(p),e}))}))),o((function(){l.forEach((e=>e())),l.clear(),c.clear(),f.clear()})),u}"serviceWorker"in navigator&&(navigator.serviceWorker.register("sw.js").then((()=>{})),navigator.serviceWorker.addEventListener("message",(function(e){e.data.reload&&location.reload()}),!1));const Dn="0VMZYpdgCGL3iKAzDHwocTt97e1hasO2mJNjExq4PvR6XyWSFbIn-5B_8fUukQlr",Ln=Dn.split(""),Pn=new Array(123);for(let e=0;e<Dn.length;e++)Pn[Dn.charCodeAt(e)]=e;const On=e=>{if(e<0)return"-"+On(-e);let t=e>>>0,n=e/4294967296>>>0,r="";for(;n>0;)r=Ln[63&t]+r,t>>>=6,t|=(63&n)<<26,n>>>=6;let a="";do{a=Ln[63&t]+a,t>>>=6}while(t>0);return a+r};var jn={ntob:On,bton:e=>{let t=0;for(let n=0;n<e.length;n++)t=64*t+Pn[e.charCodeAt(n)];return t}};const In=[0,null,"⛩",0],Nn=(()=>{let e=n(In);const t=n([e]),r=t=>e(t),a=e=>{let n=t();n[e[0]]!==e&&(n[e[0]]=e),n.splice(e[0]+1),t(n),r(e),location.hash=e[0]>0?jn.ntob(e[3]):""};return{path:t=>e()[t],paths:t,len:()=>t().length,setpath:r,same:t=>t===e(),cd:a,update:e=>{t([In,...e]),r(e[e.length-1]||In)},ishome:()=>e()===In,home:()=>a(In)}})();var Kn=[];function Fn(){!function(e){for(var t=0,n=Kn;t<n.length;t++)(0,n[t])(e)}(document.location.hash.substr(1))}window.addEventListener("hashchange",Fn),setTimeout(Fn);const zn=30,Rn=e=>(t,n)=>{if(void 0===t)return e;let r=e.get(t);return n?r?r[n]:void 0:r},Bn=e=>{let t=n(e);return t.add=e=>t().indexOf(e)<0?t([...t(),e]):t(),t.delete=e=>{t().splice(t().indexOf(e),1),t(t())},t.last=()=>t()[t().length-1],t.pop=()=>{let e=t().pop();return t(t()),e},t},qn=n([]),Hn=n([]),$n=n(0),Vn=n(0),Wn=n(0),Yn=n(0),Gn=n(""),Xn=n(""),Zn=n(""),Jn=n(!1),Qn=n(!1),er=Rn(new Map),tr=Rn(new Map),nr=Rn(new Map),rr={id:0,childids:n([]),childs:Rn(new Map),open:()=>{}},ar=Rn(new Map([[0,rr]])),ir=n([]),or=Bn([]),ur=Bn([]),sr=n([]),lr=n([]),cr=n(0),dr=n(null),fr=n(!1),hr=n(""),pr=n(!1),mr=Bn([]),vr=Bn([]),yr=Bn([]),gr=n(!0),wr=n(null),br=n(!1),kr=n(!1);n(""),n("");const Cr=n(0),Sr=n(0),Er=n(0),xr=n(null),_r=n(location.hash.substr(1)),Ar=n(null),Tr=Bn([]),Ur=Rn(new Map),Mr=Bn([]),Dr=n(!1),Lr=()=>Hn().length>0?Hn()[Hn().length-1]:0,Pr=(()=>{const e={},t={};return{create:n=>t[n]=new Promise((t=>e[n]=t)),complete:(t,n)=>e[t]?e[t](n):null,join:e=>t[e],joinall:(...e)=>Promise.all(e.map((e=>t[e]))),select:(...e)=>Promise.race(e.map((e=>t[e])))}})(),Or={content:null},jr=()=>{switch(Er()){case 1:return"please login first";case 2:return"invalid login name or password";case 3:return"email existed";case 4:return"username existed";case 5:return"please select a topic";case 6:return"topic is empty";case 7:return"invalid email address";case 8:return"error adding people";case 9:return"error signing up";case 10:return"invalid name";case 11:return"invalid input";case 12:return"password too short";case 13:return"invalid password";case 14:return"new password is the same with old password";case 15:return"peer offline";case 16:return"You are behind a NAT or firewall, can not create a direct connection to peer"}};function Ir(...e){return e.includes(Er())}let Nr;const Kr=e=>{Er(e),clearTimeout(Nr),Nr=setTimeout((()=>Er(0)),5e3)},Fr=e=>{xr(e),clearTimeout(Nr),Nr=setTimeout((()=>xr(null)),5e3)};Sn.recv((async e=>{let t=e.value;switch(e.tag){case"Err":Kr(t);break;case"Unpack":Pr.complete("unpack",t);break;case"AddMems":Pr.complete("addmems",t);break;case"Logout":Le({d:!1});break;case"NewChan":Yn(t),A();break;case"Shin":if(!t)return;E(t.chats,tr()),x(t.users,nr()),_(t.chans,er()),re("_t",t.chats),re("_h",t.chans),re("_e",t.users),async function(e){let t=e||[],n=$n();if(0===t.length)return Jn(!0),de(n,null,!0),void Pr.complete("chatscan",t);Jn(!1),de(n,[t[0],t[t.length-1]]);let r=t.map((e=>({chanid:n,chatid:e})));re("_c",r),Pr.complete("chatscan",t)}(t.chats.map((e=>e.id)));break;case"Update":{let e=new Set([$n()]);sa(e,t),e.forEach((e=>ve("_u",e,t.id)));break}case"Updates":t&&t.length&&async function(e){let t=new Set([$n()]);for(const n of e)sa(t,n);t.forEach((t=>ve("_u",t,e[e.length-1].id)))}(t);break;case"ChanUpdates":t&&t.length&&async function(e){let t=new Set([$n()]);for(const{action:n,chanid:r,name:a,about:i,md:o}of e)switch(n){case 1:{let e=er(r);e&&(null!==a&&e.fullname(a),null!==i&&e.about(i),null!==o&&e.md(o)),e=await me(r,"_h"),e&&(null!==a&&(e.fullname=a),null!==i&&(e.about=i),null!==o&&(e.md=o),await ie("_h",e),e.dir.forEach((e=>t.add(e))));break}case 2:let e=await ra(r);e&&e.dir.forEach((e=>t.add(e)))}t.forEach((t=>ve("_d",t,e[e.length-1].id)))}(t);break;case"MemUpdates":t&&t.length&&async function(e){let t=new Set([$n()]),n=new Map;for(const{action:t,chanid:r,by:a}of e)switch(t){case 1:n.has(r)?n.get(r).adds.push(a):n.set(r,{adds:[a],rms:[]});break;case 0:n.has(r)?n.get(r).rms.push(a):n.set(r,{adds:[],rms:[a]})}for(let[e,{adds:r,rms:a}]of n.entries()){let n=await me(e,"_n");n&&(n=n.filter((e=>a.indexOf(e)<0)),ve("_n",e,Array.from(new Set([...r,...n])))),t.add(e)}ca(Yn()||$n()),t.forEach((t=>ve("_m",t,e[e.length-1].id)))}(t);break;case"Login":if(!t)return Kr(2),Pe(void 0),void Te("login",!1);await function(e){var t=e.data,n=e.chans;return Se(this,void 0,void 0,(function(){var e;return Ee(this,(function(r){switch(r.label){case 0:return[4,Fe(t)];case 1:return e=r.sent(),ie("_e",e),Le({d:!0}),Oe.chans(n),te("c",n),[2]}}))}))}(t),pa(),Te("login",!0),Dr(!1),Yn(0),rr.childids([]),oa(),Vr();break;case"Pwd":if(!t)return Pe(void 0),void Pr.complete("pwd",13);Oe.id()&&await Fe(t),Pr.complete("pwd");break;case"Users":re("_e",t),Pr.complete("users",t);break;case"Chans":re("_h",t),Pr.complete("chans",t);break;case"Chat":!async function(e){let t=Hn();if(t.includes(e.id))return;let r=!er(e.chanid),a=R();e.by==Oe.id()&&wr(e.id);await ie("_t",e);let i=($n()?e.dir:[0,...e.dir]).map((t=>(de(t,[e.id,e.id]),{chanid:t,chatid:e.id})));re("_c",i);let o=new Set(nr().has(e.by)?[]:[e.by]);e.men&&e.men.forEach((e=>{nr().has(e)||o.add(e)}));let u=e.dir.filter((e=>!er(e))),s=new Set(u);await qr(o,s),e.re&&Ea(e.re);let l=tr(Lr())||{};e.nor=n(0),e.star=n(!1),e.txt=n(e.txt),e.showby=n(e.by!==l.by),e.first=n(e.chanid!==l.chanid),e.last=n(!1),e.firstre=n(e.re&&e.re!==l.re&&e.re!=l.id),e.lastre=n(!1),e.timestamp=new Date(e.timestamp),tr().set(e.id,e),t.push(e.id),Hn(t),r&&Vr(!0);a&&A();"ontouchstart"in document.documentElement||ha();e.dir.forEach((async t=>{let n=er(t);n&&(n.chatid=e.id),n=await me(t,"_h"),n&&(n.chatid=e.id,await ie("_h",n))}))}(t);break;case"Chats":t.length>0&&re("_t",t),Pr.complete("chats",t);break;case"Shan":{let e=t;e.length>0?(Qn(!1),await $r(e)):Qn(!0),Pr.complete("chanscan",e);break}case"Tree":t.length>0&&(re("_h",t),_(t,er())),Pr.complete("scantree",t.map((e=>e.id)));break;case"Treeid":t.length>0&&await $r(t),Pr.complete("scantree",t);break;case"MuteChan":{let e=t;if(!e)return;let n=Oe.chans();if(n.includes(e))return;n.push(e),Oe.chans(n),await te("c",n),await ae(0,e,...er(e,"dir")),oa(),Wr(Nn.path(3));break}case"UnmuteChan":{let e=t,n=Oe.chans();if(!n.includes(e))return;const r=n.indexOf(e);r>-1&&n.splice(r,1),Oe.chans(n),await te("c",n),await ae(0,e,...er(e,"dir")),oa(),Wr(Nn.path(3));break}case"DelChan":ra(t);break;case"Mems":Pr.complete("memlist",t);break;case"FindUsers":x(t,nr()),re("_e",t),Pr.complete("findusers",t);break;case"FindMems":x(t,nr()),re("_e",t),Pr.complete("findmems",t);break;case"On":{let{id:e,online:n}=t;if(!e)return;let r=nr(e);r&&r.online(n);break}case"Ons":t.forEach((e=>nr(e).online(!0)));break;case"Profile":Pr.complete("profile",t);break;case"Name":Pr.complete("name",t);break;case"Signup":Pr.complete("signup",t);break;case"ChatThread":Pr.complete("thread",t);break;case"ChatList":Pr.complete("list",t);break;case"Status":Pr.complete("status",t);break;case"Sdp":t.offer?async function({fr:e,sd:t,ca:n}){let r=Pr.create("ice"),a=await Ua(e),{a:i,k:o}=M(new Uint8Array(t)),{keypair:u,pub:s}=await Aa();o=await we(o),a.sharedkey=await ge(u.privateKey,o);let l=(new TextDecoder).decode(cn(i));await a.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:l}));let c=await a.createAnswer();await a.setLocalDescription(c);for(const e of n){const t=new RTCIceCandidate({candidate:e,sdpMid:0,sdpMLineIndex:0});await a.addIceCandidate(t)}t=dn((new TextEncoder).encode(a.localDescription.sdp)),t=U(t,s),await r,Sn.send(Ue.Sdp({fr:null,to:e,sd:t,ca:_a,offer:null}))}(t):Pr.complete("offer",t)}})),function(e){Kn.push(e)}((async e=>{_r(e),Ar(null);let t=Tr();if(Oe.id()>0&&(t=[...t,Oe.id()]),await ua(t),"$"===e[0]){let[t,r,a]=e.slice(1).split("/");if(r.length<50)return location.hash="#",Dr(!1);let i=await Pr.create("unpack",Sn.send(Ue.Unpack(r)));if(!i)return location.hash="#",Dr(!1);let o=await Pr.create("name",Sn.send(Ue.Email(i)));switch(t){case"i":if(!o)return function(e,t){const r=n("Log in Telegram");let a={};function i(e){e.preventDefault();let{n:n,p:r}=e.target,i=n.value.trim();wa(z,i)&&wa(V,r.value)&&async function(e,t,n,r,a){await ne();const i=crypto.getRandomValues(new Uint8Array(12)),o=await Ne(r,i);let u=await Ie(n,t),s=I(i,new Uint8Array(await ke(u,o,i))),l=B(),c={name:t,key:s,tz:l,tgid:a.id||null,tgname:a.username||null,tgfn:a.first_name||null,tgln:a.last_name||null};Pe(u),Sn.send(Ue.NewUser(c))}(0,i,r.value,t,a)}function o(e){e.preventDefault(),window.Telegram.Login.auth({bot_id:"1850607378",request_access:!0},(e=>{e&&(S("username").value=e.username,r("Log in as "+e.first_name),a=e)}))}Or.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Sign up"),p("div",{class:"sub"},e),p("form",{onsubmit:i},(()=>Ir(4,10,12)&&p("div",{class:"erm"},jr())),p("input",{id:"username",type:"text",name:"n",placeholder:"Username",onkeypress:H,onkeyup:$,required:!0,autocomplete:"on",class:()=>Ir(4,10)&&"er"}),p("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>Ir(12)&&"er"}),p("script",{async:!0,src:"https://telegram.org/js/telegram-widget.js?15"}),p("div",null,p("button",{onclick:o},r)),p("div",{class:"bn"},p("button",{type:"submit"},"Sign up"))))),Dr(!0)}(i,a),Ae("login",(e=>e?location.hash="#":null));break;case"f":if(o&&(o==Oe.name()||!Oe.id()))return function(e,t,n){async function r(t){t.preventDefault();let{p:r}=t.target;if(wa(V,r.value)){let t=await ga(e,n,r.value);if(t)return Kr(t);Fr("password updated"),Dr(!1),location.hash="#"}}Or.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Reset password"),p("div",{class:"sub"},t),p("form",{onsubmit:r},(()=>Ir(12)&&p("div",{class:"erm"},jr())),p("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>Ir(12)&&"er"}),p("div",{class:"bn"},p("button",{type:"submit"},"Submit"))))),Dr(!0)}(o,i,a)}return location.hash="#",Dr(!1)}if("/"===e[0]){let t=jn.bton(e.slice(1));return Vn(t),Hn([]),async function(e){ia.cb=null;let t=await Pr.create("thread",Sn.send(Ue.ChatThread({i:e,kw:null,ub:null,lb:null})));await zr(t,"re"),ia.cb=t=>async function(e,t){let n=await Pr.create("thread",Sn.send(Ue.ChatThread({i:e,kw:null,ub:t,lb:null})));return zr(n)}(e,t)}(t),ha(),void await Vr()}if("&"===e[0]){let t=jn.bton(e.slice(1));return t==Oe.id()?location.hash="#":($n(0),Vn(0),ca(0),Yn(0),Hr([]),Hn([]),await ua([t]),Ar(t),await async function(e){let t=await(async(e,t,n,r=!0)=>{let a={value:e};return await ue("_p",se,a,n,t,r,"prev")})(e);Mr(t.reverse())}(t),await Vr(),!Ur().has(t)&&nr(t).online()&&Ta(t),void setTimeout((()=>ha()||A()),100))}let r=["!","@","*"].indexOf(e[0]);if(r>-1)return $n(0),Yn(0),Vn(0),Hn([]),async function(e){ia.cb=null;let t=await Pr.create("list",Sn.send(Ue.ChatList({i:e,kw:null,ub:null,lb:null})));await zr(t,"re"),ia.cb=t=>async function(e,t){let n=await Pr.create("list",Sn.send(Ue.ChatList({i:e,kw:null,ub:t,lb:null})));return zr(n)}(e,t)}(r),ha(),void await Vr();if("%"===e[0])return location.hash="#"+jn.ntob(Number(e.slice(1)));if(!e||!Dn.includes(e[0]))return $n(0),Vn(0),ca(0),Yn(0),Hr([]),await Vr(),oa(),void(document.title="hyze - micro chat for team");let a=jn.bton(e);if(await Vr(),$n(a),Yn(0),Vn(0),oa(),!er(a))return;let i=er(a).dir;Hr([...i,a]),ca(a),document.title=er($n()).fullname()+" - hyze"}));const zr=async(e,t=null)=>{await Rr(e);let r=e[0],a=new Set,i=new Set,o=Hn(),u="re"===t?new Set:new Set(o);switch(e=e.filter((e=>{let t=tr(e);if(!t)return!1;"function"!=typeof t.txt&&(t.txt=n(t.txt),t.star=n(t.star),t.first=n(!1),t.last=n(!1),t.firstre=n(!1),t.lastre=n(!1),t.showby=n(!1),t.nor=n(t.nor)),"string"==typeof t.timestamp&&(t.timestamp=new Date(t.timestamp)),nr().has(t.by)||a.add(t.by),t.men&&t.men.forEach((e=>{nr().has(e)||a.add(e)})),t.dir.forEach((e=>{er().has(e)||i.add(e)}));let r=u.has(e);return u.add(e),!r})),await qr(a,i),e.reverse(),t){case"re":Hn(e);break;case"pre":Hn(o.concat(e));break;default:Hn(e.concat(o))}let s=Hn();for(let e=0;e<s.length;e++){let t=tr(s[e-1])||{},n=tr(s[e+1])||{},r=tr(s[e]);r.showby(r.by!==t.by),r.first(r.chanid!==t.chanid),r.last(r.chanid!==n.chanid),r.firstre(r.re&&r.re!==t.re&&r.re!=t.id),r.lastre(r.re&&r.re!==n.re)}ha(),r&&S(jn.ntob(r)+"_").scrollIntoView()},Rr=async e=>{e=await Br(e),e=new Set(e.map((e=>tr(e,"re"))).filter((e=>e>0&&!tr().has(e)))),Br(Array.from(e))},Br=async e=>{if(0===(e=e.filter((e=>!tr().has(e)))).length)return e;let{value:t,missed:n}=await oe("_t",e);if(E(t,tr()),n.length>0){let e=await Pr.create("chats",Sn.send(Ue.Chats(n)));E(e,tr())}return e},qr=async(e,t)=>{let n=await oe("_e",Array.from(e)),r=await oe("_h",Array.from(t));n.value.length&&Sn.send(Ue.Ons(n.value.filter((e=>e.id!=Oe.id())).map((e=>e.id)))),x(n.value,nr()),_(r.value,er()),n.missed.length>0&&Pr.create("users",Sn.send(Ue.Users(n.missed))),r.missed.length>0&&Pr.create("chans",Sn.send(Ue.Chans(r.missed)));let[a,i]=await Pr.joinall("users","chans");a&&x(a,nr()),i&&_(i,er())},Hr=e=>{let t=e.map(((e,t)=>{let n=er(e)||{};return[t+1,n.mom,n.fullname,e]}));Nn.update(t)},$r=async e=>{if(0===(e=e.filter((e=>!er().has(e)))).length)return;let{value:t,missed:n}=await oe("_h",e);if(_(t,er()),n.length>0){let e=await Pr.create("chans",Sn.send(Ue.Chans(n)));_(e,er())}};async function Vr(e=null,t=null){if(0===rr.childids().length||e){performance.now();let n=t?[]:await async function(){let e=await ue("_h",(e=>[e.index("chatid"),null]));return _(e,er()),e.map((e=>e.id))}();n.length<1&&(n=await async function(e=null,t=null){t&&Xn(t);return Pr.create("scantree",Sn.send(Ue.Tree({kw:t,reload:e})))}(e,t)),Yr(n)}}const Wr=async(e,t=null,n=null)=>{performance.now(),Vr(null,t);let r=await me(e,"_d")||null,a=await me(e,"_m")||null,i=await((e,t=null,n=null,r=null,a=null,i=null)=>{r&&Xn(r);let o=Ue.Shan({chanid:e,kw:r,ub:a,lb:i,cu:t,mu:n});return Pr.create("chanscan",Sn.send(o))})(e,r,a,t,n);n?0===i.length||qn(qn().concat(i)):(0!==i.length||t||Te("nochan"),qn(i));let o=Gr(e);o&&(Xr(qn(),o.childs()),o.childids(qn()))};function Yr(e,t=0){const n=e.filter((e=>er(e).mom==t));let r=Gr(t);r&&(($n()==t||$n()&&er($n())&&er($n()).dir.includes(t))&&r.open(!0),Xr(n,r.childs()),r.childids(n));for(const t of n)Yr(e,t)}function Gr(e){let t=e&&er(e)?[0,...er(e).dir,e]:[0],n=ar();var r,a;for(a=0;a<t.length;a++){let e=t[a];n.has(e)&&(r=n.get(e),n=r.childs())}return r}function Xr(e,t){return e.reduce(((e,t)=>(e.has(t)||e.set(t,{id:t,childids:n([]),childs:Rn(new Map),open:n(!1)}),e)),t)}const Zr=e=>Wr(Nn.path(3),e),Jr=e=>{Zn(e),oa(e)};const Qr=async({id:e,mom:t,name:n})=>{e!==$n()&&Nn.cd([Nn.path(0)+1,t,n,e])},ea=async e=>{Sn.send(Ue.MuteChan(e))},ta=async e=>{Sn.send(Ue.UnmuteChan(e))},na=async(e,t,n)=>{let r=await Pr.create("addmems",Sn.send(Ue.AddMems({chanid:e,userids:t,emails:n})));return ca(e),r};async function ra(e){let t=er(e);t&&er().delete(e),t=await me(e,"_h"),t&&await(async({id:e,dir:t})=>{let n=await G.join();if(!n)return;let r=[0,...t,e];!function(e){e.forEach((async e=>{he(e)}))}(r),function(e){let t=n.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);t.delete(n).onerror=console.error}))}(r)})(t);let n=qn(),r=n.indexOf(e);return r>-1&&(n.splice(r,1),qn(n)),t}const aa=async e=>{let t=Zn()||null,n=$n();performance.now();let r=await fe(n)||[];if(r[2]&&e===r[1])return void Jn(!0);if(Jn(!1),!t){let t=await ce(n,e,zn);if(r[2]||t.length===zn)return void await zr(t)}let a=await((e=null,t=null,n=null)=>{let r=Ue.Shin({chanid:$n(),kw:e,ub:t,lb:n,lu:null,cu:null,mu:null});return Pr.create("chatscan",Sn.send(r))})(t,e);a.length>0&&await zr(a)};let ia={cb:null};async function oa(e=null){ia.cb=null,Jn(!1),Wn(0);let t=$n();performance.now();let n=await fe(t)||[],r=e?null:n[0]||null,a=await ce(t,null,zn);await zr(a,"re"),ia.cb=aa;let i={id:await me(t,"_u")||0,lo:n[1]||0},o=await me(t,"_d")||null,u=await me(t,"_m")||null,s=await((e=null,t=null,n=null,r=null,a=null,i=null)=>{let o=Ue.Shin({chanid:$n(),kw:r,ub:a,lb:i,lu:e,cu:t,mu:n});return Pr.create("chatscan",Sn.send(o))})(i,o,u,e,null,r)||[];await zr(s,s.length!==zn&&0!==a.length&&r?"pre":"re")}async function ua(e){let t=e.filter((e=>!nr().has(e)));if(t.length){let{value:e,missed:n}=await oe("_e",t);if(x(e,nr()),n.length>0){let e=await Pr.create("users",Sn.send(Ue.Users(n)));e&&x(e,nr())}Sn.send(Ue.Ons(t.filter((e=>e!=Oe.id()))))}}async function sa(e,{action:t,chatid:n,txt:r}){switch(t){case 1:{let t=tr(n);t&&t.txt(r),t=await me(n,"_t"),t&&(t.txt=r,await ie("_t",t),t.dir.forEach((t=>e.add(t))));break}case 2:let t=await la(n);t&&t.dir.forEach((t=>e.add(t)))}}async function la(e){let t=tr(e);t&&tr().delete(e),t=await me(e,"_t"),t&&await(async({id:e,dir:t})=>{let n=await G.join();if(!n)return;let r=[0,...t];!function(e,t){t.forEach((async t=>{let n=await fe(t);n&&n.includes(e)&&he(t)}))}(e,r),function(e,t){let r=n.transaction(["_c"],"readwrite").objectStore("_c");t.forEach((t=>{let n=IDBKeyRange.only([t,e]);r.delete(n).onerror=console.error}))}(e,r),function(...e){let t=n.transaction(["_t"],"readwrite").objectStore("_t");e.forEach((e=>{t.delete(e).onerror=console.error}))}(e)})(t);let n=Hn(),r=n.indexOf(e);return r>-1&&(n.splice(r,1),Hn(n)),ha(),t}async function ca(e){if(!e)return ir([]);let t=er(e).md()<2?[...er(e).dir,e]:[e],{value:n,missed:r}=await oe("_n",t),a=[];if(r.length){let e=await Pr.create("memlist",Sn.send(Ue.Mems(r)));for(const t of e){x(t.users,nr()),re("_e",t.users);let e=t.users.map((e=>e.id));ve("_n",t.chanid,e),a=[...a,...e]}}let i=Array.from(new Set([...n.flat(),...a]));await ua(i),i.sort((e=>nr(e).online()?-1:0)),ir(i)}async function da(e){let t=await Pr.create("findusers",Sn.send(Ue.FindUsers(e)));sr(t);let n=t.find((t=>t.name===e));if(n)cr(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));cr(n?t.indexOf(n):0)}return t.length}async function fa(e){let t=await Pr.create("findmems",Sn.send(Ue.FindMems({chanid:Yn()||$n(),kw:e})));lr(t);let n=t.find((t=>t.name===e));if(n)cr(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));cr(n?t.indexOf(n):0)}return t.length}function ha(){if(!S("cs"))return;let e=window.innerHeight-S("cs").offsetHeight-(Oe.id()?96:64)-(pr()&&fr()?56:pr()?32:fr()?24:0),t=S("os");S("cs").childElementCount>2&&(e-=5),t.style.height=e>0?e+"px":"0"}function pa(){const e=Oe.id();let t=nr(e);t?t.online(!0):nr().set(e,{id:e,name:Oe.name(),tz:B(),online:n(!0)})}window.onresize=ha,Ae("reconnected",(()=>{oa(),Wr(Nn.path(3))}));let ma=new Map;async function va(e){return Sn.send(Ue.Au(e)),Fr("a secret 6-digits otp code has been sent to your registered email"),await Pr.create("enterotp",function(){let e=[...Array(6)].map((e=>p("input",{class:"ot",type:"tel",autocomplete:"chrome-off"}))),t=e[0];t.addEventListener("input",n),setTimeout((()=>t.focus()));for(let t=0;t<e.length;t++){let r=e[t];r.addEventListener("keypress",(function(n){n.keyCode>47&&n.keyCode<58&&(r.value=n.key,t!==e.length-1&&e[t+1].focus()),n.preventDefault()})),r.addEventListener("keydown",(function(n){"Backspace"===n.key&&(r.value="",0!==t&&e[t-1].focus())})),r.addEventListener("keyup",(function(t){if(16===t.keyCode||9==t.keyCode||224==t.keyCode||18==t.keyCode||17==t.keyCode)return;t.target.value.length>1&&n(t);let r=e.map((e=>e.value)).join("");r.length===e.length&&Pr.complete("enterotp",r)}))}function n(e){let t=e.data||e.target.value;t&&1!==t.length&&r(e.target,t)}function r(e,t){e.focus(),e.value=t[0],t=t.substring(1),e.nextElementSibling&&t.length&&r(e.nextElementSibling,t)}Or.content=p("div",{class:"pi"},p("div",{class:"su otp"},p("div",{class:"head"},"Enter OTP code"),p("div",{class:"sub"},"Please enter the 6-digits code sent to your email"),p("div",{id:"otp"},e))),Dr(!0)}())}async function ya(e,t,n){er().clear(),tr().clear(),nr().clear(),ir([]),await ne();const r=crypto.getRandomValues(new Uint8Array(12)),a=await Ne(n,r);let i=await Ie(t,e),o={name:e,key:I(r,new Uint8Array(await ke(i,a,r))),tz:B()};Pe(i),Sn.send(Ue.Login(o))}async function ga(e,t,n,r=null){const a=crypto.getRandomValues(new Uint8Array(12)),i=await Ne(t,a);let o=r?new Uint8Array(await Ie(r,e)):null,u=await Ie(n,e),s=I(a,new Uint8Array(await ke(u,i,a)));return Pe(u),Pr.create("pwd",Sn.send(Ue.Pwd({key:s,okey:o})))}function wa(e,...t){let n=e(...t);return!n||Kr(n)}function ba(){Or.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Sign up"),p("div",{class:"sub"},"We will send a sign up invitation to your email"),p("form",{onsubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();if(F(n)){let e=await Pr.create("signup",Sn.send(Ue.Signup(n)));if(e)return Kr(e);Fr(`an invite code has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Dr(!1)}else Kr(7)}},(()=>Ir(3,7)&&p("div",{class:"erm"},jr())),p("input",{type:"text",name:"m",placeholder:"Your email address",onkeypress:q,onkeyup:$,required:!0,autocomplete:"on",class:()=>Ir(3,7)&&"er"}),p("div",{class:"bn"},p("button",{type:"submit"},"Sign up"))))),Dr(!0)}function ka(){Or.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Log in"),p("div",{class:"sub"}),p("form",{onsubmit:async function(e){e.preventDefault();let{m:t,p:n}=e.target,r=t.value.trim();if(F(r))return async function(e,t){let n=ma.has(e)?ma.get(e):await Pr.create("name",Sn.send(Ue.Email(e)));if(ma.set(e,n),!n)return Kr(2);ya(n,t,await va(n))}(r,n.value);if(wa(z,r)){let e=await va(r);ya(r,n.value,e)}}},(()=>Ir(7,10)&&p("div",{class:"erm"},jr())),p("input",{type:"text",name:"m",placeholder:"Username or email",onkeypress:q,onkeyup:$,required:!0,autocomplete:"on",class:()=>Ir(7,10)&&"er"}),p("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on"}),p("div",{class:"lf fp"},p("a",{onclick:Ca},"Forgot password")),p("div",{class:"bn"},p("button",{type:"submit"},"Log in"))))),Dr(!0)}function Ca(){Or.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Forgot password"),p("div",{class:"sub"},"We will send a password reset link to your email"),p("form",{onsubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();F(n)?(Pr.create("forgotpwd",Sn.send(Ue.Fp(n))),Fr(`a password reset link has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Dr(!1)):Kr(7)}},(()=>Ir(7)&&p("div",{class:"erm"},jr())),p("input",{type:"text",name:"m",placeholder:"Your email address",onkeypress:q,onkeyup:$,required:!0,autocomplete:"on",class:()=>Ir(7)&&"er"}),p("div",{class:"bn"},p("button",{type:"submit"},"Submit"))))),Dr(!0)}Ae("config",(async({d:e})=>{e?(pa(),Un()):Oe.id()&&(Yn(0),nr(Oe.id())&&nr(Oe.id()).online(!1),Oe.id(0),Oe.name(null),Oe.chans([]),delete Oe.sskey,delete Oe.salt,await ne(),rr.childids([]),Nn.ishome()?(oa(),Vr()):Nn.home())})),Ae("subs",(function(e){Sn.send(Ue.PushSubs({endpoint:e.endpoint,auth:e.keys.auth,p256dh:e.keys.p256dh}))}));const Sa=e=>{Yn()!==e?Yn(e):Yn(0),ca(Yn()||$n()),Wn(0)};const Ea=async e=>{const t=tr(e);t&&t.nor(t.nor()+1);const n=await me(e,"_t");n&&(n.nor=t.nor(),await ie("_t",n))};async function xa(e){return Pr.create("status",Sn.send(Ue.Status(e)))}let _a=[];async function Aa(){const e=await be(),t=await crypto.subtle.exportKey("raw",e.publicKey);return{keypair:e,pub:new Uint8Array(t)}}async function Ta(e){let t=Pr.create("ice"),n=await Ua(e),r=await n.createOffer();await n.setLocalDescription(r);let a=dn((new TextEncoder).encode(n.localDescription.sdp)),{keypair:i,pub:o}=await Aa();a=U(a,o),await t;let u=await Pr.create("offer",Sn.send(Ue.Sdp({fr:null,to:e,sd:a,ca:_a,offer:!0}))),{a:s,k:l}=M(new Uint8Array(u.sd));l=await we(l),n.sharedkey=await ge(i.privateKey,l);let c=(new TextDecoder).decode(cn(s));n.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:c}));for(const e of u.ca){const t=new RTCIceCandidate({candidate:e,sdpMid:0,sdpMLineIndex:0});await n.addIceCandidate(t)}}async function Ua(e){await ua([e]);let t=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});Ur().has(e)||Tr.add(e),Ur().set(e,t),t.onicecandidate=e=>{e.candidate?_a.push(e.candidate.candidate):Pr.complete("ice",_a)},t.onconnectionstatechange=e=>{};let n=t.createDataChannel("p",{negotiated:!0,id:1});return n.binaryType="arraybuffer",n.onopen=e=>{},n.onmessage=async({data:n})=>{let r=R(),a=new Uint8Array(n),i=a.subarray(0,12);a=new Uint8Array(await Ce(a.subarray(12),t.sharedkey,i)),T(a,i);let o=ln(cn(a));o.by=e,o.ts=new Date,o.room=e,(Mr.last()||{}).by!=e&&(o.showby=!0),o.id=await ie("_p",o),Ar()==e&&Mr.add(o),r&&setTimeout(A),ha()},n.onclose=t=>{var n,r;setTimeout((()=>{if(nr(e).online())return Ta(e)}),(n=1e3,r=5e3,Math.random()*(r-n)+n))},n.onerror=e=>{},t.send=async e=>{let r=dn(sn(e));const a=crypto.getRandomValues(new Uint8Array(12));T(r,a),r=I(a,new Uint8Array(await ke(r,t.sharedkey,a))),n.send(r)},t.open=()=>"open"===n.readyState,t}function Ma({id:e},t){if(!e||Wn()===e)return Wn(0);t.focus(),Wn(e)}var Da=function(){var e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=b((function(){var t=e.textContent;t&&t.length>50||(Zr(t),Jr(t))}),200),e.onkeydown=function(e){"Enter"!==e.key||e.shiftKey||e.preventDefault()};var t=document.createElement("div");return setTimeout((function(){new IntersectionObserver((function(t){if(!(t[0].intersectionRatio<=0)){var n=Gr($n()).childids(),r=n[n.length-1];if(!(!r||Qn()||n.length<zn)){var a=e.textContent||null;a&&a.length>50||setTimeout((function(){return Wr(Nn.path(3),a,r)}))}}}),{}).observe(t)})),p("div",{class:"cn"},p("div",{class:"s"},e),p("div",{class:"tbl"},p("table",null,p("tbody",null,(function(){return Mn(Gr($n()).childids,(function(e){var t=er(e);return p("tr",{onClick:function(){return Qr(t)}},p("td",null,p("button",{onClick:function(t){return function(e,t){if(e.stopPropagation(),!Oe.id())return ka();Oe.chans().includes(t)?ta(t):ea(t)}(t,e)}},(function(){return Oe.chans().includes(e)?"➕":"➖"}))),p("td",null,t.fullname))}))}),t))))},La="formatBlock",Pa=function(e,t){return e.appendChild(t)},Oa=function(e){return document.createElement(e)},ja=function(e){return document.queryCommandState(e)},Ia=function(e,t){return document.execCommand(e,!1,t)},Na=[{icon:"<b>B</b>",title:"Bold",state:function(){return ja("bold")},result:function(){return Ia("bold")}},{icon:"<i>I</i>",title:"Italic",state:function(){return ja("italic")},result:function(){return Ia("italic")}},{icon:"<u>U</u>",title:"Underline",state:function(){return ja("underline")},result:function(){return Ia("underline")}},{icon:"<strike>S</strike>",title:"Strike-through",state:function(){return ja("strikeThrough")},result:function(){return Ia("strikeThrough")}},{icon:"&#8220&#8221;",title:"Quote",result:function(){return Ia(La,"<blockquote>")}},{icon:"&lt;&gt;",title:"Code",result:function(){return Ia(La,"<pre>")}},{icon:"&#128279;",title:"Link",class:" lk",result:function(){var e=window.prompt("Enter the link URL");e&&Ia("createLink",e)}},{icon:"🌁",title:"Image",class:" im",result:function(){var e=window.prompt("Enter the image URL");e&&Ia("insertImage",e)}},{icon:"⏎",title:"Enter to send",class:" en se",result:function(e){return gr()?gr(!1):gr(!0),gr()?e.classList.add("se"):e.classList.remove("se"),!0}}],Ka="e-b",Fa="e-bs",za="",Ra=0,Ba=!1,qa=n(!1),Ha=function(){return S("tp")},$a=function(){return S("pm")},Va=function(){return S("mb")},Wa=function(e){Ra=C();var t=e.textContent,n=t.indexOf(" ",Ra);-1==n&&(n=t.length);var r=/[\S]+$/.exec(t.slice(0,n));return r?r[0]:""},Ya=function(e){var t=e.id,n=e.name;lr([]),cr(0);var r=dr();if(r.spellcheck=!1,r===Va()){var a=za?"@"+n:n;r.textContent=za?function(e,t){var n=e.textContent,r=n.indexOf(" ",Ra);-1==r&&(r=n.length);var a=n.slice(0,r).replace(/\S+$/,t);return Ra=a.length,a+n.slice(r)}(r,a):r.textContent+a,r.focus(),za?function(e,t){var n=document.createRange(),r=window.getSelection();n.setStart(e.childNodes[0],t),n.collapse(!0),r.removeAllRanges(),r.addRange(n)}(r,Ra):k(),qa(!1),t&&yr.add(t)}else t?mr.add(t):vr.add(za),r.textContent="",$a().focus()},Ga=function(){return p("div",{id:"uls",class:function(){return"uls"+(dr()===Va()&&pr()?" ms":"")}},p("ul",null,Mn(lr,(function(e){return p("li",{id:e.id,tabIndex:-1,class:function(){return lr()[cr()]===e?"se":""},onClick:function(){return Ya(e)},onMouseOver:function(){return Ba||cr(lr().indexOf(e))}},e.id?p("i",{class:function(){return"dot"+(nr(e.id).online()?" on":"")}}):null,e.name)}))))},Xa=function(){return p("div",{class:function(){return"em sel"+(pr()?" sh":"")},onClick:function(){return $a().focus()}},Mn(vr,(function(e){return p("div",{class:"tg ie"},e,p("i",{onClick:function(){return vr.delete(e)}},"✕"))})),Mn(mr,(function(e){return p("div",{class:function(){return nr(e).online()?"tg on":"tg"}},nr(e).name,p("i",{onClick:function(){return mr.delete(e)}},"✕"))})),p("div",{class:"wp"},p("div",{id:"pm",class:"e-m"+(vr().length+mr().length===0?" to":""),onKeyDown:Za,onInput:ei,contentEditable:!0}),(function(){return dr()===$a()&&pr()&&lr().length>0&&Ga})))};function Za(e){if(!Ja(e)){if(8!=e.keyCode||$a().textContent.length||(mr.pop(),$a().focus()),32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1;"Enter"!==e.key&&"Tab"!==e.key||(Va().focus(),e.preventDefault())}}function Ja(e){return!!lr().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(Ya(lr()[cr()]),e.preventDefault(),!0):27==e.keyCode?(lr([]),cr(),qa(!1),!0):(38==e.keyCode&&(0===cr()?cr(lr().length-1):cr(cr()-1),S(lr()[cr()].id).focus(),e.preventDefault(),Ba=!0,setTimeout((function(){return Ba=!1}),300)),40==e.keyCode&&(cr()===lr().length-1?cr(0):cr(cr()+1),S(lr()[cr()].id).focus(),e.preventDefault(),Ba=!0,setTimeout((function(){return Ba=!1}),300)),e.target.focus(),!0))}var Qa=b((function(e){return Se(void 0,void 0,void 0,(function(){var t,n,r;return Ee(this,(function(a){switch(a.label){case 0:return(za=Wa(e.target).toLowerCase()).length>50?[2]:[4,fa(za)];case 1:return t=a.sent(),n=er(Yn()||$n()),r=n&&n.md()<2,!t&&F(za)&&r&&lr([{id:0,name:"✉️ Invite "+za}]),[2]}}))}))}),100);function ei(e){dr($a()),Qa(e)}var ti=function(){if(!Oe.id())return null;if(Lr()&&tr(Lr())&&Yn()==tr(Lr()).chanid)return null;var e=er(Yn());if(!e)return null;R()&&setTimeout(A,50);var t=function(){return xe(xe([],e.dir.slice(Nn.len()-2)),[e.id])};return t().length>0&&p("div",{class:"dr",style:function(){return"background:"+K(e.id)}},Mn(t,(function(e){return p("span",null,p("a",{href:"#"+jn.ntob(e)},er(e,"fullname")))})))},ni=function(){return p("div",{id:"tp",class:function(){return"e-t"+(fr()?" sh":"")},onKeyUp:ai,onKeyDown:ri,contentEditable:!0})},ri=function(e){e.target.spellcheck=!1,"Enter"===e.key&&e.preventDefault()},ai=function(e){hr(e.target.textContent),"Enter"===e.key&&(Va().focus(),e.preventDefault())},ii=function(){return!(Yn()||$n()||pr()||fr())},oi=function(){return p(Array.prototype,null,p("style",null,".e-c[contenteditable]:empty::before { content: '"+function(){var e,t="Send a "+(pr()?"private ":"")+"message ";return Yn()?e=er(Yn()):$n()&&(e=er($n())),e?t+(fr()?"on new topic "+(hr()?'"'+hr()+'" ':"")+'in "'+e.fullname()+'"':'in "'+e.fullname()+'"'):fr()?t+"on new topic "+(hr()?'"'+hr()+'"':""):t+"..."}()+"'; }"),(function(){return dr()===Va()&&qa()&&lr().length>0&&Ga}),p("div",{id:"mb",class:"e-c",onKeyDown:si,onInput:li,onFocus:ui,contentEditable:!0}))},ui=function(){if(0!==Hn().length)return ii()?(Yn(tr(Lr()).chanid),void ca(Yn())):Yn()||pr()||fr()?void 0:(Yn(tr(Lr()).chanid),void ca(Yn()))},si=function(e){if(dr(Va()),"@"===e.key&&qa(!0),!Ja(e)&&"Enter"===e.key){if(e.preventDefault(),gr()&&!e.shiftKey)return void async function(e,t){if(!Oe.id())return Kr(1);if(e.innerHTML.length>120)return Kr(11);if(t.innerHTML.length>4e3)return Kr(11);if(!t.innerHTML.trim())return;if(Ar()){if(!nr(Ar()).online())return Kr(15);if(!Ur(Ar()).open())return Kr(16);let e={txt:t.innerHTML.trim()};return Ur(Ar()).send(e),e.by=Oe.id(),e.ts=new Date,e.room=Ar(),(Mr.last()||{}).by!=Oe.id()&&(e.showby=!0),e.id=await ie("_p",e),Mr.add(e),t.textContent="",void ha()}let n=Yn()||$n(),r=Wn()||Vn()||null,a=null;if(e.textContent!==Gn()&&(a=e.textContent,!a.trim().length))return Kr(6);if(!(n||pr()||a&&a.trim().length))return Kr(5);let i=t.innerHTML.trim(),o=null,u=null,s=null;pr()&&(mr().length>0&&(o=mr.add(Oe.id()).sort(((e,t)=>e-t))),vr().length>0&&(u=vr())),yr().length>0&&(s=yr().filter((e=>i.indexOf("@"+nr(e).name)>-1))),Sn.send(Ue.NewChat({txt:i,chanid:n,re:r,chname:a,men:s,to:o,emails:u})),fr(!1),pr(!1),e.textContent="",t.textContent="",hr(""),Gn(""),Ma({},t)}(Ha(),Va());e.target.textContent+="\n\n",k()}},li=function(e){Va().spellcheck=!1,qa()&&ci(e)},ci=b((function(e){(za=Wa(e.target).toLowerCase()).startsWith("@")?(za=za.replace(/[@'";:,.\/?\\-]/,"")).length>50||fa(za):qa(!1)}),100),di=p("div",{class:"e-a"});Na.forEach((function(e){var t,n,r=Oa("button");if(r.className=Ka+" eb",e.class&&(r.className+=e.class),r.innerHTML=e.icon,r.title=e.title,r.setAttribute("type","button"),r.onclick=function(t){return e.result(r)&&Va().focus()},e.state){t="click",n=function(){return r.classList[e.state()?"add":"remove"](Fa)},r.addEventListener(t,n)}Pa(di,r)}));var fi=Oa("button");fi.className=Ka+" md",fi.innerHTML="👤",fi.title="Private message",fi.setAttribute("type","button");var hi=function(){if(!Oe.id())return ka();var e=R();fi.classList.add("se"),pr(!0),e&&setTimeout(A),ha(),"ontouchstart"in document.documentElement||$a().focus()};fi.onclick=function(){return pr()?(fi.classList.remove("se"),pr(!1),void ha()):hi()};var pi=Oa("button");pi.className="ntb",pi.innerHTML="✏️ New Topic",pi.title="New topic",pi.setAttribute("type","button"),pi.onclick=function(e){if(!Oe.id())return ka();var t=R();fr()?fr(!1):fr(!0),t&&fr()&&setTimeout(A),function(e,t){if(fr(e),ha(),e?pi.classList.add("se"):pi.classList.remove("se"),"ontouchstart"in document.documentElement)return;e&&Ha().focus();t&&(Ha().innerText=t,hr(t))}(fr())},Pa(di,pi),Pa(di,fi),Ia("defaultParagraphSeparator","div");var mi=function(){return p("div",{class:function(){return"e"+(Oe.id()?ii()?" ds":"":" hd")}},(function(){return Wn()?p("div",{class:"re",style:function(){return"color:"+K(Wn())}},p("i",null,"→"),p("b",null,nr(tr(Wn()).by).name),p("a",{href:"#/"+jn.ntob(Wn())},tr(Wn()).txt)):null}),ti," ",ni," ",Xa," ",oi," ",di)},vi=function(e,t){var n=S(e+"_").querySelector(".ct");if("true"===n.contentEditable)return n.contentEditable=!1,n.classList.remove("ce"),n.innerHTML=t.txt(),void(n.onclick=function(){return!1});n.spellcheck=!1,n.contentEditable=!0,n.classList.add("ce"),n.focus(),n.onclick=function(e){"true"===n.contentEditable&&e.stopPropagation()},n.onkeydown=function(e){if("Tab"===e.key)return document.execCommand("insertHTML",!1,"&#09"),e.preventDefault();if("Escape"===e.key)return n.contentEditable=!1,n.classList.remove("ce"),void(n.innerHTML=t.txt());if("Enter"===e.key){var r=n.innerHTML.trim();e.shiftKey||(e.preventDefault(),n.contentEditable=!1,n.classList.remove("ce"),r!==t.txt()&&(a=t.id,i=r,Sn.send(Ue.EditChat({id:a,txt:i}))))}var a,i}};var yi="0cc8d4a",gi="0.0.331";function wi(e){e.id;var t=e.name;return Se(this,void 0,void 0,(function(){function e(e){e.preventDefault();var t=e.target.n,n=t.value.trim()==r?null:t.value.trim(),i=S("ab").textContent.trim(),o=function(e,t){return e&&e.length<2?10:t&&t.length>1e3?11:0}(n,i=i==(a||"")?null:i);0===o?(!function(e,t,n=null){Pr.create("saveprofile",Sn.send(Ue.EditProfile({fullname:e,about:t,email:n})))}(n,i),Dr(!1)):Kr(o)}var n,r,a;return Ee(this,(function(i){switch(i.label){case 0:return[4,Pr.create("profile",Sn.send(Ue.Profile))];case 1:return n=i.sent(),r=n.fullname,a=n.about,Or.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Profile"),p("div",{class:"sub"},t),p("form",{onSubmit:function(t){return e(t)}},(function(){return Ir(10,11)&&p("div",{class:"erm"},jr())}),p("input",{value:r,type:"text",name:"n",placeholder:"Full name",required:!0,class:function(){return Ir(10)&&"er"}}),p("div",{id:"ab",class:"ab",contentEditable:!0},a),p("div",{class:"bn"},p("button",{type:"submit"},"Save"))))),Dr(!0),[2]}}))}))}var bi,ki=function(e,t){return Se(void 0,void 0,void 0,(function(){function r(e){var n=e.target.textContent;if(n&&n.length>50)return Kr(11);var r=n&&n.trim().length?n:null,a=B(),i=nr(t).otz!=a?a:null;nr(t).tz(a),nr(t).st(r),function(e){Sn.send(Ue.EditStatus(e))}({st:r,tz:i})}var a,i,o;return Ee(this,(function(u){switch(u.label){case 0:return Oe.id()?(e.stopPropagation(),nr(t).st?[3,2]:[4,xa(t)]):[2];case 1:a=u.sent(),i=a.st,o=a.tz,Oe.id()==t&&(nr(t).otz=o,o=B()),nr(t).st=n(i),nr(t).tz=n(o),u.label=2;case 2:return Or.content=p("div",{class:"pi"},p("div",{class:"ui"},p("div",{class:"un"},p("i",{class:function(){return"do"+(nr(t).online()?" on":"")}}),p("b",{style:function(){return nr(t).online()?"color:"+K(nr(t).name):""}},nr(t).name)),t!==Oe.id()?p("div",{style:"font-size:12px"},nr(t).st):p("div",{class:"st",contentEditable:!0,onBlur:r},nr(t).st)),p("hr",null),(function(){return nr(t).tz()&&p("div",{class:"sub"},p("i",null,"🕑")," Local time ",function(e){return(new Date).toLocaleTimeString(Intl.DateTimeFormat().resolvedOptions().locale,{timeZone:e,hour:"numeric",minute:"2-digit"})}(nr(t).tz()))}),t!==Oe.id()?p(Array.prototype,null,p("div",{class:"bt"},p("i",{class:"fl"},"💬")," ",p("a",{onClick:function(){return function(e){Dr(!1),hi(),mr([e]),Wn(0)}(t)}},"Send private message")),p("div",{class:"bt"},p("i",null,"@")," ",p("a",{onClick:function(){return function(e){if(Dr(!1),!Oe.id())return ka();Va().innerHTML+="@"+nr(e).name,Va().focus(),k(Va()),yr.add(e)}(t)}},"Mention ",p("b",null,nr(t).name))),nr(t).online()&&p("div",{class:"bt"},p("i",{class:"fl"},"↔"),p("a",{onClick:function(){Dr(!1),location.hash="#&"+jn.ntob(t)}},"Send direct p2p message"))):p(Array.prototype,null,p("div",{class:"bt",onClick:function(){return wi(nr(t))}},p("i",null,"✏️")," ",p("a",null,"Edit profile")),p("div",{class:"bt",onClick:function(){return function(e){var t=e.name;Or.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Change Password"),p("div",{class:"sub"},t),p("form",{onSubmit:function(e){return Se(this,void 0,void 0,(function(){var n,r,a,i,o;return Ee(this,(function(u){switch(u.label){case 0:return e.preventDefault(),n=e.target,r=n.o,wa(V,(a=n.p).value,r.value)?[4,va(t)]:[3,3];case 1:return i=u.sent(),[4,ga(t,i,a.value,r.value)];case 2:if(o=u.sent())return[2,Kr(o)];Fr("password updated"),Dr(!1),u.label=3;case 3:return[2]}}))}))}},(function(){return Ir(12,13,14)&&p("div",{class:"erm"},jr())}),p("input",{type:"password",name:"o",placeholder:"Old password",required:!0,autocomplete:"true",class:function(){return Ir(13)&&"er"}}),p("input",{type:"password",name:"p",placeholder:"New password",required:!0,autocomplete:"true",class:function(){return Ir(12,14)&&"er"}}),p("div",{class:"bn"},p("button",{type:"submit"},"Submit"))))),Dr(!0)}(nr(t))}},p("i",null,"🔒")," ",p("a",null,"Change password")),p("div",{class:"bt",onClick:function(){return async function(){Yn(0),ir([]),nr(Oe.id()).online(!1),er().clear(),tr().clear(),await Sn.send(Ue.Logout(Oe.salt)),await ne(),Le({d:!1}),Dr(!1),Te("logout")}()}},p("i",null,"🚪")," ",p("a",null,"Sign out")),p("div",{class:"v"},gi," ",yi))),Dr(!0),[2]}}))}))},Ci=function(e,t){if(e.shiftKey)return function(e,t){var n=screen.width/2-300,r=screen.height/2-300;window.open(e,t,"toolbar=yes,location=yes,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=600,height=600,top="+r+",left="+n)}("#"+jn.ntob(t),t),e.preventDefault();Sa(t),e.stopPropagation()},Si=function(){var e=n(0),t=n(0),r=!1,a=function(n){var a=n.id,o=n.txt,u=n.by,s=n.chanid,l=n.star,c=n.men,d=n.timestamp,f=n.showby,h=n.first,v=n.firstre,y=n.last,g=n.lastre,w=n.re,b=n.nor,k=jn.ntob(a);function C(){return["ct"].join(" ")}return p("div",{id:k+"_",class:function(){return"c"+(Wn()===a||t()==a?" cur":"")+(Yn()>0&&Yn()!==s?" bl":"")+(((new Date).getTime()-d.getTime())/1e3<60?" nc":"")+(w||b()?" r":"")+(h()||v()&&w!=Vn()?" fr":"")+(y()||g()&&w!=Vn()?" lr":"")},onClick:function(e){return function(e,t){"ontouchstart"in document.documentElement||Sa(t.chanid)}(0,n)},onTouchEnd:function(e){return function(e,t){r||Sa(t.chanid)}(0,n)},onMouseOver:function(){return e()!==a&&e(a)},style:function(){return"border-color:"+K(w||(b()?a:s))}},(function(){return v()&&w!=Vn()&&tr(w)?p("div",{class:"re",style:function(){return w||b()?"color:"+K(w||a):""},onMouseOver:function(){return t()!==w&&t(w)},onMouseOut:function(){return t(0)}},p("i",null,"→"),p("b",null,nr(tr(w,"by"),"name")),p("a",{href:"#/"+jn.ntob(w),onClick:function(e){return e.stopPropagation()}},tr(w,"txt"))):null}),(function(){return f()||h()||v()?p("div",null,p("a",{class:function(){return"by"+(nr(u).online()?" on":"")},style:function(){return nr(u).online()?"color:"+K(nr(u).name):""},onClick:function(e){return ki(e,u)}},nr(u).name)):null}),p("div",{class:function(){return l()?" star":""},style:function(){return b()?"color:"+K(a):""}},(function(){var e=o();if(c&&c.length)for(var t=0,n=c;t<n.length;t++){var r=n[t],a=nr(r).name,i=Oe.id()==r?"j":nr(r).online()?"k":"i",u=nr(r).online()?'style="color:'+K(a)+'"':"";e=e.replaceAll("@"+a,'<b onclick="b('+r+')" class="'+i+'" '+u+">@"+a+"</b>")}return m(bi||(bi=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}(["<div class="," innerHTML="," />"],["<div class="," innerHTML="," />"])),C,e)}),(function(){return b()&&a!=Vn()?p("p",{class:"mr"},p("i",null,"→"),p("a",{href:"#/"+k,onClick:function(e){return e.stopPropagation()}},b()+(b()>1?" replies":" reply"))):null})),(function(){return e()===a&&Oe.id()?i(k,n):null}))},i=function(e,t){var n,r,a,i=function(e){e.preventDefault(),e.stopPropagation();var n=R();Ma(t,Va()),Wn()===t.id?Yn(t.chanid):Yn(0),n&&setTimeout(A)};return p(Array.prototype,null,p("div",{class:"ts"},(n=t.timestamp,r=6e4,(a=new Date-n)<r?Math.round(a/1e3)+"s":a<36e5?Math.round(a/r)+"m":n.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{hour:"numeric",minute:"2-digit"}))),p("div",{class:"pm pr",title:"reply",onTouchEnd:i,onClick:i},p("i",null,"→"),p("div",{class:"pu"},p("div",null,"reply"))),p("div",{class:"pm",onClick:function(e){return e.stopPropagation()}},p("i",{class:"i"},"..."),p("div",{class:"pu"},p("div",{onClick:function(e){return(async e=>{e.star(!e.star()),Sn.send(Ue.Star(e.id));const t=await me(e.id,"_t");t&&(t.star=e.star(),await ie("_t",t))})(t)}},"⭐ ",t.star()?"unstar":"star"),p("div",{onClick:function(n){return vi(e,t)}},"✏️ edit"),p("div",{onClick:function(e){return o(t)}},"🗑️ trash"))))},o=function(e){var t=e.id,n=e.txt;confirm('Do you want to delete this chat? \n"'+n()+'"')&&function(e){Sn.send(Ue.DelChat(e)),la(e)}(t)},u=document.createElement("div");return setTimeout((function(){new IntersectionObserver((function(e){e[0].intersectionRatio<=0||ia.cb&&(!Hn()[0]||Jn()||Hn().length<zn||setTimeout((function(){if(ia.cb){var e=Hn()[0];!e||Jn()||Hn().length<zn||ia.cb(e)}})))}),{}).observe(u)})),setTimeout((function(){S("cs").addEventListener("touchstart",(function(e){return r=!1}),{passive:!0}),S("cs").addEventListener("touchmove",(function(e){return r=!0}),{passive:!0})})),p(Array.prototype,null,p("div",{id:"os"}),p("div",{id:"cs"},u,(function(){var e=[],t=0,r=null;return Hn().reduce((function(e,a){return W(tr(a).timestamp,r)?tr(a).chanid!=t?(t=tr(a).chanid,e.push(n([a])),e):(e[e.length-1]().push(a),e):(r=tr(a).timestamp,e.push(n(r)),t=tr(a).chanid,e.push(n([a])),e)}),e),Mn(n(e),(function(e){var t=e();if(t instanceof Array){var n=tr(e()[0]);return p("div",null,p("div",{class:"tn"},(function(){return function(e){var t=er(e);if(!t)return null;var n=function(){return xe(xe([],t.dir.slice(Nn.len()-2)),[t.id])};return n().length>0&&p("div",{class:"dr",style:function(){return"background:"+K(e)}},Mn(n,(function(e){return p("span",null,p("a",{href:"#"+jn.ntob(e),onClick:function(t){return Ci(t,e)}},er(e,"fullname")))})))}(n.chanid)}),p("div",{class:"ts"},n.timestamp.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))),Mn(e,(function(e){return tr(e)&&a(tr(e))})))}return p("div",{class:"date"},function(e){let t=new Date;return W(e,t)?"Today":(t.setDate(t.getDate()-1),W(e,t)?"Yesterday":e.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric"}))}(t))}))}),(function(){return nr(Ar())?p("div",null,p("div",{class:"tn"},p("div",{class:"dr",style:function(){return"background:"+K(nr(Ar()).name)}},p("span",null,p("a",null,"↔ ",nr(Ar()).name)))),Mn(Mr,(function(e){var t=e.by,n=e.txt,r=e.showby;return nr(t)?p("div",{class:"c",style:function(){return"border-color:"+K(nr(Ar()).name)}},(function(){return r?p("div",null,p("a",{class:function(){return"by"+(nr(t).online()?" on":"")},style:function(){return nr(t).online()?"color:"+K(nr(t,"name")):""},onClick:function(e){return ki(e,t)}},nr(t,"name"))):null}),p("div",null,n)):p("div",null)}))):null})),mi)},Ei=[["","All messages"],["!","Private messages"],["@","Mentions"],["*","Stars"]],xi=function(){var e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=b((function(t){var n=e.textContent;n&&n.length>50||(Zr(n),Jr(n))}),200),e.onkeydown=function(e){"Enter"!==e.key||e.shiftKey||e.preventDefault()};var t=function(e){return p("ul",null,Mn(e.childids,(function(n){var r=e.childs(n);return p(Array.prototype,null,p("li",{class:function(){return function(e){return[Oe.chans().includes(e)?"":"on",e==$n()?"se":""].join(" ")}(n)},onClick:function(){return function(e,t){e.open(!e.open()),Qr(t)}(r,er(n))}},p("div",{class:"sb"},p("i",null,(function(){return r.childids().length?r.open()?"▼":"▶":""}))),p("div",{class:"lb"},(function(){return function(e){return er(e,"md")&&er(e,"md")()>1?"🔒":""}(n)})," ",er(n,"fullname")),p("div",{class:"dot",onClick:function(e){return function(e,t){if(e.stopPropagation(),!Oe.id())return ka();Oe.chans().includes(t)?ta(t):ea(t)}(e,n)}})),(function(){return r.open()&&r.childids().length?t(r):null}))})))};return p(Array.prototype,null,p("div",{class:"dn n"},p("i",{onClick:function(){return Te("lnclose")}},"✕")),p("div",{class:"s"},e),Oe.id()?p("ul",{class:"hm"},(function(){return Ei.map((function(e){return p("li",{class:(_r()[0]||"")==e[0]?"se":"",onClick:function(){return location.hash=e[0]}},e[1])}))})):null,Mn(Tr,(function(e){return p("div",null,p("div",{class:"tn"},p("div",{class:"dr",style:function(){return"background:"+K(nr(e,"name"))}},p("span",null,p("a",{href:"#&"+jn.ntob(e)},"↔ ",nr(e,"name"))))))})),p("div",{class:"nt"},(function(){return rr.childids().length?t(rr):null})))},_i="",Ai=0,Ti=!1,Ui=function(){var e=b((function(e){return Se(void 0,void 0,void 0,(function(){return Ee(this,(function(t){switch(t.label){case 0:return(_i=function(e){Ai=C();var t=e.textContent,n=t.indexOf(" ",Ai);-1==n&&(n=t.length);var r=/[\S]+$/.exec(t.slice(0,n));return r?r[0]:""}(e.target).toLowerCase())&&_i.length>50?[2]:[4,da(_i)];case 1:return!t.sent()&&F(_i)&&sr([{id:0,name:"✉️ Invite "+_i}]),[2]}}))}))}),100),t=p("div",{class:"am",contentEditable:!0,onKeyDown:function(e){if(dr(t),r(e))return;8!=e.keyCode||t.textContent.length||(or.pop(),t.focus());if(32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return void e.preventDefault();"Enter"!==e.key&&"Tab"!==e.key||e.preventDefault()},onInput:e});function n(e){var n=e.id;e.name,sr([]),cr(0),n?or.add(n):ur.add(_i),t.textContent="",t.spellcheck=!1,t.focus()}function r(e){return!!sr().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(n(sr()[cr()]),e.preventDefault(),!0):27==e.keyCode?(sr([]),cr(),!0):(38==e.keyCode&&(0===cr()?cr(sr().length-1):cr(cr()-1),S(sr()[cr()].id).focus(),e.preventDefault(),Ti=!0,setTimeout((function(){return Ti=!1}),300)),40==e.keyCode&&(cr()===sr().length-1?cr(0):cr(cr()+1),S(sr()[cr()].id).focus(),e.preventDefault(),Ti=!0,setTimeout((function(){return Ti=!1}),300)),e.target.focus(),!0))}var a=function(){return p("div",{class:"uls adm"},p("ul",null,Mn(sr,(function(e){return p("li",{id:e.id,tabIndex:-1,class:function(){return sr()[cr()]===e?"se":""},onClick:function(){return n(e)},onMouseOver:function(){return function(e){Ti||cr(e)}(sr().indexOf(e))}},e.id?p("i",{class:function(){return nr(e.id).online()," on"}}):null," ",e.name)}))))},i=p("div",{class:"sel",onClick:function(){return t.focus()}},Mn(ur,(function(e){return p("div",{class:"tg ie"},e,p("i",{onClick:function(){return ur.delete(e)}},"✕"))})),Mn(or,(function(e){return p("div",{class:function(){return nr(e).online()?"tg on":"tg"}},nr(e).name,p("i",{onClick:function(){return or.delete(e)}},"✕"))})),t,(function(){return dr()===t&&sr().length>0&&a}));return i.focus=function(){return t.focus()},i},Mi=function(){var e=["Public","Internal"],t=function(){return Yn()?er(Yn()):$n()?er($n()):null};var n=function(e,t){e.stopPropagation(),window.confirm("Do you want to delete this channel?\n"+t.fullname())&&(async e=>{Sn.send(Ue.DelChan(e))})(t.id)},r=function(){return t().by===Oe.id()};function a(){var e=or().length+ur().length;return e>0?" "+e+(e>1?" people":" person"):""}var i=function(e){var t=e.id,n=e.fullname,r=Ui();Or.content=p("div",{class:"pi"},p("div",{class:"amb"},p("div",{class:"head"},"Add people"),p("div",{class:"sub"},n),r,p("div",{class:"bn"},p("button",{onClick:function(){return function(e,t){return Se(void 0,void 0,void 0,(function(){var n,r;return Ee(this,(function(i){switch(i.label){case 0:return n=or().length?or():null,r=ur().length?ur():null,n||r?[4,na(e,n,r)]:[2];case 1:return i.sent()?(Fr("added"+a()+" to "+t()),Dr(!1)):Kr(8),[2]}}))}))}(t,n)}},"Add",a)))),Dr(!0),r.focus()};function o(e,t){var n=t.id,r=t.fullname,a=t.about,i=t.md;e.preventDefault();var o=e.target,u=o.n,s=o.m,l=u.value.trim()==r()?null:u.value.trim(),c=s&&s.value.trim()!=i()?s.value.trim():null,d=S("ab").textContent.trim(),f=function(e,t,n){return e&&0===e.length?10:n&&(n>2||n<0)||t&&t.length>1e3?11:0}(l,d=d==(a()||"")?null:d,c);0===f?(!function(e,t,n,r){Pr.create("editchan",Sn.send(Ue.EditChan({id:e,name:t,about:n,md:r})))}(n,l,d,c),Dr(!1)):Kr(f)}return p(Array.prototype,null,p("div",{class:"dn"},p("i",{onClick:function(){return Te("rnclose")}},"✕")),p("div",{class:"ub"},(function(){return t()&&r()&&p("div",{title:"edit",onClick:function(){return n=t(),Or.content=p("div",{class:"pi"},p("div",{class:"su et"},p("div",{class:"head"},"About"),p("div",{class:"sub"},n.fullname),p("form",{onSubmit:function(e){return o(e,n)}},(function(){return Ir(10,11)&&p("div",{class:"erm"},jr())}),p("input",{value:n.fullname,type:"text",name:"n",placeholder:"topic name",required:!0,class:function(){return Ir(10)&&"er"}}),p("div",{id:"ab",class:"ab",contentEditable:!0},n.about),1==Oe.id()&&n.md()<2?p("select",{name:"m"},e.map((function(e,t){return p("option",{selected:function(){return n.md()==t},value:t},e)}))):null,p("div",{class:"bn"},p("button",{type:"submit"},"Save"))))),void Dr(!0);var n},class:"ed"},"✎")}),p("div",{class:"head"},"About"),p("div",{class:"sub b"},(function(){return t()?t().fullname:""})),p("div",{class:"sub"},(function(){return t()?t().about:""}))),p("div",{class:"ub"},p("div",{class:"he"},"Settings"),p("div",{class:"sub"},(function(){return t()?xe(xe([],e),["Private"])[t().md()]:""}))),p("div",{class:"ft"},p("div",{class:"ub lf"},p("div",{class:"he"},"Members")),(function(){return Oe.id()>0&&p("div",{class:"rt"},(function(){return t()&&p("button",{title:"add members",onClick:function(){return i(t())}},"👤")}))})),p("div",{class:"uls mem"},p("ul",null,Mn(ir,(function(e){return p("li",{id:e.toString(),tabIndex:-1,style:function(){return nr(e).online()?"color:"+K(nr(e).name):""},onClick:function(t){return ki(t,e)}},e?p("i",{class:function(){return"dot"+(nr(e).online()?" on":"")}}):null,nr(e).name)})))),(function(){return t()&&r()&&p("div",{class:"ft dt"},p("div",{class:"ub lf"},p("div",{class:"he"},"Delete")),p("div",{class:"rt"},p("button",{title:"delete topic",onClick:function(e){return n(e,t())}},"🗑️")))}))},Di=function(){return br()?localStorage.getItem("w")||185:0},Li=function(){return kr()?localStorage.getItem("e")||185:0};function Pi(){var e=localStorage.getItem("l"),t=e&&"0"!==e&&window.innerWidth>650;br(t);var n="1"==localStorage.getItem("r")&&window.innerWidth>650;kr(n),Cr(Di()),Sr(Li())}function Oi(){br(!br()),Cr(Di()),localStorage.setItem("l",br()?"1":"0")}function ji(){kr(!kr()),Sr(Li()),localStorage.setItem("r",kr()?"1":"0")}Pi(),setTimeout(Pi,100);var Ii=function(){return null},Ni=n(Ii);function Ki(){return p("div",{onMouseDown:function(e){document.onmousemove=function(e){Cr(e.clientX+2)},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null,localStorage.setItem("w",Cr())}},class:"dw"})}function Fi(){return p("div",{onMouseDown:function(e){document.onmousemove=function(e){Sr(document.documentElement.offsetWidth-e.clientX+2)},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null,localStorage.setItem("e",Sr())}},class:"de"})}document.querySelector("body").append(function(){Ae("nochan",(function(){return Ni(Ii)})),Ae("rnclose",ji),Ae("lnclose",Oi);return p(Array.prototype,null,p("div",{class:"ma",style:function(){return"left:"+(br()&&window.innerWidth>650?Cr():0)+"px;right:"+(kr()&&window.innerWidth>650?Sr():0)+"px"}},p("div",{class:"n"},p("div",null,p("ol",{class:"bc"},(function(){return Mn(Nn.paths,(function(e){return p("li",null,p("a",{onClick:function(){return function(e){e[0]===Nn.len()-1?Ni()===Da?Ni(Ii):Ni(Da):Nn.cd(e)}(e)}},e[2]))}))})),(function(){return Oe.id()?p(Array.prototype,null,p("div",{onClick:Oi,class:"av mv"},p("i",null,"☰")),p("div",{onClick:ji,class:"av iv"},p("i",null,"ⓘ")),p("div",{onClick:function(e){return ki(e,Oe.id())},class:"av"},p("i",null,"👨🏻‍💻"))):p(Array.prototype,null,p("div",{class:"u"},p("a",{onClick:ba},"sign up")),p("div",{class:"m"},p("a",{onClick:ka},"log in")))})),Ni),Si),(function(){return br()&&p("div",{class:"ln",style:"width:"+Cr()+"px"},xi,Ki)}),(function(){return kr()&&p("div",{class:"rn",style:"width:"+Sr()+"px"},Mi,Fi)}),(function(){return Er()>0&&p("div",{class:"err"},jr())}),(function(){return xr()&&p("div",{class:"inf"},xr())}),(function(){return Dr()&&p("div",{id:"mod",class:"mod",onClick:function(){return Dr(!1)}},p("div",{class:"pop",onClick:function(e){return e.stopPropagation()}},Or.content))}))}())}();
