!function(){"use strict";let e,t=[];function n(n){function a(t){if(0===arguments.length)return e&&!a.__o.has(e)&&(a.__o.add(e),e.u.push(a)),n;n=t;let i=e;return e=void 0,a.o=new Set(a.__o),a.o.forEach((e=>e.i=!1)),a.o.forEach((e=>{e.i||e()})),e=i,n}return a.$o=1,a.__o=new Set,a.t=t,a}function a(e){e.__c.forEach(a),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),i(e)}function i(e){e.u=[],e.__c=[],e.l=[]}let r=(e,t,n,a)=>{let i={};for(let s=1;s<t.length;s++){let l=t[s],o="number"==typeof l?n[l]:l,c=t[++s];if(1===c)a[0]=o;else if(3===c)a[1]=Object.assign(a[1]||{},o);else if(5===c)(a[1]=a[1]||{})[t[++s]]=o;else if(6===c){let e=t[++s],n=(a[1]=a[1]||{})[e],r=i[e];r||"function"!=typeof o&&"function"!=typeof n||(r=n&&[n]||[],a[1][e]=function(){let e="";for(var t=0;t<r.length;t++)e+="function"==typeof r[t]?r[t].call(this):r[t];return e}),r?r.push(o):a[1][e]+=o+""}else if(c){let t=()=>e.apply(null,r(e,o,n,["",null]));a.push("function"==typeof a[0]?t:t())}else a.push(o)}return a},s=function(e){let t,n,a=1,i="",r="",s=[0],l=e=>{1===a&&(e||(i=i.replace(/^\s*\n\s*|\s*\n\s*$/g,"")))?s.push(e||i,0):3===a&&(e||i)?(s.push(e||i,1),a=2):2===a&&"..."===i&&e?s.push(e,3):2===a&&i&&!e?s.push(!0,5,i):a>=5&&((i||!e&&5===a)&&(s.push(i,a,n),a=6),e&&(s.push(e,a,n),a=6)),i=""};for(let o=0;o<e.length;o++){o&&(1===a&&l(),l(o));for(let c=0;c<e[o].length;c++)t=e[o][c],1===a?"<"===t?(l(),s=[s],a=3):i+=t:4===a?"--"===i&&">"===t?(a=1,i=""):i=t+i[0]:r?t===r?r="":i+=t:'"'===t||"'"===t?r=t:">"===t?(l(),a=1):a&&("="===t?(a=5,n=i,i=""):"/"===t&&(a<5||">"===e[o][c+1])?(l(),3===a&&(s=s[0]),a=s,(s=s[0]).push(a,2),a=0):" "===t||"\t"===t||"\n"===t||"\r"===t?(l(),a=2):i+=t),3===a&&"!--"===i&&(a=4,s=s[0])}return l(),s},l=new Map,o=function(e){let t=l.get(this);return t||(t=new Map,l.set(this,t)),t=r(this,t.get(e)||(t.set(e,t=s(e)),t),arguments,[]),t.length>1?t:t[0]},c=function(){let e=o.apply(this,arguments);if(e)return Array.isArray(e)?this(e):"object"==typeof e?e:this([e])};function u(){let e=c.bind(this);return(this.wrap||e).apply(e,arguments)}let d={},h=[];function f(e){return this.t&&this.t[e.type](e)}d.h=(...e)=>{let t,n=a=>{if(null==a);else if("string"==typeof a)t?d.add(t,a):t=d.s?document.createElementNS("http://www.w3.org/2000/svg",a):document.createElement(a);else if(Array.isArray(a))t||(t=document.createDocumentFragment()),a.forEach(n);else if(a instanceof Node)t?d.add(t,a):t=a;else if("object"==typeof a)d.property(t,a,null,d.s);else if("function"==typeof a)if(t){let e=d.add(t,"");d.insert(t,a,e)}else t=a.apply(null,e.splice(1));else d.add(t,""+a)};return e.forEach(n),t},d.insert=(e,t,n,a,i)=>(e=n&&n.parentNode||e,i=i||a instanceof Node&&a,t===a||(a&&"string"!=typeof a||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?d.subscribe((()=>{a=d.insert(e,t.call({el:e,endMark:n}),n,a,i)})):(n?a&&(i||(i=a.o&&a.o.nextSibling||n.previousSibling),d.rm(e,i,n)):e.textContent="",a=null,t&&!0!==t&&(a=d.add(e,t,n))):(null!=a&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?d.add(e,t,n):e.textContent=t,a=t)),a),d.property=(e,t,n,a,i)=>{if(null!=t)if(!n||"attrs"===n&&(a=!0))for(n in t)d.property(e,t[n],n,a,i);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?d.subscribe((()=>{d.property(e,t.call({el:e,name:n}),n,a,i)})):i?e.style.setProperty(n,t):a||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:d.property(e,t,null,a,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,f):e.removeEventListener(t,f),(e.t||(e.t={}))[t]=n})(e,n,t)},d.add=(e,t,n)=>{let a=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:d.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:d.h(h,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),a},d.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},d.subscribe=function(t){return function(t,n){function r(){let i=e;return e&&e.__c.push(r),a(r),r.i=!0,e=r,n=t(n),e=i,n}function s(){return r.i?e&&r.u.forEach((e=>e())):n=r(),n}t.s=r,i(r),r(),s.$o=1}(t),()=>a(t.s)},d.cleanup=function(t){return e&&e.l.push(t),t},d.root=function(t){let n=e,r=()=>{};e=r,i(r);let s=t((()=>{a(r),e=void 0}));return e=n,s},d.sample=function(t){let n=e;e=void 0;let a=t();return e=n,a},d.hs=(...e)=>{let t=d.s;d.s=!0;let n=m(...e);return d.s=t,n};let m=(...e)=>d.h.apply(d.h,e),p=(...e)=>u.apply(m,e);var v={};function y(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(v,"__esModule",{value:!0});var g=function(){function e(e,t){void 0===e&&(e=0);var n=null==t?void 0:t.grow;this.grow=n&&isFinite(n)&&y(n)||n||0,this.buffer="number"==typeof e?new Uint8Array(y(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var a=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(a<=this.grow){var i=new Uint8Array(a);i.set(this.buffer),this.buffer=i}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var a=t,i=a>>3,r=128>>a%8,s=this.buffer[i];a<n;a++)e(!!(s&r),a),r=1===r?(s=this.buffer[++i],128):r>>1},e}(),w=v.default=g;function b(e,t,n=!1){var a;return(...i)=>{clearTimeout(a),n&&!a&&e.apply(this,i),a=setTimeout((()=>{a=null,n||e.apply(this,i)}),t)}}function k(){document.execCommand("selectAll",!1,null),document.getSelection().collapseToEnd()}function C(){return document.getSelection().focusOffset}const S=e=>document.getElementById(e);const E=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)||e.set(t.id,t),e)),t),x=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)?"online"in t&&e.get(t.id).online(t.online):e.set(t.id,{...t,online:n(t.online)}),delete t.online,e)),t),_=(e,t)=>e.reduce(((e,t)=>{if(e.has(t.id)){let n=e.get(t.id);n.fullname(t.fullname),n.about(t.about),n.md(t.md)}else e.set(t.id,{...t,fullname:n(t.fullname),about:n(t.about),md:n(t.md)});return e}),t);function $(){window.scrollTo(0,document.documentElement.scrollHeight)}const T=(e,t)=>{let n=0,a=0;for(;n<e.length;)a>=t.length&&(a=0),e.set([e[n]^t[a]],n),n++,a++},U=(e,t)=>I(M(e,t),64,24),A=e=>{let{a:t}=D(e);return D(t)},M=(e,t)=>(T(e,t),P(e,t)),D=e=>{let{a:t,k:n}=L(e);return T(t,n),{a:t,k:n}},L=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},P=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},j=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),O=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},I=(e,t=64,n=8)=>M(e,crypto.getRandomValues(new Uint8Array(j(n,t)))),N=e=>(e=>"hsl("+e%360+",100%,30%)")((e=>{var t=0;if(0==e.length)return t;for(var n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t),t&=t;return t})(e+"#"));function K(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&e.length<70}function z(e){return e.length<2||e.length>30?10:/^[0-9a-z_]+$/.test(e)?0:10}function F(){return window.scrollY+window.innerHeight===document.documentElement.scrollHeight}function R(){let e=Intl.DateTimeFormat().resolvedOptions().timeZone;return e&&e.length>0?e:null}function B(e){if(!/^[a-z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1}function q(e){if(!/^[a-z0-9\_]+$/.test(e.key))return e.preventDefault(),!1}function H(e){e.target.value=e.target.value.toLowerCase().replace(/\s/g,"")}function V(e,t=null){return e.length<6?12:t&&e==t?14:void 0}function W(e,t){return!!t&&(e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate())}const Y=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},X=Y(),G="s",Z=["_t","_p","_e","_h","_r","_c","_s","_u","_n","_d","_m"];let J,Q=indexedDB.open(G,1);function ee(e){var t=window.indexedDB.deleteDatabase(e);t.onerror=e=>{},t.onsuccess=e=>{}}Q.onsuccess=e=>{J=Q.result,function(e){let t=e.objectStoreNames;if(t.length!==Z.length)return void ee(G);for(const e of Z)if(!t.contains(e))return void ee(G)}(J),X.complete(J),Q.open?Q.open():Q.open=!0},Q.onerror=e=>{ee(G),location.reload()},Q.onblocked=e=>{},Q.onupgradeneeded=e=>{J=Q.result;let t=J.objectStoreNames;if(t.contains("_s")||J.createObjectStore("_s"),t.contains("_r")||J.createObjectStore("_r"),t.contains("_e")||J.createObjectStore("_e",{keyPath:"id"}),!t.contains("_t")){let e=J.createObjectStore("_t",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1})}if(!t.contains("_p")){J.createObjectStore("_p",{keyPath:"id",autoIncrement:!0}).createIndex("room",["room","id"],{unique:!1})}if(!t.contains("_h")){let e=J.createObjectStore("_h",{keyPath:"id"});e.createIndex("mom",["mom","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1}),e.createIndex("chatid","chatid",{unique:!1})}t.contains("_c")||J.createObjectStore("_c",{keyPath:["chanid","chatid"]}),t.contains("_u")||J.createObjectStore("_u"),t.contains("_n")||J.createObjectStore("_n"),t.contains("_d")||J.createObjectStore("_d"),t.contains("_m")||J.createObjectStore("_m");for(const e of Z)J.objectStoreNames.contains(e)||J.createObjectStore(e)};const te=async(e,t)=>{let n=await X.join();n&&n.transaction(["_s"],"readwrite").objectStore("_s").put(t,e)},ne=async()=>{let e=await X.join();e&&Z.forEach((t=>e.transaction([t],"readwrite").objectStore(t).clear()))},ae=async(e,t)=>{let n=await X.join();if(!n)return;let a=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>{"string"==typeof e.timestamp&&(e.timestamp=new Date(e.timestamp)),a.put(e).onerror=console.error}))},ie=async(...e)=>{let t=await X.join();t&&(await fe(...e),function(e){let n=t.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);n.delete(t).onerror=console.error}))}(e),function(e){let n=t.transaction(["_t"],"readwrite").objectStore("_t"),a=n.index("chanid");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);a.openCursor(t).onsuccess=e=>{var t=e.target.result;t&&(n.delete(t.primaryKey).onerror=console.error,t.continue())}}))}(e.filter((e=>e>0))))},re=async(e,t)=>{let n=await X.join();if(!n)return;let a=n.transaction([e],"readwrite").objectStore(e);return new Promise((e=>{let n=a.put(t);n.onsuccess=t=>{e(t.target.result)},n.onerror=console.error}))},se=async(e,t)=>{let n=await X.join();if(!n)return{value:[],missed:t};if(0===t.length)return{value:[],missed:[]};performance.now();let a=[],i=new Set,r=n.transaction([e],"readonly").objectStore(e),s=0;return new Promise((e=>{t.forEach((n=>{let l=r.get(n);l.onerror=console.error,l.onsuccess=r=>{if(l.result?a.push(l.result):i.add(n),++s===t.length){let t={value:a,missed:Array.from(i)};e(t)}}}))}))},le=async(e,t,n,a,i,r,s="prev")=>{let l=await X.join();if(!l)return;performance.now();let o=[],c=l.transaction([e],"readonly"),[u,d]=t?t(c.objectStore(e),n,i,r):[c.objectStore(e),null],h=0;return new Promise((e=>{u.openCursor(d,s).onsuccess=t=>{var n=t.target.result;if(n){if(o.push(n.value),a&&++h===a)return e(o);n.continue()}else e(o)}}))},oe=(e,t,n,a)=>{let i=n?IDBKeyRange.upperBound(n,a):null;if(!t)return[e,i];let r=n||Number.MAX_VALUE;return e=e.index("room"),i=IDBKeyRange.bound([t.value],[t.value,r],!1,a),[e,i]},ce=(e,t,n,a)=>{let i=n?IDBKeyRange.upperBound(n,a):null;if(!t)return[e,i];let r=n||Number.MAX_VALUE;return i=IDBKeyRange.bound([t.value],[t.value,r],!1,a),[e,i]},ue=async(e,t,n=30,a=!0)=>{let i={value:e};return(await le("_c",ce,i,n,t,a,"prev")).map((e=>e.chatid))},de=async(e,t,n)=>{let a=await X.join();if(!a)return;let i=a.transaction(["_r"],"readwrite").objectStore("_r"),r=i.get(e);r.onerror=console.error,r.onsuccess=async a=>{if(r.result){if(n)return i.put([r.result[0],r.result[1],n],e).onerror=console.error;t[0]<r.result[0]&&(t[0]=r.result[0]),t[1]>r.result[0]&&(t[1]=r.result[1])}i.put(t,e).onerror=console.error}},he=e=>pe(e,"_r"),fe=async(...e)=>ye("_r",...e),me=e=>pe(e,"_s"),pe=async(e,t)=>{let n=await X.join();if(!n)return;let a=n.transaction([t],"readonly").objectStore(t);return new Promise((t=>{let n=a.get(e);n.onerror=console.error,n.onsuccess=e=>t(n.result)}))},ve=async(e,t,n)=>{let a=await X.join();a&&a.transaction([e],"readwrite").objectStore(e).put(n,t)},ye=async(e,...t)=>{let n=await X.join();if(!n)return;let a=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>a.delete(e).onerror=console.error))},ge=(e,t)=>crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:t},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),we=e=>crypto.subtle.importKey("raw",e,{name:"ECDH",namedCurve:"P-256"},!0,[]),be=async()=>await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"]),ke=async(e,t,n)=>await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),Ce=async(e,t,n)=>await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e),Se=new Map,Ee=(e,t,n=!1)=>{let a=Se.get(e)||[];n?a=[t]:a.push(t),Se.set(e,a)},xe=(e,t)=>Se.has(e)?Se.get(e).forEach((e=>e(t))):void 0,_e={},$e=e=>(e&&(Object.assign(_e,e),xe("config",_e)),_e),Te=n(void 0),Ue={id:n(0),name:n(null),chans:n([])};async function Ae(){let e=await me("a");if(!e||e.byteLength<54)return;let t=new Uint8Array(e,0,16),n=new Uint8Array(e,16,32);16===t.length&&(Ue.salt=t),32===n.length&&(Ue.sskey=await crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"]));let a=new Uint8Array(e,48,4),i=new Uint8Array(e,52),r=new DataView(a.buffer).getInt32(48,!1),s=(new TextDecoder).decode(i);r&&s&&(Ue.id(r),Ue.name(s));let l=await me("c");l&&l instanceof Array&&Ue.chans(l);var o=new Uint8Array(20);return o.set(t),o.set(a,16),setTimeout($),o}async function Me(e,t){let n=new TextEncoder,a=await Le(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",a)}async function De(e,t){return await Le((new TextEncoder).encode(e),t)}async function Le(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function Pe(e){let t=new Uint8Array(e.slice(16,20)),n=new Uint8Array(e.slice(20)),a=new DataView(t.buffer).getInt32(0,!1),i=(new TextDecoder).decode(n);Ue.id(a),Ue.name(i),Ue.salt=new Uint8Array(e.slice(0,16)),Ue.sskey=await Le(Te(),Ue.salt),Te(void 0);let r=new Uint8Array(await crypto.subtle.exportKey("raw",Ue.sskey)),s=Ue.salt.length,l=new Uint8Array(s+r.length+t.length+n.length);return l.set(Ue.salt),l.set(r,s),l.set(t,s+r.length),l.set(n,s+r.length+t.length),te("a",l.buffer),{id:a,name:i,tz:R()}}var je,Oe;!function(e){e.Shin=e=>({tag:"Shin",value:e}),e.Shan=e=>({tag:"Shan",value:e}),e.Tree=e=>({tag:"Tree",value:e}),e.NewChat=e=>({tag:"NewChat",value:e}),e.NewUser=e=>({tag:"NewUser",value:e}),e.Login=e=>({tag:"Login",value:e}),e.Logout=e=>({tag:"Logout",value:e}),e.Users=e=>({tag:"Users",value:e}),e.Chans=e=>({tag:"Chans",value:e}),e.Chats=e=>({tag:"Chats",value:e}),e.MuteChan=e=>({tag:"MuteChan",value:e}),e.UnmuteChan=e=>({tag:"UnmuteChan",value:e}),e.AddMems=e=>({tag:"AddMems",value:e}),e.DelChat=e=>({tag:"DelChat",value:e}),e.DelChan=e=>({tag:"DelChan",value:e}),e.EditChat=e=>({tag:"EditChat",value:e}),e.EditChan=e=>({tag:"EditChan",value:e}),e.Mems=e=>({tag:"Mems",value:e}),e.FindUsers=e=>({tag:"FindUsers",value:e}),e.FindMems=e=>({tag:"FindMems",value:e}),e.PushSubs=e=>({tag:"PushSubs",value:e}),e.Ons=e=>({tag:"Ons",value:e}),e.Unpack=e=>({tag:"Unpack",value:e}),e.Tz=e=>({tag:"Tz",value:e}),e.Profile={tag:"Profile"},e.EditProfile=e=>({tag:"EditProfile",value:e}),e.Pwd=e=>({tag:"Pwd",value:e}),e.Email=e=>({tag:"Email",value:e}),e.Au=e=>({tag:"Au",value:e}),e.Signup=e=>({tag:"Signup",value:e}),e.Fp=e=>({tag:"Fp",value:e}),e.EditStatus=e=>({tag:"EditStatus",value:e}),e.Status=e=>({tag:"Status",value:e}),e.ChatThread=e=>({tag:"ChatThread",value:e}),e.ChatList=e=>({tag:"ChatList",value:e}),e.Star=e=>({tag:"Star",value:e}),e.Sdp=e=>({tag:"Sdp",value:e})}(je||(je={})),function(e){e.Shin=e=>({tag:"Shin",value:e}),e.Shan=e=>({tag:"Shan",value:e}),e.Tree=e=>({tag:"Tree",value:e}),e.Treeid=e=>({tag:"Treeid",value:e}),e.Chats=e=>({tag:"Chats",value:e}),e.Chans=e=>({tag:"Chans",value:e}),e.Users=e=>({tag:"Users",value:e}),e.Chat=e=>({tag:"Chat",value:e}),e.Login=e=>({tag:"Login",value:e}),e.MuteChan=e=>({tag:"MuteChan",value:e}),e.UnmuteChan=e=>({tag:"UnmuteChan",value:e}),e.DelChan=e=>({tag:"DelChan",value:e}),e.Update=e=>({tag:"Update",value:e}),e.Updates=e=>({tag:"Updates",value:e}),e.ChanUpdates=e=>({tag:"ChanUpdates",value:e}),e.MemUpdates=e=>({tag:"MemUpdates",value:e}),e.On=e=>({tag:"On",value:e}),e.Ons=e=>({tag:"Ons",value:e}),e.Mems=e=>({tag:"Mems",value:e}),e.Err=e=>({tag:"Err",value:e}),e.NewChan=e=>({tag:"NewChan",value:e}),e.FindUsers=e=>({tag:"FindUsers",value:e}),e.FindMems=e=>({tag:"FindMems",value:e}),e.Logout=e=>({tag:"Logout",value:e}),e.AddMems=e=>({tag:"AddMems",value:e}),e.Unpack=e=>({tag:"Unpack",value:e}),e.Profile=e=>({tag:"Profile",value:e}),e.Pwd=e=>({tag:"Pwd",value:e}),e.Name=e=>({tag:"Name",value:e}),e.Signup=e=>({tag:"Signup",value:e}),e.Typing=e=>({tag:"Typing",value:e}),e.Status=e=>({tag:"Status",value:e}),e.ChatThread=e=>({tag:"ChatThread",value:e}),e.ChatList=e=>({tag:"ChatList",value:e}),e.Sdp=e=>({tag:"Sdp",value:e})}(Oe||(Oe={}));const Ie=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),Ne=(e,t)=>{const{view:{buffer:n},pos:a}=e,i=n.byteLength;if(i-a>t)return e;const r=Math.max(2*i,i+t),s=new Uint8Array(r);return s.set(new Uint8Array(n)),Ie(s.buffer,a,e.littleEndian)},Ke=(e,t)=>{e=Ne(e,1);const{view:n,pos:a}=e;return n.setUint8(a,t),e.pos+=1,e},ze=(e,t)=>{e=Ne(e,4);const{view:n,pos:a,littleEndian:i}=e;return n.setUint32(a,t,i),e.pos+=4,e},Fe=(e,t)=>{e=Ne(e,2);const{view:n,pos:a,littleEndian:i}=e;return n.setUint16(a,t,i),e.pos+=2,e};function Re(e,t){const{view:n,pos:a,littleEndian:i}=e;return n.setUint32(i?a:a+4,t,i),n.setUint32(i?a+4:a,0,i),e.pos+=8,e}const Be=(e,t)=>{e=Ne(e,4);const{view:n,pos:a,littleEndian:i}=e;return n.setInt32(a,t,i),e.pos+=4,e},qe=new TextEncoder,He="encodeInto"in qe?(e,t)=>qe.encodeInto(e,t).written:(e,t)=>{const n=qe.encode(e);return t.set(n),n.length},Ve=(e,t)=>{e=Ne(e,3*t.length+8);const n=He(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=Re(e,n)).pos+=n,e},We=(e,t)=>Ke(e,t?1:0),Ye=e=>(t,n)=>n.reduce(e,((e,t)=>Re(Ne(e,8),t))(t,n.length)),Xe=e=>(t,n)=>null===n?Ke(t,0):e(Ke(t,1),n),Ge=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},Ze=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=2,n.getUint16(t,a)},Je=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getUint32(t,a)},Qe=e=>{const{view:t,pos:n,littleEndian:a}=e;return e.pos+=8,t.getUint32(a?n:n+4,a)},et=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getInt32(t,a)},tt=e=>1===Ge(e),nt=e=>t=>1===Ge(t)?e(t):null,at=e=>t=>{const n=Qe(t),a=new Array;for(let i=0;i<n;i++)a.push(e(t));return a},it=new TextDecoder,rt=e=>{const t=Qe(e),{pos:n,view:{buffer:a}}=e,i=it.decode(new Uint8Array(a,n,t));return e.pos+=t,i},st=Ye(Be),lt=Xe(Ve),ot=Xe(st),ct=Xe(Be),ut=Xe(We),dt=Xe(((e,{id:t,lo:n})=>Be(Be(e,t),n))),ht=Ye(Ve),ft=Xe(ht),mt=Ye(Ke),pt=Xe(((e,t)=>{e=Ne(e,8);const{view:n,pos:a,littleEndian:i}=e;return n.setFloat64(a,t,i),e.pos+=8,e})),vt=Xe(mt),yt=Xe(Fe),gt=(e,{id:t,txt:n,by:a,chanid:i,dir:r,timestamp:s,men:l,re:o,nor:c,star:u})=>ut(ct(ct(ot(Ve(st(Be(Be(Ve(Be(e,t),n),a),i),r),s),l),o),c),u),wt=(Ye(gt),Ye(((e,{id:t,fullname:n,mom:a,by:i,dir:r,md:s,timestamp:l,chatid:o,about:c,to:u,re:d})=>ct(ot(lt(Be(Ve(Fe(st(Be(Be(Ve(Be(e,t),n),a),i),r),s),l),o),c),u),d))),(e,{id:t,name:n,online:a})=>We(Ve(Be(e,t),n),a)),bt=Ye(wt),kt=(Xe(((e,{data:t,chans:n})=>st(mt(e,t),n))),(e,{id:t,action:n,chatid:a,txt:i})=>lt(Be(Fe(Be(e,t),n),a),i)),Ct=(Ye(kt),Ye(((e,{id:t,action:n,chanid:a,name:i,about:r,md:s})=>yt(lt(lt(Be(Fe(Be(e,t),n),a),i),r),s))),Ye(((e,{id:t,action:n,chanid:a,by:i})=>Be(Be(Fe(Be(e,t),n),a),i))),Ye(((e,{chanid:t,users:n})=>bt(Be(e,t),n))),(e,{email:t,fullname:n,about:a})=>lt(lt(lt(e,t),n),a)),St=(e,{i:t,ub:n,lb:a,kw:i})=>lt(ct(ct(Be(e,t),n),a),i),Et=(e,{fr:t,to:n,offer:a,sd:i,ca:r})=>ht(mt(ut(ct(ct(e,t),n),a),i),r),xt=(e,{txt:t})=>Ve(e,t),_t=(e,{st:t,tz:n})=>lt(lt(e,t),n),$t=(e,t)=>{switch(t.tag){case"Shin":return((e,{chanid:t,kw:n,lu:a,cu:i,mu:r,ub:s,lb:l})=>ct(ct(ct(ct(dt(lt(ct(e,t),n),a),i),r),s),l))(ze(e,0),t.value);case"Shan":return((e,{chanid:t,kw:n,cu:a,mu:i,ub:r,lb:s})=>ct(ct(ct(ct(lt(Be(e,t),n),a),i),r),s))(ze(e,1),t.value);case"Tree":return((e,{kw:t,reload:n})=>ut(lt(e,t),n))(ze(e,2),t.value);case"NewChat":return((e,{txt:t,chanid:n,re:a,chname:i,men:r,to:s,emails:l})=>ft(ot(ot(lt(ct(Be(Ve(e,t),n),a),i),r),s),l))(ze(e,3),t.value);case"NewUser":return((e,{name:t,key:n,tz:a,tgid:i,tgname:r,tgfn:s,tgln:l})=>lt(lt(lt(pt(lt(mt(Ve(e,t),n),a),i),r),s),l))(ze(e,4),t.value);case"Login":return((e,{name:t,key:n,tz:a})=>lt(mt(Ve(e,t),n),a))(ze(e,5),t.value);case"Logout":return mt(ze(e,6),t.value);case"Users":return st(ze(e,7),t.value);case"Chans":return st(ze(e,8),t.value);case"Chats":return st(ze(e,9),t.value);case"MuteChan":return Be(ze(e,10),t.value);case"UnmuteChan":return Be(ze(e,11),t.value);case"AddMems":return((e,{chanid:t,userids:n,emails:a})=>ft(ot(Be(e,t),n),a))(ze(e,12),t.value);case"DelChat":return Be(ze(e,13),t.value);case"DelChan":return Be(ze(e,14),t.value);case"EditChat":return((e,{id:t,txt:n})=>Ve(Be(e,t),n))(ze(e,15),t.value);case"EditChan":return((e,{id:t,name:n,about:a,md:i})=>yt(lt(lt(Be(e,t),n),a),i))(ze(e,16),t.value);case"Mems":return st(ze(e,17),t.value);case"FindUsers":return Ve(ze(e,18),t.value);case"FindMems":return((e,{chanid:t,kw:n})=>Ve(Be(e,t),n))(ze(e,19),t.value);case"PushSubs":return((e,{endpoint:t,auth:n,p256dh:a})=>Ve(Ve(Ve(e,t),n),a))(ze(e,20),t.value);case"Ons":return st(ze(e,21),t.value);case"Unpack":return Ve(ze(e,22),t.value);case"Tz":return Ve(ze(e,23),t.value);case"Profile":return ze(e,24);case"EditProfile":return Ct(ze(e,25),t.value);case"Pwd":return((e,{key:t,okey:n})=>vt(mt(e,t),n))(ze(e,26),t.value);case"Email":return Ve(ze(e,27),t.value);case"Au":return Ve(ze(e,28),t.value);case"Signup":return Ve(ze(e,29),t.value);case"Fp":return Ve(ze(e,30),t.value);case"EditStatus":return _t(ze(e,31),t.value);case"Status":return Be(ze(e,32),t.value);case"ChatThread":return St(ze(e,33),t.value);case"ChatList":return St(ze(e,34),t.value);case"Star":return Be(ze(e,35),t.value);case"Sdp":return Et(ze(e,36),t.value)}},Tt=at(et),Ut=nt(rt),At=nt(Tt),Mt=nt(et),Dt=nt(tt),Lt=(nt((e=>({id:et(e),lo:et(e)}))),at(rt)),Pt=(nt(Lt),at(Ge)),jt=(nt((e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=8,n.getFloat64(t,a)})),nt(Pt)),Ot=nt(Ze),It=e=>({id:et(e),txt:rt(e),by:et(e),chanid:et(e),dir:Tt(e),timestamp:rt(e),men:At(e),re:Mt(e),nor:Mt(e),star:Dt(e)}),Nt=at(It),Kt=at((e=>({id:et(e),fullname:rt(e),mom:et(e),by:et(e),dir:Tt(e),md:Ze(e),timestamp:rt(e),chatid:et(e),about:Ut(e),to:At(e),re:Mt(e)}))),zt=e=>({id:et(e),name:rt(e),online:tt(e)}),Ft=at(zt),Rt=nt((e=>({data:Pt(e),chans:Tt(e)}))),Bt=e=>({id:et(e),action:Ze(e),chatid:et(e),txt:Ut(e)}),qt=at(Bt),Ht=at((e=>({id:et(e),action:Ze(e),chanid:et(e),name:Ut(e),about:Ut(e),md:Ot(e)}))),Vt=at((e=>({id:et(e),action:Ze(e),chanid:et(e),by:et(e)}))),Wt=at((e=>({chanid:et(e),users:Ft(e)}))),Yt=e=>({email:Ut(e),fullname:Ut(e),about:Ut(e)}),Xt=e=>({fr:Mt(e),to:Mt(e),offer:Dt(e),sd:Pt(e),ca:Lt(e)}),Gt=e=>({txt:rt(e)}),Zt=e=>({st:Ut(e),tz:Ut(e)}),Jt=e=>{switch(Je(e)){case 0:return Oe.Shin((e=>({chats:Nt(e),chans:Kt(e),users:Ft(e)}))(e));case 1:return Oe.Shan(Tt(e));case 2:return Oe.Tree(Kt(e));case 3:return Oe.Treeid(Tt(e));case 4:return Oe.Chats(Nt(e));case 5:return Oe.Chans(Kt(e));case 6:return Oe.Users(Ft(e));case 7:return Oe.Chat(It(e));case 8:return Oe.Login(Rt(e));case 9:return Oe.MuteChan(Mt(e));case 10:return Oe.UnmuteChan(Mt(e));case 11:return Oe.DelChan(et(e));case 12:return Oe.Update(Bt(e));case 13:return Oe.Updates(qt(e));case 14:return Oe.ChanUpdates(Ht(e));case 15:return Oe.MemUpdates(Vt(e));case 16:return Oe.On(zt(e));case 17:return Oe.Ons(Tt(e));case 18:return Oe.Mems(Wt(e));case 19:return Oe.Err(Ze(e));case 20:return Oe.NewChan(et(e));case 21:return Oe.FindUsers(Ft(e));case 22:return Oe.FindMems(Ft(e));case 23:return Oe.Logout(tt(e));case 24:return Oe.AddMems(tt(e));case 25:return Oe.Unpack(Ut(e));case 26:return Oe.Profile(Yt(e));case 27:return Oe.Pwd(jt(e));case 28:return Oe.Name(Ut(e));case 29:return Oe.Signup(Ze(e));case 30:return Oe.Typing((e=>({by:Mt(e),dir:Tt(e),key:Ut(e),keyCode:Ot(e),anchor:Ze(e),focus:Ze(e),txt:Ut(e),chname:Ut(e),re:Mt(e)}))(e));case 31:return Oe.Status(Zt(e));case 32:return Oe.ChatThread(Tt(e));case 33:return Oe.ChatList(Tt(e));case 34:return Oe.Sdp(Xt(e))}throw new Error("bad variant index for Response")};let Qt=Ie(new ArrayBuffer(512));const en=(e,t)=>(Qt.pos=0,Qt=t(Qt,e),new Uint8Array(Qt.view.buffer).slice(0,Qt.pos)),tn=(e,t)=>t(Ie(e)),nn=e=>tn(e.buffer,Jt),an=e=>en(e,$t),rn=e=>en(e,xt),sn=e=>tn(e.buffer,Gt),ln=e=>new Zlib.RawInflate(e).decompress(),on=e=>new Zlib.RawDeflate(e).compress();async function cn(e,t){let n=new Uint8Array(e),a=n.length,{z:i,c:r,d:s}=$e();if(s){let e=n.subarray(0,12);n=new Uint8Array(await Ce(n.subarray(12),Ue.sskey,e)),T(n,e)}if(r){let e=n.subarray(0,12);n=new Uint8Array(await Ce(n.subarray(12),t,e)),T(n,e)}return i&&(n=ln(n)),(100*a/n.length).toFixed(2),function(e){return nn(e)}(n)}const un=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),dn=un?un.groups.ip:"mx.hyze.io:9898",hn=Y();let fn,mn,pn,vn=!1,yn=500,gn=0,wn=()=>{},bn={recv:e=>wn=e,send:async function(e){await hn.join(),fn.send(await async function(e,t){((e,t)=>{e.length||e.byteLength})(e=an(e));let{z:n,c:a,d:i}=$e();if(n&&(e=on(e)),a){const n=crypto.getRandomValues(new Uint8Array(12));T(e,n),e=O(n,new Uint8Array(await ke(e,t,n)))}if(i){const t=crypto.getRandomValues(new Uint8Array(12));T(e,t),e=O(t,new Uint8Array(await ke(e,Ue.sskey,t)))}return performance.now(),e}(e,pn))}};function kn(){vn=!0,gn++,yn+=j(0,gn<16?200:3e3),setTimeout(Cn,yn)}async function Cn(){const e=await async function(){const e=async()=>{mn=await be();let e=await crypto.subtle.exportKey("raw",mn.publicKey);return new Uint8Array(e)};return await(async(e,t)=>{let[n,a]=await Promise.all([e(),t()]);return a?M(n,a):I(n,64,24)})(e,Ae)}();performance.now(),fn=new WebSocket("wss://"+dn),fn.binaryType="arraybuffer",fn.onopen=async()=>{fn.send(e)},fn.onmessage=Sn,fn.onerror=console.error,fn.onclose=kn}async function Sn({data:e}){let t=new Uint8Array(e);$e((e=>{const t=new w(e);return{z:t.get(0),c:t.get(1),d:t.get(2)}})(t));let n=await we(t.slice(1));pn=await ge(mn.privateKey,n),fn.onmessage=En,hn.complete(),vn&&xe("reconnected"),vn=!1}async function En({data:e}){wn(await cn(e,pn))}Cn();function xn(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),a=new Uint8Array(n.length);for(let e=0;e<n.length;++e)a[e]=n.charCodeAt(e);return a}async function _n(){let e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(t){let e=JSON.parse(JSON.stringify(t)),n=await me("s");if(n instanceof ArrayBuffer&&(new TextDecoder).decode(n)==e.keys.auth)return;te("s",(new TextEncoder).encode(e.keys.auth).buffer),xe("subs",e)}else navigator.serviceWorker.getRegistration().then((e=>{e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:xn("BIm2PpzmeMy3pe_VkzyP8Yq-iqG8ay0qLBGcJZNXnq5lOKu1fAyY9xQ2PK2KQjzWulmKu8IzBLmut276h4tIw5k")}).then((e=>{}),(e=>{}))}))}function $n(e,t,n){const{root:a,subscribe:i,sample:r,cleanup:s}=d;null==n&&(n=!t.$t);let l=d.h([]),o=d.add(l,""),c=new Map,u=new Map,h=new Set;function f(e,i){if(null==e)return;let r=u.get(e);return 1===i?(h.delete(e),r||(r=n?a((n=>(c.set(e,n),t(e.$v||e)))):t(e.$v||e),11===r.nodeType&&(r=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let a=Array.from(t);return{nodeType:111,t:a[0],o:a[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(a[t++])}return e}}})(r)||r),u.set(e,r))):-1===i&&h.add(e),((e,t)=>111===e.nodeType?1/t<0?t?d.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(r,i)}function m(e){let t=c.get(e);t&&(t(),c.delete(e)),u.delete(e)}return s(i((t=>{let n=e();return r((()=>{h.clear();let e=Array.from(function(e,t,n,a,i){let r,s,l=new Map,o=new Map;for(r=0;r<t.length;r++)l.set(t[r],r);for(r=0;r<n.length;r++)o.set(n[r],r);for(r=s=0;r!==t.length||s!==n.length;){var c=t[r],u=n[s];if(null===c)r++;else if(n.length<=s)e.removeChild(a(t[r],-1)),r++;else if(t.length<=r)e.insertBefore(a(u,1),a(t[r],0)||i),s++;else if(c===u)r++,s++;else{var d=o.get(c),h=l.get(u);void 0===d?(e.removeChild(a(t[r],-1)),r++):void 0===h?(e.insertBefore(a(u,1),a(t[r],0)||i),s++):(e.insertBefore(a(t[h],1),a(t[r],0)||i),t[h]=null,h>r+1&&r++,s++)}}return n}(o.parentNode,t||[],n,f,o));return h.forEach(m),e}))}))),s((function(){c.forEach((e=>e())),c.clear(),u.clear(),h.clear()})),l}"serviceWorker"in navigator&&(navigator.serviceWorker.register("sw.js").then((()=>{})),navigator.serviceWorker.addEventListener("message",(function(e){e.data.reload&&location.reload()}),!1));const Tn="0VMZYpdgCGL3iKAzDHwocTt97e1hasO2mJNjExq4PvR6XyWSFbIn-5B_8fUukQlr",Un=Tn.split(""),An=new Array(123);for(let e=0;e<Tn.length;e++)An[Tn.charCodeAt(e)]=e;const Mn=e=>{if(e<0)return"-"+Mn(-e);let t=e>>>0,n=e/4294967296>>>0,a="";for(;n>0;)a=Un[63&t]+a,t>>>=6,t|=(63&n)<<26,n>>>=6;let i="";do{i=Un[63&t]+i,t>>>=6}while(t>0);return i+a};var Dn={ntob:Mn,bton:e=>{let t=0;for(let n=0;n<e.length;n++)t=64*t+An[e.charCodeAt(n)];return t}};const Ln=[0,null,"⛩",0],Pn=(()=>{let e=n(Ln);const t=n([e]),a=t=>e(t),i=e=>{let n=t();n[e[0]]!==e&&(n[e[0]]=e),n.splice(e[0]+1),t(n),a(e),location.hash=e[0]>0?Dn.ntob(e[3]):""};return{path:t=>e()[t],paths:t,len:()=>t().length,setpath:a,same:t=>t===e(),cd:i,update:e=>{t([Ln,...e]),a(e[e.length-1]||Ln)},ishome:()=>e()===Ln,home:()=>i(Ln)}})(),jn=[];function On(){!function(e){for(const t of jn)t(e)}(document.location.hash.substr(1))}window.addEventListener("hashchange",On),setTimeout(On);const In=30,Nn=e=>(t,n)=>{if(void 0===t)return e;let a=e.get(t);return n?a?a[n]:void 0:a},Kn=e=>{let t=n(e);return t.add=e=>t().indexOf(e)<0?t([...t(),e]):t(),t.delete=e=>{t().splice(t().indexOf(e),1),t(t())},t.last=()=>t()[t().length-1],t.pop=()=>{let e=t().pop();return t(t()),e},t},zn=n([]),Fn=n([]),Rn=n(0),Bn=n(0),qn=n(0),Hn=n(0),Vn=n(""),Wn=n(""),Yn=n(""),Xn=n(!1),Gn=n(!1),Zn=Nn(new Map),Jn=Nn(new Map),Qn=Nn(new Map),ea={id:0,childids:n([]),childs:Nn(new Map),open:()=>{}},ta=Nn(new Map([[0,ea]])),na=n([]),aa=Kn([]),ia=Kn([]),ra=n([]),sa=n([]),la=n(0),oa=n(null),ca=n(!1),ua=n(""),da=n(!1),ha=Kn([]),fa=Kn([]),ma=Kn([]),pa=n(!0),va=n(null),ya=n(!1),ga=n(!1);n(""),n("");const wa=n(0),ba=n(0),ka=n(0),Ca=n(null),Sa=n(location.hash.substr(1)),Ea=n(null),xa=Kn([]),_a=Nn(new Map),$a=Kn([]),Ta=n(!1),Ua=()=>Fn().length>0?Fn()[Fn().length-1]:0,Aa=(()=>{const e={},t={};return{create:n=>t[n]=new Promise((t=>e[n]=t)),complete:(t,n)=>e[t]?e[t](n):null,join:e=>t[e],joinall:(...e)=>Promise.all(e.map((e=>t[e]))),select:(...e)=>Promise.race(e.map((e=>t[e])))}})(),Ma={content:null},Da=()=>{switch(ka()){case 1:return"please login first";case 2:return"invalid login name or password";case 3:return"email existed";case 4:return"username existed";case 5:return"please select a topic";case 6:return"topic is empty";case 7:return"invalid email address";case 8:return"error adding people";case 9:return"error signing up";case 10:return"invalid name";case 11:return"invalid input";case 12:return"password too short";case 13:return"invalid password";case 14:return"new password is the same with old password";case 15:return"peer offline";case 16:return"You are behind a NAT or firewall, can not create a direct connection to peer"}};function La(...e){return e.includes(ka())}let Pa;const ja=e=>{ka(e),clearTimeout(Pa),Pa=setTimeout((()=>ka(0)),5e3)},Oa=e=>{Ca(e),clearTimeout(Pa),Pa=setTimeout((()=>Ca(null)),5e3)};bn.recv((async e=>{let t=e.value;switch(e.tag){case"Err":ja(t);break;case"Unpack":Aa.complete("unpack",t);break;case"AddMems":Aa.complete("addmems",t);break;case"Logout":$e({d:!1});break;case"NewChan":Hn(t),$();break;case"Shin":if(!t)return;E(t.chats,Jn()),x(t.users,Qn()),_(t.chans,Zn()),ae("_t",t.chats),ae("_h",t.chans),ae("_e",t.users),async function(e){let t=e||[],n=Rn();if(0===t.length)return Xn(!0),de(n,null,!0),void Aa.complete("chatscan",t);Xn(!1),de(n,[t[0],t[t.length-1]]);let a=t.map((e=>({chanid:n,chatid:e})));ae("_c",a),Aa.complete("chatscan",t)}(t.chats.map((e=>e.id)));break;case"Update":{let e=new Set([Rn()]);ii(e,t),e.forEach((e=>ve("_u",e,t.id)));break}case"Updates":t&&t.length&&async function(e){let t=new Set([Rn()]);for(const n of e)ii(t,n);t.forEach((t=>ve("_u",t,e[e.length-1].id)))}(t);break;case"ChanUpdates":t&&t.length&&async function(e){let t=new Set([Rn()]);for(const{action:n,chanid:a,name:i,about:r,md:s}of e)switch(n){case 1:{let e=Zn(a);e&&(null!==i&&e.fullname(i),null!==r&&e.about(r),null!==s&&e.md(s)),e=await pe(a,"_h"),e&&(null!==i&&(e.fullname=i),null!==r&&(e.about=r),null!==s&&(e.md=s),await re("_h",e),e.dir.forEach((e=>t.add(e))));break}case 2:let e=await Qa(a);e&&e.dir.forEach((e=>t.add(e)))}t.forEach((t=>ve("_d",t,e[e.length-1].id)))}(t);break;case"MemUpdates":t&&t.length&&async function(e){let t=new Set([Rn()]),n=new Map;for(const{action:t,chanid:a,by:i}of e)switch(t){case 1:n.has(a)?n.get(a).adds.push(i):n.set(a,{adds:[i],rms:[]});break;case 0:n.has(a)?n.get(a).rms.push(i):n.set(a,{adds:[],rms:[i]})}for(let[e,{adds:a,rms:i}]of n.entries()){let n=await pe(e,"_n");n&&(n=n.filter((e=>i.indexOf(e)<0)),ve("_n",e,Array.from(new Set([...a,...n])))),t.add(e)}si(Hn()||Rn()),t.forEach((t=>ve("_m",t,e[e.length-1].id)))}(t);break;case"Login":if(!t)return ja(2),Te(void 0),void xe("login",!1);await async function({data:e,chans:t}){const n=await Pe(e);re("_e",n),$e({d:!0}),Ue.chans(t),te("c",t)}(t),ci(),xe("login",!0),Ta(!1),Hn(0),ea.childids([]),ni(),Ba();break;case"Pwd":if(!t)return Te(void 0),void Aa.complete("pwd",13);Ue.id()&&await Pe(t),Aa.complete("pwd");break;case"Users":ae("_e",t),Aa.complete("users",t);break;case"Chans":ae("_h",t),Aa.complete("chans",t);break;case"Chat":!async function(e){let t=Fn();if(t.includes(e.id))return;let a=!Zn(e.chanid),i=F();e.by==Ue.id()&&va(e.id);await re("_t",e);let r=(Rn()?e.dir:[0,...e.dir]).map((t=>(de(t,[e.id,e.id]),{chanid:t,chatid:e.id})));ae("_c",r);let s=new Set(Qn().has(e.by)?[]:[e.by]);e.men&&e.men.forEach((e=>{Qn().has(e)||s.add(e)}));let l=e.dir.filter((e=>!Zn(e))),o=new Set(l);await za(s,o),e.re&&wi(e.re);let c=Jn(Ua())||{};e.nor=n(0),e.star=n(!1),e.txt=n(e.txt),e.showby=n(e.by!==c.by),e.first=n(e.chanid!==c.chanid),e.last=n(!1),e.firstre=n(e.re&&e.re!==c.re&&e.re!=c.id),e.lastre=n(!1),e.timestamp=new Date(e.timestamp),Jn().set(e.id,e),t.push(e.id),Fn(t),a&&Ba(!0);i&&$();"ontouchstart"in document.documentElement||oi();e.dir.forEach((async t=>{let n=Zn(t);n&&(n.chatid=e.id),n=await pe(t,"_h"),n&&(n.chatid=e.id,await re("_h",n))}))}(t);break;case"Chats":t.length>0&&ae("_t",t),Aa.complete("chats",t);break;case"Shan":{let e=t;e.length>0?(Gn(!1),await Ra(e)):Gn(!0),Aa.complete("chanscan",e);break}case"Tree":t.length>0&&(ae("_h",t),_(t,Zn())),Aa.complete("scantree",t.map((e=>e.id)));break;case"Treeid":t.length>0&&await Ra(t),Aa.complete("scantree",t);break;case"MuteChan":{let e=t;if(!e)return;let n=Ue.chans();if(n.includes(e))return;n.push(e),Ue.chans(n),await te("c",n),await ie(0,e,...Zn(e,"dir")),ni(),qa(Pn.path(3));break}case"UnmuteChan":{let e=t,n=Ue.chans();if(!n.includes(e))return;const a=n.indexOf(e);a>-1&&n.splice(a,1),Ue.chans(n),await te("c",n),await ie(0,e,...Zn(e,"dir")),ni(),qa(Pn.path(3));break}case"DelChan":Qa(t);break;case"Mems":Aa.complete("memlist",t);break;case"FindUsers":x(t,Qn()),ae("_e",t),Aa.complete("findusers",t);break;case"FindMems":x(t,Qn()),ae("_e",t),Aa.complete("findmems",t);break;case"On":{let{id:e,online:n}=t;if(!e)return;let a=Qn(e);a&&a.online(n);break}case"Ons":t.forEach((e=>Qn(e).online(!0)));break;case"Profile":Aa.complete("profile",t);break;case"Name":Aa.complete("name",t);break;case"Signup":Aa.complete("signup",t);break;case"ChatThread":Aa.complete("thread",t);break;case"ChatList":Aa.complete("list",t);break;case"Status":Aa.complete("status",t);break;case"Sdp":t.offer?async function({fr:e,sd:t,ca:n}){let a=Aa.create("ice"),i=await Si(e),{a:r,k:s}=A(new Uint8Array(t)),{keypair:l,pub:o}=await ki();s=await we(s),i.sharedkey=await ge(l.privateKey,s);let c=(new TextDecoder).decode(ln(r));await i.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:c}));let u=await i.createAnswer();await i.setLocalDescription(u);for(const e of n){const t=new RTCIceCandidate({candidate:e,sdpMid:0,sdpMLineIndex:0});await i.addIceCandidate(t)}t=on((new TextEncoder).encode(i.localDescription.sdp)),t=U(t,o),await a,bn.send(je.Sdp({fr:null,to:e,sd:t,ca:bi,offer:null}))}(t):Aa.complete("offer",t)}})),(e=>{jn.push(e)})((async e=>{Sa(e),Ea(null);let t=xa();if(Ue.id()>0&&(t=[...t,Ue.id()]),await ai(t),"$"===e[0]){let[t,a,i]=e.slice(1).split("/");if(a.length<50)return location.hash="#",Ta(!1);let r=await Aa.create("unpack",bn.send(je.Unpack(a)));if(!r)return location.hash="#",Ta(!1);let s=await Aa.create("name",bn.send(je.Email(r)));switch(t){case"i":if(!s)return function(e,t){const a=n("Log in Telegram");let i={};function r(e){e.preventDefault();let{n:n,p:a}=e.target,r=n.value.trim();mi(z,r)&&mi(V,a.value)&&async function(e,t,n,a,i){await ne();const r=crypto.getRandomValues(new Uint8Array(12)),s=await De(a,r);let l=await Me(n,t),o=O(r,new Uint8Array(await ke(l,s,r))),c=R(),u={name:t,key:o,tz:c,tgid:i.id||null,tgname:i.username||null,tgfn:i.first_name||null,tgln:i.last_name||null};Te(l),bn.send(je.NewUser(u))}(0,r,a.value,t,i)}function s(e){e.preventDefault(),window.Telegram.Login.auth({bot_id:"1850607378",request_access:!0},(e=>{e&&(S("username").value=e.username,a("Log in as "+e.first_name),i=e)}))}Ma.content=m("div",{class:"pi"},m("div",{class:"su"},m("div",{class:"head"},"Sign up"),m("div",{class:"sub"},e),m("form",{onsubmit:r},(()=>La(4,10,12)&&m("div",{class:"erm"},Da())),m("input",{id:"username",type:"text",name:"n",placeholder:"Username",onkeypress:q,onkeyup:H,required:!0,autocomplete:"on",class:()=>La(4,10)&&"er"}),m("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>La(12)&&"er"}),m("script",{async:!0,src:"https://telegram.org/js/telegram-widget.js?15"}),m("div",null,m("button",{onclick:s},a)),m("div",{class:"bn"},m("button",{type:"submit"},"Sign up"))))),Ta(!0)}(r,i),Ee("login",(e=>e?location.hash="#":null));break;case"f":if(s&&(s==Ue.name()||!Ue.id()))return function(e,t,n){async function a(t){t.preventDefault();let{p:a}=t.target;if(mi(V,a.value)){let t=await fi(e,n,a.value);if(t)return ja(t);Oa("password updated"),Ta(!1),location.hash="#"}}Ma.content=m("div",{class:"pi"},m("div",{class:"su"},m("div",{class:"head"},"Reset password"),m("div",{class:"sub"},t),m("form",{onsubmit:a},(()=>La(12)&&m("div",{class:"erm"},Da())),m("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>La(12)&&"er"}),m("div",{class:"bn"},m("button",{type:"submit"},"Submit"))))),Ta(!0)}(s,r,i)}return location.hash="#",Ta(!1)}if("/"===e[0]){let t=Dn.bton(e.slice(1));return Bn(t),Fn([]),async function(e){ti.cb=null;let t=await Aa.create("thread",bn.send(je.ChatThread({i:e,kw:null,ub:null,lb:null})));await Ia(t,"re"),ti.cb=t=>async function(e,t){let n=await Aa.create("thread",bn.send(je.ChatThread({i:e,kw:null,ub:t,lb:null})));return Ia(n)}(e,t)}(t),oi(),void await Ba()}if("&"===e[0]){let t=Dn.bton(e.slice(1));return t==Ue.id()?location.hash="#":(Rn(0),Bn(0),si(0),Hn(0),Fa([]),Fn([]),await ai([t]),Ea(t),await async function(e){let t=await(async(e,t,n,a=!0)=>{let i={value:e};return await le("_p",oe,i,n,t,a,"prev")})(e);$a(t.reverse())}(t),await Ba(),!_a().has(t)&&Qn(t).online()&&Ci(t),void setTimeout((()=>oi()||$()),100))}let a=["!","@","*"].indexOf(e[0]);if(a>-1)return Rn(0),Hn(0),Bn(0),Fn([]),async function(e){ti.cb=null;let t=await Aa.create("list",bn.send(je.ChatList({i:e,kw:null,ub:null,lb:null})));await Ia(t,"re"),ti.cb=t=>async function(e,t){let n=await Aa.create("list",bn.send(je.ChatList({i:e,kw:null,ub:t,lb:null})));return Ia(n)}(e,t)}(a),oi(),void await Ba();if("%"===e[0])return location.hash="#"+Dn.ntob(Number(e.slice(1)));if(!e||!Tn.includes(e[0]))return Rn(0),Bn(0),si(0),Hn(0),Fa([]),await Ba(),ni(),void(document.title="hyze - micro chat for team");let i=Dn.bton(e);if(await Ba(),Rn(i),Hn(0),Bn(0),ni(),!Zn(i))return;let r=Zn(i).dir;Fa([...r,i]),si(i),document.title=Zn(Rn()).fullname()+" - hyze"}));const Ia=async(e,t=null)=>{await Na(e);let a=e[0],i=new Set,r=new Set,s=Fn(),l="re"===t?new Set:new Set(s);switch(e=e.filter((e=>{let t=Jn(e);if(!t)return!1;"function"!=typeof t.txt&&(t.txt=n(t.txt),t.star=n(t.star),t.first=n(!1),t.last=n(!1),t.firstre=n(!1),t.lastre=n(!1),t.showby=n(!1),t.nor=n(t.nor)),"string"==typeof t.timestamp&&(t.timestamp=new Date(t.timestamp)),Qn().has(t.by)||i.add(t.by),t.men&&t.men.forEach((e=>{Qn().has(e)||i.add(e)})),t.dir.forEach((e=>{Zn().has(e)||r.add(e)}));let a=l.has(e);return l.add(e),!a})),await za(i,r),e.reverse(),t){case"re":Fn(e);break;case"pre":Fn(s.concat(e));break;default:Fn(e.concat(s))}let o=Fn();for(let e=0;e<o.length;e++){let t=Jn(o[e-1])||{},n=Jn(o[e+1])||{},a=Jn(o[e]);a.showby(a.by!==t.by),a.first(a.chanid!==t.chanid),a.last(a.chanid!==n.chanid),a.firstre(a.re&&a.re!==t.re&&a.re!=t.id),a.lastre(a.re&&a.re!==n.re)}oi(),a&&S(Dn.ntob(a)+"_").scrollIntoView()},Na=async e=>{e=await Ka(e),e=new Set(e.map((e=>Jn(e,"re"))).filter((e=>e>0&&!Jn().has(e)))),Ka(Array.from(e))},Ka=async e=>{if(0===(e=e.filter((e=>!Jn().has(e)))).length)return e;let{value:t,missed:n}=await se("_t",e);if(E(t,Jn()),n.length>0){let e=await Aa.create("chats",bn.send(je.Chats(n)));E(e,Jn())}return e},za=async(e,t)=>{let n=await se("_e",Array.from(e)),a=await se("_h",Array.from(t));n.value.length&&bn.send(je.Ons(n.value.filter((e=>e.id!=Ue.id())).map((e=>e.id)))),x(n.value,Qn()),_(a.value,Zn()),n.missed.length>0&&Aa.create("users",bn.send(je.Users(n.missed))),a.missed.length>0&&Aa.create("chans",bn.send(je.Chans(a.missed)));let[i,r]=await Aa.joinall("users","chans");i&&x(i,Qn()),r&&_(r,Zn())},Fa=e=>{let t=e.map(((e,t)=>{let n=Zn(e)||{};return[t+1,n.mom,n.fullname,e]}));Pn.update(t)},Ra=async e=>{if(0===(e=e.filter((e=>!Zn().has(e)))).length)return;let{value:t,missed:n}=await se("_h",e);if(_(t,Zn()),n.length>0){let e=await Aa.create("chans",bn.send(je.Chans(n)));_(e,Zn())}};async function Ba(e=null,t=null){if(0===ea.childids().length||e){performance.now();let n=t?[]:await async function(){let e=await le("_h",(e=>[e.index("chatid"),null]));return _(e,Zn()),e.map((e=>e.id))}();n.length<1&&(n=await async function(e=null,t=null){t&&Wn(t);return Aa.create("scantree",bn.send(je.Tree({kw:t,reload:e})))}(e,t)),Ha(n)}}const qa=async(e,t=null,n=null)=>{performance.now(),Ba(null,t);let a=await pe(e,"_d")||null,i=await pe(e,"_m")||null,r=await((e,t=null,n=null,a=null,i=null,r=null)=>{a&&Wn(a);let s=je.Shan({chanid:e,kw:a,ub:i,lb:r,cu:t,mu:n});return Aa.create("chanscan",bn.send(s))})(e,a,i,t,n);n?0===r.length||zn(zn().concat(r)):(0!==r.length||t||xe("nochan"),zn(r));let s=Va(e);s&&(Wa(zn(),s.childs()),s.childids(zn()))};function Ha(e,t=0){const n=e.filter((e=>Zn(e).mom==t));let a=Va(t);a&&((Rn()==t||Rn()&&Zn(Rn())&&Zn(Rn()).dir.includes(t))&&a.open(!0),Wa(n,a.childs()),a.childids(n));for(const t of n)Ha(e,t)}function Va(e){let t=e&&Zn(e)?[0,...Zn(e).dir,e]:[0],n=ta();var a,i;for(i=0;i<t.length;i++){let e=t[i];n.has(e)&&(a=n.get(e),n=a.childs())}return a}function Wa(e,t){return e.reduce(((e,t)=>(e.has(t)||e.set(t,{id:t,childids:n([]),childs:Nn(new Map),open:n(!1)}),e)),t)}const Ya=e=>qa(Pn.path(3),e),Xa=e=>{Yn(e),ni(e)};const Ga=async({id:e,mom:t,name:n})=>{e!==Rn()&&Pn.cd([Pn.path(0)+1,t,n,e])},Za=async e=>{bn.send(je.MuteChan(e))},Ja=async e=>{bn.send(je.UnmuteChan(e))};async function Qa(e){let t=Zn(e);t&&Zn().delete(e),t=await pe(e,"_h"),t&&await(async({id:e,dir:t})=>{let n=await X.join();if(!n)return;let a=[0,...t,e];!function(e){e.forEach((async e=>{fe(e)}))}(a),function(e){let t=n.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);t.delete(n).onerror=console.error}))}(a)})(t);let n=zn(),a=n.indexOf(e);return a>-1&&(n.splice(a,1),zn(n)),t}const ei=async e=>{let t=Yn()||null,n=Rn();performance.now();let a=await he(n)||[];if(a[2]&&e===a[1])return void Xn(!0);if(Xn(!1),!t){let t=await ue(n,e,In);if(a[2]||t.length===In)return void await Ia(t)}let i=await((e=null,t=null,n=null)=>{let a=je.Shin({chanid:Rn(),kw:e,ub:t,lb:n,lu:null,cu:null,mu:null});return Aa.create("chatscan",bn.send(a))})(t,e);i.length>0&&await Ia(i)};let ti={cb:null};async function ni(e=null){ti.cb=null,Xn(!1),qn(0);let t=Rn();performance.now();let n=await he(t)||[],a=e?null:n[0]||null,i=await ue(t,null,In);await Ia(i,"re"),ti.cb=ei;let r={id:await pe(t,"_u")||0,lo:n[1]||0},s=await pe(t,"_d")||null,l=await pe(t,"_m")||null,o=await((e=null,t=null,n=null,a=null,i=null,r=null)=>{let s=je.Shin({chanid:Rn(),kw:a,ub:i,lb:r,lu:e,cu:t,mu:n});return Aa.create("chatscan",bn.send(s))})(r,s,l,e,null,a)||[];await Ia(o,o.length!==In&&0!==i.length&&a?"pre":"re")}async function ai(e){let t=e.filter((e=>!Qn().has(e)));if(t.length){let{value:e,missed:n}=await se("_e",t);if(x(e,Qn()),n.length>0){let e=await Aa.create("users",bn.send(je.Users(n)));e&&x(e,Qn())}bn.send(je.Ons(t.filter((e=>e!=Ue.id()))))}}async function ii(e,{action:t,chatid:n,txt:a}){switch(t){case 1:{let t=Jn(n);t&&t.txt(a),t=await pe(n,"_t"),t&&(t.txt=a,await re("_t",t),t.dir.forEach((t=>e.add(t))));break}case 2:let t=await ri(n);t&&t.dir.forEach((t=>e.add(t)))}}async function ri(e){let t=Jn(e);t&&Jn().delete(e),t=await pe(e,"_t"),t&&await(async({id:e,dir:t})=>{let n=await X.join();if(!n)return;let a=[0,...t];!function(e,t){t.forEach((async t=>{let n=await he(t);n&&n.includes(e)&&fe(t)}))}(e,a),function(e,t){let a=n.transaction(["_c"],"readwrite").objectStore("_c");t.forEach((t=>{let n=IDBKeyRange.only([t,e]);a.delete(n).onerror=console.error}))}(e,a),function(...e){let t=n.transaction(["_t"],"readwrite").objectStore("_t");e.forEach((e=>{t.delete(e).onerror=console.error}))}(e)})(t);let n=Fn(),a=n.indexOf(e);return a>-1&&(n.splice(a,1),Fn(n)),oi(),t}async function si(e){if(!e)return na([]);let t=Zn(e).md()<2?[...Zn(e).dir,e]:[e],{value:n,missed:a}=await se("_n",t),i=[];if(a.length){let e=await Aa.create("memlist",bn.send(je.Mems(a)));for(const t of e){x(t.users,Qn()),ae("_e",t.users);let e=t.users.map((e=>e.id));ve("_n",t.chanid,e),i=[...i,...e]}}let r=Array.from(new Set([...n.flat(),...i]));await ai(r),r.sort((e=>Qn(e).online()?-1:0)),na(r)}async function li(e){let t=await Aa.create("findmems",bn.send(je.FindMems({chanid:Hn()||Rn(),kw:e})));sa(t);let n=t.find((t=>t.name===e));if(n)la(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));la(n?t.indexOf(n):0)}return t.length}function oi(){if(!S("cs"))return;let e=window.innerHeight-S("cs").offsetHeight-(Ue.id()?96:64)-(da()&&ca()?56:da()?32:ca()?24:0),t=S("os");S("cs").childElementCount>2&&(e-=5),t.style.height=e>0?e+"px":"0"}function ci(){const e=Ue.id();let t=Qn(e);t?t.online(!0):Qn().set(e,{id:e,name:Ue.name(),tz:R(),online:n(!0)})}window.onresize=oi,Ee("reconnected",(()=>{ni(),qa(Pn.path(3))}));let ui=new Map;async function di(e){return bn.send(je.Au(e)),Oa("a secret 6-digits otp code has been sent to your registered email"),await Aa.create("enterotp",function(){let e=[...Array(6)].map((e=>m("input",{class:"ot",type:"tel",autocomplete:"chrome-off"}))),t=e[0];t.addEventListener("input",n),setTimeout((()=>t.focus()));for(let t=0;t<e.length;t++){let a=e[t];a.addEventListener("keypress",(function(n){n.keyCode>47&&n.keyCode<58&&(a.value=n.key,t!==e.length-1&&e[t+1].focus()),n.preventDefault()})),a.addEventListener("keydown",(function(n){"Backspace"===n.key&&(a.value="",0!==t&&e[t-1].focus())})),a.addEventListener("keyup",(function(t){if(16===t.keyCode||9==t.keyCode||224==t.keyCode||18==t.keyCode||17==t.keyCode)return;t.target.value.length>1&&n(t);let a=e.map((e=>e.value)).join("");a.length===e.length&&Aa.complete("enterotp",a)}))}function n(e){let t=e.data||e.target.value;t&&1!==t.length&&a(e.target,t)}function a(e,t){e.focus(),e.value=t[0],t=t.substring(1),e.nextElementSibling&&t.length&&a(e.nextElementSibling,t)}Ma.content=m("div",{class:"pi"},m("div",{class:"su otp"},m("div",{class:"head"},"Enter OTP code"),m("div",{class:"sub"},"Please enter the 6-digits code sent to your email"),m("div",{id:"otp"},e))),Ta(!0)}())}async function hi(e,t,n){Zn().clear(),Jn().clear(),Qn().clear(),na([]),await ne();const a=crypto.getRandomValues(new Uint8Array(12)),i=await De(n,a);let r=await Me(t,e),s={name:e,key:O(a,new Uint8Array(await ke(r,i,a))),tz:R()};Te(r),bn.send(je.Login(s))}async function fi(e,t,n,a=null){const i=crypto.getRandomValues(new Uint8Array(12)),r=await De(t,i);let s=a?new Uint8Array(await Me(a,e)):null,l=await Me(n,e),o=O(i,new Uint8Array(await ke(l,r,i)));return Te(l),Aa.create("pwd",bn.send(je.Pwd({key:o,okey:s})))}function mi(e,...t){let n=e(...t);return!n||ja(n)}function pi(){Ma.content=m("div",{class:"pi"},m("div",{class:"su"},m("div",{class:"head"},"Sign up"),m("div",{class:"sub"},"We will send a sign up invitation to your email"),m("form",{onsubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();if(K(n)){let e=await Aa.create("signup",bn.send(je.Signup(n)));if(e)return ja(e);Oa(`an invite code has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Ta(!1)}else ja(7)}},(()=>La(3,7)&&m("div",{class:"erm"},Da())),m("input",{type:"text",name:"m",placeholder:"Your email address",onkeypress:B,onkeyup:H,required:!0,autocomplete:"on",class:()=>La(3,7)&&"er"}),m("div",{class:"bn"},m("button",{type:"submit"},"Sign up"))))),Ta(!0)}function vi(){Ma.content=m("div",{class:"pi"},m("div",{class:"su"},m("div",{class:"head"},"Log in"),m("div",{class:"sub"}),m("form",{onsubmit:async function(e){e.preventDefault();let{m:t,p:n}=e.target,a=t.value.trim();if(K(a))return async function(e,t){let n=ui.has(e)?ui.get(e):await Aa.create("name",bn.send(je.Email(e)));if(ui.set(e,n),!n)return ja(2);hi(n,t,await di(n))}(a,n.value);if(mi(z,a)){let e=await di(a);hi(a,n.value,e)}}},(()=>La(7,10)&&m("div",{class:"erm"},Da())),m("input",{type:"text",name:"m",placeholder:"Username or email",onkeypress:B,onkeyup:H,required:!0,autocomplete:"on",class:()=>La(7,10)&&"er"}),m("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on"}),m("div",{class:"lf fp"},m("a",{onclick:yi},"Forgot password")),m("div",{class:"bn"},m("button",{type:"submit"},"Log in"))))),Ta(!0)}function yi(){Ma.content=m("div",{class:"pi"},m("div",{class:"su"},m("div",{class:"head"},"Forgot password"),m("div",{class:"sub"},"We will send a password reset link to your email"),m("form",{onsubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();K(n)?(Aa.create("forgotpwd",bn.send(je.Fp(n))),Oa(`a password reset link has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Ta(!1)):ja(7)}},(()=>La(7)&&m("div",{class:"erm"},Da())),m("input",{type:"text",name:"m",placeholder:"Your email address",onkeypress:B,onkeyup:H,required:!0,autocomplete:"on",class:()=>La(7)&&"er"}),m("div",{class:"bn"},m("button",{type:"submit"},"Submit"))))),Ta(!0)}Ee("config",(async({d:e})=>{e?(ci(),_n()):Ue.id()&&(Hn(0),Qn(Ue.id())&&Qn(Ue.id()).online(!1),Ue.id(0),Ue.name(null),Ue.chans([]),delete Ue.sskey,delete Ue.salt,await ne(),ea.childids([]),Pn.ishome()?(ni(),Ba()):Pn.home())})),Ee("subs",(function(e){bn.send(je.PushSubs({endpoint:e.endpoint,auth:e.keys.auth,p256dh:e.keys.p256dh}))}));const gi=e=>{Hn()!==e?Hn(e):Hn(0),si(Hn()||Rn()),qn(0)};const wi=async e=>{const t=Jn(e);t&&t.nor(t.nor()+1);const n=await pe(e,"_t");n&&(n.nor=t.nor(),await re("_t",n))};let bi=[];async function ki(){const e=await be(),t=await crypto.subtle.exportKey("raw",e.publicKey);return{keypair:e,pub:new Uint8Array(t)}}async function Ci(e){let t=Aa.create("ice"),n=await Si(e),a=await n.createOffer();await n.setLocalDescription(a);let i=on((new TextEncoder).encode(n.localDescription.sdp)),{keypair:r,pub:s}=await ki();i=U(i,s),await t;let l=await Aa.create("offer",bn.send(je.Sdp({fr:null,to:e,sd:i,ca:bi,offer:!0}))),{a:o,k:c}=A(new Uint8Array(l.sd));c=await we(c),n.sharedkey=await ge(r.privateKey,c);let u=(new TextDecoder).decode(ln(o));n.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:u}));for(const e of l.ca){const t=new RTCIceCandidate({candidate:e,sdpMid:0,sdpMLineIndex:0});await n.addIceCandidate(t)}}async function Si(e){await ai([e]);let t=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});_a().has(e)||xa.add(e),_a().set(e,t),t.onicecandidate=e=>{e.candidate?bi.push(e.candidate.candidate):Aa.complete("ice",bi)},t.onconnectionstatechange=e=>{};let n=t.createDataChannel("p",{negotiated:!0,id:1});return n.binaryType="arraybuffer",n.onopen=e=>{},n.onmessage=async({data:n})=>{let a=F(),i=new Uint8Array(n),r=i.subarray(0,12);i=new Uint8Array(await Ce(i.subarray(12),t.sharedkey,r)),T(i,r);let s=sn(ln(i));s.by=e,s.ts=new Date,s.room=e,($a.last()||{}).by!=e&&(s.showby=!0),s.id=await re("_p",s),Ea()==e&&$a.add(s),a&&setTimeout($),oi()},n.onclose=t=>{var n,a;setTimeout((()=>{if(Qn(e).online())return Ci(e)}),(n=1e3,a=5e3,Math.random()*(a-n)+n))},n.onerror=e=>{},t.send=async e=>{let a=on(rn(e));const i=crypto.getRandomValues(new Uint8Array(12));T(a,i),a=O(i,new Uint8Array(await ke(a,t.sharedkey,i))),n.send(a)},t.open=()=>"open"===n.readyState,t}function Ei({id:e},t){if(!e||qn()===e)return qn(0);t.focus(),qn(e)}const xi=()=>{const e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=b((()=>{let t=e.textContent;t&&t.length>50||(Ya(t),Xa(t))}),200),e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};let t=document.createElement("div");return setTimeout((function(){new IntersectionObserver((t=>{if(t[0].intersectionRatio<=0)return;let n=Va(Rn()).childids(),a=n[n.length-1];if(!a||Gn()||n.length<In)return;let i=e.textContent||null;i&&i.length>50||setTimeout((()=>qa(Pn.path(3),i,a)))}),{}).observe(t)})),p`
        <div class="cn">
            <div class="s">${e}</div>
            <div class="tbl">
                <table>
                    <tbody>
                        ${()=>$n(Va(Rn()).childids,(e=>{let t=Zn(e);return p`
                                    <tr onclick=${()=>Ga(t)}>
                                        <td>
                                            <button onclick=${t=>((e,t)=>{if(e.stopPropagation(),!Ue.id())return vi();Ue.chans().includes(t)?Ja(t):Za(t)})(t,e)}>
                                                ${()=>Ue.chans().includes(e)?"➕":"➖"}
                                            </button>
                                        </td>
                                        <td>${t.fullname}</td>
                                    </tr>
                                `}))}
                        ${t}
                    </tbody>
                </table>
            </div>
        </div>
    `};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function _i(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{o(a.next(e))}catch(e){r(e)}}function l(e){try{o(a.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}o((a=a.apply(e,t||[])).next())}))}const $i="formatBlock",Ti=(e,t)=>e.appendChild(t),Ui=e=>document.createElement(e),Ai=e=>document.queryCommandState(e),Mi=(e,t=null)=>document.execCommand(e,!1,t),Di=[{icon:"<b>B</b>",title:"Bold",state:()=>Ai("bold"),result:()=>Mi("bold")},{icon:"<i>I</i>",title:"Italic",state:()=>Ai("italic"),result:()=>Mi("italic")},{icon:"<u>U</u>",title:"Underline",state:()=>Ai("underline"),result:()=>Mi("underline")},{icon:"<strike>S</strike>",title:"Strike-through",state:()=>Ai("strikeThrough"),result:()=>Mi("strikeThrough")},{icon:"&#8220&#8221;",title:"Quote",result:()=>Mi($i,"<blockquote>")},{icon:"&lt;&gt;",title:"Code",result:()=>Mi($i,"<pre>")},{icon:"&#128279;",title:"Link",class:" lk",result:()=>{const e=window.prompt("Enter the link URL");e&&Mi("createLink",e)}},{icon:"🌁",title:"Image",class:" im",result:()=>{const e=window.prompt("Enter the image URL");e&&Mi("insertImage",e)}},{icon:"⏎",title:"Enter to send",class:" en se",result:e=>(pa()?pa(!1):pa(!0),pa()?e.classList.add("se"):e.classList.remove("se"),!0)}],Li="e-b",Pi="e-bs";let ji="",Oi=0,Ii=!1,Ni=n(!1);const Ki=()=>S("tp"),zi=()=>S("pm"),Fi=()=>S("mb"),Ri=e=>{Oi=C();let t=e.textContent,n=t.indexOf(" ",Oi);-1==n&&(n=t.length);var a=/[\S]+$/.exec(t.slice(0,n));return a?a[0]:""},Bi=({id:e,name:t})=>{sa([]),la(0);let n=oa();if(n.spellcheck=!1,n===Fi()){let a=ji?"@"+t:t;n.textContent=ji?((e,t)=>{let n=e.textContent,a=n.indexOf(" ",Oi);-1==a&&(a=n.length);var i=n.slice(0,a).replace(/\S+$/,t);return Oi=i.length,i+n.slice(a)})(n,a):n.textContent+a,n.focus(),ji?function(e,t){var n=document.createRange(),a=window.getSelection();n.setStart(e.childNodes[0],t),n.collapse(!0),a.removeAllRanges(),a.addRange(n)}(n,Oi):k(),Ni(!1),e&&ma.add(e)}else e?ha.add(e):fa.add(ji),n.textContent="",zi().focus()},qi=()=>m("div",{id:"uls",class:function(){return"uls"+(()=>oa()===Fi()&&da()?" ms":"").call(this)}},m("ul",null,$n(sa,(e=>m("li",{id:e.id,tabIndex:"-1",class:()=>sa()[la()]===e?"se":"",onclick:()=>Bi(e),onMouseOver:()=>Ii||la(sa().indexOf(e))},e.id?m("i",{class:function(){return"dot"+(()=>Qn(e.id).online()?" on":"").call(this)}}):null," ",e.name))))),Hi=()=>m("div",{class:function(){return"em sel"+(()=>da()?" sh":"").call(this)},onclick:()=>zi().focus()},$n(fa,(e=>m("div",{class:"tg ie"},e,m("i",{onclick:()=>fa.delete(e)},"✕")))),$n(ha,(e=>m("div",{class:()=>Qn(e).online()?"tg on":"tg"},Qn(e).name,m("i",{onclick:()=>ha.delete(e)},"✕")))),m("div",{class:"wp"},m("div",{id:"pm",class:"e-m"+(fa().length+ha().length===0?" to":""),onkeydown:Vi,oninput:Xi,contentEditable:"true"}),(()=>oa()===zi()&&da()&&sa().length>0&&qi)));function Vi(e){if(!Wi(e)){if(8!=e.keyCode||zi().textContent.length||(ha.pop(),zi().focus()),32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1;"Enter"!==e.key&&"Tab"!==e.key||(Fi().focus(),e.preventDefault())}}function Wi(e){return!!sa().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(Bi(sa()[la()]),e.preventDefault(),!0):27==e.keyCode?(sa([]),la(),Ni(!1),!0):(38==e.keyCode&&(0===la()?la(sa().length-1):la(la()-1),S(sa()[la()].id).focus(),e.preventDefault(),Ii=!0,setTimeout((()=>Ii=!1),300)),40==e.keyCode&&(la()===sa().length-1?la(0):la(la()+1),S(sa()[la()].id).focus(),e.preventDefault(),Ii=!0,setTimeout((()=>Ii=!1),300)),e.target.focus(),!0))}const Yi=b((async e=>{if(ji=Ri(e.target).toLowerCase(),ji.length>50)return;let t=await li(ji),n=Zn(Hn()||Rn()),a=n&&n.md()<2;!t&&K(ji)&&a&&sa([{id:0,name:"✉️ Invite "+ji}])}),100);function Xi(e){oa(zi()),Yi(e)}const Gi=()=>{if(!Ue.id())return null;if(Ua()&&Jn(Ua())&&Hn()==Jn(Ua()).chanid)return null;let e=Zn(Hn());if(!e)return null;F()&&setTimeout($,50);const t=()=>[...e.dir.slice(Pn.len()-2),e.id];return t().length>0&&m("div",{class:"dr",style:()=>"background:"+N(e.id)},$n(t,(e=>m("span",null,m("a",{href:"#"+Dn.ntob(e),innerHTML:Zn(e,"fullname")})))))},Zi=()=>m("div",{id:"tp",class:function(){return"e-t"+(()=>ca()?" sh":"").call(this)},onkeyup:Qi,onkeydown:Ji,contentEditable:"true"}),Ji=e=>{e.target.spellcheck=!1,"Enter"===e.key&&e.preventDefault()},Qi=e=>{ua(e.target.textContent),"Enter"===e.key&&(Fi().focus(),e.preventDefault())},er=()=>!(Hn()||Rn()||da()||ca()),tr=()=>Ue.id()?er()?" ds":"":" hd",nr=()=>m([m("style",null,".e-c[contenteditable]:empty::before { content: '",(()=>{let e,t=`Send a ${da()?"private ":""}message `;return Hn()?e=Zn(Hn()):Rn()&&(e=Zn(Rn())),e?t+(ca()?`on new topic ${ua()?`"${ua()}" `:""}in "${e.fullname()}"`:`in "${e.fullname()}"`):ca()?t+"on new topic "+(ua()?`"${ua()}"`:""):t+"..."}),"'; }"),()=>oa()===Fi()&&Ni()&&sa().length>0&&qi,m("div",{id:"mb",class:"e-c",onkeydown:ir,oninput:rr,onfocus:ar,contentEditable:"true"})]),ar=()=>{if(0!==Fn().length)return er()?(Hn(Jn(Ua()).chanid),void si(Hn())):Hn()||da()||ca()?void 0:(Hn(Jn(Ua()).chanid),void si(Hn()))},ir=e=>{if(oa(Fi()),"@"===e.key&&Ni(!0),!Wi(e)&&"Enter"===e.key){if(e.preventDefault(),pa()&&!e.shiftKey)return void async function(e,t){if(!Ue.id())return ja(1);if(e.innerHTML.length>120)return ja(11);if(t.innerHTML.length>4e3)return ja(11);if(!t.innerHTML.trim())return;if(Ea()){if(!Qn(Ea()).online())return ja(15);if(!_a(Ea()).open())return ja(16);let e={txt:t.innerHTML.trim()};return _a(Ea()).send(e),e.by=Ue.id(),e.ts=new Date,e.room=Ea(),($a.last()||{}).by!=Ue.id()&&(e.showby=!0),e.id=await re("_p",e),$a.add(e),t.textContent="",void oi()}let n=Hn()||Rn(),a=qn()||Bn()||null,i=null;if(e.textContent!==Vn()&&(i=e.textContent,!i.trim().length))return ja(6);if(!(n||da()||i&&i.trim().length))return ja(5);let r=t.innerHTML.trim(),s=null,l=null,o=null;da()&&(ha().length>0&&(s=ha.add(Ue.id()).sort(((e,t)=>e-t))),fa().length>0&&(l=fa())),ma().length>0&&(o=ma().filter((e=>r.indexOf("@"+Qn(e).name)>-1))),bn.send(je.NewChat({txt:r,chanid:n,re:a,chname:i,men:o,to:s,emails:l})),ca(!1),da(!1),e.textContent="",t.textContent="",ua(""),Vn(""),Ei({},t)}(Ki(),Fi());e.target.textContent+="\n\n",k()}},rr=e=>{Fi().spellcheck=!1,Ni()&&sr(e)},sr=b((e=>{(ji=Ri(e.target).toLowerCase(),ji.startsWith("@"))?(ji=ji.replace(/[@'";:,.\/?\\-]/,""),ji.length>50||li(ji)):Ni(!1)}),100),lr=m("div",{class:"e-a"});Di.forEach((e=>{const t=Ui("button");if(t.className=Li+" eb",e.class&&(t.className+=e.class),t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=n=>e.result(t)&&Fi().focus(),e.state){n="click",a=()=>t.classList[e.state()?"add":"remove"](Pi),t.addEventListener(n,a)}var n,a;Ti(lr,t)}));const or=Ui("button");or.className=Li+" md",or.innerHTML="👤",or.title="Private message",or.setAttribute("type","button");const cr=()=>{if(!Ue.id())return vi();let e=F();or.classList.add("se"),da(!0),e&&setTimeout($),oi(),"ontouchstart"in document.documentElement||zi().focus()};or.onclick=()=>da()?(or.classList.remove("se"),da(!1),void oi()):cr();const ur=Ui("button");ur.className="ntb",ur.innerHTML="✏️ New Topic",ur.title="New topic",ur.setAttribute("type","button"),ur.onclick=e=>{if(!Ue.id())return vi();let t=F();ca()?ca(!1):ca(!0),t&&ca()&&setTimeout($),function(e,t){if(ca(e),oi(),e?ur.classList.add("se"):ur.classList.remove("se"),"ontouchstart"in document.documentElement)return;e&&Ki().focus();t&&(Ki().innerText=t,ua(t))}(ca())},Ti(lr,ur),Ti(lr,or),Mi("defaultParagraphSeparator","div");const dr=()=>m("div",{class:function(){return"e"+tr.call(this)}},(()=>qn()?m("div",{class:"re",style:()=>"color:"+N(qn())},m("i",null,"→"),m("b",null,Qn(Jn(qn()).by).name)," ",m("a",{href:"#/"+Dn.ntob(qn())},Jn(qn()).txt)):null),Gi,Zi,Hi,nr,lr),hr=(e,t)=>{let n=S(e+"_").querySelector(".ct");if("true"===n.contentEditable)return n.contentEditable=!1,n.classList.remove("ce"),n.innerHTML=t.txt(),void(n.onclick=()=>!1);n.spellcheck=!1,n.contentEditable=!0,n.classList.add("ce"),n.focus(),n.onclick=e=>{"true"===n.contentEditable&&e.stopPropagation()},n.onkeydown=e=>{if("Tab"===e.key)return document.execCommand("insertHTML",!1,"&#09"),e.preventDefault();if("Escape"===e.key)return n.contentEditable=!1,n.classList.remove("ce"),void(n.innerHTML=t.txt());if("Enter"===e.key){let r=n.innerHTML.trim();e.shiftKey||(e.preventDefault(),n.contentEditable=!1,n.classList.remove("ce"),r!==t.txt()&&(a=t.id,i=r,bn.send(je.EditChat({id:a,txt:i}))))}var a,i}};var fr="0b658dc",mr="0.0.323";function pr({id:e,name:t}){return _i(this,void 0,void 0,(function*(){let{fullname:e,about:n}=yield Aa.create("profile",bn.send(je.Profile));function a(t){t.preventDefault();let{n:a}=t.target,i=a.value.trim()==e?null:a.value.trim(),r=S("ab").textContent.trim();r=r==(n||"")?null:r;let s=function(e,t){return e&&e.length<2?10:t&&t.length>1e3?11:0}(i,r);0===s?(!function(e,t,n=null){Aa.create("saveprofile",bn.send(je.EditProfile({fullname:e,about:t,email:n})))}(i,r),Ta(!1)):ja(s)}Ma.content=p`
        <div class="pi">
            <div class="su">
                <div class="head">Profile</div>
                <div class="sub">${t}</div>
                <form onsubmit=${e=>a(e)}>
                    ${()=>La(10,11)&&p`<div class="erm">${Da()}</div>`}
                    <input
                        value=${e}
                        type="text"
                        name="n"
                        placeholder="Full name"
                        required
                        class=${()=>La(10)&&"er"}
                    />
                    <div id="ab" class="ab" contenteditable="true">${n}</div>
                    <div class="bn"><button type="submit">Save</button></div>
                </form>
            </div>
        </div>
    `,Ta(!0)}))}const vr=(e,t)=>_i(void 0,void 0,void 0,(function*(){if(Ue.id()){if(e.stopPropagation(),!Qn(t).st){let{st:e,tz:a}=yield async function(e){return Aa.create("status",bn.send(je.Status(e)))}(t);Ue.id()==t&&(Qn(t).otz=a,a=R()),Qn(t).st=n(e),Qn(t).tz=n(a)}Ma.content=p`
        <div class="pi">
            <div class="ui">
                <div class="un">
                    <i class="dot${()=>Qn(t).online()?" on":""}"></i>
                    <b style=${()=>Qn(t).online()?"color:"+N(Qn(t).name):""}
                        >${Qn(t).name}</b
                    >
                </div>
                ${t!==Ue.id()?p`<div style="font-size:12px">${Qn(t).st}</div>`:p`<div class="st" contenteditable="true" onblur=${function(e){const{textContent:n}=e.target;if(n&&n.length>50)return ja(11);const a=n&&n.trim().length?n:null;let i=R();const r=Qn(t).otz!=i?i:null;Qn(t).tz(i),Qn(t).st(a),function(e){bn.send(je.EditStatus(e))}({st:a,tz:r})}}>${Qn(t).st}</div>`}
            </div>
            <hr />
            ${()=>{return Qn(t).tz()&&p`<div class="sub"><i>🕑</i> Local time ${e=Qn(t).tz(),(new Date).toLocaleTimeString(Intl.DateTimeFormat().resolvedOptions().locale,{timeZone:e,hour:"numeric",minute:"2-digit"})}</div>`;var e}}
            ${t!==Ue.id()?p`
                      <div class="bt"><i class="fl">💬</i> <a onclick=${()=>(e=>{Ta(!1),cr(),ha([e]),qn(0)})(t)}>Send private message</a></div>
                      <div class="bt">
                          <i>@</i> <a onclick=${()=>(e=>{if(Ta(!1),!Ue.id())return vi();Fi().innerHTML+="@"+Qn(e).name,Fi().focus(),k(Fi()),ma.add(e)})(t)}>Mention <b>${Qn(t).name}</b></a>
                      </div>
                      ${Qn(t).online()&&p`<div class="bt">
                          <i class="fl">↔</i>
                          <a
                              onclick=${()=>{Ta(!1),location.hash="#&"+Dn.ntob(t)}}
                              >Send direct p2p message</a
                          >
                      </div>`}
                  `:p`
                      <div class="bt" onclick=${()=>pr(Qn(t))}><i>✏️</i> <a>Edit profile</a></div>
                      <div class="bt" onclick=${()=>function({name:e}){Ma.content=p`
        <div class="pi">
            <div class="su">
                <div class="head">Change Password</div>
                <div class="sub">${e}</div>
                <form onsubmit=${function(t){return _i(this,void 0,void 0,(function*(){t.preventDefault();let{o:n,p:a}=t.target;if(mi(V,a.value,n.value)){let t=yield di(e),i=yield fi(e,t,a.value,n.value);if(i)return ja(i);Oa("password updated"),Ta(!1)}}))}}>
                    ${()=>La(12,13,14)&&p`<div class="erm">${Da()}</div>`}
                    <input
                        type="password"
                        name="o"
                        placeholder="Old password"
                        required
                        autocomplete="true"
                        class=${()=>La(13)&&"er"}
                    />
                    <input
                        type="password"
                        name="p"
                        placeholder="New password"
                        required
                        autocomplete="true"
                        class=${()=>La(12,14)&&"er"}
                    />
                    <div class="bn"><button type="submit">Submit</button></div>
                </form>
            </div>
        </div>
    `,Ta(!0)}(Qn(t))}><i>🔒</i> <a>Change password</a></div>
                      <div class="bt" onclick=${()=>async function(){Hn(0),na([]),Qn(Ue.id()).online(!1),Zn().clear(),Jn().clear(),await bn.send(je.Logout(Ue.salt)),await ne(),$e({d:!1}),Ta(!1),xe("logout")}()}><i>🚪</i> <a>Sign out</a></div>
                      <div class="v">${mr} ${fr}</div>
                  `}
        </div>
    `,Ta(!0)}})),yr=(e,t)=>{if(e.shiftKey)return((e,t)=>{let n=screen.width/2-300,a=screen.height/2-300;window.open(e,t,`toolbar=yes,location=yes,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=600,height=600,top=${a},left=${n}`)})("#"+Dn.ntob(t),t),e.preventDefault();gi(t),e.stopPropagation()},gr=()=>{const e=n(0),t=n(0);let a=!1;const i=n=>{let{id:i,txt:s,by:l,chanid:o,star:c,men:u,timestamp:d,showby:h,first:f,firstre:m,last:v,lastre:y,re:g,nor:w}=n,b=Dn.ntob(i);function k(){return["ct"].join(" ")}return p`
            <div
                id=${b+"_"}
                class="c${()=>(qn()===i||t()==i?" cur":"")+(Hn()>0&&Hn()!==o?" bl":"")+(((new Date).getTime()-d.getTime())/1e3<60?" nc":"")+(g||w()?" r":"")+(f()||m()&&g!=Bn()?" fr":"")+(v()||y()&&g!=Bn()?" lr":"")}"
                onclick=${e=>((e,t)=>{"ontouchstart"in document.documentElement||gi(t.chanid)})(0,n)}
                ontouchend=${e=>((e,t)=>{a||gi(t.chanid)})(0,n)}
                onmouseover=${t=>e()!==i&&e(i)}
                style=${()=>"border-color:"+N(g||(w()?i:o))}
            >
                ${()=>m()&&g!=Bn()&&Jn(g)?p`
                              <div
                                  class="re"
                                  style=${()=>g||w()?"color:"+N(g||i):""}
                                  onmouseover=${e=>t()!==g&&t(g)}
                                  onmouseout=${e=>t(0)}
                              >
                                  <i>→</i><b>${Qn(Jn(g,"by"),"name")}</b>
                                  <a href="#/${Dn.ntob(g)}" onclick=${e=>e.stopPropagation()}
                                      >${Jn(g,"txt")}</a
                                  >
                              </div>
                          `:null}
                ${()=>h()||f()||m()?p`<div>
                              <a
                                  class="by${()=>Qn(l).online()?" on":""}"
                                  style=${()=>Qn(l).online()?"color:"+N(Qn(l).name):""}
                                  onclick=${e=>vr(e,l)}
                                  >${Qn(l).name}</a
                              >
                          </div>`:null}
                <div class=${()=>c()?" star":""} style=${()=>w()?"color:"+N(i):""}>
                    ${()=>{let e=s();if(u&&u.length)for(const t of u){let n=Qn(t).name,a=Ue.id()==t?"j":Qn(t).online()?"k":"i",i=Qn(t).online()?`style="color:${N(n)}"`:"";e=e.replaceAll("@"+n,`<b onclick="b(${t})" class="${a}" ${i}>@${n}</b>`)}return p`<div class=${k} innerHTML=${e} />`}}
                    ${()=>w()&&i!=Bn()?p`<p class="mr">
                                  <i>→</i
                                  ><a href="#/${b}" onclick=${e=>e.stopPropagation()}
                                      >${w()+(w()>1?" replies":" reply")}</a
                                  >
                              </p>`:null}
                </div>
                ${()=>e()===i&&Ue.id()?r(b,n):null}
            </div>
        `},r=(e,t)=>{const n=e=>{e.preventDefault(),e.stopPropagation();let n=F();Ei(t,Fi()),qn()===t.id?Hn(t.chanid):Hn(0),n&&setTimeout($)};return p`
            <div class="ts">${a=t.timestamp,i=6e4,r=new Date-a,r<i?Math.round(r/1e3)+"s":r<36e5?Math.round(r/i)+"m":a.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{hour:"numeric",minute:"2-digit"})}</div>
            <div class="pm pr" title="reply" ontouchend=${n} onclick=${n}>
                <i>→</i>
                <div class="pu">
                    <div>reply</div>
                </div>
            </div>
            <div class="pm" onclick=${e=>e.stopPropagation()}>
                <i class="i">...</i>
                <div class="pu">
                    <div onclick=${e=>(async e=>{e.star(!e.star()),bn.send(je.Star(e.id));const t=await pe(e.id,"_t");t&&(t.star=e.star(),await re("_t",t))})(t)}>⭐ ${t.star()?"unstar":"star"}</div>
                    <div onclick=${n=>hr(e,t)}>✏️ edit</div>
                    <div onclick=${e=>s(t)}>🗑️ trash</div>
                </div>
            </div>
        `;var a,i,r},s=({id:e,txt:t})=>{confirm('Do you want to delete this chat? \n"'+t()+'"')&&function(e){bn.send(je.DelChat(e)),ri(e)}(e)},l=document.createElement("div");return setTimeout((function(){new IntersectionObserver((e=>{if(e[0].intersectionRatio<=0)return;if(!ti.cb)return;!Fn()[0]||Xn()||Fn().length<In||setTimeout((()=>{if(!ti.cb)return;let e=Fn()[0];!e||Xn()||Fn().length<In||ti.cb(e)}))}),{}).observe(l)})),setTimeout((()=>{S("cs").addEventListener("touchstart",(e=>a=!1),{passive:!0}),S("cs").addEventListener("touchmove",(e=>a=!0),{passive:!0})})),p`
        <div id="os"></div>
        <div id="cs">
            ${l}
            ${()=>{let e=[],t=0,a=null;return Fn().reduce(((e,i)=>W(Jn(i).timestamp,a)?Jn(i).chanid!=t?(t=Jn(i).chanid,e.push(n([i])),e):(e[e.length-1]().push(i),e):(a=Jn(i).timestamp,e.push(n(a)),t=Jn(i).chanid,e.push(n([i])),e)),e),$n(n(e),(e=>{let t=e();if(t instanceof Array){const t=Jn(e()[0]);return p`
                            <div>
                                <div class="tn">
                                    ${()=>(e=>{let t=Zn(e);if(!t)return null;const n=()=>[...t.dir.slice(Pn.len()-2),t.id];return n().length>0&&p`<div class="dr" style=${()=>"background:"+N(e)}>
            ${$n(n,(e=>p`<span
                    ><a
                        href="#${Dn.ntob(e)}"
                        onclick=${t=>yr(t,e)}
                        innerHTML=${Zn(e,"fullname")}
                /></span>`))}
        </div>`})(t.chanid)}
                                    <div class="ts">${n=t.timestamp,n.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}</div>
                                </div>
                                ${$n(e,(e=>Jn(e)&&i(Jn(e))))}
                            </div>
                        `}return p`<div class="date">${function(e){let t=new Date;return W(e,t)?"Today":(t.setDate(t.getDate()-1),W(e,t)?"Yesterday":e.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric"}))}(t)}</div>`;var n}))}}
            ${()=>Qn(Ea())?p`<div>
                          <div class="tn">
                              <div class="dr" style=${()=>"background:"+N(Qn(Ea()).name)}>
                                  <span><a>↔ ${Qn(Ea()).name}</a></span>
                              </div>
                          </div>
                          ${$n($a,(({by:e,txt:t,showby:n})=>Qn(e)?p`
                                        <div class="c" style=${()=>"border-color:"+N(Qn(Ea()).name)}>
                                            ${()=>n?p`<div>
                                                          <a
                                                              class="by${()=>Qn(e).online()?" on":""}"
                                                              style=${()=>Qn(e).online()?"color:"+N(Qn(e,"name")):""}
                                                              onclick=${t=>vr(t,e)}
                                                              >${Qn(e,"name")}</a
                                                          >
                                                      </div>`:null}
                                            <div>${t}</div>
                                        </div>
                                    `:p`<div />`))}
                      </div>`:null}
        </div>
        ${dr}
    `},wr=[["","All messages"],["!","Private messages"],["@","Mentions"],["*","Stars"]],br=()=>{const e=document.createElement("div");e.contentEditable=!0,e.className="s-c",e.oninput=b((t=>{let n=e.textContent;n.length>50||(Ya(n),Xa(n))}),200),e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};const t=e=>m("ul",null,$n(e.childids,(n=>{let a=e.childs(n);return m([m("li",{class:()=>function(e){return[Ue.chans().includes(e)?"":"on",e==Rn()?"se":""].join(" ")}(n),onclick:()=>function(e,t){e.open(!e.open()),Ga(t)}(a,Zn(n))},m("div",{class:"sb"},m("i",null,(()=>a.childids().length?a.open()?"▼":"▶":""))),m("div",{class:"lb"},(()=>function(e){return Zn(e,"md")&&Zn(e,"md")()>1?"🔒":""}(n))," ",Zn(n,"fullname")),m("div",{class:"dot",onclick:e=>((e,t)=>{if(e.stopPropagation(),!Ue.id())return vi();Ue.chans().includes(t)?Ja(t):Za(t)})(e,n)})),()=>a.open()&&a.childids().length?t(a):null])})));return m([m("div",{class:"dn n"},m("i",{onclick:()=>xe("lnclose")},"✕")),m("div",{class:"s"},e),Ue.id()?m("ul",{class:"hm"},(()=>wr.map((e=>m("li",{class:(Sa()[0]||"")==e[0]&&"se",onclick:()=>location.hash=e[0]},e[1]))))):null,$n(xa,(e=>m("div",null,m("div",{class:"tn"},m("div",{class:"dr",style:()=>"background:"+N(Qn(e,"name"))},m("span",null,m("a",{href:"#&"+Dn.ntob(e)},"↔ ",Qn(e,"name")))))))),m("div",{class:"nt"},(()=>ea.childids().length?t(ea):null))])};let kr="",Cr=0,Sr=!1;const Er=()=>{const e=b((async e=>{if(kr=(e=>{Cr=C();let t=e.textContent,n=t.indexOf(" ",Cr);-1==n&&(n=t.length);var a=/[\S]+$/.exec(t.slice(0,n));return a?a[0]:""})(e.target).toLowerCase(),kr&&kr.length>50)return;!await async function(e){let t=await Aa.create("findusers",bn.send(je.FindUsers(e)));ra(t);let n=t.find((t=>t.name===e));if(n)la(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));la(n?t.indexOf(n):0)}return t.length}(kr)&&K(kr)&&ra([{id:0,name:"✉️ Invite "+kr}])}),100),t=m("div",{class:"am",contentEditable:"true",onkeydown:function(e){if(oa(t),a(e))return;8!=e.keyCode||t.textContent.length||(aa.pop(),t.focus());if(32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return void e.preventDefault();"Enter"!==e.key&&"Tab"!==e.key||e.preventDefault()},oninput:e});function n({id:e,name:n}){ra([]),la(0),e?aa.add(e):ia.add(kr),t.textContent="",t.spellcheck=!1,t.focus()}function a(e){return!!ra().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(n(ra()[la()]),e.preventDefault(),!0):27==e.keyCode?(ra([]),la(),!0):(38==e.keyCode&&(0===la()?la(ra().length-1):la(la()-1),S(ra()[la()].id).focus(),e.preventDefault(),Sr=!0,setTimeout((()=>Sr=!1),300)),40==e.keyCode&&(la()===ra().length-1?la(0):la(la()+1),S(ra()[la()].id).focus(),e.preventDefault(),Sr=!0,setTimeout((()=>Sr=!1),300)),e.target.focus(),!0))}const i=()=>m("div",{class:"uls adm"},m("ul",null,$n(ra,(e=>m("li",{id:e.id,tabIndex:"-1",class:()=>ra()[la()]===e?"se":"",onclick:()=>n(e),onMouseOver:()=>function(e){Sr||la(e)}(ra().indexOf(e))},e.id?m("i",{class:function(){return"dot"+(()=>Qn(e.id).online()?" on":"").call(this)}}):null," ",e.name))))),r=m("div",{class:"sel",onclick:()=>t.focus()},$n(ia,(e=>m("div",{class:"tg ie"},e,m("i",{onclick:()=>ia.delete(e)},"✕")))),$n(aa,(e=>m("div",{class:()=>Qn(e).online()?"tg on":"tg"},Qn(e).name,m("i",{onclick:()=>aa.delete(e)},"✕")))),t,(()=>oa()===t&&ra().length>0&&i));return r.focus=()=>t.focus(),r},xr=()=>{const e=["Public","Internal"],t=()=>Hn()?Zn(Hn()):Rn()?Zn(Rn()):null;const n=(e,t)=>{e.stopPropagation(),window.confirm("Do you want to delete this channel?\n"+t.fullname())&&(async e=>{bn.send(je.DelChan(e))})(t.id)},a=()=>t().by===Ue.id(),i=async(e,t)=>{let n=aa().length?aa():null,a=ia().length?ia():null;(n||a)&&(await(async(e,t,n)=>{let a=await Aa.create("addmems",bn.send(je.AddMems({chanid:e,userids:t,emails:n})));return si(e),a})(e,n,a)?(Oa(`added${r()} to ${t()}`),Ta(!1)):ja(8))};function r(){let e=aa().length+ia().length;return e>0?" "+e+(e>1?" people":" person"):""}function s(e,{id:t,fullname:n,about:a,md:i}){e.preventDefault();let{n:r,m:s}=e.target,l=r.value.trim()==n()?null:r.value.trim(),o=s&&s.value.trim()!=i()?s.value.trim():null,c=S("ab").textContent.trim();c=c==(a()||"")?null:c;let u=function(e,t,n){return e&&0===e.length?10:n&&(n>2||n<0)||t&&t.length>1e3?11:0}(l,c,o);0===u?(!function(e,t,n,a){Aa.create("editchan",bn.send(je.EditChan({id:e,name:t,about:n,md:a})))}(t,l,c,o),Ta(!1)):ja(u)}return m([m("div",{class:"dn"},m("i",{onclick:()=>xe("rnclose")},"✕")),m("div",{class:"ub"},(()=>t()&&a()&&m("div",{title:"edit",onclick:()=>{return n=t(),Ma.content=m("div",{class:"pi"},m("div",{class:"su et"},m("div",{class:"head"},"About"),m("div",{class:"sub"},n.fullname),m("form",{onsubmit:e=>s(e,n)},(()=>La(10,11)&&m("div",{class:"erm"},errmsg())),m("input",{value:n.fullname,type:"text",name:"n",placeholder:"topic name",required:!0,class:()=>La(10)&&"er"}),m("div",{id:"ab",class:"ab",contentEditable:"true"},n.about),1==Ue.id()&&n.md()<2?m("select",{name:"m"},e.map(((e,t)=>m("option",{selected:()=>n.md()==t,value:t},e)))):null,m("div",{class:"bn"},m("button",{type:"submit"},"Save"))))),void Ta(!0);var n},class:"ed"},"✎")),m("div",{class:"head"},"About"),m("div",{class:"sub b"},(function(){return t()?t().fullname:""})),m("div",{class:"sub"},(function(){return t()?t().about:""}))),m("div",{class:"ub"},m("div",{class:"he"},"Settings"),m("div",{class:"sub"},(function(){return t()?[...e,"Private"][t().md()]:""}))),m("div",{class:"ft"},m("div",{class:"ub lf"},m("div",{class:"he"},"Members")),(()=>Ue.id()>0&&m("div",{class:"rt"},(()=>t()&&m("button",{title:"add members",onclick:()=>(({id:e,fullname:t})=>{const n=Er();Ma.content=m("div",{class:"pi"},m("div",{class:"amb"},m("div",{class:"head"},"Add people"),m("div",{class:"sub"},t),n,m("div",{class:"bn"},m("button",{onclick:()=>i(e,t)},"Add",r)))),Ta(!0),n.focus()})(t())},"👤"))))),m("div",{class:"uls mem"},m("ul",null,$n(na,(e=>m("li",{id:e,tabIndex:"-1",style:()=>Qn(e).online()?"color:"+N(Qn(e).name):"",onclick:t=>vr(t,e)},e?m("i",{class:function(){return"dot"+(()=>Qn(e).online()?" on":"").call(this)}}):null," ",Qn(e).name))))),()=>t()&&a()&&m("div",{class:"ft dt"},m("div",{class:"ub lf"},m("div",{class:"he"},"Delete")),m("div",{class:"rt"},m("button",{title:"delete topic",onclick:e=>n(e,t())},"🗑️")))])},_r=()=>ya()?localStorage.getItem("w")||185:0,$r=()=>ga()?localStorage.getItem("e")||185:0;function Tr(){const e="0"!==localStorage.getItem("l")&&window.innerWidth>650;ya(e);const t=1==localStorage.getItem("r")&&window.innerWidth>650;ga(t),wa(_r()),ba($r())}function Ur(){ya(!ya()),wa(_r()),localStorage.setItem("l",ya()?1:0)}function Ar(){ga(!ga()),ba($r()),localStorage.setItem("r",ga()?1:0)}Tr(),setTimeout(Tr,100);const Mr=()=>null,Dr=n(Mr);function Lr(){return m("div",{onmousedown:function(e){document.onmousemove=e=>{wa(e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("w",wa())}},class:"dw"})}function Pr(){return m("div",{onmousedown:function(e){document.onmousemove=e=>{ba(document.documentElement.offsetWidth-e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("e",ba())}},class:"de"})}document.querySelector("body").append((()=>{Ee("nochan",(()=>Dr(Mr))),Ee("rnclose",Ar),Ee("lnclose",Ur);function e(){return ya()&&window.innerWidth>650?wa():0}function t(){return ga()&&window.innerWidth>650?ba():0}return m([m("div",{class:"ma",style:function(){return"left:"+e.call(this)+"px;right:"+t.call(this)+"px"}},m("div",{class:"n"},m("div",null,m("ol",{class:"bc"},(()=>$n(Pn.paths,(e=>m("li",null,m("a",{onclick:t=>(e=>{e[0]===Pn.len()-1?Dr()===xi?Dr(Mr):Dr(xi):Pn.cd(e)})(e)},e[2])))))),(()=>Ue.id()?m([m("div",{onclick:Ur,class:"av mv"},m("i",null,"☰")),m("div",{onclick:Ar,class:"av iv"},m("i",null,"ⓘ")),m("div",{onclick:e=>vr(e,Ue.id()),class:"av"},m("i",null,"👨🏻‍💻"))]):m([m("div",{class:"u"},m("a",{onclick:pi},"sign up")),m("div",{class:"m"},m("a",{onclick:vi},"log in"))]))),Dr),gr),()=>ya()&&m("div",{class:"ln",style:function(){return"width:"+("function"==typeof wa?wa.call(this):wa)+"px"}},br,Lr),()=>ga()&&m("div",{class:"rn",style:function(){return"width:"+("function"==typeof ba?ba.call(this):ba)+"px"}},xr,Pr),()=>ka()>0&&m("div",{class:"err"},Da()),()=>Ca()&&m("div",{class:"inf"},Ca()),()=>Ta()&&m("div",{id:"mod",class:"mod",onclick:()=>Ta(!1)},m("div",{class:"pop",onclick:e=>e.stopPropagation()},Ma.content))])})())}();
