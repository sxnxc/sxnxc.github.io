!function(){"use strict";const e=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},t=e(),n="s",a=["_t","_p","_e","_h","_r","_c","_s","_u","_n","_d","_m"];var r;let s=indexedDB.open(n,1);function l(e){console.warn("[db] deleting database",e);var t=window.indexedDB.deleteDatabase(e);t.onerror=t=>{console.error("[db] error deleting database",e,t)},t.onsuccess=()=>{console.warn("[db] deleted database",e)}}s.onsuccess=()=>{r=s.result,console.log("[db] open -",r.name,r.version,r.objectStoreNames),function(e){let t=e.objectStoreNames;if(t.length!==a.length)return console.warn("[db] db store missing"),void l(n);for(const e of a)if(!t.contains(e))return console.warn("[db] db store missing",e),void l(n)}(r),t.complete(r)},s.onerror=e=>{console.error("[db] error",e.target.error),l(n),location.reload()},s.onblocked=e=>{console.log("[db] blocked",e)},s.onupgradeneeded=e=>{console.warn("[db] database upgrade needed from version",e.oldVersion,"->",e.newVersion);let t=(r=s.result).objectStoreNames;if(console.log(t),t.contains("_s")||(console.log("make _ store"),r.createObjectStore("_s")),t.contains("_r")||(console.log("make ranges store"),r.createObjectStore("_r")),t.contains("_e")||(console.log("make users store"),r.createObjectStore("_e",{keyPath:"id"})),!t.contains("_t")){console.log("make chats store");let e=r.createObjectStore("_t",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1})}if(!t.contains("_p")){console.log("make p2p chats store"),r.createObjectStore("_p",{keyPath:"id",autoIncrement:!0}).createIndex("room",["room","id"],{unique:!1})}if(!t.contains("_h")){console.log("make chans store");let e=r.createObjectStore("_h",{keyPath:"id"});e.createIndex("mom",["mom","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1}),e.createIndex("chatid","chatid",{unique:!1})}t.contains("_c")||(console.log("make chanchats store"),r.createObjectStore("_c",{keyPath:["chanid","chatid"]})),t.contains("_u")||(console.log("make updates store"),r.createObjectStore("_u")),t.contains("_n")||(console.log("make chanusers store"),r.createObjectStore("_n")),t.contains("_d")||(console.log("make chanupdates store"),r.createObjectStore("_d")),t.contains("_m")||(console.log("make memupdates store"),r.createObjectStore("_m"));for(const e of a)r.objectStoreNames.contains(e)||(console.warn(`[db] ${e} store missing, creating a dummy one`),r.createObjectStore(e));console.warn("[db] database upgrade complete")};const o=(e,t)=>crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:t},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),i=e=>crypto.subtle.importKey("raw",e,{name:"ECDH",namedCurve:"P-256"},!0,[]),c=async()=>(console.log("[sec] generating key pairs"),await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"])),u=async(e,t,n)=>await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),d=async(e,t,n)=>await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e);let m,h=[];function f(e){function t(n){if(0===arguments.length)return m&&!t.__o.has(m)&&(t.__o.add(m),m.u.push(t)),e;e=n;let a=m;return m=void 0,t.o=new Set(t.__o),t.o.forEach((e=>e.i=!1)),t.o.forEach((e=>{e.i||e()})),m=a,e}return t.$o=1,t.__o=new Set,t.t=h,t}function p(e){e.__c.forEach(p),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),g(e)}function g(e){e.u=[],e.__c=[],e.l=[]}let v={},w=[];function y(e){return this.t&&this.t[e.type](e)}v.h=(...e)=>{let t,n=a=>{if(null==a);else if("string"==typeof a)t?v.add(t,a):t=v.s?document.createElementNS("http://www.w3.org/2000/svg",a):document.createElement(a);else if(Array.isArray(a))t||(t=document.createDocumentFragment()),a.forEach(n);else if(a instanceof Node)t?v.add(t,a):t=a;else if("object"==typeof a)v.property(t,a,null,v.s);else if("function"==typeof a)if(t){let e=v.add(t,"");v.insert(t,a,e)}else t=a.apply(null,e.splice(1));else v.add(t,""+a)};return e.forEach(n),t},v.insert=(e,t,n,a,r)=>(e=n&&n.parentNode||e,r=r||a instanceof Node&&a,t===a||(a&&"string"!=typeof a||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?v.subscribe((()=>{a=v.insert(e,t.call({el:e,endMark:n}),n,a,r)})):(n?a&&(r||(r=a.o&&a.o.nextSibling||n.previousSibling),v.rm(e,r,n)):e.textContent="",a=null,t&&!0!==t&&(a=v.add(e,t,n))):(null!=a&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?v.add(e,t,n):e.textContent=t,a=t)),a),v.property=(e,t,n,a,r)=>{if(null!=t)if(!n||"attrs"===n&&(a=!0))for(n in t)v.property(e,t[n],n,a,r);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?v.subscribe((()=>{v.property(e,t.call({el:e,name:n}),n,a,r)})):r?e.style.setProperty(n,t):a||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:v.property(e,t,null,a,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,y):e.removeEventListener(t,y),(e.t||(e.t={}))[t]=n})(e,n,t)},v.add=(e,t,n)=>{let a=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:v.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:v.h(w,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),a},v.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},v.subscribe=function(e){return function(e,t){function n(){let a=m;return m&&m.__c.push(n),p(n),n.i=!0,m=n,t=e(t),m=a,t}function a(){return n.i?m&&n.u.forEach((e=>e())):t=n(),t}e.s=n,g(n),n(),a.$o=1}(e),()=>p(e.s)},v.cleanup=function(e){return m&&m.l.push(e),e},v.root=function(e){let t=m,n=()=>{};m=n,g(n);let a=e((()=>{p(n),m=void 0}));return m=t,a},v.sample=function(e){let t=m;m=void 0;let n=e();return m=t,n},v.hs=(...e)=>{let t=v.s;v.s=!0;let n=b(...e);return v.s=t,n};let b=(...e)=>v.h.apply(v.h,e);const k=new Map,C=(e,t,n)=>{let a=k.get(e)||[];n?a=[t]:a.push(t),k.set(e,a)},S=(e,t)=>k.get(e)?.forEach((e=>e(t)));var E={};function x(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(E,"__esModule",{value:!0});var _=function(){function e(e,t){void 0===e&&(e=0);var n=null==t?void 0:t.grow;this.grow=n&&isFinite(n)&&x(n)||n||0,this.buffer="number"==typeof e?new Uint8Array(x(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var a=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(a<=this.grow){var r=new Uint8Array(a);r.set(this.buffer),this.buffer=r}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var a=t,r=a>>3,s=128>>a%8,l=this.buffer[r];a<n;a++)e(!!(l&s),a),s=1===s?(l=this.buffer[++r],128):s>>1},e}(),A=E.default=_;function U(e,t,n=!1){var a;return(...r)=>{a&&clearTimeout(a),n&&!a&&e.apply(this,r),a=setTimeout((()=>{a=null,n||e.apply(this,r)}),t)}}function T(){document.execCommand("selectAll",!1,void 0),document.getSelection()?.collapseToEnd()}function D(){var e=document.getSelection();return console.warn(e),e.focusOffset}const M=e=>document.getElementById(e.toString());function L(){window.scrollTo(0,document.documentElement.scrollHeight)}const P=(e,t)=>{let n=0,a=0;for(;n<e.length;)a>=t.length&&(a=0),e.set([e[n]^t[a]],n),n++,a++},O=(e,t)=>B(j(e,t),64,24),I=e=>{let{a:t}=N(e);return N(t)},j=(e,t)=>(P(e,t),K(e,t)),N=e=>{let{a:t,k:n}=$(e);return P(t,n),{a:t,k:n}},$=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},K=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},F=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),z=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},R=e=>(performance.now()-e).toFixed(2),B=(e,t=64,n=8)=>j(e,crypto.getRandomValues(new Uint8Array(F(n,t)))),q=e=>(e=>"hsl("+e%360+",100%,30%)")((e=>{var t=0;if(0==e.length)return t;for(var n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t),t&=t;return t})(e+"#"));function H(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&e.length<70}function V(e){return e.length<2||e.length>30?10:/^[0-9a-z_]+$/.test(e)?0:10}function W(){return window.scrollY+window.innerHeight===document.documentElement.scrollHeight}function Y(){return Intl.DateTimeFormat().resolvedOptions().timeZone}function X(e){if(!/^[a-z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1}function G(e){if(!/^[a-z0-9\_]+$/.test(e.key))return e.preventDefault(),!1}function Z(e){e.target.value=e.target.value.toLowerCase().replace(/\s/g,"")}function J(e,t){return e.length<6?12:t&&e==t?14:void 0}function Q(e,t){return!!t&&(e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate())}const ee=async()=>{let e=await t.join();e&&a.forEach((t=>e.transaction([t],"readwrite").objectStore(t).clear()))},te=async(...e)=>{let n=await t.join();n&&(await oe(...e),function(e){let t=n.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);t.delete(n).onerror=console.error}))}(e),function(e){let t=n.transaction(["_t"],"readwrite").objectStore("_t"),a=t.index("chanid");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);a.openCursor(n).onsuccess=e=>{var n=e.target.result;n&&(t.delete(n.primaryKey).onerror=console.error,n.continue())}}))}(e.filter((e=>e>0))))},ne=async(e,n)=>{let a=await t.join();if(!a)return;console.log("add",e,n);let r=a.transaction([e],"readwrite").objectStore(e);return new Promise((e=>{let t=r.put(n);t.onsuccess=t=>{e(t.target.result)},t.onerror=console.error}))},ae=async(e,n)=>{let a=await t.join();if(!a)return;let r=a.transaction([e],"readwrite").objectStore(e);n.forEach((e=>{"string"==typeof e.timestamp&&(e.timestamp=new Date(e.timestamp)),r.put(e).onerror=console.error}))},re=async(e,n)=>{let a=await t.join();if(!a)return{value:[],missed:n};if(0===n.length)return{value:[],missed:[]};let r=performance.now(),s=[],l=new Set,o=a.transaction([e],"readonly").objectStore(e),i=0;return new Promise((t=>{n.forEach((a=>{let c=o.get(a);c.onerror=console.error,c.onsuccess=()=>{if(c.result?s.push(c.result):l.add(a),++i===n.length){let n={value:s,missed:Array.from(l)};console.log("[db]",`get ${e} in`,R(r),"ms",n),t(n)}}}))}))},se=async(e,n,a)=>{let r=await t.join();if(!r)return;let s=r.transaction(["_r"],"readwrite").objectStore("_r"),l=s.get(e);l.onerror=console.error,l.onsuccess=async()=>{if(l.result){if(a)return s.put([l.result[0],l.result[1],a],e).onerror=console.error;n[0]<l.result[0]&&(n[0]=l.result[0]),n[1]>l.result[0]&&(n[1]=l.result[1])}s.put(n,e).onerror=console.error}},le=e=>ue(e,"_r"),oe=async(...e)=>(async(e,...n)=>{let a=await t.join();if(!a)return;let r=a.transaction([e],"readwrite").objectStore(e);n.forEach((e=>r.delete(e).onerror=console.error))})("_r",...e),ie=async(e,n)=>{let a=await t.join();a&&a.transaction(["_s"],"readwrite").objectStore("_s").put(n,e)},ce=e=>ue(e,"_s"),ue=async(e,n)=>{let a=await t.join();if(!a)return;let r=a.transaction([n],"readonly").objectStore(n);return new Promise((t=>{let n=r.get(e);n.onerror=console.error,n.onsuccess=()=>t(n.result)}))},de=async(e,n,a)=>{let r=await t.join();r&&r.transaction([e],"readwrite").objectStore(e).put(a,n)},me={},he=e=>(e&&(Object.assign(me,e),S("config",me)),me),fe=f(void 0),pe={id:f(0),name:f(""),chans:f([]),salt:new Uint8Array};async function ge(){let e=await ce("a");if(!e||e.byteLength<54)return;let t=new Uint8Array(e,0,16),n=new Uint8Array(e,16,32);16===t.length&&(pe.salt=t),32===n.length&&(pe.sskey=await crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"]));let a=new Uint8Array(e,48,4),r=new Uint8Array(e,52),s=new DataView(a.buffer).getInt32(48,!1),l=(new TextDecoder).decode(r);s&&l&&(pe.id(s),pe.name(l));let o=await ce("c");o&&o instanceof Array&&pe.chans(o),console.log("[au]",pe);var i=new Uint8Array(20);return i.set(t),i.set(a,16),setTimeout(L),i}async function ve(e,t){let n=new TextEncoder,a=await ye(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",a)}async function we(e,t){return await ye((new TextEncoder).encode(e),t)}async function ye(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function be(e){let t=new Uint8Array(e.slice(16,20)),n=new Uint8Array(e.slice(20)),a=new DataView(t.buffer).getInt32(0,!1),r=(new TextDecoder).decode(n);pe.id(a),pe.name(r),pe.salt=new Uint8Array(e.slice(0,16)),pe.sskey=await ye(fe(),pe.salt),fe(void 0);let s=new Uint8Array(await crypto.subtle.exportKey("raw",pe.sskey)),l=pe.salt.length,o=new Uint8Array(l+s.length+t.length+n.length);return o.set(pe.salt),o.set(s,l),o.set(t,l+s.length),o.set(n,l+s.length+t.length),ie("a",o.buffer),{id:a,name:r,tz:Y()}}var ke,Ce;!function(e){e.Shin=e=>({tag:"Shin",value:e}),e.Shan=e=>({tag:"Shan",value:e}),e.Tree=e=>({tag:"Tree",value:e}),e.NewChat=e=>({tag:"NewChat",value:e}),e.NewUser=e=>({tag:"NewUser",value:e}),e.Login=e=>({tag:"Login",value:e}),e.Logout=e=>({tag:"Logout",value:e}),e.Users=e=>({tag:"Users",value:e}),e.Chans=e=>({tag:"Chans",value:e}),e.Chats=e=>({tag:"Chats",value:e}),e.MuteChan=e=>({tag:"MuteChan",value:e}),e.UnmuteChan=e=>({tag:"UnmuteChan",value:e}),e.AddMems=e=>({tag:"AddMems",value:e}),e.DelChat=e=>({tag:"DelChat",value:e}),e.DelChan=e=>({tag:"DelChan",value:e}),e.EditChat=e=>({tag:"EditChat",value:e}),e.EditChan=e=>({tag:"EditChan",value:e}),e.Mems=e=>({tag:"Mems",value:e}),e.FindUsers=e=>({tag:"FindUsers",value:e}),e.FindMems=e=>({tag:"FindMems",value:e}),e.PushSubs=e=>({tag:"PushSubs",value:e}),e.Ons=e=>({tag:"Ons",value:e}),e.Unpack=e=>({tag:"Unpack",value:e}),e.Tz=e=>({tag:"Tz",value:e}),e.Profile={tag:"Profile"},e.EditProfile=e=>({tag:"EditProfile",value:e}),e.Pwd=e=>({tag:"Pwd",value:e}),e.Email=e=>({tag:"Email",value:e}),e.Au=e=>({tag:"Au",value:e}),e.Signup=e=>({tag:"Signup",value:e}),e.Fp=e=>({tag:"Fp",value:e}),e.EditStatus=e=>({tag:"EditStatus",value:e}),e.Status=e=>({tag:"Status",value:e}),e.ChatThread=e=>({tag:"ChatThread",value:e}),e.ChatList=e=>({tag:"ChatList",value:e}),e.Star=e=>({tag:"Star",value:e}),e.Sdp=e=>({tag:"Sdp",value:e})}(ke||(ke={})),function(e){e.Shin=e=>({tag:"Shin",value:e}),e.Shan=e=>({tag:"Shan",value:e}),e.Tree=e=>({tag:"Tree",value:e}),e.Treeid=e=>({tag:"Treeid",value:e}),e.Chats=e=>({tag:"Chats",value:e}),e.Chans=e=>({tag:"Chans",value:e}),e.Users=e=>({tag:"Users",value:e}),e.Chat=e=>({tag:"Chat",value:e}),e.Login=e=>({tag:"Login",value:e}),e.MuteChan=e=>({tag:"MuteChan",value:e}),e.UnmuteChan=e=>({tag:"UnmuteChan",value:e}),e.DelChan=e=>({tag:"DelChan",value:e}),e.Update=e=>({tag:"Update",value:e}),e.Updates=e=>({tag:"Updates",value:e}),e.ChanUpdates=e=>({tag:"ChanUpdates",value:e}),e.MemUpdates=e=>({tag:"MemUpdates",value:e}),e.On=e=>({tag:"On",value:e}),e.Ons=e=>({tag:"Ons",value:e}),e.Mems=e=>({tag:"Mems",value:e}),e.Err=e=>({tag:"Err",value:e}),e.NewChan=e=>({tag:"NewChan",value:e}),e.FindUsers=e=>({tag:"FindUsers",value:e}),e.FindMems=e=>({tag:"FindMems",value:e}),e.Logout=e=>({tag:"Logout",value:e}),e.AddMems=e=>({tag:"AddMems",value:e}),e.Unpack=e=>({tag:"Unpack",value:e}),e.Profile=e=>({tag:"Profile",value:e}),e.Pwd=e=>({tag:"Pwd",value:e}),e.Name=e=>({tag:"Name",value:e}),e.Signup=e=>({tag:"Signup",value:e}),e.Typing=e=>({tag:"Typing",value:e}),e.Status=e=>({tag:"Status",value:e}),e.ChatThread=e=>({tag:"ChatThread",value:e}),e.ChatList=e=>({tag:"ChatList",value:e}),e.Sdp=e=>({tag:"Sdp",value:e})}(Ce||(Ce={}));const Se=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),Ee=(e,t)=>{const{view:{buffer:n},pos:a}=e,r=n.byteLength;if(r-a>t)return e;const s=Math.max(2*r,r+t),l=new Uint8Array(s);return l.set(new Uint8Array(n)),Se(l.buffer,a,e.littleEndian)},xe=(e,t)=>{e=Ee(e,1);const{view:n,pos:a}=e;return n.setUint8(a,t),e.pos+=1,e},_e=(e,t)=>{e=Ee(e,4);const{view:n,pos:a,littleEndian:r}=e;return n.setUint32(a,t,r),e.pos+=4,e},Ae=(e,t)=>{e=Ee(e,2);const{view:n,pos:a,littleEndian:r}=e;return n.setUint16(a,t,r),e.pos+=2,e};function Ue(e,t){const{view:n,pos:a,littleEndian:r}=e;return n.setUint32(r?a:a+4,t,r),n.setUint32(r?a+4:a,0,r),e.pos+=8,e}const Te=(e,t)=>{e=Ee(e,4);const{view:n,pos:a,littleEndian:r}=e;return n.setInt32(a,t,r),e.pos+=4,e},De=new TextEncoder,Me="encodeInto"in De?(e,t)=>De.encodeInto(e,t).written:(e,t)=>{const n=De.encode(e);return t.set(n),n.length},Le=(e,t)=>{e=Ee(e,3*t.length+8);const n=Me(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=Ue(e,n)).pos+=n,e},Pe=(e,t)=>xe(e,t?1:0),Oe=e=>(t,n)=>n.reduce(e,((e,t)=>Ue(Ee(e,8),t))(t,n.length)),Ie=e=>(t,n)=>null===n?xe(t,0):e(xe(t,1),n),je=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},Ne=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=2,n.getUint16(t,a)},$e=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getUint32(t,a)},Ke=e=>{const{view:t,pos:n,littleEndian:a}=e;return e.pos+=8,t.getUint32(a?n:n+4,a)},Fe=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getInt32(t,a)},ze=e=>1===je(e),Re=e=>t=>1===je(t)?e(t):null,Be=e=>t=>{const n=Ke(t),a=new Array;for(let r=0;r<n;r++)a.push(e(t));return a},qe=new TextDecoder,He=e=>{const t=Ke(e),{pos:n,view:{buffer:a}}=e,r=qe.decode(new Uint8Array(a,n,t));return e.pos+=t,r},Ve=Oe(Te),We=Ie(Le),Ye=Ie(Ve),Xe=Ie(Te),Ge=Ie(Pe),Ze=Ie(((e,{id:t,lo:n})=>Te(Te(e,t),n))),Je=Oe(Le),Qe=Ie(Je),et=Oe(xe),tt=Ie(((e,t)=>{e=Ee(e,8);const{view:n,pos:a,littleEndian:r}=e;return n.setFloat64(a,t,r),e.pos+=8,e})),nt=Ie(et),at=Ie(Ae),rt=(e,{id:t,txt:n,by:a,chanid:r,dir:s,timestamp:l,men:o,re:i,nor:c,star:u})=>Ge(Xe(Xe(Ye(Le(Ve(Te(Te(Le(Te(e,t),n),a),r),s),l),o),i),c),u),st=(Oe(rt),Oe(((e,{id:t,fullname:n,mom:a,by:r,dir:s,md:l,timestamp:o,chatid:i,about:c,to:u,re:d})=>Xe(Ye(We(Te(Le(Ae(Ve(Te(Te(Le(Te(e,t),n),a),r),s),l),o),i),c),u),d))),(e,{id:t,name:n,online:a})=>Pe(Le(Te(e,t),n),a)),lt=Oe(st),ot=(Ie(((e,{data:t,chans:n})=>Ve(et(e,t),n))),(e,{id:t,action:n,chatid:a,txt:r})=>We(Te(Ae(Te(e,t),n),a),r)),it=(Oe(ot),Oe(((e,{id:t,action:n,chanid:a,name:r,about:s,md:l})=>at(We(We(Te(Ae(Te(e,t),n),a),r),s),l))),Oe(((e,{id:t,action:n,chanid:a,by:r})=>Te(Te(Ae(Te(e,t),n),a),r))),Oe(((e,{chanid:t,users:n})=>lt(Te(e,t),n))),(e,{email:t,fullname:n,about:a})=>We(We(We(e,t),n),a)),ct=(e,{i:t,ub:n,lb:a,kw:r})=>We(Xe(Xe(Te(e,t),n),a),r),ut=(e,{fr:t,to:n,offer:a,sd:r,ca:s})=>Je(et(Ge(Xe(Xe(e,t),n),a),r),s),dt=(e,{txt:t})=>Le(e,t),mt=(e,{st:t,tz:n})=>We(We(e,t),n),ht=(e,t)=>{switch(t.tag){case"Shin":return((e,{chanid:t,kw:n,lu:a,cu:r,mu:s,ub:l,lb:o})=>Xe(Xe(Xe(Xe(Ze(We(Xe(e,t),n),a),r),s),l),o))(_e(e,0),t.value);case"Shan":return((e,{chanid:t,kw:n,cu:a,mu:r,ub:s,lb:l})=>Xe(Xe(Xe(Xe(We(Te(e,t),n),a),r),s),l))(_e(e,1),t.value);case"Tree":return((e,{kw:t,reload:n})=>Ge(We(e,t),n))(_e(e,2),t.value);case"NewChat":return((e,{txt:t,chanid:n,re:a,chname:r,men:s,to:l,emails:o})=>Qe(Ye(Ye(We(Xe(Te(Le(e,t),n),a),r),s),l),o))(_e(e,3),t.value);case"NewUser":return((e,{name:t,key:n,tz:a,tgid:r,tgname:s,tgfn:l,tgln:o})=>We(We(We(tt(We(et(Le(e,t),n),a),r),s),l),o))(_e(e,4),t.value);case"Login":return((e,{name:t,key:n,tz:a})=>We(et(Le(e,t),n),a))(_e(e,5),t.value);case"Logout":return et(_e(e,6),t.value);case"Users":return Ve(_e(e,7),t.value);case"Chans":return Ve(_e(e,8),t.value);case"Chats":return Ve(_e(e,9),t.value);case"MuteChan":return Te(_e(e,10),t.value);case"UnmuteChan":return Te(_e(e,11),t.value);case"AddMems":return((e,{chanid:t,userids:n,emails:a})=>Qe(Ye(Te(e,t),n),a))(_e(e,12),t.value);case"DelChat":return Te(_e(e,13),t.value);case"DelChan":return Te(_e(e,14),t.value);case"EditChat":return((e,{id:t,txt:n})=>Le(Te(e,t),n))(_e(e,15),t.value);case"EditChan":return((e,{id:t,name:n,about:a,md:r})=>at(We(We(Te(e,t),n),a),r))(_e(e,16),t.value);case"Mems":return Ve(_e(e,17),t.value);case"FindUsers":return Le(_e(e,18),t.value);case"FindMems":return((e,{chanid:t,kw:n})=>Le(Te(e,t),n))(_e(e,19),t.value);case"PushSubs":return((e,{endpoint:t,auth:n,p256dh:a})=>Le(Le(Le(e,t),n),a))(_e(e,20),t.value);case"Ons":return Ve(_e(e,21),t.value);case"Unpack":return Le(_e(e,22),t.value);case"Tz":return Le(_e(e,23),t.value);case"Profile":return _e(e,24);case"EditProfile":return it(_e(e,25),t.value);case"Pwd":return((e,{key:t,okey:n})=>nt(et(e,t),n))(_e(e,26),t.value);case"Email":return Le(_e(e,27),t.value);case"Au":return Le(_e(e,28),t.value);case"Signup":return Le(_e(e,29),t.value);case"Fp":return Le(_e(e,30),t.value);case"EditStatus":return mt(_e(e,31),t.value);case"Status":return Te(_e(e,32),t.value);case"ChatThread":return ct(_e(e,33),t.value);case"ChatList":return ct(_e(e,34),t.value);case"Star":return Te(_e(e,35),t.value);case"Sdp":return ut(_e(e,36),t.value)}},ft=Be(Fe),pt=Re(He),gt=Re(ft),vt=Re(Fe),wt=Re(ze),yt=(Re((e=>({id:Fe(e),lo:Fe(e)}))),Be(He)),bt=(Re(yt),Be(je)),kt=(Re((e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=8,n.getFloat64(t,a)})),Re(bt)),Ct=Re(Ne),St=e=>({id:Fe(e),txt:He(e),by:Fe(e),chanid:Fe(e),dir:ft(e),timestamp:He(e),men:gt(e),re:vt(e),nor:vt(e),star:wt(e)}),Et=Be(St),xt=Be((e=>({id:Fe(e),fullname:He(e),mom:Fe(e),by:Fe(e),dir:ft(e),md:Ne(e),timestamp:He(e),chatid:Fe(e),about:pt(e),to:gt(e),re:vt(e)}))),_t=e=>({id:Fe(e),name:He(e),online:ze(e)}),At=Be(_t),Ut=Re((e=>({data:bt(e),chans:ft(e)}))),Tt=e=>({id:Fe(e),action:Ne(e),chatid:Fe(e),txt:pt(e)}),Dt=Be(Tt),Mt=Be((e=>({id:Fe(e),action:Ne(e),chanid:Fe(e),name:pt(e),about:pt(e),md:Ct(e)}))),Lt=Be((e=>({id:Fe(e),action:Ne(e),chanid:Fe(e),by:Fe(e)}))),Pt=Be((e=>({chanid:Fe(e),users:At(e)}))),Ot=e=>({email:pt(e),fullname:pt(e),about:pt(e)}),It=e=>({fr:vt(e),to:vt(e),offer:wt(e),sd:bt(e),ca:yt(e)}),jt=e=>({txt:He(e)}),Nt=e=>({st:pt(e),tz:pt(e)}),$t=e=>{switch($e(e)){case 0:return Ce.Shin((e=>({chats:Et(e),chans:xt(e),users:At(e)}))(e));case 1:return Ce.Shan(ft(e));case 2:return Ce.Tree(xt(e));case 3:return Ce.Treeid(ft(e));case 4:return Ce.Chats(Et(e));case 5:return Ce.Chans(xt(e));case 6:return Ce.Users(At(e));case 7:return Ce.Chat(St(e));case 8:return Ce.Login(Ut(e));case 9:return Ce.MuteChan(vt(e));case 10:return Ce.UnmuteChan(vt(e));case 11:return Ce.DelChan(Fe(e));case 12:return Ce.Update(Tt(e));case 13:return Ce.Updates(Dt(e));case 14:return Ce.ChanUpdates(Mt(e));case 15:return Ce.MemUpdates(Lt(e));case 16:return Ce.On(_t(e));case 17:return Ce.Ons(ft(e));case 18:return Ce.Mems(Pt(e));case 19:return Ce.Err(Ne(e));case 20:return Ce.NewChan(Fe(e));case 21:return Ce.FindUsers(At(e));case 22:return Ce.FindMems(At(e));case 23:return Ce.Logout(ze(e));case 24:return Ce.AddMems(ze(e));case 25:return Ce.Unpack(pt(e));case 26:return Ce.Profile(Ot(e));case 27:return Ce.Pwd(kt(e));case 28:return Ce.Name(pt(e));case 29:return Ce.Signup(Ne(e));case 30:return Ce.Typing((e=>({by:vt(e),dir:ft(e),key:pt(e),keyCode:Ct(e),anchor:Ne(e),focus:Ne(e),txt:pt(e),chname:pt(e),re:vt(e)}))(e));case 31:return Ce.Status(Nt(e));case 32:return Ce.ChatThread(ft(e));case 33:return Ce.ChatList(ft(e));case 34:return Ce.Sdp(It(e))}throw new Error("bad variant index for Response")};let Kt=Se(new ArrayBuffer(512));const Ft=(e,t)=>(Kt.pos=0,Kt=t(Kt,e),new Uint8Array(Kt.view.buffer).slice(0,Kt.pos)),zt=(e,t)=>t(Se(e)),Rt=e=>zt(e.buffer,$t),Bt=e=>Ft(e,ht),qt=e=>Ft(e,dt),Ht=e=>zt(e.buffer,jt),Vt=e=>new Zlib.RawInflate(e).decompress(),Wt=e=>new Zlib.RawDeflate(e).compress();let Yt,Xt=0,Gt=0;async function Zt(e,t){Xt++,console.groupCollapsed("[ax]","-> [nr] pack",Xt,e);let n=Bt(e);((e,t)=>{if(!e.length&&!e.byteLength)return console.log(e);console.log(t,"Length",e.length||e.byteLength,"bytes"),console.log((Object(e).buffer instanceof ArrayBuffer?e:"string"==typeof e?(new TextEncoder).encode(e):new Uint8ClampedArray(e)).reduce(((e,t,n,a)=>e+(n%16==0?n.toString(16).padStart(6,0)+"  ":" ")+t.toString(16).padStart(2,0)+(n===a.length-1||n%16==15?" ".repeat(3*(15-n%16))+Array.from(a).splice(n-n%16,16).reduce(((e,t)=>e+(t>31&&t<127||t>159?String.fromCharCode(t):".")),"  ")+"\n":"")),""))})(n),console.groupEnd();let{z:a,c:r,d:s}=he();if(a&&(n=Wt(n)),r){const e=crypto.getRandomValues(new Uint8Array(12));P(n,e),n=z(e,new Uint8Array(await u(n,t,e)))}if(s){const e=crypto.getRandomValues(new Uint8Array(12));P(n,e),n=z(e,new Uint8Array(await u(n,pe.sskey,e)))}return Yt=performance.now(),n}async function Jt(e,t){let n=new Uint8Array(e),a=n.length;Gt++,console.log("[ax]","<- [nr]",Gt,a,"bytes in",R(Yt),"ms");let{z:r,c:s,d:l}=he();if(l){let e=n.subarray(0,12);n=new Uint8Array(await d(n.subarray(12),pe.sskey,e)),P(n,e)}if(s){let e=n.subarray(0,12);n=new Uint8Array(await d(n.subarray(12),t,e)),P(n,e)}r&&(n=Vt(n));let o=(100*a/n.length).toFixed(2);return console.log("[ax] unpacked",Gt,`${a} / ${n.length} bytes ${o}% in ${R(Yt)} ms`),function(e){let t=Rt(e);return console.groupCollapsed("[ax]","<- [nr] decode",Gt,t),console.table(t.value),console.groupEnd(),t}(n)}const Qt=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),en=Qt?Qt.groups?.ip:"mx.hyze.io:9898";console.warn(en);const tn=e();let nn,an,rn,sn=performance.now(),ln=!1,on=500,cn=0,un=e=>{},dn={recv:e=>un=e,send:async function(e){await tn.join(),nn.send(await Zt(e,rn))}};function mn(){ln=!0,cn++,on+=F(0,cn<16?200:3e3),console.groupEnd(),console.groupEnd(),console.group("[ws]",`retry ${cn} in ${(on/1e3).toFixed(2)} sec`),setTimeout(hn,on)}async function hn(){const e=await async function(){const e=async()=>{an=await c();let e=await crypto.subtle.exportKey("raw",an.publicKey);return new Uint8Array(e)},t=await(async(e,t)=>{let[n,a]=await Promise.all([e(),t()]);return a?j(n,a):B(n,64,24)})(e,ge);return console.log(`[ws] offer in ${R(sn)} ms`),t}();nn=new WebSocket(`wss://${en}`),nn.binaryType="arraybuffer",nn.onopen=async()=>{console.log(`[ws] open in ${R(sn)} ms`),nn.send(e),console.log("[ws] -> send offer")},nn.onmessage=fn,nn.onerror=console.error,nn.onclose=mn}async function fn({data:e}){console.log(`[ws] <- received answer in ${R(sn)} ms`);let t=new Uint8Array(e),n=he((e=>{const t=new A(e);return{z:t.get(0),c:t.get(1),d:t.get(2)}})(t));console.log(n);let a=await i(t.slice(1));rn=await o(an.privateKey,a),nn.onmessage=pn,tn.complete(),ln&&S("reconnected"),ln=!1}async function pn({data:e}){un(await Jt(e,rn))}console.groupCollapsed("[ws]","starting..."),hn();function gn(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),a=new Uint8Array(n.length);for(let e=0;e<n.length;++e)a[e]=n.charCodeAt(e);return a}async function vn(){let e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(t){let e=JSON.parse(JSON.stringify(t)),n=await ce("s");if(n instanceof ArrayBuffer&&(new TextDecoder).decode(n)==e.keys.auth)return;ie("s",(new TextEncoder).encode(e.keys.auth).buffer),S("subs",e)}else console.log("no valid subscription"),navigator.serviceWorker.getRegistration().then((e=>{e?.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:gn("BIm2PpzmeMy3pe_VkzyP8Yq-iqG8ay0qLBGcJZNXnq5lOKu1fAyY9xQ2PK2KQjzWulmKu8IzBLmut276h4tIw5k")}).then((e=>{console.log("push subscription",e)}),(e=>{console.log("error getting push permission",e)}))}))}"serviceWorker"in navigator&&(navigator.serviceWorker.register("sw.js").then((()=>{console.log("[sw] registered")})),navigator.serviceWorker.addEventListener("message",(function(e){e.data.reload&&location.reload()}),!1));const wn="0VMZYpdgCGL3iKAzDHwocTt97e1hasO2mJNjExq4PvR6XyWSFbIn-5B_8fUukQlr",yn=wn.split(""),bn=new Array(123);for(let e=0;e<wn.length;e++)bn[wn.charCodeAt(e)]=e;const kn=e=>{if(e<0)return`-${kn(-e)}`;let t=e>>>0,n=e/4294967296>>>0,a="";for(;n>0;)a=yn[63&t]+a,t>>>=6,t|=(63&n)<<26,n>>>=6;let r="";do{r=yn[63&t]+r,t>>>=6}while(t>0);return r+a};var Cn={ntob:kn,bton:e=>{let t=0;for(let n=0;n<e.length;n++)t=64*t+bn[e.charCodeAt(n)];return t}};const Sn={i:0,mom:null,fullname:"⛩",id:0},En=(()=>{const e=f(Sn),t=f([Sn]),n=n=>{let a=t();a[n.i]!==n&&(a[n.i]=n),a.splice(n.i+1),t(a),e(n),location.hash=n.i>0?Cn.ntob(n.id):""};return{path:()=>e(),i:()=>e().i,id:()=>e().id,paths:t,len:()=>t().length,same:t=>t===e(),cd:n,update:n=>{t([Sn,...n]),e(n[n.length-1]||Sn)},ishome:()=>e()===Sn,home:()=>n(Sn)}})(),xn=async(e,n,a,r,s,l,o="prev")=>{let i=await t.join();if(!i)return[];let c=performance.now(),u=[],d=i.transaction([e],"readonly").objectStore(e),{store:m,bound:h}=n?n(d,a,s,l):{store:d,bound:null},f=0;return new Promise((t=>{m.openCursor(h,o).onsuccess=n=>{var l=n.target.result;if(l){if(u.push(l.value),r&&++f===r)return console.log("[db] scan",e,a,s||"",r,"in",R(c),"ms",{value:u}),t(u);l.continue()}else console.log("[db] scan",e,a,s||"",r,"in",R(c),"ms",{value:u}),t(u)}}))},_n=(e,t,n,a)=>{let r=n?IDBKeyRange.upperBound(n,a):null;if(!t)return{store:e,bound:r};let s=n||Number.MAX_VALUE,l=e.index("room");return r=IDBKeyRange.bound([t.value],[t.value,s],!1,a),{store:l,bound:r}},An=(e,t,n,a)=>{let r=n?IDBKeyRange.upperBound(n,a):null;if(!t)return{store:e,bound:r};let s=n||Number.MAX_VALUE;return r=IDBKeyRange.bound([t.value],[t.value,s],!1,a),{store:e,bound:r}},Un=async(e,t,n=30,a=!0)=>{let r={value:e};return(await xn("_c",An,r,n,t,a,"prev")).map((e=>e.chatid))};function Tn(e){return t=>void 0===t?e:e.get(t)}function Dn(){let e=f([]);return e.add=t=>e().indexOf(t)<0?e([...e(),t]):e(),e.delete=t=>{e().splice(e().indexOf(t),1),e(e())},e.last=()=>e()[e().length-1],e.pop=()=>{let t=e().pop();return e(e()),t},e}function Mn(e){return{id:e.id,by:e.by,chanid:e.chanid,dir:e.dir,timestamp:new Date(e.timestamp),men:e.men,re:e.re,txt:f(e.txt),star:f(e.star),first:f(!1),last:f(!1),firstre:f(!1),lastre:f(!1),showby:f(!1),nor:f(e.nor)}}const Ln=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)||e.set(t.id,Mn(t)),e)),t),Pn=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)?"online"in t&&e.get(t.id).online(t.online):e.set(t.id,{id:t.id,name:t.name,online:f(t.online),tz:f(""),st:f("")}),delete t.online,e)),t),On=(e,t)=>e.reduce(((e,t)=>{if(e.has(t.id)){let n=e.get(t.id);n.fullname(t.fullname),n.about(t.about),n.md(t.md)}else e.set(t.id,function(e){return{id:e.id,mom:e.mom,by:e.by,dir:e.dir,timestamp:new Date(e.timestamp),chatid:e.chatid,to:e.to,re:e.re,fullname:f(e.fullname),about:f(e.about),md:f(e.md)}}(t));return e}),t);const In=(()=>{let e={},t={};return{create:(n,a)=>t[n]=new Promise((t=>e[n]=t)),complete:(t,n)=>e[t]?e[t](n):null,join:e=>t[e],joinall:(...e)=>Promise.all(e.map((e=>t[e]))),select:(...e)=>Promise.race(e.map((e=>t[e])))}})(),jn=30,Nn=f([]),$n=f([]),Kn=f(0),Fn=f(0),zn=f(0),Rn=f(0),Bn=f(""),qn=f(""),Hn=f(null),Vn=f(!1),Wn=f(!1),Yn=Tn(new Map),Xn=Tn(new Map),Gn=Tn(new Map),Zn={id:0,childids:f([]),childs:Tn(new Map),open:()=>!0},Jn=Tn(new Map([[0,Zn]])),Qn=f([]),ea=Dn(),ta=Dn(),na=f([]),aa=f([]),ra=f(0),sa=f(null),la=f(!1),oa=f(""),ia=f(!1),ca=Dn(),ua=Dn(),da=Dn(),ma=f(!0),ha=f(!1),fa=f(!1);f(""),f("");const pa=f(0),ga=f(0),va=f(0),wa=f(null),ya=f(location.hash.substr(1)),ba=f(0),ka=Dn(),Ca=Tn(new Map),Sa=Dn(),Ea=f(!1);let xa={cb:null};const _a=()=>$n().length>0?$n()[$n().length-1]:0;async function Aa(e,{action:t,chatid:n,txt:a}){switch(t){case 1:Xn(n)?.txt(a);let t=await ue(n,"_t");t&&(t.txt=a??"",await ne("_t",t),t.dir.forEach((t=>e.add(t))));break;case 2:let r=await Ua(n);r&&r.dir.forEach((t=>e.add(t)))}}async function Ua(e){let n=Xn(e);n&&Xn().delete(e),n=await ue(e,"_t"),n&&await(async({id:e,dir:n})=>{let a=await t.join();if(!a)return;let r=[0,...n];!function(e,t){t.forEach((async t=>{let n=await le(t);n&&n.includes(e)&&oe(t)}))}(e,r),function(e,t){let n=a.transaction(["_c"],"readwrite").objectStore("_c");t.forEach((t=>{let a=IDBKeyRange.only([t,e]);n.delete(a).onerror=console.error}))}(e,r),function(...e){let t=a.transaction(["_t"],"readwrite").objectStore("_t");e.forEach((e=>{t.delete(e).onerror=console.error}))}(e)})(n);let a=$n(),r=a.indexOf(e);return r>-1&&(a.splice(r,1),$n(a)),Ta(),n}function Ta(){if(!M("cs"))return;let e=window.innerHeight-M("cs").offsetHeight-(pe.id()?96:64)-(ia()&&la()?56:ia()?32:la()?24:0);M("cs").childElementCount>2&&(e-=5),M("os").style.height=e>0?e+"px":"0"}window.onresize=Ta;const Da=async(e,t)=>{await Ma(e);let n=e[0],a=new Set,r=new Set,s=$n(),l="re"===t?new Set:new Set(s);switch(e=e.filter((e=>{let t=Xn(e);if(!t)return!1;Gn().has(t.by)||a.add(t.by),t.men&&t.men.forEach((e=>{Gn().has(e)||a.add(e)})),t.dir.forEach((e=>{Yn().has(e)||r.add(e)}));let n=l.has(e);return n&&console.error("duplicated id in keys",e),l.add(e),!n})),await Pa(a,r),e.reverse(),t){case"re":$n(e);break;case"pre":$n(s.concat(e));break;default:$n(e.concat(s))}let o=$n();for(let e=0;e<o.length;e++){let t=Xn(o[e-1]),n=Xn(o[e+1]),a=Xn(o[e]);a.showby(a.by!==t?.by),a.first(a.chanid!==t?.chanid),a.last(a.chanid!==n?.chanid),a.firstre(null!==a.re&&a.re!==t?.re&&a.re!=t?.id),a.lastre(null!==a.re&&a.re!==n?.re)}Ta(),n&&M(Cn.ntob(n)+"_")?.scrollIntoView()},Ma=async e=>{let t=(e=await La(e)).map((e=>Xn(e)?.re)).filter((e=>e&&e>0&&!Xn().has(e)));La(Array.from(new Set(t)))},La=async e=>{if(0===(e=e.filter((e=>!Xn().has(e)))).length)return e;let{value:t,missed:n}=await re("_t",e);if(Ln(t,Xn()),n.length>0){let e=await In.create("chats",dn.send(ke.Chats(n)));Ln(e,Xn())}return e},Pa=async(e,t)=>{let n=await re("_e",Array.from(e)),a=await re("_h",Array.from(t));n.value.length&&dn.send(ke.Ons(n.value.filter((e=>e.id!=pe.id())).map((e=>e.id)))),Pn(n.value,Gn()),On(a.value,Yn()),n.missed.length>0&&In.create("users",dn.send(ke.Users(n.missed))),a.missed.length>0&&In.create("chans",dn.send(ke.Chans(a.missed)));let[r,s]=await In.joinall("users","chans");r&&Pn(r,Gn()),s&&On(s,Yn())},Oa=async e=>{let t=Hn()||null,n=Kn();console.groupEnd(),console.groupCollapsed("[store]","⬆ load more",n,"ub",e,"kw",t);const a=performance.now();let r=await le(n)||[];if(r[2]&&e===r[1])return Vn(!0),void console.log("[store] top chat reached");if(Vn(!1),!t){let t=await Un(n,e,jn);if(r[2]||t.length===jn)return await Da(t),void console.log("[store]","scan more",n,"ub",e,"in",R(a),"ms")}let s=await((e=null,t=null,n=null)=>{let a=ke.Shin({chanid:Kn(),kw:e,ub:t,lb:n,lu:null,cu:null,mu:null});return In.create("chatscan",dn.send(a))})(t,e);s.length>0&&await Da(s),console.log("[store]","update more",n,"ub",e,"kw",t,"in",R(a),"ms"),console.groupEnd()};async function Ia(e=null){xa.cb=null,Vn(!1),zn(0);let t=Kn();console.groupEnd(),console.groupCollapsed("[store]","⟳ reload",t);const n=performance.now();let a,r=await le(t)||[],s=e?null:r[0]||null,l=await Un(t,a,jn);await Da(l,"re"),xa.cb=Oa,console.log("[store]","chats reload",t,"in",R(n),"ms");let o={id:await ue(t,"_u")||0,lo:r[1]||0},i=await ue(t,"_d")||null,c=await ue(t,"_m")||null,u=await ja(o,i,c,e,a,s)||[];await Da(u,u.length!==jn&&0!==l.length&&s?"pre":"re"),console.log("[store]","updated",t,"in",R(n),"ms"),console.groupEnd()}const ja=(e=null,t=null,n=null,a=null,r=null,s=null)=>{let l=ke.Shin({chanid:Kn(),kw:a,ub:r,lb:s,lu:e,cu:t,mu:n});return In.create("chatscan",dn.send(l))},Na=(e=null)=>{Hn(e),Ia(e)},$a=e=>{let t=e.map(((e,t)=>{let{mom:n,fullname:a}=Yn(e);return{i:t+1,mom:n,fullname:a,id:e}}));En.update(t)},Ka=async e=>{if(0===(e=e.filter((e=>!Yn().has(e)))).length)return;let{value:t,missed:n}=await re("_h",e);if(console.log("[chans] gets",{value:t,missed:n}),On(t,Yn()),n.length>0){let e=await In.create("chans",dn.send(ke.Chans(n)));On(e,Yn())}};async function Fa(e=null,t=null){if(0===Zn.childids().length||e){console.log("[dir]","load tree",e||"",t||"");const n=performance.now();let a=t?[]:await async function(){let e=await xn("_h",(e=>({store:e.index("chatid"),bound:null})));return console.log("[chans] load tree",e),On(e,Yn()),e.map((e=>e.id))}();a.length<1&&(a=await async function(e=null,t=null){t&&qn(t);return In.create("scantree",dn.send(ke.Tree({kw:t,reload:e})))}(e,t)),Ra(a),console.log("[dir]","tree loaded",t||"","in",R(n),"ms")}}const za=async(e,t=null,n=null)=>{console.groupEnd(),console.log("[dir]","list",e,"ub",n,t?`"${t}"`:"");const a=performance.now();Fa(null,t);let r=await ue(e,"_d")||null,s=await ue(e,"_m")||null,l=await((e,t=null,n=null,a=null,r=null,s=null)=>{a&&qn(a);let l=ke.Shan({chanid:e,kw:a,ub:r,lb:s,cu:t,mu:n});return In.create("chanscan",dn.send(l))})(e,r,s,t,n);n?0===l.length?console.warn("no more result"):Nn(Nn().concat(l)):(0!==l.length||t||S("nochan"),Nn(l));let o=Ba(e);o&&(qa(Nn(),o.childs()),o.childids(Nn())),console.log("[dir]","chans load",e,"ub",n,t?`"${t}"`:"","in",R(a),"ms"),console.groupEnd()};function Ra(e,t=0){const n=e.filter((e=>Yn(e)?.mom==t));let a=Ba(t);a&&((Kn()==t||Kn()&&Yn(Kn())&&Yn(Kn())?.dir.includes(t))&&a.open(!0),qa(n,a.childs()),a.childids(n));for(const t of n)Ra(e,t)}function Ba(e){let t=e&&Yn(e)?[0,...Yn(e)?.dir??[],e]:[0],n=Jn();var a,r;for(r=0;r<t.length;r++){let e=t[r];n.has(e)&&(a=n.get(e),n=a.childs())}return a}function qa(e,t){return e.reduce(((e,t)=>(e.has(t)||e.set(t,{id:t,childids:f([]),childs:Tn(new Map),open:f(!1)}),e)),t)}const Ha=(e=null)=>za(En.id(),e);const Va=async({id:e,mom:t,fullname:n})=>{e!==Kn()&&En.cd({i:En.i()+1,mom:t,fullname:n,id:e})},Wa=async e=>{dn.send(ke.MuteChan(e))},Ya=async e=>{dn.send(ke.UnmuteChan(e))};async function Xa(e){let n=Yn(e);n&&Yn().delete(e),n=await ue(e,"_h"),n&&await(async({id:e,dir:n})=>{let a=await t.join();if(!a)return;let r=[0,...n,e];!function(e){e.forEach((async e=>{oe(e)}))}(r),function(e){let t=a.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);t.delete(n).onerror=console.error}))}(r)})(n);let a=Nn(),r=a.indexOf(e);return r>-1&&(a.splice(r,1),Nn(a)),n}async function Ga(e){let t=e.filter((e=>!Gn().has(e)));if(t.length){let{value:e,missed:n}=await re("_e",t);if(Pn(e,Gn()),n.length>0){let e=await In.create("users",dn.send(ke.Users(n)));e&&Pn(e,Gn())}dn.send(ke.Ons(t.filter((e=>e!=pe.id()))))}}async function Za(e){if(!e)return Qn([]);let t=Yn(e)?.md()??1?[...Yn(e)?.dir??[],e]:[e],{value:n,missed:a}=await re("_n",t),r=[];if(a.length){let e=await In.create("memlist",dn.send(ke.Mems(a)));for(const t of e){Pn(t.users,Gn()),ae("_e",t.users);let e=t.users.map((e=>e.id));de("_n",t.chanid,e),r=[...r,...e]}}let s=Array.from(new Set([...n.flat(),...r]));await Ga(s),s.sort((e=>Gn(e)?.online()?-1:0)),Qn(s)}async function Ja(e){let t=await In.create("findmems",dn.send(ke.FindMems({chanid:Rn()||Kn(),kw:e})));aa(t);let n=t.find((t=>t.name===e));if(n)ra(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));ra(n?t.indexOf(n):0)}return t.length}function Qa(){const e=pe.id();let t=Gn(e);t?t.online(!0):Gn().set(e,{id:e,name:pe.name(),online:f(!0),tz:f(Y()),st:f("")})}const er=e=>{Rn()!==e?Rn(e):Rn(0),Za(Rn()||Kn()),zn(0)};async function tr(e){xa.cb=null;let t=await In.create("thread",dn.send(ke.ChatThread({i:e,kw:null,ub:null,lb:null})));await Da(t,"re"),xa.cb=t=>async function(e,t){let n=await In.create("thread",dn.send(ke.ChatThread({i:e,kw:null,ub:t,lb:null})));return Da(n)}(e,t)}async function nr(e){xa.cb=null;let t=await In.create("list",dn.send(ke.ChatList({i:e,kw:null,ub:null,lb:null})));await Da(t,"re"),xa.cb=t=>async function(e,t){let n=await In.create("list",dn.send(ke.ChatList({i:e,kw:null,ub:t,lb:null})));return Da(n)}(e,t)}C("reconnected",(()=>{Ia(),za(En.id())})),C("config",(async({d:e})=>{e?(Qa(),vn()):pe.id()&&(Rn(0),Gn(pe.id())&&Gn(pe.id())?.online(!1),pe.id(0),pe.name(""),pe.chans([]),delete pe.sskey,pe.salt=new Uint8Array,await ee(),Zn.childids([]),En.ishome()?(Ia(),Fa()):En.home())})),C("subs",(function(e){dn.send(ke.PushSubs({endpoint:e.endpoint,auth:e.keys.auth,p256dh:e.keys.p256dh}))}));const ar={content:null},rr=()=>{switch(va()){case 1:return"please login first";case 2:return"invalid login name or password";case 3:return"email existed";case 4:return"username existed";case 5:return"please select a topic";case 6:return"topic is empty";case 7:return"invalid email address";case 8:return"error adding people";case 9:return"error signing up";case 10:return"invalid name";case 11:return"invalid input";case 12:return"password too short";case 13:return"invalid password";case 14:return"new password is the same with old password";case 15:return"peer offline";case 16:return"You are behind a NAT or firewall, can not create a direct connection to peer"}};function sr(...e){return e.includes(va())}let lr;const or=e=>{va(e),clearTimeout(lr),lr=setTimeout((()=>va(0)),5e3)},ir=e=>{wa(e),clearTimeout(lr),lr=setTimeout((()=>wa(null)),5e3)};let cr=[];async function ur(){const e=await c(),t=await crypto.subtle.exportKey("raw",e.publicKey);return{keypair:e,pub:new Uint8Array(t)}}async function dr(e){let t=In.create("ice"),n=await mr(e),a=await n.createOffer();await n.setLocalDescription(a);let r=Wt((new TextEncoder).encode(n.localDescription?.sdp)),{keypair:s,pub:l}=await ur();r=O(r,l),await t;let c=await In.create("offer",dn.send(ke.Sdp({fr:null,to:e,sd:r,ca:cr,offer:!0}))),{a:u,k:d}=I(new Uint8Array(c.sd)),m=await i(d);n.sharedkey=await o(s.privateKey,m);let h=(new TextDecoder).decode(Vt(u));n.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:h}));for(const e of c.ca){const t=new RTCIceCandidate({candidate:e,sdpMid:"0",sdpMLineIndex:0});await n.addIceCandidate(t)}}async function mr(e){await Ga([e]);let t=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});Ca().has(e)||ka.add(e),Ca().set(e,t),t.onicecandidate=e=>{e.candidate?cr.push(e.candidate.candidate):In.complete("ice",cr)},t.onconnectionstatechange=()=>{console.log("[peer]",t.connectionState),t.connectionState};let n=t.createDataChannel("p",{negotiated:!0,id:1});return n.binaryType="arraybuffer",n.onopen=t=>{console.log("dc",e,"open",t)},n.onmessage=async({data:n})=>{let a=W(),r=new Uint8Array(n),s=r.subarray(0,12);r=new Uint8Array(await d(r.subarray(12),t.sharedkey,s)),P(r,s);let l={id:0,txt:Ht(Vt(r)).txt,by:e,ts:new Date,room:e,showby:!1};Sa.last().by!=e&&(l.showby=!0),l.id=await ne("_p",l),ba()==e&&Sa.add(l),a&&setTimeout(L),Ta()},n.onclose=t=>{var n,a;console.log("dc",e,"close",t),setTimeout((()=>{if(Gn(e)?.online())return dr(e)}),(n=1e3,a=5e3,Math.random()*(a-n)+n))},n.onerror=t=>{console.warn("dc",e,"error",t)},t.send=async e=>{let a=Wt(qt(e));const r=crypto.getRandomValues(new Uint8Array(12));P(a,r),a=z(r,new Uint8Array(await u(a,t.sharedkey,r))),n.send(a)},t.open=()=>"open"===n.readyState,t}function hr({id:e},t){if(!e||zn()===e)return zn(0);t.focus(),zn(e)}async function fr(e){let t=await(async(e,t,n,a=!0)=>{let r={value:e};return await xn("_p",_n,r,n,t,a,"prev")})(e);Sa(t.reverse())}let pr=new Map;async function gr(e){return dn.send(ke.Au(e)),ir("a secret 6-digits otp code has been sent to your registered email"),await In.create("enterotp",function(){let e=[...Array(6)].map((()=>b("input",{class:"ot",type:"tel",autocomplete:"chrome-off"}))),t=e[0];t.addEventListener("input",n),setTimeout((()=>t.focus()));for(let t=0;t<e.length;t++){let a=e[t];a.addEventListener("keypress",(function(n){n.keyCode>47&&n.keyCode<58&&(a.value=n.key,t!==e.length-1&&e[t+1].focus()),n.preventDefault()})),a.addEventListener("keydown",(function(n){"Backspace"===n.key&&(a.value="",0!==t&&e[t-1].focus())})),a.addEventListener("keyup",(function(t){if(16===t.keyCode||9==t.keyCode||224==t.keyCode||18==t.keyCode||17==t.keyCode)return;t.target.value.length>1&&n(t);let a=e.map((e=>e.value)).join("");a.length===e.length&&In.complete("enterotp",a)}))}function n(e){let t=e.data||e.target.value;t&&1!==t.length&&a(e.target,t)}function a(e,t){e.focus(),e.value=t[0],t=t.substring(1),e.nextElementSibling&&t.length&&a(e.nextElementSibling,t)}ar.content=b("div",{class:"pi"},b("div",{class:"su otp"},b("div",{class:"head"},"Enter OTP code"),b("div",{class:"sub"},"Please enter the 6-digits code sent to your email"),b("div",{id:"otp"},e))),Ea(!0)}())}async function vr(e,t,n){console.groupEnd(),console.groupCollapsed("[au]","login",e),Yn().clear(),Xn().clear(),Gn().clear(),Qn([]),await ee();const a=crypto.getRandomValues(new Uint8Array(12)),r=await we(n,a);let s=await ve(t,e),l={name:e,key:z(a,new Uint8Array(await u(s,r,a))),tz:Y()};fe(s),dn.send(ke.Login(l))}async function wr(e,t,n,a=null){const r=crypto.getRandomValues(new Uint8Array(12)),s=await we(t,r);let l=a?new Uint8Array(await ve(a,e)):null,o=await ve(n,e),i=z(r,new Uint8Array(await u(o,s,r)));return fe(o),In.create("pwd",dn.send(ke.Pwd({key:i,okey:l})))}function yr(e,...t){let n=e(...t);return!n||or(n)}function br(){ar.content=b("div",{class:"pi"},b("div",{class:"su"},b("div",{class:"head"},"Sign up"),b("div",{class:"sub"},"We will send a sign up invitation to your email"),b("form",{onSubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();if(H(n)){let e=await In.create("signup",dn.send(ke.Signup(n)));if(e)return or(e);ir(`an invite code has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Ea(!1)}else or(7)}},(()=>sr(3,7)?b("div",{class:"erm"},rr()):null),b("input",{type:"text",name:"m",placeholder:"Your email address",onKeyPress:X,onKeyUp:Z,required:!0,autocomplete:"on",class:()=>sr(3,7)?"er":""}),b("div",{class:"bn"},b("button",{type:"submit"},"Sign up"))))),Ea(!0)}function kr(e,t){const n=f("Log in Telegram");let a={};ar.content=b("div",{class:"pi"},b("div",{class:"su"},b("div",{class:"head"},"Sign up"),b("div",{class:"sub"},e),b("form",{onSubmit:function(n){n.preventDefault();let{n:r,p:s}=n.target,l=r.value.trim();yr(V,l)&&yr(J,s.value)&&async function(e,t,n,a,r){console.groupEnd(),console.groupCollapsed("[au]","register",e,t),await ee();const s=crypto.getRandomValues(new Uint8Array(12)),l=await we(a,s);let o=await ve(n,t),i={name:t,key:z(s,new Uint8Array(await u(o,l,s))),tz:Y(),tgid:r.id||null,tgname:r.username||null,tgfn:r.first_name||null,tgln:r.last_name||null};fe(o),dn.send(ke.NewUser(i))}(e,l,s.value,t,a)}},(()=>sr(4,10,12)?b("div",{class:"erm"},rr()):null),b("input",{id:"username",type:"text",name:"n",placeholder:"Username",onKeyPress:G,onKeyUp:Z,required:!0,autocomplete:"on",class:()=>sr(4,10)?"er":""}),b("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>sr(12)?"er":""}),b("script",{async:!0,src:"https://telegram.org/js/telegram-widget.js?15"}),b("div",null,b("button",{onClick:function(e){e.preventDefault(),Telegram.Login.auth({bot_id:"1850607378",request_access:!0},(e=>{e&&(M("username").value=e.username,n("Log in as "+e.first_name),a=e)}))}},n)),b("div",{class:"bn"},b("button",{type:"submit"},"Sign up"))))),Ea(!0)}function Cr(){ar.content=b("div",{class:"pi"},b("div",{class:"su"},b("div",{class:"head"},"Log in"),b("div",{class:"sub"}),b("form",{onSubmit:async function(e){e.preventDefault();let{m:t,p:n}=e.target,a=t.value.trim();if(H(a))return async function(e,t){let n=pr.has(e)?pr.get(e):await In.create("name",dn.send(ke.Email(e)));if(pr.set(e,n),!n)return or(2);vr(n,t,await gr(n))}(a,n.value);if(yr(V,a)){let e=await gr(a);vr(a,n.value,e)}}},(()=>sr(7,10)?b("div",{class:"erm"},rr()):null),b("input",{type:"text",name:"m",placeholder:"Username or email",onKeyPress:X,onKeyUp:Z,required:!0,autocomplete:"on",class:()=>sr(7,10)?"er":""}),b("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on"}),b("div",{class:"lf fp"},b("a",{onClick:Sr},"Forgot password")),b("div",{class:"bn"},b("button",{type:"submit"},"Log in"))))),Ea(!0)}function Sr(){ar.content=b("div",{class:"pi"},b("div",{class:"su"},b("div",{class:"head"},"Forgot password"),b("div",{class:"sub"},"We will send a password reset link to your email"),b("form",{onSubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();H(n)?(In.create("forgotpwd",dn.send(ke.Fp(n))),ir(`a password reset link has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Ea(!1)):or(7)}},(()=>sr(7)?b("div",{class:"erm"},rr()):null),b("input",{type:"text",name:"m",placeholder:"Your email address",onKeyPress:X,onKeyUp:Z,required:!0,autocomplete:"on",class:()=>sr(7)?"er":""}),b("div",{class:"bn"},b("button",{type:"submit"},"Submit"))))),Ea(!0)}const Er=[];function xr(){!function(e){for(const t of Er)t(e)}(document.location.hash.substr(1))}window.addEventListener("hashchange",xr),setTimeout(xr),(e=>{Er.push(e)})((async e=>{ya(e),ba(0);let t=ka();if(pe.id()>0&&(t=[...t,pe.id()]),await Ga(t),"$"===e[0]){let[t,n,a]=e.slice(1).split("/");if(n.length<50)return location.hash="#",Ea(!1);let r=await In.create("unpack",dn.send(ke.Unpack(n)));if(!r)return location.hash="#",Ea(!1);let s=await In.create("name",dn.send(ke.Email(r)));switch(t){case"i":if(!s)return kr(r,a),C("login",(e=>e?location.hash="#":null));break;case"f":if(s&&(s==pe.name()||!pe.id()))return function(e,t,n){ar.content=b("div",{class:"pi"},b("div",{class:"su"},b("div",{class:"head"},"Reset password"),b("div",{class:"sub"},t),b("form",{onSubmit:async function(t){t.preventDefault();let{p:a}=t.target;if(yr(J,a.value)){let t=await wr(e,n,a.value);if(t)return or(t);ir("password updated"),Ea(!1),location.hash="#"}}},(()=>sr(12)?b("div",{class:"erm"},rr()):null),b("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>sr(12)?"er":""}),b("div",{class:"bn"},b("button",{type:"submit"},"Submit"))))),Ea(!0)}(s,r,a)}return location.hash="#",Ea(!1)}if("/"===e[0]){let t=Cn.bton(e.slice(1));return Fn(t),$n([]),tr(t),Ta(),void await Fa()}if("&"===e[0]){let t=Cn.bton(e.slice(1));return t==pe.id()?location.hash="#":(Kn(0),Fn(0),Za(0),Rn(0),$a([]),$n([]),await Ga([t]),ba(t),await fr(t),await Fa(),!Ca().has(t)&&Gn(t)?.online()&&dr(t),void setTimeout((()=>{Ta(),L()}),100))}let n=["!","@","*"].indexOf(e[0]);if(n>-1)return Kn(0),Rn(0),Fn(0),$n([]),nr(n),Ta(),void await Fa();if("%"===e[0])return location.hash="#"+Cn.ntob(Number(e.slice(1)));if(!e||!wn.includes(e[0]))return Kn(0),Fn(0),Za(0),Rn(0),$a([]),await Fa(),Ia(),void(document.title="hyze - micro chat for team");let a=Cn.bton(e);if(await Fa(),Kn(a),Rn(0),Fn(0),Ia(),!Yn(a))return;let r=Yn(a)?.dir??[];$a([...r,a]),Za(a),document.title=Yn(Kn())?.fullname()+" - hyze"}));const _r=async e=>{const t=Xn(e);t&&t.nor(t.nor()+1);const n=await ue(e,"_t");n&&(n.nor=t?.nor()??null,await ne("_t",n))};function Ar(e,t,n){const{root:a,subscribe:r,sample:s,cleanup:l}=v;null==n&&(n=!t.$t);let o=v.h([]),i=v.add(o,""),c=new Map,u=new Map,d=new Set;function m(e,r){if(null==e)return;let s=u.get(e);return 1===r?(d.delete(e),s||(s=n?a((n=>(c.set(e,n),t(e.$v||e)))):t(e.$v||e),11===s.nodeType&&(s=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let a=Array.from(t);return{nodeType:111,t:a[0],o:a[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(a[t++])}return e}}})(s)||s),u.set(e,s))):-1===r&&d.add(e),((e,t)=>111===e.nodeType?1/t<0?t?v.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(s,r)}function h(e){let t=c.get(e);t&&(t(),c.delete(e)),u.delete(e)}return l(r((t=>{let n=e();return s((()=>{d.clear();let e=Array.from(function(e,t,n,a,r){let s,l,o=new Map,i=new Map;for(s=0;s<t.length;s++)o.set(t[s],s);for(s=0;s<n.length;s++)i.set(n[s],s);for(s=l=0;s!==t.length||l!==n.length;){var c=t[s],u=n[l];if(null===c)s++;else if(n.length<=l)e.removeChild(a(t[s],-1)),s++;else if(t.length<=s)e.insertBefore(a(u,1),a(t[s],0)||r),l++;else if(c===u)s++,l++;else{var d=i.get(c),m=o.get(u);void 0===d?(e.removeChild(a(t[s],-1)),s++):void 0===m?(e.insertBefore(a(u,1),a(t[s],0)||r),l++):(e.insertBefore(a(t[m],1),a(t[s],0)||r),t[m]=null,m>s+1&&s++,l++)}}return n}(i.parentNode,t||[],n,m,i));return d.forEach(h),e}))}))),l((function(){c.forEach((e=>e())),c.clear(),u.clear(),d.clear()})),o}dn.recv((async({tag:e,value:t})=>{switch(e){case"Err":or(t);break;case"Unpack":In.complete("unpack",t);break;case"AddMems":In.complete("addmems",t);break;case"Logout":he({d:!1});break;case"NewChan":Rn(t),L();break;case"Shin":let e=t;Ln(e.chats,Xn()),Pn(e.users,Gn()),On(e.chans,Yn()),ae("_t",e.chats),ae("_h",e.chans),ae("_e",e.users),async function(e){let t=e||[],n=Kn();if(0===t.length)return Vn(!0),se(n,[],!0),console.log("top chat reached"),void In.complete("chatscan",t);Vn(!1),se(n,[t[0],t[t.length-1]]);let a=t.map((e=>({chanid:n,chatid:e})));ae("_c",a),In.complete("chatscan",t)}(e.chats.map((e=>e.id)));break;case"Update":{let e=t,n=new Set([Kn()]);Aa(n,e),n.forEach((t=>de("_u",t,e.id)));break}case"Updates":let n=t;n.length&&async function(e){let t=new Set([Kn()]);for(const n of e)Aa(t,n);t.forEach((t=>de("_u",t,e[e.length-1].id)))}(n);break;case"ChanUpdates":let a=t;a.length&&async function(e){let t=new Set([Kn()]);for(const{action:n,chanid:a,name:r,about:s,md:l}of e)switch(n){case 1:{let e=Yn(a);e&&(null!==r&&e.fullname(r),null!==s&&e.about(s),null!==l&&e.md(l));let n=await ue(a,"_h");n&&(null!==r&&(n.fullname=r),null!==s&&(n.about=s),null!==l&&(n.md=l),await ne("_h",n),n.dir.forEach((e=>t.add(e))));break}case 2:let e=await Xa(a);e&&e.dir.forEach((e=>t.add(e)))}t.forEach((t=>de("_d",t,e[e.length-1].id)))}(a);break;case"MemUpdates":let r=t;r.length&&async function(e){let t=new Set([Kn()]),n=new Map;for(const{action:t,chanid:a,by:r}of e)switch(t){case 1:n.has(a)?n.get(a).adds.push(r):n.set(a,{adds:[r],rms:[]});break;case 0:n.has(a)?n.get(a).rms.push(r):n.set(a,{adds:[],rms:[r]})}for(let[e,{adds:a,rms:r}]of n.entries()){let n=await ue(e,"_n");n&&(n=n.filter((e=>r.indexOf(e)<0)),de("_n",e,Array.from(new Set([...a,...n])))),t.add(e)}Za(Rn()||Kn()),t.forEach((t=>de("_m",t,e[e.length-1].id)))}(r);break;case"Login":if(console.groupEnd(),!t)return or(2),fe(void 0),void S("login",!1);await async function({data:e,chans:t}){const n=await be(e);ne("_e",n),he({d:!0}),pe.chans(t),ie("c",t)}(t),Qa(),S("login",!0),Ea(!1),Rn(0),Zn.childids([]),Ia(),Fa();break;case"Pwd":if(!t)return fe(void 0),void In.complete("pwd",13);pe.id()&&await be(t),In.complete("pwd");break;case"Users":ae("_e",t),In.complete("users",t);break;case"Chans":ae("_h",t),In.complete("chans",t);break;case"Chat":!async function(e){let t=$n();if(t.includes(e.id))return;let n=!Yn(e.chanid),a=W();await ne("_t",e);let r=(Kn()?e.dir:[0,...e.dir]).map((t=>(se(t,[e.id,e.id]),{chanid:t,chatid:e.id})));ae("_c",r);let s=new Set(Gn().has(e.by)?[]:[e.by]);e.men&&e.men.forEach((e=>{Gn().has(e)||s.add(e)}));let l=e.dir.filter((e=>!Yn(e))),o=new Set(l);await Pa(s,o),e.re&&_r(e.re),Xn().set(e.id,Mn(e)),t.push(e.id),$n(t),n&&Fa(!0),a&&L(),"ontouchstart"in document.documentElement||Ta(),e.dir.forEach((async t=>{let n=Yn(t);n&&(n.chatid=e.id),n=await ue(t,"_h"),n&&(n.chatid=e.id,await ne("_h",n))}))}(t);break;case"Chats":let s=t;ae("_t",s),In.complete("chats",s);break;case"Shan":{let e=t;e.length>0?(Wn(!1),await Ka(e)):Wn(!0),In.complete("chanscan",e);break}case"Tree":let l=t;l.length>0&&(ae("_h",l),On(l,Yn())),In.complete("scantree",l.map((e=>e.id)));break;case"Treeid":let c=t;c.length>0&&await Ka(c),In.complete("scantree",t);break;case"MuteChan":{if(!t)return;let e=t,n=pe.chans();if(n.includes(e))return;n.push(e),pe.chans(n),await ie("c",n),await te(0,e,...Yn(e)?.dir??[]),Ia(),za(En.id());break}case"UnmuteChan":{if(!t)return;let e=t,n=pe.chans();if(!n.includes(e))return;const a=n.indexOf(e);a>-1&&n.splice(a,1),pe.chans(n),await ie("c",n),await te(0,e,...Yn(e)?.dir??[]),Ia(),za(En.id());break}case"DelChan":Xa(t);break;case"Mems":In.complete("memlist",t);break;case"FindUsers":{let e=t;Pn(e,Gn()),ae("_e",e),In.complete("findusers",e);break}case"FindMems":{let e=t;Pn(e,Gn()),ae("_e",e),In.complete("findmems",e);break}case"On":{let{id:e,online:n}=t;if(!e)return;Gn(e)?.online(n);break}case"Ons":t.forEach((e=>Gn(e)?.online(!0)));break;case"Profile":In.complete("profile",t);break;case"Name":In.complete("name",t);break;case"Signup":In.complete("signup",t);break;case"ChatThread":In.complete("thread",t);break;case"ChatList":In.complete("list",t);break;case"Status":In.complete("status",t);break;case"Sdp":let u=t;u.offer?async function({fr:e,sd:t,ca:n}){let a=In.create("ice"),r=await mr(e),{a:s,k:l}=I(new Uint8Array(t)),{keypair:c,pub:u}=await ur(),d=await i(l);r.sharedkey=await o(c.privateKey,d);let m=(new TextDecoder).decode(Vt(s));await r.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:m}));let h=await r.createAnswer();await r.setLocalDescription(h);for(const e of n){const t=new RTCIceCandidate({candidate:e,sdpMid:"0",sdpMLineIndex:0});await r.addIceCandidate(t)}let f=Wt((new TextEncoder).encode(r.localDescription?.sdp)),p=O(f,u);await a,dn.send(ke.Sdp({fr:null,to:e,sd:p,ca:cr,offer:null}))}(u):In.complete("offer",u)}}));const Ur=()=>{const e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=U((()=>{let t=e.textContent;t&&t.length>50||(Ha(t),Na(t))}),200),e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};let t=document.createElement("div");return setTimeout((function(){new IntersectionObserver((t=>{if(t[0].intersectionRatio<=0)return;let n=Ba(Kn()).childids(),a=n[n.length-1];if(!a||Wn()||n.length<jn)return;let r=e.textContent||null;r&&r.length>50||setTimeout((()=>za(En.id(),r,a)))}),{}).observe(t)})),b("div",{class:"cn"},b("div",{class:"s"},e),b("div",{class:"tbl"},b("table",null,b("tbody",null,(()=>Ar(Ba(Kn()).childids,(e=>{let t=Yn(e);return b("tr",{onClick:()=>Va(t)},b("td",null,b("button",{onClick:t=>((e,t)=>{if(e.stopPropagation(),!pe.id())return Cr();pe.chans().includes(t)?Ya(t):Wa(t)})(t,e)},(()=>pe.chans().includes(e)?"➕":"➖"))),b("td",null,t.fullname))}))),t))))},Tr="formatBlock",Dr=(e,t)=>e.appendChild(t),Mr=e=>document.createElement(e),Lr=e=>document.queryCommandState(e),Pr=(e,t)=>document.execCommand(e,!1,t),Or=[{icon:"<b>B</b>",title:"Bold",state:()=>Lr("bold"),result:()=>Pr("bold")},{icon:"<i>I</i>",title:"Italic",state:()=>Lr("italic"),result:()=>Pr("italic")},{icon:"<u>U</u>",title:"Underline",state:()=>Lr("underline"),result:()=>Pr("underline")},{icon:"<strike>S</strike>",title:"Strike-through",state:()=>Lr("strikeThrough"),result:()=>Pr("strikeThrough")},{icon:"&#8220&#8221;",title:"Quote",result:()=>Pr(Tr,"<blockquote>")},{icon:"&lt;&gt;",title:"Code",result:()=>Pr(Tr,"<pre>")},{icon:"&#128279;",title:"Link",class:" lk",result:()=>{const e=window.prompt("Enter the link URL");e&&Pr("createLink",e)}},{icon:"🌁",title:"Image",class:" im",result:()=>{const e=window.prompt("Enter the image URL");e&&Pr("insertImage",e)}},{icon:"⏎",title:"Enter to send",class:" en se",result:e=>(ma()?ma(!1):ma(!0),ma()?e.classList.add("se"):e.classList.remove("se"),!0)}],Ir="e-b",jr="e-bs";let Nr="",$r=0,Kr=!1,Fr=f(!1);const zr=()=>M("tp"),Rr=()=>M("pm"),Br=()=>M("mb"),qr=e=>{$r=D();let t=e.textContent,n=t.indexOf(" ",$r);-1==n&&(n=t.length);var a=/[\S]+$/.exec(t.slice(0,n));return a?a[0]:""},Hr=({id:e,name:t})=>{aa([]),ra(0);let n=sa();if(n.spellcheck=!1,n===Br()){let a=Nr?"@"+t:t;n.textContent=Nr?((e,t)=>{let n=e.textContent,a=n.indexOf(" ",$r);-1==a&&(a=n.length);var r=n.slice(0,a).replace(/\S+$/,t);return $r=r.length,r+n.slice(a)})(n,a):n.textContent+a,n.focus(),Nr?function(e,t){var n=document.createRange(),a=window.getSelection();n.setStart(e.childNodes[0],t),n.collapse(!0),a?.removeAllRanges(),a?.addRange(n)}(n,$r):T(),Fr(!1),e&&da.add(e)}else e?ca.add(e):ua.add(Nr),n.textContent="",Rr().focus()},Vr=()=>b("div",{id:"uls",class:()=>"uls"+(sa()===Br()&&ia()?" ms":"")},b("ul",null,Ar(aa,(e=>b("li",{id:e.id.toString(),tabIndex:-1,class:()=>aa()[ra()]===e?"se":"",onClick:()=>Hr(e),onMouseOver:()=>Kr||ra(aa().indexOf(e))},e.id?b("i",{class:()=>"dot"+(Gn(e.id)?.online()?" on":"")}):null,e.name))))),Wr=()=>b("div",{class:()=>"em sel"+(ia()?" sh":""),onClick:()=>Rr().focus()},Ar(ua,(e=>b("div",{class:"tg ie"},e,b("i",{onClick:()=>ua.delete(e)},"✕")))),Ar(ca,(e=>b("div",{class:()=>Gn(e)?.online()?"tg on":"tg"},Gn(e)?.name,b("i",{onClick:()=>ca.delete(e)},"✕")))),b("div",{class:"wp"},b("div",{id:"pm",class:"e-m"+(ua().length+ca().length===0?" to":""),onKeyDown:Yr,onInput:Zr,contentEditable:!0}),(()=>sa()===Rr()&&ia()&&aa().length>0&&Vr)));function Yr(e){if(!Xr(e)){if(8!=e.keyCode||Rr().textContent?.length||(ca.pop(),Rr().focus()),32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1;"Enter"!==e.key&&"Tab"!==e.key||(Br().focus(),e.preventDefault())}}function Xr(e){return!!aa().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(Hr(aa()[ra()]),e.preventDefault(),!0):27==e.keyCode?(aa([]),ra(),Fr(!1),!0):(38==e.keyCode&&(0===ra()?ra(aa().length-1):ra(ra()-1),M(aa()[ra()].id)?.focus(),e.preventDefault(),Kr=!0,setTimeout((()=>Kr=!1),300)),40==e.keyCode&&(ra()===aa().length-1?ra(0):ra(ra()+1),M(aa()[ra()].id)?.focus(),e.preventDefault(),Kr=!0,setTimeout((()=>Kr=!1),300)),e.target.focus(),!0))}const Gr=U((async e=>{if(Nr=qr(e.target).toLowerCase(),Nr.length>50)return;let t=await Ja(Nr),n=Yn(Rn()||Kn()),a=void 0!==n&&(n.md()??0)<2;!t&&H(Nr)&&a&&aa([{id:0,name:`✉️ Invite ${Nr}`,online:!1}])}),100);function Zr(e){sa(Rr()),Gr(e)}const Jr=()=>{if(!pe.id())return null;if(_a()&&Xn(_a())&&Rn()==Xn(_a())?.chanid)return null;let e=Yn(Rn());if(!e)return null;W()&&setTimeout(L,50);const t=()=>[...e.dir.slice(En.len()-2),e.id];return t().length>0&&b("div",{class:"dr",style:()=>"background:"+q(e.id)},Ar(t,(e=>b("span",null,b("a",{href:"#"+Cn.ntob(e)},Yn(e)?.fullname)))))},Qr=()=>b("div",{id:"tp",class:()=>"e-t"+(la()?" sh":""),onKeyUp:ts,onKeyDown:es,contentEditable:!0}),es=e=>{e.target.spellcheck=!1,"Enter"===e.key&&e.preventDefault()},ts=e=>{oa(e.target.textContent),"Enter"===e.key&&(Br().focus(),e.preventDefault())},ns=()=>!(Rn()||Kn()||ia()||la()),as=()=>b(Array.prototype,null,b("style",null,`.e-c[contenteditable]:empty::before { content: '${(()=>{let e,t=`Send a ${ia()?"private ":""}message `;return Rn()?e=Yn(Rn()):Kn()&&(e=Yn(Kn())),e?t+(la()?`on new topic ${oa()?`"${oa()}" `:""}in "${e.fullname()}"`:`in "${e.fullname()}"`):la()?t+"on new topic "+(oa()?`"${oa()}"`:""):t+"..."})()}'; }`),(()=>sa()===Br()&&Fr()&&aa().length>0&&Vr),b("div",{id:"mb",class:"e-c",onKeyDown:ss,onInput:ls,onFocus:rs,contentEditable:!0})),rs=()=>{if(0!==$n().length)return ns()?(Rn(Xn(_a()).chanid),void Za(Rn())):Rn()||ia()||la()?void 0:(Rn(Xn(_a()).chanid),void Za(Rn()))},ss=e=>{if(sa(Br()),"@"===e.key&&Fr(!0),!Xr(e)&&"Enter"===e.key){if(e.preventDefault(),ma()&&!e.shiftKey)return void async function(e,t){if(!pe.id())return or(1);if(e.innerHTML.length>120)return or(11);if(t.innerHTML.length>4e3)return or(11);if(!t.innerHTML.trim())return;if(ba()){if(!Gn(ba())?.online())return or(15);if(!Ca(ba()).open())return or(16);let e={txt:t.innerHTML.trim()};Ca(ba()).send(e);let n={id:0,txt:e.txt,by:pe.id(),ts:new Date,room:ba(),showby:!1};return Sa.last()?.by!=pe.id()&&(n.showby=!0),n.id=await ne("_p",n),Sa.add(n),t.textContent="",void Ta()}let n=Rn()||Kn(),a=zn()||Fn()||null,r=null;if(e.textContent!==Bn()&&(r=e.textContent,!r?.trim().length))return or(6);if(!(n||ia()||r&&r.trim().length))return or(5);let s=t.innerHTML.trim(),l=null,o=null,i=null;ia()&&(ca().length>0&&(l=ca.add(pe.id()).sort(((e,t)=>e-t))),ua().length>0&&(o=ua())),da().length>0&&(i=da().filter((e=>s.indexOf("@"+Gn(e)?.name)>-1))),dn.send(ke.NewChat({txt:s,chanid:n,re:a,chname:r,men:i,to:l,emails:o})),la(!1),ia(!1),e.textContent="",t.textContent="",oa(""),Bn(""),hr({},t)}(zr(),Br());e.target.textContent+="\n\n",T()}},ls=e=>{Br().spellcheck=!1,Fr()&&os(e)},os=U((e=>{(Nr=qr(e.target).toLowerCase(),Nr.startsWith("@"))?(Nr=Nr.replace(/[@'";:,.\/?\\-]/,""),Nr.length>50||Ja(Nr)):Fr(!1)}),100),is=b("div",{class:"e-a"});Or.forEach((e=>{const t=Mr("button");if(t.className=Ir+" eb",e.class&&(t.className+=e.class),t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=()=>e.result(t)&&Br().focus(),e.state){n="click",a=()=>t.classList[e.state()?"add":"remove"](jr),t.addEventListener(n,a)}var n,a;Dr(is,t)}));const cs=Mr("button");cs.className=Ir+" md",cs.innerHTML="👤",cs.title="Private message",cs.setAttribute("type","button");const us=()=>{if(!pe.id())return Cr();let e=W();cs.classList.add("se"),ia(!0),e&&setTimeout(L),Ta(),"ontouchstart"in document.documentElement||Rr().focus()};cs.onclick=()=>ia()?(cs.classList.remove("se"),ia(!1),void Ta()):us();const ds=Mr("button");ds.className="ntb",ds.innerHTML="✏️ New Topic",ds.title="New topic",ds.setAttribute("type","button"),ds.onclick=()=>{if(!pe.id())return Cr();let e=W();la()?la(!1):la(!0),e&&la()&&setTimeout(L),function(e,t){if(la(e),Ta(),e?ds.classList.add("se"):ds.classList.remove("se"),"ontouchstart"in document.documentElement)return;e&&zr().focus();t&&(zr().innerText=t,oa(t))}(la())},Dr(is,ds),Dr(is,cs),Pr("defaultParagraphSeparator","div");const ms=()=>b("div",{class:()=>"e"+(pe.id()?ns()?" ds":"":" hd")},(()=>zn()?b("div",{class:"re",style:()=>"color:"+q(zn())},b("i",null,"→"),b("b",null,Gn(Xn(zn()).by)?.name),b("a",{href:"#/"+Cn.ntob(zn())},Xn(zn())?.txt)):null),Jr," ",Qr," ",Wr," ",as," ",is),hs=(e,t)=>{let n=M(e+"_")?.querySelector(".ct");if("true"===n.contentEditable)return n.contentEditable="false",n.classList.remove("ce"),n.innerHTML=t.txt(),void(n.onclick=()=>!1);n.spellcheck=!1,n.contentEditable="true",n.classList.add("ce"),n.focus(),n.onclick=e=>{"true"===n.contentEditable&&e.stopPropagation()},n.onkeydown=e=>{if("Tab"===e.key)return document.execCommand("insertHTML",!1,"&#09"),e.preventDefault();if("Escape"===e.key)return n.contentEditable="false",n.classList.remove("ce"),void(n.innerHTML=t.txt());if("Enter"===e.key){let s=n.innerHTML.trim();e.shiftKey||(e.preventDefault(),n.contentEditable="false",n.classList.remove("ce"),s!==t.txt()&&(a=t.id,r=s,dn.send(ke.EditChat({id:a,txt:r}))))}var a,r}};const fs=(e,t)=>{const n=e=>{e.preventDefault(),e.stopPropagation();let n=W();hr(t,Br()),zn()===t.id?Rn(t.chanid):Rn(0),n&&setTimeout(L)};return b(Array.prototype,null,b("div",{class:"ts"},(a=t.timestamp,r=6e4,(s=(new Date).getTime()-a.getTime())<r?Math.round(s/1e3)+"s":s<36e5?Math.round(s/r)+"m":a.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{hour:"numeric",minute:"2-digit"}))),b("div",{class:"pm pr",title:"reply",onTouchEnd:n,onClick:n},b("i",null,"→"),b("div",{class:"pu"},b("div",null,"reply"))),b("div",{class:"pm",onClick:e=>e.stopPropagation()},b("i",{class:"i"},"..."),b("div",{class:"pu"},b("div",{onClick:()=>(async e=>{e.star(!e.star()),dn.send(ke.Star(e.id));const t=await ue(e.id,"_t");t&&(t.star=e.star(),await ne("_t",t))})(t)},"⭐ ",t.star()?"unstar":"star"),b("div",{onClick:()=>hs(e,t)},"✏️ edit"),b("div",{onClick:()=>ps(t)},"🗑️ trash"))));var a,r,s},ps=({id:e,txt:t})=>{confirm('Do you want to delete this chat? \n"'+t()+'"')&&function(e){dn.send(ke.DelChat(e)),Ua(e)}(e)};var gs="410098e",vs="0.0.345";async function ws({name:e}){let{fullname:t,about:n}=await In.create("profile",dn.send(ke.Profile));function a(e){e.preventDefault();let{n:a}=e.target,r=a.value.trim()==t?null:a.value.trim(),s=M("ab")?.textContent?.trim()??null;s=s==(n||"")?null:s;let l=function(e,t){return e&&e.length<2?10:t&&t.length>1e3?11:0}(r,s);0===l?(!function(e,t,n=null){dn.send(ke.EditProfile({fullname:e,about:t,email:n}))}(r,s),Ea(!1)):or(l)}ar.content=b("div",{class:"pi"},b("div",{class:"su"},b("div",{class:"head"},"Profile"),b("div",{class:"sub"},e),b("form",{onSubmit:e=>a(e)},(()=>sr(10,11)&&b("div",{class:"erm"},rr())),b("input",{value:t??"",type:"text",name:"n",placeholder:"Full name",required:!0,class:()=>sr(10)?"er":""}),b("div",{id:"ab",class:"ab",contentEditable:!0},n),b("div",{class:"bn"},b("button",{type:"submit"},"Save"))))),Ea(!0)}const ys=async(e,t)=>{if(pe.id()){if(e.stopPropagation(),!Gn(t)?.tz()){let{st:e,tz:n}=await async function(e){return In.create("status",dn.send(ke.Status(e)))}(t);pe.id()==t&&(n=Y()),Gn(t).tz(n??""),Gn(t).st(e??"")}ar.content=b("div",{class:"pi"},b("div",{class:"ui"},b("div",{class:"un"},b("i",{class:()=>"do"+(Gn(t)?.online()?" on":"")}),b("b",{style:()=>Gn(t)?.online()?"color:"+q(Gn(t)?.name):""},Gn(t)?.name)),t!==pe.id()?b("div",{style:"font-size:12px"},Gn(t)?.st()):b("div",{class:"st",contentEditable:!0,onBlur:function(e){const{textContent:n}=e.target;if(n&&n.length>50)return or(11);const a=Y(),r=n&&n.trim().length?n:null;Gn(t).tz(a),Gn(t).st(r??""),function(e){dn.send(ke.EditStatus(e))}({tz:a,st:r})}},Gn(t)?.st)),b("hr",null),(()=>{return Gn(t)?.tz()?b("div",{class:"sub"},b("i",null,"🕑")," Local time ",(e=Gn(t)?.tz(),(new Date).toLocaleTimeString(Intl.DateTimeFormat().resolvedOptions().locale,{timeZone:e,hour:"numeric",minute:"2-digit"}))):null;var e}),t!==pe.id()?b(Array.prototype,null,b("div",{class:"bt"},b("i",{class:"fl"},"💬")," ",b("a",{onClick:()=>(e=>{Ea(!1),us(),ca([e]),zn(0)})(t)},"Send private message")),b("div",{class:"bt"},b("i",null,"@")," ",b("a",{onClick:()=>(e=>{if(Ea(!1),!pe.id())return Cr();Br().innerHTML+=`@${Gn(e)?.name}`,Br().focus(),T(),da.add(e)})(t)},"Mention ",b("b",null,Gn(t)?.name))),Gn(t)?.online()?b("div",{class:"bt"},b("i",{class:"fl"},"↔"),b("a",{onClick:()=>{Ea(!1),location.hash="#&"+Cn.ntob(t)}},"Send direct p2p message")):null):b(Array.prototype,null,b("div",{class:"bt",onClick:()=>ws(Gn(t))},b("i",null,"✏️")," ",b("a",null,"Edit profile")),b("div",{class:"bt",onClick:()=>function({name:e}){ar.content=b("div",{class:"pi"},b("div",{class:"su"},b("div",{class:"head"},"Change Password"),b("div",{class:"sub"},e),b("form",{onSubmit:async function(t){t.preventDefault();let{o:n,p:a}=t.target;if(yr(J,a.value,n.value)){let t=await gr(e),r=await wr(e,t,a.value,n.value);if(r)return or(r);ir("password updated"),Ea(!1)}}},(()=>sr(12,13,14)&&b("div",{class:"erm"},rr())),b("input",{type:"password",name:"o",placeholder:"Old password",required:!0,autocomplete:"true",class:()=>sr(13)?"er":""}),b("input",{type:"password",name:"p",placeholder:"New password",required:!0,autocomplete:"true",class:()=>sr(12,14)?"er":""}),b("div",{class:"bn"},b("button",{type:"submit"},"Submit"))))),Ea(!0)}(Gn(t))},b("i",null,"🔒")," ",b("a",null,"Change password")),b("div",{class:"bt",onClick:()=>async function(){console.groupEnd(),console.groupCollapsed("[au]","logout"),Rn(0),Qn([]),Gn(pe.id())?.online(!1),Yn().clear(),Xn().clear(),await dn.send(ke.Logout(pe.salt)),await ee(),he({d:!1}),console.groupEnd(),Ea(!1),S("logout")}()},b("i",null,"🚪")," ",b("a",null,"Sign out")),b("div",{class:"v"},vs," ",gs))),Ea(!0)}},bs=f(0),ks=f(0);let Cs=!1;const Ss=e=>{let{id:t,txt:n,by:a,chanid:r,star:s,men:l,timestamp:o,showby:i,first:c,firstre:u,last:d,lastre:m,re:h,nor:f}=e,p=Cn.ntob(t);function g(){return["ct"].join(" ")}return setTimeout((()=>{M("cs")?.addEventListener("touchstart",(()=>Cs=!1),{passive:!0}),M("cs")?.addEventListener("touchmove",(()=>Cs=!0),{passive:!0})})),b("div",{id:p+"_",class:()=>"c"+(zn()===t||ks()==t?" cur":"")+(Rn()>0&&Rn()!==r?" bl":"")+(((new Date).getTime()-o.getTime())/1e3<60?" nc":"")+(h||f()?" r":"")+(c()||u()&&h!=Fn()?" fr":"")+(d()||m()&&h!=Fn()?" lr":""),onClick:t=>((e,t)=>{"ontouchstart"in document.documentElement||er(t.chanid)})(0,e),onTouchEnd:t=>((e,t)=>{Cs||er(t.chanid)})(0,e),onMouseOver:()=>bs()!==t&&bs(t),style:()=>"border-color:"+q(h||(f()?t:r))},(()=>u()&&h!=Fn()&&Xn(h)?b("div",{class:"re",style:()=>h||f()?"color:"+q(h||t):"",onMouseOver:()=>ks()!==h&&ks(h),onMouseOut:()=>ks(0)},b("i",null,"→"),b("b",null,Gn(Xn(h).by)?.name),b("a",{href:"#/"+Cn.ntob(h),onClick:e=>e.stopPropagation()},Xn(h)?.txt)):null),(()=>i()||c()||u()?b("div",null,b("a",{class:()=>"by"+(Gn(a)?.online()?" on":""),style:()=>Gn(a)?.online()?"color:"+q(Gn(a)?.name):"",onClick:e=>ys(e,a)},Gn(a)?.name)):null),b("div",{class:()=>s()?" star":"",style:()=>f()?"color:"+q(t):""},(()=>{let e=n();if(l&&l.length)for(const t of l){let n=Gn(t)?.name,a=pe.id()==t?"j":Gn(t)?.online()?"k":"i",r=Gn(t)?.online()?`style="color:${q(n)}"`:"";e=e.replaceAll("@"+n,`<b onclick="b(${t})" class="${a}" ${r}>@${n}</b>`)}return b("div",{class:g,innerHTML:e})}),(()=>f()&&t!=Fn()?b("p",{class:"mr"},b("i",null,"→"),b("a",{href:"#/"+p,onClick:e=>e.stopPropagation()},f()+(f()?" replies":" reply"))):null)),(()=>bs()===t&&pe.id()?fs(p,e):null))},Es=(e,t)=>{if(e.shiftKey)return((e,t)=>{let n=screen.width/2-300,a=screen.height/2-300;window.open(e,t,`toolbar=yes,location=yes,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=600,height=600,top=${a},left=${n}`)})("#"+Cn.ntob(t),t.toString()),e.preventDefault();er(t),e.stopPropagation()},xs=()=>{const e=document.createElement("div");return setTimeout((function(){new IntersectionObserver((e=>{if(e[0].intersectionRatio<=0)return;if(!xa.cb)return;!$n()[0]||Vn()||$n().length<jn||setTimeout((()=>{if(!xa.cb)return;let e=$n()[0];!e||Vn()||$n().length<jn||xa.cb(e)}))}),{}).observe(e)})),b(Array.prototype,null,b("div",{id:"os"}),b("div",{id:"cs"},e,(()=>{let e=[],t=0,n=null;return $n().reduce(((e,a)=>Q(Xn(a).timestamp,n)?Xn(a).chanid!=t?(t=Xn(a).chanid,e.push(f([a])),e):(e[e.length-1]().push(a),e):(n=Xn(a).timestamp,e.push(f(n)),t=Xn(a).chanid,e.push(f([a])),e)),e),Ar(f(e),(e=>{let t=e();if(t instanceof Date)return b("div",{class:"date"},function(e){let t=new Date;return Q(e,t)?"Today":(t.setDate(t.getDate()-1),Q(e,t)?"Yesterday":e.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric"}))}(t));{const t=Xn(e()[0]);return b("div",null,b("div",{class:"tn"},(()=>(e=>{let t=Yn(e);if(!t)return null;const n=()=>[...t.dir.slice(En.len()-2),t.id];return n().length>0&&b("div",{class:"dr",style:()=>"background:"+q(e)},Ar(n,(e=>b("span",null,b("a",{href:"#"+Cn.ntob(e),onClick:t=>Es(t,e)},Yn(e)?.fullname)))))})(t.chanid)),b("div",{class:"ts"},t.timestamp.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))),Ar(e,(e=>Ss(Xn(e)))))}}))}),(()=>Gn(ba())?b("div",null,b("div",{class:"tn"},b("div",{class:"dr",style:()=>"background:"+q(Gn(ba())?.name)},b("span",null,b("a",null,"↔ ",Gn(ba())?.name)))),Ar(Sa,(({by:e,txt:t,showby:n})=>Gn(e)?b("div",{class:"c",style:()=>"border-color:"+q(Gn(ba())?.name)},(()=>n?b("div",null,b("a",{class:()=>"by"+(Gn(e)?.online()?" on":""),style:()=>Gn(e)?.online()?"color:"+q(Gn(e)?.name):"",onClick:t=>ys(t,e)},Gn(e)?.name)):null),b("div",null,t)):b("div",null)))):null)),ms)},_s=[["","All messages"],["!","Private messages"],["@","Mentions"],["*","Stars"]],As=()=>{const e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=U((()=>{let t=e.textContent;t&&t.length>50||(Ha(t),Na(t))}),200),e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};const t=e=>b("ul",null,Ar(e.childids,(n=>{let a=e.childs(n);return b(Array.prototype,null,b("li",{class:()=>function(e){return[pe.chans().includes(e)?"":"on",e==Kn()?"se":""].join(" ")}(n),onClick:()=>function(e,t){e.open(!e.open()),Va(t)}(a,Yn(n))},b("div",{class:"sb"},b("i",null,(()=>a.childids().length?a.open()?"▼":"▶":""))),b("div",{class:"lb"},(()=>function(e){return Yn(e)?.md&&Yn(e)?.md()?"🔒":""}(n))," ",Yn(n)?.fullname),b("div",{class:"dot",onClick:e=>((e,t)=>{if(e.stopPropagation(),!pe.id())return Cr();pe.chans().includes(t)?Ya(t):Wa(t)})(e,n)})),(()=>a.open()&&a.childids().length?t(a):null))})));return b(Array.prototype,null,b("div",{class:"dn n"},b("i",{onClick:()=>S("lnclose")},"✕")),b("div",{class:"s"},e),pe.id()?b("ul",{class:"hm"},(()=>_s.map((e=>b("li",{class:(ya()[0]||"")==e[0]?"se":"",onClick:()=>location.hash=e[0]},e[1]))))):null,Ar(ka,(e=>b("div",null,b("div",{class:"tn"},b("div",{class:"dr",style:()=>"background:"+q(Gn(e)?.name)},b("span",null,b("a",{href:"#&"+Cn.ntob(e)},"↔ ",Gn(e)?.name))))))),b("div",{class:"nt"},(()=>Zn.childids().length?t(Zn):null)))};let Us="",Ts=0,Ds=!1;const Ms=()=>{const e=U((async e=>{if(Us=(e=>{Ts=D();let t=e.textContent,n=t.indexOf(" ",Ts);-1==n&&(n=t.length);var a=/[\S]+$/.exec(t.slice(0,n));return a?a[0]:""})(e.target).toLowerCase(),Us&&Us.length>50)return;let t=await async function(e){let t=await In.create("findusers",dn.send(ke.FindUsers(e)));na(t);let n=t.find((t=>t.name===e));if(n)ra(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));ra(n?t.indexOf(n):0)}return t.length}(Us);!t&&H(Us)&&na([{id:0,name:`✉️ Invite ${Us}`,online:!1}])}),100),t=b("div",{class:"am",contentEditable:!0,onKeyDown:function(e){if(sa(t),a(e))return;8!=e.keyCode||t.textContent.length||(ea.pop(),t.focus());if(32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return void e.preventDefault();"Enter"!==e.key&&"Tab"!==e.key||e.preventDefault()},onInput:e});function n({id:e}){na([]),ra(0),e?ea.add(e):ta.add(Us),t.textContent="",t.spellcheck=!1,t.focus()}function a(e){return!!na().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(n(na()[ra()]),e.preventDefault(),!0):27==e.keyCode?(na([]),ra(),!0):(38==e.keyCode&&(0===ra()?ra(na().length-1):ra(ra()-1),M(na()[ra()].id)?.focus(),e.preventDefault(),Ds=!0,setTimeout((()=>Ds=!1),300)),40==e.keyCode&&(ra()===na().length-1?ra(0):ra(ra()+1),M(na()[ra()].id)?.focus(),e.preventDefault(),Ds=!0,setTimeout((()=>Ds=!1),300)),e.target.focus(),!0))}const r=()=>b("div",{class:"uls adm"},b("ul",null,Ar(na,(e=>b("li",{id:e.id.toString(),tabIndex:-1,class:()=>na()[ra()]===e?"se":"",onClick:()=>n(e),onMouseOver:()=>function(e){Ds||ra(e)}(na().indexOf(e))},e.id?b("i",{class:()=>(Gn(e.id)?.online()," on")}):null," ",e.name))))),s=b("div",{class:"sel",onClick:()=>t.focus()},Ar(ta,(e=>b("div",{class:"tg ie"},e,b("i",{onClick:()=>ta.delete(e)},"✕")))),Ar(ea,(e=>b("div",{class:()=>Gn(e)?.online()?"tg on":"tg"},Gn(e)?.name,b("i",{onClick:()=>ea.delete(e)},"✕")))),t,(()=>sa()===t&&na().length>0&&r));return s.focus=()=>t.focus(),s},Ls=()=>{const e=["Public","Internal"],t=()=>Rn()?Yn(Rn()):Yn(Kn());const n=(e,t)=>{e.stopPropagation(),window.confirm("Do you want to delete this channel?\n"+t.fullname())&&(async e=>{dn.send(ke.DelChan(e))})(t.id)},a=()=>t()?.by===pe.id(),r=async(e,t)=>{let n=ea().length?ea():null,a=ta().length?ta():null;if(!n&&!a)return;let r=await(async(e,t,n)=>{let a=await In.create("addmems",dn.send(ke.AddMems({chanid:e,userids:t,emails:n})));return Za(e),a})(e,n,a);r?(ir(`added${s()} to ${t()}`),Ea(!1)):or(8)};function s(){let e=ea().length+ta().length;return e>0?" "+e+(e>1?" people":" person"):""}function l(e,{id:t,fullname:n,about:a,md:r}){e.preventDefault();let{n:s,m:l}=e.target,o=s.value.trim()==n()?null:s.value.trim(),i=l&&Number(l.value)!=r()?Number(l.value):null,c=M("ab")?.textContent?.trim()??null;c=c==(a()||"")?null:c;let u=function(e,t,n){return e&&0===e.length?10:n&&(n>2||n<0)||t&&t.length>1e3?11:0}(o,c,i);if(0===u){!function(e){dn.send(ke.EditChan(e))}({id:t,name:o,about:c,md:i}),Ea(!1)}else or(u)}return b(Array.prototype,null,b("div",{class:"dn"},b("i",{onClick:()=>S("rnclose")},"✕")),b("div",{class:"ub"},(()=>t()&&a()&&b("div",{title:"edit",onClick:()=>{return n=t(),ar.content=b("div",{class:"pi"},b("div",{class:"su et"},b("div",{class:"head"},"About"),b("div",{class:"sub"},n.fullname),b("form",{onSubmit:e=>l(e,n)},(()=>sr(10,11)&&b("div",{class:"erm"},rr())),b("input",{value:n.fullname,type:"text",name:"n",placeholder:"topic name",required:!0,class:()=>sr(10)?"er":""}),b("div",{id:"ab",class:"ab",contentEditable:!0},n.about),1==pe.id()&&(n?.md()??1)?b("select",{name:"m"},e.map(((e,t)=>b("option",{selected:()=>n.md()==t,value:t},e)))):null,b("div",{class:"bn"},b("button",{type:"submit"},"Save"))))),void Ea(!0);var n},class:"ed"},"✎")),b("div",{class:"head"},"About"),b("div",{class:"sub b"},(function(){return t()?.fullname})),b("div",{class:"sub"},(function(){return t()?.about}))),b("div",{class:"ub"},b("div",{class:"he"},"Settings"),b("div",{class:"sub"},(function(){return t()?[...e,"Private"][t().md()]:""}))),b("div",{class:"ft"},b("div",{class:"ub lf"},b("div",{class:"he"},"Members")),(()=>pe.id()>0&&b("div",{class:"rt"},(()=>t()&&b("button",{title:"add members",onClick:()=>(({id:e,fullname:t})=>{const n=Ms();ar.content=b("div",{class:"pi"},b("div",{class:"amb"},b("div",{class:"head"},"Add people"),b("div",{class:"sub"},t),n,b("div",{class:"bn"},b("button",{onClick:()=>r(e,t)},"Add",s)))),Ea(!0),n.focus()})(t())},"👤"))))),b("div",{class:"uls mem"},b("ul",null,Ar(Qn,(e=>b("li",{id:e.toString(),tabIndex:-1,style:()=>Gn(e)?.online()?"color:"+q(Gn(e)?.name):"",onClick:t=>ys(t,e)},e?b("i",{class:()=>"dot"+(Gn(e)?.online()?" on":"")}):null,Gn(e)?.name))))),(()=>t()&&a()&&b("div",{class:"ft dt"},b("div",{class:"ub lf"},b("div",{class:"he"},"Delete")),b("div",{class:"rt"},b("button",{title:"delete topic",onClick:e=>n(e,t())},"🗑️")))))},Ps=()=>ha()?Number(localStorage.getItem("w")||185):0,Os=()=>fa()?Number(localStorage.getItem("e")||185):0;function Is(){let e=localStorage.getItem("l");const t=null!==e&&"0"!==e&&window.innerWidth>650;ha(t);const n="1"==localStorage.getItem("r")&&window.innerWidth>650;fa(n),pa(Ps()),ga(Os())}function js(){ha(!ha()),pa(Ps()),localStorage.setItem("l",ha()?"1":"0")}function Ns(){fa(!fa()),ga(Os()),localStorage.setItem("r",fa()?"1":"0")}Is(),setTimeout(Is,100);const $s=()=>null,Ks=f($s);function Fs(){return b("div",{onMouseDown:function(){document.onmousemove=e=>{pa(e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("w",pa().toString())}},class:"dw"})}function zs(){return b("div",{onMouseDown:function(){document.onmousemove=e=>{ga(document.documentElement.offsetWidth-e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("e",ga().toString())}},class:"de"})}document.querySelector("body")?.append((()=>{C("nochan",(()=>Ks($s))),C("rnclose",Ns),C("lnclose",js);return b(Array.prototype,null,b("div",{class:"ma",style:()=>`left:${ha()&&window.innerWidth>650?pa():0}px;right:${fa()&&window.innerWidth>650?ga():0}px`},b("div",{class:"n"},b("div",null,b("ol",{class:"bc"},(()=>Ar(En.paths,(e=>b("li",null,b("a",{onClick:()=>(e=>{e.i===En.len()-1?Ks()===Ur?Ks($s):Ks(Ur):En.cd(e)})(e)},e.fullname)))))),(()=>pe.id()?b(Array.prototype,null,b("div",{onClick:js,class:"av mv"},b("i",null,"☰")),b("div",{onClick:Ns,class:"av iv"},b("i",null,"ⓘ")),b("div",{onClick:e=>ys(e,pe.id()),class:"av"},b("i",null,"👨🏻‍💻"))):b(Array.prototype,null,b("div",{class:"u"},b("a",{onClick:br},"sign up")),b("div",{class:"m"},b("a",{onClick:Cr},"log in"))))),Ks),xs),(()=>ha()&&b("div",{class:"ln",style:`width:${pa()}px`},As,Fs)),(()=>fa()&&b("div",{class:"rn",style:`width:${ga()}px`},Ls,zs)),(()=>va()>0&&b("div",{class:"err"},rr())),(()=>wa()&&b("div",{class:"inf"},wa())),(()=>Ea()&&b("div",{id:"mod",class:"mod",onClick:()=>Ea(!1)},b("div",{class:"pop",onClick:e=>e.stopPropagation()},ar.content))))})())}();
