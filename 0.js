!function(){"use strict";var e,t,n,r,o,a,i;!function(e){e.None=function(e){return{tag:"None",value:e}},e.Id=function(e){return{tag:"Id",value:e}},e.TopicId=function(e){return{tag:"TopicId",value:e}},e.ChannelId=function(e){return{tag:"ChannelId",value:e}},e.GroupId=function(e){return{tag:"GroupId",value:e}},e.By=function(e){return{tag:"By",value:e}}}(e||(e={})),function(e){e.Id=function(e){return{tag:"Id",value:e}},e.Email=function(e){return{tag:"Email",value:e}},e.Handle=function(e){return{tag:"Handle",value:e}}}(t||(t={})),function(e){e.Id=function(e){return{tag:"Id",value:e}},e.Handle=function(e){return{tag:"Handle",value:e}}}(n||(n={})),function(e){e.Id=function(e){return{tag:"Id",value:e}},e.Handle=function(e){return{tag:"Handle",value:e}}}(r||(r={})),function(e){e.Id=function(e){return{tag:"Id",value:e}}}(o||(o={})),function(e){e.User=function(e){return{tag:"User",value:e}},e.Group=function(e){return{tag:"Group",value:e}},e.Groups=function(e){return{tag:"Groups",value:e}},e.Channel=function(e){return{tag:"Channel",value:e}},e.Channels=function(e){return{tag:"Channels",value:e}},e.Topic=function(e){return{tag:"Topic",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.AddChat=function(e){return{tag:"AddChat",value:e}},e.AddUser=function(e){return{tag:"AddUser",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Topics=function(e){return{tag:"Topics",value:e}}}(a||(a={})),function(e){e.User=function(e){return{tag:"User",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Group=function(e){return{tag:"Group",value:e}},e.Groups=function(e){return{tag:"Groups",value:e}},e.Channel=function(e){return{tag:"Channel",value:e}},e.Channels=function(e){return{tag:"Channels",value:e}},e.Topic=function(e){return{tag:"Topic",value:e}},e.Topics=function(e){return{tag:"Topics",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.Chat=function(e){return{tag:"Chat",value:e}},e.Login=function(e){return{tag:"Login",value:e}}}(i||(i={}));const l=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),s=(e,t)=>{const{view:{buffer:n},pos:r}=e,o=n.byteLength;if(o-r>t)return e;const a=Math.max(2*o,o+t),i=new Uint8Array(a);return i.set(new Uint8Array(n)),l(i.buffer,r,e.littleEndian)},c=(e,t)=>{e=s(e,1);const{view:n,pos:r}=e;return n.setUint8(r,t),e.pos+=1,e},u=(e,t)=>{e=s(e,4);const{view:n,pos:r,littleEndian:o}=e;return n.setUint32(r,t,o),e.pos+=4,e},d=(e,t)=>{e=s(e,2);const{view:n,pos:r,littleEndian:o}=e;return n.setUint16(r,t,o),e.pos+=2,e};function p(e,t){const{view:n,pos:r,littleEndian:o}=e;return n.setUint32(o?r:r+4,t,o),n.setUint32(o?r+4:r,0,o),e.pos+=8,e}const f=(e,t)=>{e=s(e,4);const{view:n,pos:r,littleEndian:o}=e;return n.setInt32(r,t,o),e.pos+=4,e},g=new TextEncoder,h="encodeInto"in g?(e,t)=>g.encodeInto(e,t).written:(e,t)=>{const n=g.encode(e);return t.set(n),n.length},y=(e,t)=>{e=s(e,3*t.length+8);const n=h(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=p(e,n)).pos+=n,e},m=(e,t)=>c(e,t?1:0),v=e=>(t,n)=>n.reduce(e,((e,t)=>p(s(e,8),t))(t,n.length)),w=e=>(t,n)=>null===n?c(t,0):e(c(t,1),n),b=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},A=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getUint32(t,r)},C=e=>{const{view:t,pos:n,littleEndian:r}=e;return e.pos+=8,t.getUint32(r?n:n+4,r)},I=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getInt32(t,r)},k=e=>1===b(e),E=e=>t=>1===b(t)?e(t):null,S=e=>t=>{const n=C(t),r=new Array;for(let o=0;o<n;o++)r.push(e(t));return r},U=new TextDecoder,x=e=>{const t=C(e),{pos:n,view:{buffer:r}}=e,o=U.decode(new Uint8Array(r,n,t));return e.pos+=t,o};var T=w(y),L=w(m),$=y,H=w($),P=v(c),N=v(f),_=function(e,t){var n=t.id,r=t.handle,o=t.email,a=t.emailVerified,i=t.name,l=t.key,s=t.picture,c=t.gender,u=t.lastLogin,d=t.createdAt,p=t.updatedAt;return $($(H(L(T(y(y(m(y(y(f(e,n),r),o),a),i),l),s),c),u),d),p)},M=(v(_),function(e,t){var n=t.id,r=t.name,o=t.handle,a=t.by,i=t.createdAt,l=t.updatedAt;return $($(f(y(y(f(e,n),r),o),a),i),l)}),O=(v(M),function(e,t){var n=t.id,r=t.name,o=t.handle,a=t.groupId,i=t.by,l=t.createdAt,s=t.updatedAt;return $($(f(f(y(y(f(e,n),r),o),a),i),l),s)}),j=(v(O),function(e,t){var n=t.id,r=t.name,o=t.groupId,a=t.channelId,i=t.by,l=t.createdAt,s=t.updatedAt;return $($(f(f(f(y(f(e,n),r),o),a),i),l),s)}),D=(v(j),function(e,t){var n=t.id,r=t.txt,o=t.by,a=t.re,i=t.nor,l=t.topicId,s=t.channelId,c=t.groupId,u=t.createdAt,d=t.updatedAt;return $($(f(f(f(f(f(f(y(f(e,n),r),o),a),i),l),s),c),u),d)}),G=(v(D),function(e,t){var n=t.filter,r=t.ub,o=t.lb,a=t.limit;return d(f(f(function(e,t){switch(t.tag){case"None":return m(u(e,0),t.value);case"Id":return f(u(e,1),t.value);case"TopicId":return f(u(e,2),t.value);case"ChannelId":return f(u(e,3),t.value);case"GroupId":return f(u(e,4),t.value);case"By":return f(u(e,5),t.value)}}(e,n),r),o),a)}),B=function(e,t){switch(t.tag){case"User":return function(e,t){switch(t.tag){case"Id":return f(u(e,0),t.value);case"Email":return y(u(e,1),t.value);case"Handle":return y(u(e,2),t.value)}}(u(e,0),t.value);case"Group":return function(e,t){switch(t.tag){case"Id":return f(u(e,0),t.value);case"Handle":return y(u(e,1),t.value)}}(u(e,1),t.value);case"Groups":return function(e,t){var n=t.limit,r=t.page;return d(d(e,n),r)}(u(e,2),t.value);case"Channel":return function(e,t){switch(t.tag){case"Id":return f(u(e,0),t.value);case"Handle":return y(u(e,1),t.value)}}(u(e,3),t.value);case"Channels":return function(e,t){var n=t.group_id,r=t.limit,o=t.page;return d(d(f(e,n),r),o)}(u(e,4),t.value);case"Topic":return function(e,t){switch(t.tag){case"Id":return f(u(e,0),t.value)}}(u(e,5),t.value);case"Chats":return G(u(e,6),t.value);case"AddChat":return D(u(e,7),t.value);case"AddUser":return function(e,t){var n=t.email,r=t.handle,o=t.key;return P(y(y(e,n),r),o)}(u(e,8),t.value);case"Login":return function(e,t){var n=t.email,r=t.key;return P(y(e,n),r)}(u(e,9),t.value);case"Users":return N(u(e,10),t.value);case"Topics":return N(u(e,11),t.value)}},R=E(x),K=E(k),q=x,F=E(q),Y=S(b),V=(S(I),function(e){return{id:I(e),handle:x(e),email:x(e),emailVerified:k(e),name:x(e),key:x(e),picture:R(e),gender:K(e),lastLogin:F(e),createdAt:q(e),updatedAt:q(e)}}),z=S(V),W=function(e){return{id:I(e),name:x(e),handle:x(e),by:I(e),createdAt:q(e),updatedAt:q(e)}},J=S(W),Z=function(e){return{id:I(e),name:x(e),handle:x(e),groupId:I(e),by:I(e),createdAt:q(e),updatedAt:q(e)}},Q=S(Z),X=function(e){return{id:I(e),name:x(e),groupId:I(e),channelId:I(e),by:I(e),createdAt:q(e),updatedAt:q(e)}},ee=S(X),te=function(e){return{id:I(e),txt:x(e),by:I(e),re:I(e),nor:I(e),topicId:I(e),channelId:I(e),groupId:I(e),createdAt:q(e),updatedAt:q(e)}},ne=S(te),re=function(e){switch(A(e)){case 0:return i.User(V(e));case 1:return i.Users(z(e));case 2:return i.Group(W(e));case 3:return i.Groups(J(e));case 4:return i.Channel(Z(e));case 5:return i.Channels(Q(e));case 6:return i.Topic(X(e));case 7:return i.Topics(ee(e));case 8:return i.Chats(ne(e));case 9:return i.Chat(te(e));case 10:return i.Login(Y(e))}throw new Error("bad variant index for Response")},oe=l(new ArrayBuffer(512)),ae=function(e,t){return oe.pos=0,oe=t(oe,e),new Uint8Array(oe.view.buffer).slice(0,oe.pos)},ie=function(e,t){return t(l(e))},le=function(e){return ie(e.buffer,re)},se=function(e){return ae(e,B)};const ce=e=>new Zlib.Inflate(e).decompress(),ue=e=>new Zlib.Deflate(e).compress(),de=[];function pe(e){let t={};return function(){const n=de.slice.call(arguments),r=n.map((e=>{if(he(e)||Array.isArray(e)){let t={};for(let n in e)t[n]=ge(e[n]);return t}return ge(e)})),o=JSON.stringify(r);let a=t[o];return void 0===a&&(a=e.apply(this,n),a&&11===a.nodeType&&(a=de.slice.call(a.childNodes)),t[o]=a),a}}let fe=0;function ge(e){return"function"==typeof e||e instanceof Node?(e.$m||(e.$m=++fe),{$m:e.$m}):e}function he(e){if("object"!=typeof e||null===e)return!1;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function ye(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var me,ve,we=ye((function(e,t){function n(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){void 0===e&&(e=0);var r=null==t?void 0:t.grow;this.grow=r&&isFinite(r)&&n(r)||r||0,this.buffer="number"==typeof e?new Uint8Array(n(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var r=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(r<=this.grow){var o=new Uint8Array(r);o.set(this.buffer),this.buffer=o}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var r=t,o=r>>3,a=128>>r%8,i=this.buffer[o];r<n;r++)e(!!(i&a),r),a=1===a?(i=this.buffer[++o],128):a>>1},e}();t.default=r}(ve={path:me,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&ve.path)}},ve.exports),ve.exports));let be,Ae=[];function Ce(e){let t=be,n=()=>{};be=n,Ee(n);let r=e((()=>{ke(n),be=void 0}));return be=t,r}function Ie(e){function t(n){if(0===arguments.length)return be&&!t.__o.has(be)&&(t.__o.add(be),be.u.push(t)),e;e=n;let r=be;return be=void 0,t.o=new Set(t.__o),t.o.forEach((e=>e.i=!1)),t.o.forEach((e=>{e.i||e()})),be=r,e}return t.$o=1,t.__o=new Set,t.t=Ae,t}function ke(e){e.__c.forEach(ke),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),Ee(e)}function Ee(e){e.u=[],e.__c=[],e.l=[]}const Se=()=>window.scrollTo(0,document.body.scrollHeight),Ue=pe((e=>pe(((t,n)=>Ce((()=>e(t,n))))))),xe=e=>(t,...n)=>()=>Ue(e())(t,n),Te=e=>{console.log("Length",e instanceof ArrayBuffer?new Uint8Array(e).length:e.length,"bytes"),console.log((Object(e).buffer instanceof ArrayBuffer?e:"string"==typeof e?new TextEncoder("utf-8").encode(e):new Uint8ClampedArray(e)).reduce(((e,t,n,r)=>e+(n%16==0?n.toString(16).padStart(6,0)+"  ":" ")+t.toString(16).padStart(2,0)+(n===r.length-1||n%16==15?" ".repeat(3*(15-n%16))+Array.from(r).splice(n-n%16,16).reduce(((e,t)=>e+(t>31&&t<127||t>159?String.fromCharCode(t):".")),"  ")+"\n":"")),""))},Le=(e,t)=>{let n=0,r=0;for(;n<e.length;)r>=t.length&&(r=0),e.set([e[n]^t[r]],n),n++,r++},$e=(e,t)=>(Le(e,t),Ne(e,t)),He=e=>{let{a:t,k:n}=Pe(e);return Le(t,n),{a:t,k:n}},Pe=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},Ne=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},_e=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),Me=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},Oe=e=>(performance.now()-e).toFixed(2),je=(e,t=64,n=8)=>$e(e,crypto.getRandomValues(new Uint8Array(_e(n,t)))),De=e=>{try{return new Uint8Array((e=>{const t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let t=0,r=e.length;t<r;t++)n[t]=e.charCodeAt(t);return t})(atob(e)))}catch(e){console.log(e)}},Ge=async(e,t,n)=>(console.log("[sec] encrypting data"),await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e)),Be=async(e,t,n)=>(console.log("[sec] decrypting data"),await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e)),Re={};async function Ke(e,t){let n=new TextEncoder,r=await qe(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",r)}async function qe(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}!async function(){let e=localStorage.getItem("a");Re.salt=De(e),Re.salt&&Re.salt.length>32&&(Re.salt=null);const t=De(localStorage.getItem("s"));t&&32==t.length&&(console.log(e),Te(t),Re.sskey=await crypto.subtle.importKey("raw",t,"AES-GCM",!1,["encrypt","decrypt"]))}();const Fe=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),Ye="wss://"+(Fe?Fe.groups.ip:"192.168.100.11:443");let Ve,ze,We,Je,Ze,Qe,Xe,et,tt,nt,rt,ot=500,at=0,it={ready:!1},lt=0,st=1;console.group("[ws]","starting..."),function e(t){Ve=performance.now(),ze=new WebSocket(Ye),ze.binaryType="arraybuffer",ze.onopen=()=>{console.log(`[ws] open in ${Oe(Ve)} ms`),console.groupEnd("[ws]"),console.group("[dc]","opening..."),t?ut():Ze&&ft()},ze.onmessage=async e=>{console.log(`[ws] <- received answer in ${Oe(Ve)} ms`);let t=new Uint8Array(e.data),{a:n,k:r}=He(t);var o,a,i;ct=(e=>{const t=new we(e);return{z:t.get(0),m:t.get(1),c:t.get(2),d:t.get(3)}})(n),console.log(ct),it.onconfig&&it.onconfig(ct),r=await(o=r,crypto.subtle.importKey("raw",o,{name:"ECDH",namedCurve:"P-256"},!0,[])),nt=await(a=Je.privateKey,i=r,crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:i},a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])),tt=new Uint8Array(await crypto.subtle.exportKey("raw",nt));let l=JSON.parse((e=>(new TextDecoder).decode(ce(e)))(n.slice(1))),s=l.answer?l.answer:l;if(await Qe.setRemoteDescription(new RTCSessionDescription(s)),!l.candidate)return;const c=new RTCIceCandidate({candidate:l.candidate,sdpMid:0,sdpMLineIndex:0});await Qe.addIceCandidate(c)},ze.onclose=t=>{at++,ot+=_e(0,at<16?200:3e3),console.log("[ws] closed",t),console.groupEnd("[ws]"),console.groupEnd("[ws]"),console.groupCollapsed("[ws]",`retry ${at} in ${(ot/1e3).toFixed(2)} sec`),setTimeout((()=>{e(!0)}),ot)},ze.onerror=e=>{console.log("[ws] error",e)}}(),ut();var ct={};function ut(){Xe=!1,function(){Qe=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});let e=st++;Qe.onicecandidate=e=>{e.candidate},Qe.onconnectionstatechange=t=>{switch(Qe.connectionState){case"failed":case"disconnected":console.log("[peer]",e,"restarting....")}},Qe.oniceconnectionstatechange=e=>{switch(Qe.iceConnectionState){case"disconnected":console.log("[ice] restarting....")}}}(),rt=Qe.createDataChannel("cu",{}),rt.binaryType="arraybuffer",lt=0,it.send=dt,rt.onopen=e=>{console.log(`[dc] open in ${Oe(Ve)} ms`),console.groupEnd("[dc]"),lt=0,it.ready=!0,it.open&&it.open(e)},rt.onmessage=pt,rt.onclose=e=>{console.log("[dc] close",e)},rt.onerror=e=>{console.log("[dc] error:",e)},async function(){const e=async()=>{let e=await Qe.createOffer();return await Qe.setLocalDescription(e),ue((new TextEncoder).encode(Qe.localDescription.sdp))},t=async()=>{if(et)return et;Je=await(async()=>(console.log("[sec] generating key pairs"),await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"])))();let e=await crypto.subtle.exportKey("raw",Je.publicKey);return et=new Uint8Array(e),et};Ze=await(async(e,t,n)=>{let[r,o]=await Promise.all([e(),t()]);return n?$e($e(r,o),n):je($e(r,o),64,24)})(e,t,Re.salt),console.log(`[dc] sdp in ${Oe(Ve)} ms`),1===ze.readyState&&ft()}()}async function dt(e){if(lt++,console.groupEnd("[dc]"),console.group("[dc]","-> sending packet",lt,e),e=se(e),Te(e),ct.z&&(e=ue(e)),ct.m&&(e=je(e,e.length),Le(e,tt)),ct.c){const t=crypto.getRandomValues(new Uint8Array(12));Le(e,t),e=Me(t,new Uint8Array(await Ge(e,nt,t)))}if(ct.d){const t=crypto.getRandomValues(new Uint8Array(12));Le(e,t),e=Me(t,new Uint8Array(await Ge(e,Re.sskey,t)))}rt.send(e),We=performance.now(),console.groupEnd("[dc]")}async function pt(e){let t=new Uint8Array(e.data),n=t.length;if(console.groupEnd("[dc]"),console.group("[dc]","<- received",n,"bytes in",Oe(We),"ms"),ct.d){let e=t.subarray(0,12);t=new Uint8Array(await Be(t.subarray(12),Re.sskey,e)),Le(t,e)}if(ct.c){let e=t.subarray(0,12);t=new Uint8Array(await Be(t.subarray(12),nt,e)),Le(t,e)}if(ct.m){Le(t,tt);let{a:e}=He(t);t=new Uint8Array(e)}ct.z&&(t=ce(t));let r=(100*n/t.length).toFixed(2);console.log(`[dc] unpacked ${n} / ${t.length} bytes ${r}% in ${Oe(We)} ms`);let o=gt(t);it.recv&&it.recv(o),console.groupEnd("[dc]")}const ft=()=>{Xe||(console.log("[ws] -> sending offer"),ze.send(Ze),Xe=!0)},gt=e=>{let t=le(e);return console.log(t),console.table(t.value),t};let ht={},yt=[];function mt(e){return this.t&&this.t[e.type](e)}ht.h=(...e)=>{let t,n=r=>{if(null==r);else if("string"==typeof r)t?ht.add(t,r):t=ht.s?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);else if(Array.isArray(r))t||(t=document.createDocumentFragment()),r.forEach(n);else if(r instanceof Node)t?ht.add(t,r):t=r;else if("object"==typeof r)ht.property(t,r,null,ht.s);else if("function"==typeof r)if(t){let e=ht.add(t,"");ht.insert(t,r,e)}else t=r.apply(null,e.splice(1));else ht.add(t,""+r)};return e.forEach(n),t},ht.insert=(e,t,n,r,o)=>(e=n&&n.parentNode||e,o=o||r instanceof Node&&r,t===r||(r&&"string"!=typeof r||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?ht.subscribe((()=>{r=ht.insert(e,t.call({el:e,endMark:n}),n,r,o)})):(n?r&&(o||(o=r.o&&r.o.nextSibling||n.previousSibling),ht.rm(e,o,n)):e.textContent="",r=null,t&&!0!==t&&(r=ht.add(e,t,n))):(null!=r&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?ht.add(e,t,n):e.textContent=t,r=t)),r),ht.property=(e,t,n,r,o)=>{if(null!=t)if(!n||"attrs"===n&&(r=!0))for(n in t)ht.property(e,t[n],n,r,o);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?ht.subscribe((()=>{ht.property(e,t.call({el:e,name:n}),n,r,o)})):o?e.style.setProperty(n,t):r||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:ht.property(e,t,null,r,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,mt):e.removeEventListener(t,mt),(e.t||(e.t={}))[t]=n})(e,n,t)},ht.add=(e,t,n)=>{let r=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:ht.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:ht.h(yt,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),r},ht.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},ht.subscribe=function(e){return function(e,t){function n(){let r=be;return be&&be.__c.push(n),ke(n),n.i=!0,be=n,t=e(t),be=r,t}function r(){return n.i?be&&n.u.forEach((e=>e())):t=n(),t}e.s=n,Ee(n),n(),r.$o=1}(e),()=>ke(e.s)},ht.cleanup=function(e){return be&&be.l.push(e),e},ht.root=Ce,ht.sample=function(e){let t=be;be=void 0;let n=e();return be=t,n},ht.hs=(...e)=>{let t=ht.s;ht.s=!0;let n=vt(...e);return ht.s=t,n};let vt=(...e)=>ht.h.apply(ht.h,e);function wt(e,t,n){const{root:r,subscribe:o,sample:a,cleanup:i}=ht;null==n&&(n=!t.$t);let l=ht.h([]),s=ht.add(l,""),c=new Map,u=new Map,d=new Set;function p(e,o){if(null==e)return;let a=u.get(e);return 1===o?(d.delete(e),a||(a=n?r((n=>(c.set(e,n),t(e.$v||e)))):t(e.$v||e),11===a.nodeType&&(a=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let r=Array.from(t);return{nodeType:111,t:r[0],o:r[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(r[t++])}return e}}})(a)||a),u.set(e,a))):-1===o&&d.add(e),((e,t)=>111===e.nodeType?1/t<0?t?ht.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(a,o)}function f(e){let t=c.get(e);t&&(t(),c.delete(e)),u.delete(e)}return i(o((t=>{let n=e();return a((()=>{d.clear();let e=Array.from(function(e,t,n,r,o){let a,i,l=new Map,s=new Map;for(a=0;a<t.length;a++)l.set(t[a],a);for(a=0;a<n.length;a++)s.set(n[a],a);for(a=i=0;a!==t.length||i!==n.length;){var c=t[a],u=n[i];if(null===c)a++;else if(n.length<=i)e.removeChild(r(t[a],-1)),a++;else if(t.length<=a)e.insertBefore(r(u,1),r(t[a],0)||o),i++;else if(c===u)a++,i++;else{var d=s.get(c),p=l.get(u);void 0===d?(e.removeChild(r(t[a],-1)),a++):void 0===p?(e.insertBefore(r(u,1),r(t[a],0)||o),i++):(e.insertBefore(r(t[p],1),r(t[a],0)||o),t[p]=null,p>a+1&&a++,i++)}}return n}(s.parentNode,t||[],n,p,s));return d.forEach(f),e}))}))),i((function(){c.forEach((e=>e())),c.clear(),u.clear(),d.clear()})),l}const bt=()=>It()===At?It(Ct):It(At),At=({items:e,keys:t},...n)=>vt([vt("table",null,vt("thead",null,vt("tr",null,wt(t,(e=>vt("th",{scope:"col"},e))))),vt("tbody",null,wt(e,(e=>vt("tr",{onclick:t=>location.hash="#channels/"+e.id},wt(t,(t=>vt("td",null,vt("span",null,t)," ",e[t])))))))),n]),Ct=({items:e},...t)=>vt([vt("ul",null,wt(e,(e=>vt("li",{id:e.id},e.name)))),t]),It=Ie(At);const kt=({group_id:e})=>{let t=Ie([]),n=0;it.recv=e=>{let r=e.value;if(Array.isArray(r))return 0==r.length?n--:t(r);let o=t();o.unshift(r),t(o)};const r=t=>a.Channels({group_id:e,limit:30,page:t}),o=e=>{n++,it.send(r(n))};return it.open=e=>o(),it.ready&&o(),vt([vt("button",{onclick:e=>{n--,n<1&&(n=1),it.send(r(n))}},"Prev Item"),vt("button",{onclick:o},"Next Item"),vt("button",{onclick:e=>{n=0;let t=setInterval((function(){300==n?clearInterval(t):o()}),1)}},"Run Load"),vt("button",{onclick:Et},"Switch Component"),vt("h2",null,"Channels"),vt(xe(xt),{items:t,keys:()=>Object.keys(t()[0]||{})})])},Et=()=>xt()===St?xt(Ut):xt(St),St=({items:e,keys:t},...n)=>vt([vt("table",null,vt("thead",null,vt("tr",null,wt(t,(e=>vt("th",{scope:"col"},e))))),vt("tbody",null,wt(e,(e=>vt("tr",{onclick:t=>location.hash="#topics/"+e.id},wt(t,(t=>vt("td",null,vt("span",null,t)," ",e[t])))))))),n]),Ut=({items:e},...t)=>vt([vt("ul",null,wt(e,(e=>vt("li",{id:e.id},e.name)))),t]),xt=Ie(St),Tt="defaultParagraphSeparator",Lt="formatBlock",$t=(e,t,n)=>e.addEventListener(t,n),Ht=(e,t)=>e.appendChild(t),Pt=e=>document.createElement(e),Nt=e=>document.queryCommandState(e),_t=(e,t=null)=>document.execCommand(e,!1,t),Mt={bold:{icon:"<b>B</b>",title:"Bold",state:()=>Nt("bold"),result:()=>_t("bold")},italic:{icon:"<i>I</i>",title:"Italic",state:()=>Nt("italic"),result:()=>_t("italic")},underline:{icon:"<u>U</u>",title:"Underline",state:()=>Nt("underline"),result:()=>_t("underline")},strikethrough:{icon:"<strike>S</strike>",title:"Strike-through",state:()=>Nt("strikeThrough"),result:()=>_t("strikeThrough")},heading1:{icon:"<b>H1</b>",title:"Heading 1",result:()=>_t(Lt,"<h1>")},heading2:{icon:"<b>H2</b>",title:"Heading 2",result:()=>_t(Lt,"<h2>")},quote:{icon:"&#8220;&#8221;",title:"Quote",result:()=>_t(Lt,"<blockquote>")},olist:{icon:"1.",title:"Ordered List",result:()=>_t("insertOrderedList")},ulist:{icon:"&#8226;",title:"Unordered List",result:()=>_t("insertUnorderedList")},code:{icon:"&lt;&gt;",title:"Code",result:()=>_t(Lt,"<pre>")},line:{icon:"&#8213;",title:"Horizontal Line",result:()=>_t("insertHorizontalRule")},link:{icon:"&#128279;",title:"Link",result:()=>{const e=window.prompt("Enter the link URL");e&&_t("createLink",e)}},image:{icon:"&#128247;",title:"Image",result:()=>{const e=window.prompt("Enter the image URL");e&&_t("insertImage",e)}}},Ot={actionbar:"pell-actionbar",button:"pell-button",content:"pell-content",selected:"pell-button-selected",topic:"pell-topic"};let jt,Dt=indexedDB.open("sonic",1);Dt.onsuccess=function(e){jt=e.target.result,console.log("[db] opened")},Dt.onupgradeneeded=function(e){jt=e.target.result;jt.createObjectStore("store"),jt.createObjectStore("chats",{keyPath:"id"}),jt.createObjectStore("users",{keyPath:"id"}),jt.createObjectStore("topics",{keyPath:"id"});console.log("[db] setup complete")};const Gt=async(e,t)=>{Te(t),jt.transaction(["store"],"readwrite").objectStore("store").put(t,e),caches.open("sonic").then((function(n){n.put(e,new Response(t))}));const n=(r=t,btoa(String.fromCharCode.apply(null,new Uint8Array(r))));var r;localStorage.setItem(e,n),console.log(n)},Bt=(e,t)=>{let n=jt.transaction([e],"readwrite").objectStore(e);t.forEach((e=>n.add(e)))},Rt=(e,t)=>{let n={},r=new Set,o=jt.transaction([e],"readwrite").objectStore(e),a=0;return new Promise((e=>{t.forEach((i=>{let l=o.get(i);l.onsuccess=o=>{l.result?n[i]=l.result:r.add(i),++a===t.length&&e({value:n,missed:Array.from(r)})}}))}))},Kt=([e,t])=>{let n=new Set;for(var r=e;r<=t;r++)n.add(r);return n},qt=e=>{var t,n=[];return e.sort(((e,t)=>e[0]-t[0]||e[1]-t[1])),e.forEach((e=>{!t||e[0]>t[1]+1?n.push(t=e):e[1]>t[1]&&(t[1]=e[1])})),n},Ft=e=>e.reduce(((e,t)=>(e[t.id]=t,e)),{}),Yt=({topic_id:t,chat_id:n})=>{let r=Ie([]),o={},i={},l={},s=Ie(0),c=0,u="";const d=((...e)=>{const t={},n={};return{create:e=>n[e]=new Promise((n=>t[e]=n)),complete:(e,n)=>t[e](n),join:e=>n[e],joinall:()=>Promise.all(e.map((e=>n[e]))),select:()=>Promise.race(e.map((e=>n[e])))}})("users","topics");it.recv=async e=>{switch(e.tag){case"Users":Bt("users",e.value),d.complete("users",e.value);break;case"Topics":Bt("topics",e.value),d.complete("topics",e.value);break;case"Chat":let t=window.scrollY+window.innerHeight===document.body.scrollHeight,n=r();e.value.nor=Ie(0),e.value.star=Ie(!1),o[e.value.id]=e.value,n.push(e.value.id),r(n),t&&Se();break;case"Chats":let a=e.value;if(0==a.length)return;Bt("chats",a),((e,t)=>{let n=jt.transaction(["store"],"readwrite").objectStore("store"),r=n.get(e);r.onsuccess=o=>{if(!r.result)return n.put([t],e);r.result.push(t),n.put(qt(r.result),e)}})("chats",[a[a.length-1].id,a[0].id]),p(a)}};const p=async e=>{let n=e[0].id,s=new Set,c=new Set,u=r();u=e.reverse().map((e=>(e.nor=Ie(e.nor),e.star=Ie(!1),e.createdAt=new Date(e.createdAt),e.updatedAt=new Date(e.updatedAt),o[e.id]=e,s.add(e.by),c.add(e.topicId),e.id))).concat(u);let p=await Rt("users",Array.from(s)),f=await Rt("topics",Array.from(c));console.log("users",p),console.log("topics",f),i={...i,...p.value},l={...l,...f.value},p.missed.length>0&&d.create("users",it.send(a.Users(p.missed))),f.missed.length>0&&d.create("topics",it.send(a.Topics(f.missed)));let[g,h]=await d.joinall();g&&(i={...i,...Ft(g)}),h&&(l={...l,...Ft(h)}),r(u),t&&(document.title=l[t].name),window.scrollY<100&&setTimeout((()=>document.getElementById(n).scrollIntoView()))},f=(r,o,i)=>{let l=a.Chats({filter:t>0?e.TopicId(t):n>0?e.Id(n):e.None(!0),ub:r||99999,lb:o,limit:i});it.send(l)},g=async(e,t=30)=>{let n=e||r()[0];if(n){let e=await((e,t)=>{console.log("scan",e,t);let n=[],r=Kt(t),o=jt.transaction([e],"readwrite").objectStore(e);return new Promise((e=>{o.openCursor(IDBKeyRange.bound(...t),"prev").onsuccess=t=>{var o=t.target.result;o?(n.push(o.value),r.delete(o.key),o.continue()):e({value:n,missed:Array.from(r)})}}))})("chats",[n-t,n-1]);console.log("chats",e);let r=e.value[0]?e.value[0].id:0;return r?p(e.value):f(n,r,t)}let o=await((e,t)=>{let n=[],r=jt.transaction([e],"readwrite").objectStore(e),o=0;return new Promise((e=>{r.openCursor(null,"prev").onsuccess=r=>{var a=r.target.result;if(a){if(n.push(a.value),++o===t)return e({value:n});a.continue()}else{console.log("No more entries!");let r=n[o-1],a=Kt([r+o+1-t,r]);e({value:n,missed:Array.from(a)})}}}))})("chats",t);console.log("chats",o);let a=o.value[0]?o.value[0].id:0;a&&p(o.value),f(n,a,t)};it.ready||(it.open=e=>{it.open=void 0,setTimeout((()=>g()))}),setTimeout((function(){new IntersectionObserver((e=>{e[0].intersectionRatio<=0||it.ready&&setTimeout((()=>g()))}),{}).observe(A)}));const h=(e=>{const t=e.actions?e.actions.map((e=>"string"==typeof e?Mt[e]:Mt[e.name]?{...Mt[e.name],...e}:e)):Object.keys(Mt).map((e=>Mt[e])),n={...Ot,...e.classes},r=e.defaultParagraphSeparator||"div",o=e.element.topic=Pt("div");o.contentEditable=!0,o.className=n.topic,o.onkeydown=e=>{"Enter"===e.key&&(a.focus(),e.preventDefault())},Ht(e.element,o);const a=e.element.content=Pt("div");a.contentEditable=!0,a.className=n.content,a.onfocus=()=>{let t=window.scrollY+window.innerHeight===document.body.scrollHeight;e.element.classList.add("sticky"),t&&setTimeout((()=>Se()))},a.onblur=()=>{setTimeout((()=>{e.element.contains(document.activeElement)||e.element.classList.remove("sticky")}))},a.oninput=({target:{firstChild:t}})=>{e.onchange(a.innerHTML)},a.onkeydown=t=>{"Enter"!==t.key||t.shiftKey||(e.onsend(),t.preventDefault())},Ht(e.element,a);const i=Pt("div");return i.className=n.actionbar,Ht(e.element,i),t.forEach((e=>{const t=Pt("button");if(t.className=n.button,t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=()=>e.result()&&a.focus(),e.state){const r=()=>t.classList[e.state()?"add":"remove"](n.selected);$t(a,"keyup",r),$t(a,"mouseup",r),$t(t,"click",r)}Ht(i,t)})),e.styleWithCSS&&_t("styleWithCSS"),_t(Tt,r),e.element})({element:vt("div",{class:"pell"}),onchange:e=>{},onsend:()=>{if(!h.content.textContent.trim())return;let e=s()||c,{topicId:t,channelId:n,groupId:r}=o[e];h.topic.textContent!==u&&(e=0,t=Object.keys(l).length+1,l[t].name=h.topic.textContent);let i=h.content.innerHTML.trim(),d=(new Date).toISOString();it.send(a.AddChat({id:0,txt:i,by:1,re:e,nor:0,topicId:t,channelId:n,groupId:r,createdAt:d,updatedAt:d})),h.content.textContent="",y({})}});h.content.innerHTML="";const y=({id:e,txt:t})=>{if(!e||s()===e)return h.topic.textContent="",u="",void s(0);h.topic.innerHTML=t,h.topic.textContent=h.topic.textContent,u=h.topic.textContent,s(e)},m=(e,n)=>{let{id:a,txt:u,by:d,topicId:p,re:f,star:g,nor:h}=e,y=o[c]||{},m=y.by!==d,b=y.topicId!==p;c=a;let A=l[p];const C=()=>{v("#reps/"+a,a)};return vt("div",{id:a,class:function(){return"chat"+(()=>(g()?" star":"")+(b?" topic":"")+(s()===a?" cur":"")).call(this)},onclick:t=>w(t,e)},b?vt("div",{class:"topic-name"+(f?" re":" new")+(t?" head":"")},vt("a",{href:function(){return"#chats/"+("function"==typeof p?p.call(this):p)},onclick:e=>(v("#chats/"+p,A.name),e.preventDefault(),!1),innerHTML:A.name})):null,m||b?vt("div",{class:"by"},i[d].handle):null,vt("div",{onclick:e=>e.stopPropagation()},(()=>{let e=h();if(1!==e||a!==o[r()[n+1]].re)return e>0?vt([vt("span",{class:"rep",onclick:C},e," 💬")," "]):void 0}),(e=>document.createRange().createContextualFragment(e))(u)))},v=(e,t)=>{let n=screen.width/2-300,r=screen.height/2-300;window.open(e,t,`toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=600,height=600,top=${r}, left=${n}`)},w=(e,t)=>{e.x<18&&e.offsetY<22&&b(t),e.x+28>e.target.offsetWidth&&e.offsetY<22&&y(t)},b=({id:e,star:t})=>{const n=r().filter((t=>t===e))[0],a=o[n];a.star?a.star(!t()):a.star=Ie(!1)},A=vt("div",{class:"sentinel"});return vt([A,vt("div",{class:"topics"},wt(r,((e,t)=>m(o[e],t)))),h])};var Vt;it.onconfig=e=>{e.d?Jt(Wt):Jt(zt)};const zt=()=>(it.recv=async e=>{switch(e.tag){case"Login":if(e.value.length<16)return void console.warn("login failed");Re.salt=new Uint8Array(e.value),Re.sskey=await qe(Vt,Re.salt);let t=await crypto.subtle.exportKey("raw",Re.sskey);Gt("a",Re.salt.buffer),Gt("s",t),ct.d=!0,Jt(Wt)}},vt("div",{class:"login"},vt("h2",null,"Login"),vt("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value;Vt=await Ke(t.password.value,n);let r={email:n,key:Array.from(new Uint8Array(Vt))};it.send(a.Login(r)),console.log(r)}},vt("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),vt("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),vt("button",{type:"submit"},"Login")),vt("h2",null,"Register"),vt("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value,r=t.username.value;Vt=await Ke(t.password.value,n);let o={email:n,handle:r,key:Array.from(new Uint8Array(Vt))};it.send(a.AddUser(o)),console.log(o)}},vt("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),vt("input",{type:"text",name:"username",placeholder:"username",required:!0,autocomplete:"true"}),vt("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),vt("button",{type:"submit"},"Register")))),Wt=()=>vt("div",null,"You have logged in"),Jt=Ie((()=>null)),Zt=(e,t)=>({pattern:e,view:t}),Qt=["channels","groups","login"],Xt=[Zt(/^$/,Yt),Zt(/^groups$/,(()=>{let e=Ie([]),t=0;it.recv=n=>{let r=n.value;if(Array.isArray(r))return 0==r.length?t--:e(r);let o=e();o.unshift(r),e(o)};const n=e=>a.Groups({limit:30,page:e}),r=e=>{t++,it.send(n(t))};return it.open=e=>r(),it.ready&&r(),vt([vt("button",{onclick:e=>{t--,t<1&&(t=1),it.send(n(t))}},"Prev Item"),vt("button",{onclick:r},"Next Item"),vt("button",{onclick:e=>{t=0;let n=setInterval((function(){300==t?clearInterval(n):r()}),1)}},"Run Load"),vt("button",{onclick:bt},"Switch Component"),vt("h2",null,"Groups"),vt(xe(It),{items:e,keys:()=>Object.keys(e()[0]||{})})])})),Zt(/^channels$/,kt),Zt(/^login$/,(()=>vt(xe(Jt),null))),Zt(/^channels\/(?<group_id>\d+)$/,kt),Zt(/^chats\/(?<topic_id>\d+)$/,Yt),Zt(/^reps\/(?<chat_id>\d+)$/,Yt),Zt(/^products\/(?<id>\d+)$/,(({id:e})=>vt("h2",null,"Product ",e))),Zt(/^users\/(?<name>\w+)$/,(({name:e})=>vt("h2",null,e,"'s Profile"))),Zt(/^ip\/(?<ip>[\.\d]+)$/,Yt)],en=Ie("");const tn=()=>en(document.location.hash.substr(1));window.addEventListener("hashchange",tn),tn();let nn=!1,rn=window.pageYOffset;window.onscroll=function(e){nn||(window.requestAnimationFrame((function(){!function(e){let t=window.scrollY+window.innerHeight===document.body.scrollHeight,n=window.pageYOffset;document.getElementById("nav").style.top=rn>n||t?"0":"-50px",rn=n}(),nn=!1})),nn=!0)},document.querySelector(".app").append(vt([vt("div",{id:"nav"},vt("a",{href:"#",class:"nav-item"},"home"),(()=>Qt.map((e=>vt("a",{href:"#"+e,class:"nav-item "+(en()===e?"is-active":"")},e))))),vt("div",{class:"container"},(()=>function(e){for(const{pattern:t,view:n}of Xt){const r=e.match(t);if(r)return n({...r.groups})}}(en())))]))}();
