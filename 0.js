!function(){"use strict";const e=[];function t(t){let n={};return function(){const a=e.slice.call(arguments),i=a.map((e=>{if(o(e)||Array.isArray(e)){let t={};for(let n in e)t[n]=r(e[n]);return t}return r(e)})),l=JSON.stringify(i);let s=n[l];return void 0===s&&(s=t.apply(this,a),s&&11===s.nodeType&&(s=e.slice.call(s.childNodes)),n[l]=s),s}}let n=0;function r(e){return"function"==typeof e||e instanceof Node?(e.$m||(e.$m=++n),{$m:e.$m}):e}function o(e){if("object"!=typeof e||null===e)return!1;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function a(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var i,l,s=a((function(e,t){function n(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){void 0===e&&(e=0);var r=null==t?void 0:t.grow;this.grow=r&&isFinite(r)&&n(r)||r||0,this.buffer="number"==typeof e?new Uint8Array(n(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var r=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(r<=this.grow){var o=new Uint8Array(r);o.set(this.buffer),this.buffer=o}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var r=t,o=r>>3,a=128>>r%8,i=this.buffer[o];r<n;r++)e(!!(i&a),r),a=1===a?(i=this.buffer[++o],128):a>>1},e}();t.default=r}(l={path:i,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&l.path)}},l.exports),l.exports));let c,u=[];function d(e){let t=c,n=()=>{};c=n,g(n);let r=e((()=>{f(n),c=void 0}));return c=t,r}function p(e){function t(n){if(0===arguments.length)return c&&!t.__o.has(c)&&(t.__o.add(c),c.u.push(t)),e;e=n;let r=c;return c=void 0,t.o=new Set(t.__o),t.o.forEach((e=>e.i=!1)),t.o.forEach((e=>{e.i||e()})),c=r,e}return t.$o=1,t.__o=new Set,t.t=u,t}function f(e){e.__c.forEach(f),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),g(e)}function g(e){e.u=[],e.__c=[],e.l=[]}const h=(e,t={})=>e.reduce(((e,t)=>(e[t.id]=t,e)),t),m=()=>window.scrollTo(0,document.body.scrollHeight),y=t((e=>t(((t,n)=>d((()=>e(t,n))))))),v=e=>(t,...n)=>()=>y(e())(t,n),w=e=>{console.log("Length",e instanceof ArrayBuffer?new Uint8Array(e).length:e.length,"bytes"),console.log((Object(e).buffer instanceof ArrayBuffer?e:"string"==typeof e?new TextEncoder("utf-8").encode(e):new Uint8ClampedArray(e)).reduce(((e,t,n,r)=>e+(n%16==0?n.toString(16).padStart(6,0)+"  ":" ")+t.toString(16).padStart(2,0)+(n===r.length-1||n%16==15?" ".repeat(3*(15-n%16))+Array.from(r).splice(n-n%16,16).reduce(((e,t)=>e+(t>31&&t<127||t>159?String.fromCharCode(t):".")),"  ")+"\n":"")),""))},b=(e,t)=>{let n=0,r=0;for(;n<e.length;)r>=t.length&&(r=0),e.set([e[n]^t[r]],n),n++,r++},A=(e,t)=>(b(e,t),L(e,t)),T=e=>{let{a:t,k:n}=E(e);return b(t,n),{a:t,k:n}},E=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},L=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},C=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),U=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},I=e=>(performance.now()-e).toFixed(2),N=(e,t=64,n=8)=>A(e,crypto.getRandomValues(new Uint8Array(C(n,t)))),S=e=>{try{return new Uint8Array((e=>{const t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let t=0,r=e.length;t<r;t++)n[t]=e.charCodeAt(t);return t})(atob(e)))}catch(e){console.log(e)}},k=navigator.vendor.includes("Apple")?{transaction:()=>{}}:openDatabase("sonic","1.0","Test DB",1073741824);function O(e,t){}function x(e,t){console.log(e,t)}let R;k.transaction((e=>{e.executeSql("CREATE TABLE IF NOT EXISTS users (\n            id integer NOT NULL PRIMARY KEY,\n            handle varchar(50) NOT NULL,\n            email varchar(100) NOT NULL,\n            emailVerified boolean NOT NULL DEFAULT '0',\n            name varchar(100) NOT NULL,\n            key varchar(60) NOT NULL,\n            picture varchar(250),\n            gender boolean,\n            lastLogin datetime,\n            createdAt datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            updatedAt datetime NOT NULL DEFAULT CURRENT_TIMESTAMP\n        )",[],O,x),e.executeSql("CREATE TABLE IF NOT EXISTS topics (\n            id integer NOT NULL PRIMARY KEY,\n            name varchar(250) NOT NULL,\n            groupId integer NOT NULL,\n            channelId integer NOT NULL,\n            by integer NOT NULL,\n            createdAt datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            updatedAt datetime NOT NULL DEFAULT CURRENT_TIMESTAMP\n        )",[],O,x),e.executeSql("CREATE TABLE IF NOT EXISTS chats (\n            id integer NOT NULL PRIMARY KEY,\n            txt text NOT NULL,\n            by integer NOT NULL,\n            re integer NOT NULL,\n            nor integer NOT NULL DEFAULT '0',\n            topicId integer NOT NULL,\n            channelId integer NOT NULL,\n            groupId integer NOT NULL,\n            createdAt datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            updatedAt datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            star boolean\n        )",[],O,x)}));let M=indexedDB.open("sonic",1);M.onsuccess=e=>{R=M.result,console.log("[db] open"),M.open&&M.open()},M.onupgradeneeded=e=>{R=M.result;R.createObjectStore("store"),R.createObjectStore("chats",{keyPath:"id"}),R.createObjectStore("users",{keyPath:"id"}),R.createObjectStore("topics",{keyPath:"id"});console.log("[db] setup complete")};const P=async(e,t)=>{w(t),R.transaction(["store"],"readwrite").objectStore("store").put(t,e),caches.open("sonic").then((n=>{n.put(e,new Response(t))}));const n=(r=t,btoa(String.fromCharCode.apply(null,new Uint8Array(r))));var r;localStorage.setItem(e,n),console.log(n)},$=(e,t)=>{let n=R.transaction([e],"readwrite").objectStore(e);t.forEach((e=>n.add(e))),k.transaction((n=>{t.forEach((t=>{let r=Object.keys(t),o=`INSERT OR REPLACE INTO ${e} (${r.join(",")}) VALUES (${Array(r.length).fill("?").join(",")})`;n.executeSql(o,Object.values(t).map((e=>"function"==typeof e?e():e)),j,B)}))}))},D=(e,t)=>{let n=performance.now(),r=[],o=new Set,a=R.transaction([e],"readonly").objectStore(e),i=0;return new Promise((l=>{t.forEach((s=>{let c=a.get(s);c.onsuccess=a=>{c.result?r.push(c.result):o.add(s),++i===t.length&&(console.log("[db]",`get ${e} in`,I(n),"ms"),l({value:r,missed:Array.from(o)}))}}))}))},_=(e,t,n,r=!1)=>{let o=performance.now(),a=[],i=(([e,t])=>{let n=new Set;for(var r=e;r<=t;r++)n.add(r);return n})([n-t,n-1]),l=R.transaction([e],"readonly").objectStore(e),s=0,c=n?IDBKeyRange.upperBound(n,r):null;return new Promise((r=>{l.openCursor(c,"prev").onsuccess=l=>{var c=l.target.result;if(c){if(a.push(c.value),i.delete(c.key),++s===t)return console.log("[db]","scan "+e,t,n||"","in",I(o),"ms"),r({value:a,missed:Array.from(i)});c.continue()}else console.log("[db]","scan "+e,t,n||"","in",I(o),"ms"),r({value:a,missed:Array.from(i)})}}))},H=e=>{var t,n=[];return e.sort(((e,t)=>e[0]-t[0]||e[1]-t[1])),e.forEach((e=>{!t||e[0]>t[1]+1?n.push(t=e):e[1]>t[1]&&(t[1]=e[1])})),n};function j(e,t){}function B(e,t){console.log(e,t)}var G,K,F,q,Y,V,z;!function(e){e.None=function(e){return{tag:"None",value:e}},e.Id=function(e){return{tag:"Id",value:e}},e.TopicId=function(e){return{tag:"TopicId",value:e}},e.ChannelId=function(e){return{tag:"ChannelId",value:e}},e.GroupId=function(e){return{tag:"GroupId",value:e}},e.By=function(e){return{tag:"By",value:e}}}(G||(G={})),function(e){e.Id=function(e){return{tag:"Id",value:e}},e.Email=function(e){return{tag:"Email",value:e}},e.Handle=function(e){return{tag:"Handle",value:e}}}(K||(K={})),function(e){e.Id=function(e){return{tag:"Id",value:e}},e.Handle=function(e){return{tag:"Handle",value:e}}}(F||(F={})),function(e){e.Id=function(e){return{tag:"Id",value:e}},e.Handle=function(e){return{tag:"Handle",value:e}}}(q||(q={})),function(e){e.Id=function(e){return{tag:"Id",value:e}}}(Y||(Y={})),function(e){e.User=function(e){return{tag:"User",value:e}},e.Group=function(e){return{tag:"Group",value:e}},e.Groups=function(e){return{tag:"Groups",value:e}},e.Channel=function(e){return{tag:"Channel",value:e}},e.Channels=function(e){return{tag:"Channels",value:e}},e.Topic=function(e){return{tag:"Topic",value:e}},e.ChatScan=function(e){return{tag:"ChatScan",value:e}},e.AddChat=function(e){return{tag:"AddChat",value:e}},e.AddUser=function(e){return{tag:"AddUser",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Topics=function(e){return{tag:"Topics",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}}}(V||(V={})),function(e){e.User=function(e){return{tag:"User",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Group=function(e){return{tag:"Group",value:e}},e.Groups=function(e){return{tag:"Groups",value:e}},e.Channel=function(e){return{tag:"Channel",value:e}},e.Channels=function(e){return{tag:"Channels",value:e}},e.Topic=function(e){return{tag:"Topic",value:e}},e.Topics=function(e){return{tag:"Topics",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.Chat=function(e){return{tag:"Chat",value:e}},e.Login=function(e){return{tag:"Login",value:e}}}(z||(z={}));const W=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),X=(e,t)=>{const{view:{buffer:n},pos:r}=e,o=n.byteLength;if(o-r>t)return e;const a=Math.max(2*o,o+t),i=new Uint8Array(a);return i.set(new Uint8Array(n)),W(i.buffer,r,e.littleEndian)},J=(e,t)=>{e=X(e,1);const{view:n,pos:r}=e;return n.setUint8(r,t),e.pos+=1,e},Z=(e,t)=>{e=X(e,4);const{view:n,pos:r,littleEndian:o}=e;return n.setUint32(r,t,o),e.pos+=4,e},Q=(e,t)=>{e=X(e,2);const{view:n,pos:r,littleEndian:o}=e;return n.setUint16(r,t,o),e.pos+=2,e};function ee(e,t){const{view:n,pos:r,littleEndian:o}=e;return n.setUint32(o?r:r+4,t,o),n.setUint32(o?r+4:r,0,o),e.pos+=8,e}const te=(e,t)=>{e=X(e,4);const{view:n,pos:r,littleEndian:o}=e;return n.setInt32(r,t,o),e.pos+=4,e},ne=new TextEncoder,re="encodeInto"in ne?(e,t)=>ne.encodeInto(e,t).written:(e,t)=>{const n=ne.encode(e);return t.set(n),n.length},oe=(e,t)=>{e=X(e,3*t.length+8);const n=re(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=ee(e,n)).pos+=n,e},ae=(e,t)=>J(e,t?1:0),ie=e=>(t,n)=>n.reduce(e,((e,t)=>ee(X(e,8),t))(t,n.length)),le=e=>(t,n)=>null===n?J(t,0):e(J(t,1),n),se=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},ce=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getUint32(t,r)},ue=e=>{const{view:t,pos:n,littleEndian:r}=e;return e.pos+=8,t.getUint32(r?n:n+4,r)},de=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getInt32(t,r)},pe=e=>1===se(e),fe=e=>t=>1===se(t)?e(t):null,ge=e=>t=>{const n=ue(t),r=new Array;for(let o=0;o<n;o++)r.push(e(t));return r},he=new TextDecoder,me=e=>{const t=ue(e),{pos:n,view:{buffer:r}}=e,o=he.decode(new Uint8Array(r,n,t));return e.pos+=t,o};var ye=le(oe),ve=le(ae),we=oe,be=le(we),Ae=ie(J),Te=ie(te),Ee=function(e,t){var n=t.id,r=t.handle,o=t.email,a=t.emailVerified,i=t.name,l=t.key,s=t.picture,c=t.gender,u=t.lastLogin,d=t.createdAt,p=t.updatedAt;return we(we(be(ve(ye(oe(oe(ae(oe(oe(te(e,n),r),o),a),i),l),s),c),u),d),p)},Le=(ie(Ee),function(e,t){var n=t.id,r=t.name,o=t.handle,a=t.by,i=t.createdAt,l=t.updatedAt;return we(we(te(oe(oe(te(e,n),r),o),a),i),l)}),Ce=(ie(Le),function(e,t){var n=t.id,r=t.name,o=t.handle,a=t.groupId,i=t.by,l=t.createdAt,s=t.updatedAt;return we(we(te(te(oe(oe(te(e,n),r),o),a),i),l),s)}),Ue=(ie(Ce),function(e,t){var n=t.id,r=t.name,o=t.groupId,a=t.channelId,i=t.by,l=t.createdAt,s=t.updatedAt;return we(we(te(te(te(oe(te(e,n),r),o),a),i),l),s)}),Ie=(ie(Ue),function(e,t){var n=t.id,r=t.txt,o=t.by,a=t.re,i=t.nor,l=t.topicId,s=t.channelId,c=t.groupId,u=t.createdAt,d=t.updatedAt;return we(we(te(te(te(te(te(te(oe(te(e,n),r),o),a),i),l),s),c),u),d)}),Ne=(ie(Ie),function(e,t){var n=t.filter,r=t.ub,o=t.lb,a=t.limit;return Q(te(te(function(e,t){switch(t.tag){case"None":return ae(Z(e,0),t.value);case"Id":return te(Z(e,1),t.value);case"TopicId":return te(Z(e,2),t.value);case"ChannelId":return te(Z(e,3),t.value);case"GroupId":return te(Z(e,4),t.value);case"By":return te(Z(e,5),t.value)}}(e,n),r),o),a)}),Se=function(e,t){switch(t.tag){case"User":return function(e,t){switch(t.tag){case"Id":return te(Z(e,0),t.value);case"Email":return oe(Z(e,1),t.value);case"Handle":return oe(Z(e,2),t.value)}}(Z(e,0),t.value);case"Group":return function(e,t){switch(t.tag){case"Id":return te(Z(e,0),t.value);case"Handle":return oe(Z(e,1),t.value)}}(Z(e,1),t.value);case"Groups":return function(e,t){var n=t.limit,r=t.page;return Q(Q(e,n),r)}(Z(e,2),t.value);case"Channel":return function(e,t){switch(t.tag){case"Id":return te(Z(e,0),t.value);case"Handle":return oe(Z(e,1),t.value)}}(Z(e,3),t.value);case"Channels":return function(e,t){var n=t.group_id,r=t.limit,o=t.page;return Q(Q(te(e,n),r),o)}(Z(e,4),t.value);case"Topic":return function(e,t){switch(t.tag){case"Id":return te(Z(e,0),t.value)}}(Z(e,5),t.value);case"ChatScan":return Ne(Z(e,6),t.value);case"AddChat":return Ie(Z(e,7),t.value);case"AddUser":return function(e,t){var n=t.email,r=t.handle,o=t.key;return Ae(oe(oe(e,n),r),o)}(Z(e,8),t.value);case"Login":return function(e,t){var n=t.email,r=t.key;return Ae(oe(e,n),r)}(Z(e,9),t.value);case"Users":return Te(Z(e,10),t.value);case"Topics":return Te(Z(e,11),t.value);case"Chats":return Te(Z(e,12),t.value)}},ke=fe(me),Oe=fe(pe),xe=me,Re=fe(xe),Me=ge(se),Pe=(ge(de),function(e){return{id:de(e),handle:me(e),email:me(e),emailVerified:pe(e),name:me(e),key:me(e),picture:ke(e),gender:Oe(e),lastLogin:Re(e),createdAt:xe(e),updatedAt:xe(e)}}),$e=ge(Pe),De=function(e){return{id:de(e),name:me(e),handle:me(e),by:de(e),createdAt:xe(e),updatedAt:xe(e)}},_e=ge(De),He=function(e){return{id:de(e),name:me(e),handle:me(e),groupId:de(e),by:de(e),createdAt:xe(e),updatedAt:xe(e)}},je=ge(He),Be=function(e){return{id:de(e),name:me(e),groupId:de(e),channelId:de(e),by:de(e),createdAt:xe(e),updatedAt:xe(e)}},Ge=ge(Be),Ke=function(e){return{id:de(e),txt:me(e),by:de(e),re:de(e),nor:de(e),topicId:de(e),channelId:de(e),groupId:de(e),createdAt:xe(e),updatedAt:xe(e)}},Fe=ge(Ke),qe=function(e){switch(ce(e)){case 0:return z.User(Pe(e));case 1:return z.Users($e(e));case 2:return z.Group(De(e));case 3:return z.Groups(_e(e));case 4:return z.Channel(He(e));case 5:return z.Channels(je(e));case 6:return z.Topic(Be(e));case 7:return z.Topics(Ge(e));case 8:return z.Chats(Fe(e));case 9:return z.Chat(Ke(e));case 10:return z.Login(Me(e))}throw new Error("bad variant index for Response")},Ye=W(new ArrayBuffer(512)),Ve=function(e,t){return Ye.pos=0,Ye=t(Ye,e),new Uint8Array(Ye.view.buffer).slice(0,Ye.pos)},ze=function(e,t){return t(W(e))},We=function(e){return ze(e.buffer,qe)},Xe=function(e){return Ve(e,Se)};const Je=e=>new Zlib.Inflate(e).decompress(),Ze=e=>new Zlib.Deflate(e).compress(),Qe=async(e,t,n)=>(console.log("[sec] encrypting data"),await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e)),et=async(e,t,n)=>(console.log("[sec] decrypting data"),await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e)),tt={};async function nt(e,t){let n=new TextEncoder,r=await rt(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",r)}async function rt(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}!async function(){let e=localStorage.getItem("a");tt.salt=S(e),tt.salt&&tt.salt.length>32&&(tt.salt=null);const t=S(localStorage.getItem("s"));t&&32==t.length&&(tt.sskey=await crypto.subtle.importKey("raw",t,"AES-GCM",!1,["encrypt","decrypt"]))}();const ot=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),at="wss://"+(ot?ot.groups.ip:"192.168.100.11:443");let it,lt,st,ct,ut,dt,pt,ft,gt,ht,mt,yt=500,vt=0,wt={ready:!1},bt=0,At=1;console.group("[ws]","starting..."),function e(t){it=performance.now(),lt=new WebSocket(at),lt.binaryType="arraybuffer",lt.onopen=()=>{console.log(`[ws] open in ${I(it)} ms`),console.groupEnd("[ws]"),console.group("[dc]","opening..."),t?Et():ut&&Ut()},lt.onmessage=async e=>{console.log(`[ws] <- received answer in ${I(it)} ms`);let t=new Uint8Array(e.data),{a:n,k:r}=T(t);var o,a,i;Tt=(e=>{const t=new s(e);return{z:t.get(0),m:t.get(1),c:t.get(2),d:t.get(3)}})(n),console.log(Tt),wt.onconfig&&wt.onconfig(Tt),r=await(o=r,crypto.subtle.importKey("raw",o,{name:"ECDH",namedCurve:"P-256"},!0,[])),ht=await(a=ct.privateKey,i=r,crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:i},a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])),gt=new Uint8Array(await crypto.subtle.exportKey("raw",ht));let l=JSON.parse((e=>(new TextDecoder).decode(Je(e)))(n.slice(1))),c=l.answer?l.answer:l;if(await dt.setRemoteDescription(new RTCSessionDescription(c)),!l.candidate)return;const u=new RTCIceCandidate({candidate:l.candidate,sdpMid:0,sdpMLineIndex:0});await dt.addIceCandidate(u)},lt.onclose=t=>{vt++,yt+=C(0,vt<16?200:3e3),console.log("[ws] closed",t),console.groupEnd("[ws]"),console.groupEnd("[ws]"),console.groupCollapsed("[ws]",`retry ${vt} in ${(yt/1e3).toFixed(2)} sec`),setTimeout((()=>{e(!0)}),yt)},lt.onerror=e=>{console.log("[ws] error",e)}}(),Et();var Tt={};function Et(){pt=!1,function(){dt=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});let e=At++;dt.onicecandidate=e=>{e.candidate},dt.onconnectionstatechange=t=>{switch(dt.connectionState){case"failed":case"disconnected":console.log("[peer]",e,"restarting....")}},dt.oniceconnectionstatechange=e=>{switch(dt.iceConnectionState){case"disconnected":console.log("[ice] restarting....")}}}(),mt=dt.createDataChannel("cu",{}),mt.binaryType="arraybuffer",bt=0,wt.send=Lt,mt.onopen=e=>{console.log(`[dc] open in ${I(it)} ms`),console.groupEnd("[dc]"),bt=0,wt.ready=!0,wt.open&&wt.open(e)},mt.onmessage=Ct,mt.onclose=e=>{console.log("[dc] close",e)},mt.onerror=e=>{console.log("[dc] error:",e)},async function(){const e=async()=>{let e=await dt.createOffer();return await dt.setLocalDescription(e),Ze((new TextEncoder).encode(dt.localDescription.sdp))},t=async()=>{if(ft)return ft;ct=await(async()=>(console.log("[sec] generating key pairs"),await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"])))();let e=await crypto.subtle.exportKey("raw",ct.publicKey);return ft=new Uint8Array(e),ft};ut=await(async(e,t,n)=>{let[r,o]=await Promise.all([e(),t()]);return n?A(A(r,o),n):N(A(r,o),64,24)})(e,t,tt.salt),console.log(`[dc] sdp in ${I(it)} ms`),1===lt.readyState&&Ut()}()}async function Lt(e){if(bt++,console.groupEnd("[dc]"),console.group("[dc]","-> sending packet",bt,e),e=Xe(e),w(e),Tt.z&&(e=Ze(e)),Tt.m&&(e=N(e,e.length),b(e,gt)),Tt.c){const t=crypto.getRandomValues(new Uint8Array(12));b(e,t),e=U(t,new Uint8Array(await Qe(e,ht,t)))}if(Tt.d){const t=crypto.getRandomValues(new Uint8Array(12));b(e,t),e=U(t,new Uint8Array(await Qe(e,tt.sskey,t)))}mt.send(e),st=performance.now(),console.groupEnd("[dc]")}async function Ct(e){let t=new Uint8Array(e.data),n=t.length;if(console.groupEnd("[dc]"),console.group("[dc]","<- received",n,"bytes in",I(st),"ms"),Tt.d){let e=t.subarray(0,12);t=new Uint8Array(await et(t.subarray(12),tt.sskey,e)),b(t,e)}if(Tt.c){let e=t.subarray(0,12);t=new Uint8Array(await et(t.subarray(12),ht,e)),b(t,e)}if(Tt.m){b(t,gt);let{a:e}=T(t);t=new Uint8Array(e)}Tt.z&&(t=Je(t));let r=(100*n/t.length).toFixed(2);console.log(`[dc] unpacked ${n} / ${t.length} bytes ${r}% in ${I(st)} ms`);let o=It(t);wt.recv&&wt.recv(o),console.groupEnd("[dc]")}const Ut=()=>{pt||(console.log("[ws] -> sending offer"),lt.send(ut),pt=!0)},It=e=>{let t=We(e);return console.log(t),console.table(t.value),t};let Nt={},St=[];function kt(e){return this.t&&this.t[e.type](e)}Nt.h=(...e)=>{let t,n=r=>{if(null==r);else if("string"==typeof r)t?Nt.add(t,r):t=Nt.s?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);else if(Array.isArray(r))t||(t=document.createDocumentFragment()),r.forEach(n);else if(r instanceof Node)t?Nt.add(t,r):t=r;else if("object"==typeof r)Nt.property(t,r,null,Nt.s);else if("function"==typeof r)if(t){let e=Nt.add(t,"");Nt.insert(t,r,e)}else t=r.apply(null,e.splice(1));else Nt.add(t,""+r)};return e.forEach(n),t},Nt.insert=(e,t,n,r,o)=>(e=n&&n.parentNode||e,o=o||r instanceof Node&&r,t===r||(r&&"string"!=typeof r||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?Nt.subscribe((()=>{r=Nt.insert(e,t.call({el:e,endMark:n}),n,r,o)})):(n?r&&(o||(o=r.o&&r.o.nextSibling||n.previousSibling),Nt.rm(e,o,n)):e.textContent="",r=null,t&&!0!==t&&(r=Nt.add(e,t,n))):(null!=r&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?Nt.add(e,t,n):e.textContent=t,r=t)),r),Nt.property=(e,t,n,r,o)=>{if(null!=t)if(!n||"attrs"===n&&(r=!0))for(n in t)Nt.property(e,t[n],n,r,o);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?Nt.subscribe((()=>{Nt.property(e,t.call({el:e,name:n}),n,r,o)})):o?e.style.setProperty(n,t):r||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:Nt.property(e,t,null,r,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,kt):e.removeEventListener(t,kt),(e.t||(e.t={}))[t]=n})(e,n,t)},Nt.add=(e,t,n)=>{let r=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:Nt.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:Nt.h(St,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),r},Nt.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},Nt.subscribe=function(e){return function(e,t){function n(){let r=c;return c&&c.__c.push(n),f(n),n.i=!0,c=n,t=e(t),c=r,t}function r(){return n.i?c&&n.u.forEach((e=>e())):t=n(),t}e.s=n,g(n),n(),r.$o=1}(e),()=>f(e.s)},Nt.cleanup=function(e){return c&&c.l.push(e),e},Nt.root=d,Nt.sample=function(e){let t=c;c=void 0;let n=e();return c=t,n},Nt.hs=(...e)=>{let t=Nt.s;Nt.s=!0;let n=Ot(...e);return Nt.s=t,n};let Ot=(...e)=>Nt.h.apply(Nt.h,e);function xt(e,t,n){const{root:r,subscribe:o,sample:a,cleanup:i}=Nt;null==n&&(n=!t.$t);let l=Nt.h([]),s=Nt.add(l,""),c=new Map,u=new Map,d=new Set;function p(e,o){if(null==e)return;let a=u.get(e);return 1===o?(d.delete(e),a||(a=n?r((n=>(c.set(e,n),t(e.$v||e)))):t(e.$v||e),11===a.nodeType&&(a=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let r=Array.from(t);return{nodeType:111,t:r[0],o:r[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(r[t++])}return e}}})(a)||a),u.set(e,a))):-1===o&&d.add(e),((e,t)=>111===e.nodeType?1/t<0?t?Nt.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(a,o)}function f(e){let t=c.get(e);t&&(t(),c.delete(e)),u.delete(e)}return i(o((t=>{let n=e();return a((()=>{d.clear();let e=Array.from(function(e,t,n,r,o){let a,i,l=new Map,s=new Map;for(a=0;a<t.length;a++)l.set(t[a],a);for(a=0;a<n.length;a++)s.set(n[a],a);for(a=i=0;a!==t.length||i!==n.length;){var c=t[a],u=n[i];if(null===c)a++;else if(n.length<=i)e.removeChild(r(t[a],-1)),a++;else if(t.length<=a)e.insertBefore(r(u,1),r(t[a],0)||o),i++;else if(c===u)a++,i++;else{var d=s.get(c),p=l.get(u);void 0===d?(e.removeChild(r(t[a],-1)),a++):void 0===p?(e.insertBefore(r(u,1),r(t[a],0)||o),i++):(e.insertBefore(r(t[p],1),r(t[a],0)||o),t[p]=null,p>a+1&&a++,i++)}}return n}(s.parentNode,t||[],n,p,s));return d.forEach(f),e}))}))),i((function(){c.forEach((e=>e())),c.clear(),u.clear(),d.clear()})),l}const Rt=()=>$t()===Mt?$t(Pt):$t(Mt),Mt=({items:e,keys:t},...n)=>Ot([Ot("table",null,Ot("thead",null,Ot("tr",null,xt(t,(e=>Ot("th",{scope:"col"},e))))),Ot("tbody",null,xt(e,(e=>Ot("tr",{onclick:t=>location.hash="#channels/"+e.id},xt(t,(t=>Ot("td",null,Ot("span",null,t)," ",e[t])))))))),n]),Pt=({items:e},...t)=>Ot([Ot("ul",null,xt(e,(e=>Ot("li",{id:e.id},e.name)))),t]),$t=p(Mt);const Dt=({group_id:e})=>{let t=p([]),n=0;wt.recv=e=>{let r=e.value;if(Array.isArray(r))return 0==r.length?n--:t(r);let o=t();o.unshift(r),t(o)};const r=t=>V.Channels({group_id:e,limit:30,page:t}),o=e=>{n++,wt.send(r(n))};return wt.open=e=>o(),wt.ready&&o(),Ot([Ot("button",{onclick:e=>{n--,n<1&&(n=1),wt.send(r(n))}},"Prev Item"),Ot("button",{onclick:o},"Next Item"),Ot("button",{onclick:e=>{n=0;let t=setInterval((function(){300==n?clearInterval(t):o()}),1)}},"Run Load"),Ot("button",{onclick:_t},"Switch Component"),Ot("h2",null,"Channels"),Ot(v(Bt),{items:t,keys:()=>Object.keys(t()[0]||{})})])},_t=()=>Bt()===Ht?Bt(jt):Bt(Ht),Ht=({items:e,keys:t},...n)=>Ot([Ot("table",null,Ot("thead",null,Ot("tr",null,xt(t,(e=>Ot("th",{scope:"col"},e))))),Ot("tbody",null,xt(e,(e=>Ot("tr",{onclick:t=>location.hash="#topics/"+e.id},xt(t,(t=>Ot("td",null,Ot("span",null,t)," ",e[t])))))))),n]),jt=({items:e},...t)=>Ot([Ot("ul",null,xt(e,(e=>Ot("li",{id:e.id},e.name)))),t]),Bt=p(Ht),Gt="defaultParagraphSeparator",Kt="formatBlock",Ft=(e,t,n)=>e.addEventListener(t,n),qt=(e,t)=>e.appendChild(t),Yt=e=>document.createElement(e),Vt=e=>document.queryCommandState(e),zt=(e,t=null)=>document.execCommand(e,!1,t),Wt={bold:{icon:"<b>B</b>",title:"Bold",state:()=>Vt("bold"),result:()=>zt("bold")},italic:{icon:"<i>I</i>",title:"Italic",state:()=>Vt("italic"),result:()=>zt("italic")},underline:{icon:"<u>U</u>",title:"Underline",state:()=>Vt("underline"),result:()=>zt("underline")},strikethrough:{icon:"<strike>S</strike>",title:"Strike-through",state:()=>Vt("strikeThrough"),result:()=>zt("strikeThrough")},heading1:{icon:"<b>H1</b>",title:"Heading 1",result:()=>zt(Kt,"<h1>")},heading2:{icon:"<b>H2</b>",title:"Heading 2",result:()=>zt(Kt,"<h2>")},quote:{icon:"&#8220;&#8221;",title:"Quote",result:()=>zt(Kt,"<blockquote>")},olist:{icon:"1.",title:"Ordered List",result:()=>zt("insertOrderedList")},ulist:{icon:"&#8226;",title:"Unordered List",result:()=>zt("insertUnorderedList")},code:{icon:"&lt;&gt;",title:"Code",result:()=>zt(Kt,"<pre>")},line:{icon:"&#8213;",title:"Horizontal Line",result:()=>zt("insertHorizontalRule")},link:{icon:"&#128279;",title:"Link",result:()=>{const e=window.prompt("Enter the link URL");e&&zt("createLink",e)}},image:{icon:"&#128247;",title:"Image",result:()=>{const e=window.prompt("Enter the image URL");e&&zt("insertImage",e)}}},Xt={actionbar:"pell-actionbar",button:"pell-button",content:"pell-content",selected:"pell-button-selected",topic:"pell-topic"},Jt=(...e)=>{const t={},n={};return{create:e=>n[e]=new Promise((n=>t[e]=n)),complete:(e,n)=>t[e](n),join:e=>n[e],joinall:()=>Promise.all(e.map((e=>n[e]))),select:()=>Promise.race(e.map((e=>n[e])))}},Zt=({topic_id:e,chat_id:t})=>{let n,r,o=p([]),a={},i={},l={},s=p(0);const c=Jt("users","topics"),u=Jt("db","bus");M.open||u.create("db"),wt.open||u.create("bus"),M.open=e=>u.complete("db"),wt.open=e=>u.complete("bus"),wt.recv=async e=>{switch(e.tag){case"Users":$("users",e.value),c.complete("users",e.value);break;case"Topics":$("topics",e.value),c.complete("topics",e.value);break;case"Chat":let t=window.scrollY+window.innerHeight===document.body.scrollHeight,n=o();e.value.nor=p(0),e.value.star=p(!1),a[e.value.id]=e.value,n.push(e.value.id),o(n),t&&m();break;case"Chats":let r=e.value;if(0==r.length)return;$("chats",r),((e,t)=>{let n=R.transaction(["store"],"readwrite").objectStore("store"),r=n.get(e);r.onsuccess=o=>{if(!r.result)return n.put([t],e);r.result.push(t),n.put(H(r.result),e)}})("chats",[r[r.length-1].id,r[0].id]),d(r)}};const d=async t=>{let n=t[0].id,r=new Set,i=new Set,s=o();s=t.reverse().map((e=>(e.nor=p(e.nor),e.star=p(!1),e.createdAt=new Date(e.createdAt),e.updatedAt=new Date(e.updatedAt),a[e.id]=e,r.add(e.by),i.add(e.topicId),e.id))).concat(s),await f(r,i),o(s),e&&(document.title=l[e].name),window.scrollY<100&&setTimeout((()=>document.getElementById(n).scrollIntoView()))},f=async(e,t)=>{let n=await D("users",Array.from(e)),r=await D("topics",Array.from(t));h(n.value,i),h(r.value,l),n.missed.length>0&&c.create("users",wt.send(V.Users(n.missed))),r.missed.length>0&&c.create("topics",wt.send(V.Topics(r.missed)));let[o,a]=await c.joinall();o&&h(o,i),a&&h(a,l)},g=(n,r,o)=>{let a=V.ChatScan({filter:e>0?G.TopicId(e):t>0?G.Id(t):G.None(!0),ub:n,lb:r,limit:o});wt.send(a)};(async(e=30)=>{await u.join("db");let t=await _("chats",e);console.log("chats",t);let n=t.value[0]?t.value[0].id:0;n&&d(t.value),await u.join("bus"),g(99999,n,e)})(),setTimeout((function(){new IntersectionObserver((e=>{e[0].intersectionRatio<=0||setTimeout((()=>(async(e=30)=>{let t=o()[0];if(!t)return;let{value:n,missed:r}=await _("chats",e,t,!0);n.length>0?(d(n),r.length>0&&wt.send(V.Chats(r))):g(t,0,e)})()))}),{}).observe(E)}));const y=(e=>{const t=e.actions?e.actions.map((e=>"string"==typeof e?Wt[e]:Wt[e.name]?{...Wt[e.name],...e}:e)):Object.keys(Wt).map((e=>Wt[e])),n={...Xt,...e.classes},r=e.defaultParagraphSeparator||"div",o=e.element.topic=Yt("div");o.contentEditable=!0,o.className=n.topic,o.onkeydown=e=>{"Enter"===e.key&&(a.focus(),e.preventDefault())},qt(e.element,o);const a=e.element.content=Yt("div");a.contentEditable=!0,a.className=n.content,a.onfocus=()=>{let t=window.scrollY+window.innerHeight===document.body.scrollHeight;e.element.classList.add("sticky"),t&&setTimeout((()=>m()))},a.onblur=()=>{setTimeout((()=>{e.element.contains(document.activeElement)||e.element.classList.remove("sticky")}))},a.oninput=({target:{firstChild:t}})=>{e.onchange(a.innerHTML)},a.onkeydown=t=>{"Enter"!==t.key||t.shiftKey||(e.onsend(),t.preventDefault())},qt(e.element,a);const i=Yt("div");return i.className=n.actionbar,qt(e.element,i),t.forEach((e=>{const t=Yt("button");if(t.className=n.button,t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=()=>e.result()&&a.focus(),e.state){const r=()=>t.classList[e.state()?"add":"remove"](n.selected);Ft(a,"keyup",r),Ft(a,"mouseup",r),Ft(t,"click",r)}qt(i,t)})),e.styleWithCSS&&zt("styleWithCSS"),zt(Gt,r),e.element})({element:Ot("div",{class:"pell"}),onchange:e=>{},onsend:()=>{if(!y.content.textContent.trim())return;let e=s()||r,{topicId:t,channelId:o,groupId:i}=a[e];y.topic.textContent!==n&&(e=0,t=Object.keys(l).length+1,l[t].name=y.topic.textContent);let c=y.content.innerHTML.trim(),u=(new Date).toISOString();wt.send(V.AddChat({id:0,txt:c,by:1,re:e,nor:0,topicId:t,channelId:o,groupId:i,createdAt:u,updatedAt:u})),y.content.textContent="",v({})}});y.content.innerHTML="";const v=({id:e,txt:t})=>{if(!e||s()===e)return y.topic.textContent="",n="",void s(0);y.topic.innerHTML=t,y.topic.textContent=y.topic.textContent,n=y.topic.textContent,s(e)},w=(t,n)=>{let{id:c,txt:u,by:d,topicId:p,re:f,star:g,nor:h}=t,m=a[r]||{},y=m.by!==d,v=m.topicId!==p;r=c;let w=l[p];const T=()=>{b("#reps/"+c,c)};return Ot("div",{id:c,class:function(){return"chat"+(()=>(g()?" star":"")+(v?" topic":"")+(s()===c?" cur":"")).call(this)},onclick:e=>A(e,t)},v?Ot("div",{class:"topic-name"+(f?" re":" new")+(e?" head":"")},Ot("a",{href:function(){return"#chats/"+("function"==typeof p?p.call(this):p)},onclick:e=>(b("#chats/"+p,w.name),e.preventDefault(),!1),innerHTML:w.name})):null,y||v?Ot("div",{class:"by"},i[d].handle):null,Ot("div",{onclick:e=>e.stopPropagation()},(()=>{let e=h();if(1!==e||c!==a[o()[n+1]].re)return e>0?Ot([Ot("span",{class:"rep",onclick:T},e," ðŸ’¬")," "]):void 0}),(e=>document.createRange().createContextualFragment(e))(u)))},b=(e,t)=>{let n=screen.width/2-300,r=screen.height/2-300;window.open(e,t,`toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=600,height=600,top=${r}, left=${n}`)},A=(e,t)=>{e.x<18&&e.offsetY<22&&T(t),e.x+28>e.target.offsetWidth&&e.offsetY<22&&v(t)},T=({id:e,star:t})=>{const n=o().filter((t=>t===e))[0],r=a[n];r.star?r.star(!t()):r.star=p(!1)},E=Ot("div",{class:"sentinel"});return Ot([E,Ot("div",{class:"topics"},xt(o,((e,t)=>w(a[e],t)))),y])};var Qt;wt.onconfig=e=>{e.d?nn(tn):nn(en)};const en=()=>(wt.recv=async e=>{switch(e.tag){case"Login":if(e.value.length<16)return void console.warn("login failed");tt.salt=new Uint8Array(e.value),tt.sskey=await rt(Qt,tt.salt);let t=await crypto.subtle.exportKey("raw",tt.sskey);P("a",tt.salt.buffer),P("s",t),Tt.d=!0,nn(tn)}},Ot("div",{class:"login"},Ot("h2",null,"Login"),Ot("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value;Qt=await nt(t.password.value,n);let r={email:n,key:Array.from(new Uint8Array(Qt))};wt.send(V.Login(r)),console.log(r)}},Ot("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),Ot("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),Ot("button",{type:"submit"},"Login")),Ot("h2",null,"Register"),Ot("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value,r=t.username.value;Qt=await nt(t.password.value,n);let o={email:n,handle:r,key:Array.from(new Uint8Array(Qt))};wt.send(V.AddUser(o)),console.log(o)}},Ot("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),Ot("input",{type:"text",name:"username",placeholder:"username",required:!0,autocomplete:"true"}),Ot("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),Ot("button",{type:"submit"},"Register")))),tn=()=>Ot("div",null,"You have logged in"),nn=p((()=>null)),rn=(e,t)=>({pattern:e,view:t}),on=["channels","groups","login"],an=[rn(/^$/,Zt),rn(/^groups$/,(()=>{let e=p([]),t=0;wt.recv=n=>{let r=n.value;if(Array.isArray(r))return 0==r.length?t--:e(r);let o=e();o.unshift(r),e(o)};const n=e=>V.Groups({limit:30,page:e}),r=e=>{t++,wt.send(n(t))};return wt.open=e=>r(),wt.ready&&r(),Ot([Ot("button",{onclick:e=>{t--,t<1&&(t=1),wt.send(n(t))}},"Prev Item"),Ot("button",{onclick:r},"Next Item"),Ot("button",{onclick:e=>{t=0;let n=setInterval((function(){300==t?clearInterval(n):r()}),1)}},"Run Load"),Ot("button",{onclick:Rt},"Switch Component"),Ot("h2",null,"Groups"),Ot(v($t),{items:e,keys:()=>Object.keys(e()[0]||{})})])})),rn(/^channels$/,Dt),rn(/^login$/,(()=>Ot(v(nn),null))),rn(/^channels\/(?<group_id>\d+)$/,Dt),rn(/^chats\/(?<topic_id>\d+)$/,Zt),rn(/^reps\/(?<chat_id>\d+)$/,Zt),rn(/^products\/(?<id>\d+)$/,(({id:e})=>Ot("h2",null,"Product ",e))),rn(/^users\/(?<name>\w+)$/,(({name:e})=>Ot("h2",null,e,"'s Profile"))),rn(/^ip\/(?<ip>[\.\d]+)$/,Zt)],ln=p("");const sn=()=>ln(document.location.hash.substr(1));window.addEventListener("hashchange",sn),sn();let cn=!1,un=window.pageYOffset;window.onscroll=function(e){cn||(window.requestAnimationFrame((function(){!function(e){let t=window.scrollY+window.innerHeight===document.body.scrollHeight,n=window.pageYOffset;document.getElementById("nav").style.top=un>n||t?"0":"-50px",un=n}(),cn=!1})),cn=!0)},document.querySelector(".app").append(Ot([Ot("div",{id:"nav"},Ot("a",{href:"#",class:"nav-item"},"home"),(()=>on.map((e=>Ot("a",{href:"#"+e,class:"nav-item "+(ln()===e?"is-active":"")},e))))),Ot("div",{class:"container"},(()=>function(e){for(const{pattern:t,view:n}of an){const r=e.match(t);if(r)return n({...r.groups})}}(ln())))]))}();
