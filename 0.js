!function(){"use strict";const e=[];function t(t){let n={};return function(){const o=e.slice.call(arguments),i=o.map((e=>{if(a(e)||Array.isArray(e)){let t={};for(let n in e)t[n]=r(e[n]);return t}return r(e)})),s=JSON.stringify(i);let l=n[s];return void 0===l&&(l=t.apply(this,o),l&&11===l.nodeType&&(l=e.slice.call(l.childNodes)),n[s]=l),l}}let n=0;function r(e){return"function"==typeof e||e instanceof Node?(e.$m||(e.$m=++n),{$m:e.$m}):e}function a(e){if("object"!=typeof e||null===e)return!1;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var s,l,c=o((function(e,t){function n(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){void 0===e&&(e=0);var r=null==t?void 0:t.grow;this.grow=r&&isFinite(r)&&n(r)||r||0,this.buffer="number"==typeof e?new Uint8Array(n(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var r=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(r<=this.grow){var a=new Uint8Array(r);a.set(this.buffer),this.buffer=a}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var r=t,a=r>>3,o=128>>r%8,i=this.buffer[a];r<n;r++)e(!!(i&o),r),o=1===o?(i=this.buffer[++a],128):o>>1},e}();t.default=r}(l={path:s,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&l.path)}},l.exports),l.exports));let u,d=[];function f(e){let t=u,n=()=>{};u=n,m(n);let r=e((()=>{h(n),u=void 0}));return u=t,r}function p(e){function t(n){if(0===arguments.length)return u&&!t.__o.has(u)&&(t.__o.add(u),u.u.push(t)),e;e=n;let r=u;return u=void 0,t.o=new Set(t.__o),t.o.forEach((e=>e.i=!1)),t.o.forEach((e=>{e.i||e()})),u=r,e}return t.$o=1,t.__o=new Set,t.t=d,t}function h(e){e.__c.forEach(h),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),m(e)}function m(e){e.u=[],e.__c=[],e.l=[]}const g=(e,t)=>e.reduce(((e,t)=>(e.set(t.id,t),e)),t),y=()=>window.scrollTo(0,document.body.scrollHeight),w=t((e=>t(((t,n)=>f((()=>e(t,n))))))),v=e=>(t,...n)=>()=>w(e())(t,n),b=e=>{if(!(e instanceof ArrayBuffer||e.length))return console.log(e);console.log("Length",e instanceof ArrayBuffer?new Uint8Array(e).length:e.length,"bytes"),console.log((Object(e).buffer instanceof ArrayBuffer?e:"string"==typeof e?new TextEncoder("utf-8").encode(e):new Uint8ClampedArray(e)).reduce(((e,t,n,r)=>e+(n%16==0?n.toString(16).padStart(6,0)+"  ":" ")+t.toString(16).padStart(2,0)+(n===r.length-1||n%16==15?" ".repeat(3*(15-n%16))+Array.from(r).splice(n-n%16,16).reduce(((e,t)=>e+(t>31&&t<127||t>159?String.fromCharCode(t):".")),"  ")+"\n":"")),""))},C=(e,t)=>{let n=0,r=0;for(;n<e.length;)r>=t.length&&(r=0),e.set([e[n]^t[r]],n),n++,r++},E=(e,t)=>(C(e,t),L(e,t)),S=e=>{let{a:t,k:n}=A(e);return C(t,n),{a:t,k:n}},A=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},L=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},U=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),T=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},N=e=>(performance.now()-e).toFixed(2),k=(e,t=64,n=8)=>E(e,crypto.getRandomValues(new Uint8Array(U(n,t)))),x=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},O=navigator.vendor.includes("Apple")?{transaction:()=>{}}:openDatabase("sonic","1.0","Test DB",1073741824);function j(e,t){}function I(e,t){console.log(e,t)}O.transaction((e=>{e.executeSql("CREATE TABLE IF NOT EXISTS users (\n            id integer NOT NULL PRIMARY KEY,\n            name varchar(50) NOT NULL\n        )",[],j,I),e.executeSql("CREATE TABLE IF NOT EXISTS chans (\n            id integer NOT NULL PRIMARY KEY,\n            name varchar(50) NOT NULL,\n            fullname varchar(150) NOT NULL,\n            mom integer NOT NULL,\n            by integer NOT NULL,\n            dir text NOT NULL,\n            timestamp datetime NOT NULL DEFAULT CURRENT_TIMESTAMP\n        )",[],j,I),e.executeSql("CREATE TABLE IF NOT EXISTS chats (\n            id integer NOT NULL PRIMARY KEY,\n            txt text NOT NULL,\n            by integer NOT NULL,\n            re integer NOT NULL,\n            nor integer NOT NULL DEFAULT '0',\n            chanid integer NOT NULL,\n            dir text NOT NULL,\n            timestamp datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            star boolean\n        )",[],j,I)}));const D=x(),M="sonic",R=["session","chats","users","chans"];let P,$=indexedDB.open(M,1);function B(e){console.warn("[db] deleting database",e);var t=window.indexedDB.deleteDatabase(e);t.onerror=t=>{console.error("[db] error deleting database",e,t)},t.onsuccess=t=>{console.warn("[db] deleted database",e)}}$.onsuccess=e=>{P=$.result,console.log("[db] open -",P.name,P.version,P.objectStoreNames),function(e){let t=e.objectStoreNames;for(const e of R)if(!t.contains(e))return console.warn("[db] db store missing",e),void B(M)}(P),D.complete(P),$.open?$.open():$.open=!0},$.onerror=e=>{console.error("[db] error",e.target.error),D.complete()},$.onblocked=e=>{console.log("[db] blocked",e)},$.onupgradeneeded=e=>{console.warn("[db] database upgrade needed from version",e.oldVersion,"->",e.newVersion),P=$.result;let t=P.objectStoreNames;if(console.log(t),!t.contains("session")){console.log("make session store");P.createObjectStore("session")}if(!t.contains("chats")){console.log("make chats store");let e=P.createObjectStore("chats",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1})}if(!t.contains("users")){console.log("make users store");P.createObjectStore("users",{keyPath:"id"})}if(!t.contains("chans")){console.log("make chans store"),P.createObjectStore("chans",{keyPath:"id"}).createIndex("mom",["mom","id"],{unique:!1})}for(const e of R)P.objectStoreNames.contains(e)||(console.warn(`[db] ${e} store missing, creating a dummy one`),P.createObjectStore(e));console.warn("[db] database upgrade complete")};const K=async(e,t)=>{let n=await D.join();n&&(b(t),n.transaction(["session"],"readwrite").objectStore("session").put(t,e))},q=async(e,t)=>{let n=await D.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>{"string"==typeof e.timestamp&&(e.timestamp=new Date(e.timestamp)),r.add(e)})),O.transaction((n=>{t.forEach((t=>{let r=Object.keys(t),a=`INSERT OR REPLACE INTO ${e} (${r.join(",")}) VALUES (${Array(r.length).fill("?").join(",")})`;n.executeSql(a,Object.values(t).map((e=>"function"==typeof e?e():e)),j,I)}))}))},_=async(e,t)=>{let n=await D.join();n&&(console.log("add",e,t),n.transaction([e],"readwrite").objectStore(e).add(t),O.transaction((n=>{let r=Object.keys(t),a=`INSERT OR REPLACE INTO ${e} (${r.join(",")}) VALUES (${Array(r.length).fill("?").join(",")})`;n.executeSql(a,Object.values(t).map((e=>"function"==typeof e?e():e)),j,I)})))},H=async(e,t)=>{let n=await D.join();if(!n)return{value:[],missed:t};if(0===t.length)return{value:[],missed:[]};let r=performance.now(),a=[],o=new Set,i=n.transaction([e],"readonly").objectStore(e),s=0;return new Promise((n=>{t.forEach((l=>{let c=i.get(l);c.onsuccess=i=>{c.result?a.push(c.result):o.add(l),++s===t.length&&(console.log("[db]",`get ${e} in`,N(r),"ms"),n({value:a,missed:Array.from(o)}))}}))}))},F=(e,t,n,r)=>{let a=n?IDBKeyRange.upperBound(n,r):null,o=n||99999;switch(t.tag){case"Chanid":e=e.index("mom"),a=IDBKeyRange.bound([t.value],[t.value,o],!1,r)}return[e,a]},Y=(e,t,n,r)=>(async(e,t,n,r,a,o,i)=>{let s=await D.join();if(!s)return;let l=performance.now(),c=[],u=s.transaction([e],"readonly"),[d,f]=o?o(u.objectStore(e),t,r,a):[u.objectStore(e),null],p=0;return new Promise((a=>{d.openCursor(f,i).onsuccess=o=>{var i=o.target.result;if(i){if(c.push(i.value),++p===n)return console.log("[db] scan",e,t,r||"",n,"in",N(l),"ms"),a(c);i.continue()}else console.log("[db] scan",e,t,r||"",n,"in",N(l),"ms"),a(c)}}))})("chans",e,t,n,r,F),V=e=>z(e,"session"),z=async(e,t)=>{let n=await D.join();if(!n)return;let r=n.transaction([t],"readonly").objectStore(t);return new Promise((t=>{let n=r.get(e);n.onsuccess=e=>t(n.result)}))};var G,J,W;!function(e){e.None=function(e){return{tag:"None",value:e}},e.Id=function(e){return{tag:"Id",value:e}},e.Chanid=function(e){return{tag:"Chanid",value:e}},e.By=function(e){return{tag:"By",value:e}}}(G||(G={})),function(e){e.ChatScan=function(e){return{tag:"ChatScan",value:e}},e.ChanScan=function(e){return{tag:"ChanScan",value:e}},e.AddChat=function(e){return{tag:"AddChat",value:e}},e.AddUser=function(e){return{tag:"AddUser",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.Logout=function(e){return{tag:"Logout",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}}}(J||(J={})),function(e){e.User=function(e){return{tag:"User",value:e}},e.Chan=function(e){return{tag:"Chan",value:e}},e.Chat=function(e){return{tag:"Chat",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.ChatScan=function(e){return{tag:"ChatScan",value:e}},e.ChanScan=function(e){return{tag:"ChanScan",value:e}}}(W||(W={}));const X=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),Z=(e,t)=>{const{view:{buffer:n},pos:r}=e,a=n.byteLength;if(a-r>t)return e;const o=Math.max(2*a,a+t),i=new Uint8Array(o);return i.set(new Uint8Array(n)),X(i.buffer,r,e.littleEndian)},Q=(e,t)=>{e=Z(e,1);const{view:n,pos:r}=e;return n.setUint8(r,t),e.pos+=1,e},ee=(e,t)=>{e=Z(e,4);const{view:n,pos:r,littleEndian:a}=e;return n.setUint32(r,t,a),e.pos+=4,e};function te(e,t){const{view:n,pos:r,littleEndian:a}=e;return n.setUint32(a?r:r+4,t,a),n.setUint32(a?r+4:r,0,a),e.pos+=8,e}const ne=(e,t)=>{e=Z(e,4);const{view:n,pos:r,littleEndian:a}=e;return n.setInt32(r,t,a),e.pos+=4,e},re=new TextEncoder,ae="encodeInto"in re?(e,t)=>re.encodeInto(e,t).written:(e,t)=>{const n=re.encode(e);return t.set(n),n.length},oe=(e,t)=>{e=Z(e,3*t.length+8);const n=ae(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=te(e,n)).pos+=n,e},ie=(e,t)=>Q(e,t?1:0),se=e=>(t,n)=>n.reduce(e,((e,t)=>te(Z(e,8),t))(t,n.length)),le=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},ce=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getUint32(t,r)},ue=e=>{const{view:t,pos:n,littleEndian:r}=e;return e.pos+=8,t.getUint32(r?n:n+4,r)},de=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getInt32(t,r)},fe=e=>1===le(e),pe=e=>t=>{const n=ue(t),r=new Array;for(let a=0;a<n;a++)r.push(e(t));return r},he=new TextDecoder,me=e=>{const t=ue(e),{pos:n,view:{buffer:r}}=e,a=he.decode(new Uint8Array(r,n,t));return e.pos+=t,a};ge=oe;var ge,ye,we=se(ne),ve=se(Q),be=(se((function(e,t){var n=t.id,r=t.name;return oe(ne(e,n),r)})),function(e,t){var n=t.id,r=t.name,a=t.fullname,o=t.mom,i=t.by,s=t.dir,l=t.timestamp;return oe(we(ne(ne(oe(oe(ne(e,n),r),a),o),i),s),l)}),Ce=(se(be),function(e,t){var n=t.id,r=t.txt,a=t.by,o=t.re,i=t.nor,s=t.chanid,l=t.dir,c=t.timestamp;return oe(we(ne(ne(ne(ne(oe(ne(e,n),r),a),o),i),s),l),c)}),Ee=(se(Ce),function(e,t){var n=t.filter,r=t.kw,a=t.ub,o=t.lb,i=t.limit;return((e,t)=>{e=Z(e,2);const{view:n,pos:r,littleEndian:a}=e;return n.setUint16(r,t,a),e.pos+=2,e})(ne(ne(oe(function(e,t){switch(t.tag){case"None":return ie(ee(e,0),t.value);case"Id":return ne(ee(e,1),t.value);case"Chanid":return ne(ee(e,2),t.value);case"By":return ne(ee(e,3),t.value)}}(e,n),r),a),o),i)}),Se=function(e,t){switch(t.tag){case"ChatScan":return Ee(ee(e,0),t.value);case"ChanScan":return Ee(ee(e,1),t.value);case"AddChat":return function(e,t){var n=t.txt,r=t.by,a=t.re,o=t.fullname,i=t.chanid;return ne(oe(ne(ne(oe(e,n),r),a),o),i)}(ee(e,2),t.value);case"AddUser":return function(e,t){var n=t.email,r=t.name,a=t.key;return ve(oe(oe(e,n),r),a)}(ee(e,3),t.value);case"Login":return function(e,t){var n=t.email,r=t.key;return ve(oe(e,n),r)}(ee(e,4),t.value);case"Logout":return ve(ee(e,5),t.value);case"Users":return we(ee(e,6),t.value);case"Chans":return we(ee(e,7),t.value);case"Chats":return we(ee(e,8),t.value)}},Ae=(ye=me,e=>1===le(e)?ye(e):null),Le=pe(de),Ue=pe(le),Te=pe((function(e){return{id:de(e),name:me(e)}})),Ne=function(e){return{id:de(e),name:me(e),fullname:me(e),mom:de(e),by:de(e),dir:Le(e),timestamp:me(e)}},ke=pe(Ne),xe=function(e){return{id:de(e),txt:me(e),by:de(e),re:de(e),nor:de(e),chanid:de(e),dir:Le(e),timestamp:me(e)}},Oe=pe(xe),je=function(e){switch(ce(e)){case 0:return W.User(function(e){return{id:de(e),name:me(e),email:me(e),emailverified:fe(e),fullname:me(e),key:me(e),picture:Ae(e),timestamp:me(e)}}(e));case 1:return W.Chan(Ne(e));case 2:return W.Chat(xe(e));case 3:return W.Users(Te(e));case 4:return W.Chans(ke(e));case 5:return W.Chats(Oe(e));case 6:return W.Login(Ue(e));case 7:return W.ChatScan(Le(e));case 8:return W.ChanScan(Le(e))}throw new Error("bad variant index for Response")},Ie=X(new ArrayBuffer(512)),De=function(e,t){return Ie.pos=0,Ie=t(Ie,e),new Uint8Array(Ie.view.buffer).slice(0,Ie.pos)},Me=function(e,t){return t(X(e))},Re=function(e){return Me(e.buffer,je)},Pe=function(e){return De(e,Se)};const $e=e=>new Zlib.Inflate(e).decompress(),Be=e=>new Zlib.Deflate(e).compress(),Ke=async(e,t,n)=>await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),qe=async(e,t,n)=>await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e),_e={};async function He(){let e=await V("u");e&&(_e.user=e);let t=await V("a");t&&(t=new Uint8Array(t),16===t.length&&(_e.salt=t));let n=await V("s");return n&&(n=new Uint8Array(n),32===n.length&&(_e.sskey=await crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"]))),console.log("[au]",_e),_e.salt}async function Fe(e,t){let n=new TextEncoder,r=await Ye(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",r)}async function Ye(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}const Ve=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),ze="wss://"+(Ve?Ve.groups.ip:"192.168.100.11:443");let Ge,Je,We,Xe,Ze,Qe,et,tt,nt,rt,at,ot=500,it=0,st=new Set,lt={recv:e=>st.add(e)},ct=0,ut=1;console.group("[ws]","starting..."),function e(t){Ge=performance.now(),Je=new WebSocket(ze),Je.binaryType="arraybuffer",Je.onopen=()=>{console.log(`[ws] open in ${N(Ge)} ms`),console.groupEnd("[ws]"),console.group("[dc]","opening..."),t?pt():Ze&&gt()},Je.onmessage=async e=>{console.log(`[ws] <- received answer in ${N(Ge)} ms`);let t=new Uint8Array(e.data),{a:n,k:r}=S(t);var a,o,i;ft=(e=>{const t=new c(e);return{z:t.get(0),m:t.get(1),c:t.get(2),d:t.get(3)}})(n),console.log(ft),lt.onconfig&&lt.onconfig(ft),r=await(a=r,crypto.subtle.importKey("raw",a,{name:"ECDH",namedCurve:"P-256"},!0,[])),rt=await(o=Xe.privateKey,i=r,crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:i},o,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])),nt=new Uint8Array(await crypto.subtle.exportKey("raw",rt));let s=JSON.parse((e=>(new TextDecoder).decode($e(e)))(n.slice(1))),l=s.answer?s.answer:s;if(await Qe.setRemoteDescription(new RTCSessionDescription(l)),!s.candidate)return;const u=new RTCIceCandidate({candidate:s.candidate,sdpMid:0,sdpMLineIndex:0});await Qe.addIceCandidate(u)},Je.onclose=t=>{it++,ot+=U(0,it<16?200:3e3),console.warn("[ws] closed",t),console.groupEnd("[ws]"),console.groupEnd("[ws]"),console.groupCollapsed("[ws]",`retry ${it} in ${(ot/1e3).toFixed(2)} sec`),setTimeout((()=>{e(!0)}),ot)},Je.onerror=e=>{console.error("[ws] error",e)}}(),pt();const dt=x();var ft={};function pt(){et=!1,function(){Qe=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});let e=ut++;Qe.onicecandidate=e=>{e.candidate},Qe.onconnectionstatechange=t=>{switch(Qe.connectionState){case"failed":case"disconnected":console.warn("[peer]",e,Qe.connectionState,"restarting....")}},Qe.oniceconnectionstatechange=t=>{switch(Qe.iceConnectionState){case"disconnected":console.warn("[ice]",e,Qe.connectionState,"restarting....")}}}(),at=Qe.createDataChannel("cu",{}),at.binaryType="arraybuffer",ct=0,lt.send=ht,at.onopen=e=>{console.log(`[dc] open in ${N(Ge)} ms`),console.groupEnd("[dc]"),ct=0,dt.complete(at)},at.onmessage=mt,at.onclose=e=>{console.warn("[dc] close",e)},at.onerror=e=>{console.error("[dc] error:",e)},async function(){const e=async()=>{let e=await Qe.createOffer();return await Qe.setLocalDescription(e),Be((new TextEncoder).encode(Qe.localDescription.sdp))},t=async()=>{if(tt)return tt;Xe=await(async()=>(console.log("[sec] generating key pairs"),await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"])))();let e=await crypto.subtle.exportKey("raw",Xe.publicKey);return tt=new Uint8Array(e),tt};Ze=await(async(e,t,n)=>{let[r,a,o]=await Promise.all([e(),t(),n()]);return o?E(E(r,a),o):k(E(r,a),64,24)})(e,t,He),console.log(`[dc] sdp in ${N(Ge)} ms`),1===Je.readyState&&gt()}()}async function ht(e){if(await dt.join(),ct++,console.groupEnd("[dc]"),console.group("[dc]","-> sending packet",ct,e),e=Pe(e),b(e),ft.z&&(e=Be(e)),ft.m&&(e=k(e,e.length),C(e,nt)),ft.c){const t=crypto.getRandomValues(new Uint8Array(12));C(e,t),e=T(t,new Uint8Array(await Ke(e,rt,t)))}if(ft.d){const t=crypto.getRandomValues(new Uint8Array(12));C(e,t),e=T(t,new Uint8Array(await Ke(e,_e.sskey,t)))}at.send(e),We=performance.now(),console.groupEnd("[dc]")}async function mt(e){let t=new Uint8Array(e.data),n=t.length;if(console.groupEnd("[dc]"),console.group("[dc]","<- received",n,"bytes in",N(We),"ms"),ft.d){let e=t.subarray(0,12);t=new Uint8Array(await qe(t.subarray(12),_e.sskey,e)),C(t,e)}if(ft.c){let e=t.subarray(0,12);t=new Uint8Array(await qe(t.subarray(12),rt,e)),C(t,e)}if(ft.m){C(t,nt);let{a:e}=S(t);t=new Uint8Array(e)}ft.z&&(t=$e(t));let r=(100*n/t.length).toFixed(2);console.log(`[dc] unpacked ${n} / ${t.length} bytes ${r}% in ${N(We)} ms`);let a=yt(t);st.forEach((e=>e(a))),console.groupEnd("[dc]")}const gt=()=>{et||(console.log("[ws] -> sending offer"),Je.send(Ze),et=!0)},yt=e=>{let t=Re(e);return console.log(t),console.table(t.value),t};let wt={},vt=[];function bt(e){return this.t&&this.t[e.type](e)}wt.h=(...e)=>{let t,n=r=>{if(null==r);else if("string"==typeof r)t?wt.add(t,r):t=wt.s?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);else if(Array.isArray(r))t||(t=document.createDocumentFragment()),r.forEach(n);else if(r instanceof Node)t?wt.add(t,r):t=r;else if("object"==typeof r)wt.property(t,r,null,wt.s);else if("function"==typeof r)if(t){let e=wt.add(t,"");wt.insert(t,r,e)}else t=r.apply(null,e.splice(1));else wt.add(t,""+r)};return e.forEach(n),t},wt.insert=(e,t,n,r,a)=>(e=n&&n.parentNode||e,a=a||r instanceof Node&&r,t===r||(r&&"string"!=typeof r||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?wt.subscribe((()=>{r=wt.insert(e,t.call({el:e,endMark:n}),n,r,a)})):(n?r&&(a||(a=r.o&&r.o.nextSibling||n.previousSibling),wt.rm(e,a,n)):e.textContent="",r=null,t&&!0!==t&&(r=wt.add(e,t,n))):(null!=r&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?wt.add(e,t,n):e.textContent=t,r=t)),r),wt.property=(e,t,n,r,a)=>{if(null!=t)if(!n||"attrs"===n&&(r=!0))for(n in t)wt.property(e,t[n],n,r,a);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?wt.subscribe((()=>{wt.property(e,t.call({el:e,name:n}),n,r,a)})):a?e.style.setProperty(n,t):r||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:wt.property(e,t,null,r,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,bt):e.removeEventListener(t,bt),(e.t||(e.t={}))[t]=n})(e,n,t)},wt.add=(e,t,n)=>{let r=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:wt.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:wt.h(vt,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),r},wt.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},wt.subscribe=function(e){return function(e,t){function n(){let r=u;return u&&u.__c.push(n),h(n),n.i=!0,u=n,t=e(t),u=r,t}function r(){return n.i?u&&n.u.forEach((e=>e())):t=n(),t}e.s=n,m(n),n(),r.$o=1}(e),()=>h(e.s)},wt.cleanup=function(e){return u&&u.l.push(e),e},wt.root=f,wt.sample=function(e){let t=u;u=void 0;let n=e();return u=t,n},wt.hs=(...e)=>{let t=wt.s;wt.s=!0;let n=Ct(...e);return wt.s=t,n};let Ct=(...e)=>wt.h.apply(wt.h,e);function Et(e,t,n){const{root:r,subscribe:a,sample:o,cleanup:i}=wt;null==n&&(n=!t.$t);let s=wt.h([]),l=wt.add(s,""),c=new Map,u=new Map,d=new Set;function f(e,a){if(null==e)return;let o=u.get(e);return 1===a?(d.delete(e),o||(o=n?r((n=>(c.set(e,n),t(e.$v||e)))):t(e.$v||e),11===o.nodeType&&(o=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let r=Array.from(t);return{nodeType:111,t:r[0],o:r[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(r[t++])}return e}}})(o)||o),u.set(e,o))):-1===a&&d.add(e),((e,t)=>111===e.nodeType?1/t<0?t?wt.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(o,a)}function p(e){let t=c.get(e);t&&(t(),c.delete(e)),u.delete(e)}return i(a((t=>{let n=e();return o((()=>{d.clear();let e=Array.from(function(e,t,n,r,a){let o,i,s=new Map,l=new Map;for(o=0;o<t.length;o++)s.set(t[o],o);for(o=0;o<n.length;o++)l.set(n[o],o);for(o=i=0;o!==t.length||i!==n.length;){var c=t[o],u=n[i];if(null===c)o++;else if(n.length<=i)e.removeChild(r(t[o],-1)),o++;else if(t.length<=o)e.insertBefore(r(u,1),r(t[o],0)||a),i++;else if(c===u)o++,i++;else{var d=l.get(c),f=s.get(u);void 0===d?(e.removeChild(r(t[o],-1)),o++):void 0===f?(e.insertBefore(r(u,1),r(t[o],0)||a),i++):(e.insertBefore(r(t[f],1),r(t[o],0)||a),t[f]=null,f>o+1&&o++,i++)}}return n}(l.parentNode,t||[],n,f,l));return d.forEach(p),e}))}))),i((function(){c.forEach((e=>e())),c.clear(),u.clear(),d.clear()})),s}const St="0VMZYpdgCGL3iKAzDHwocTt97e1hasO2mJNjExq4PvR6XyWSFbIn-5B_8fUukQlr",At=St.split(""),Lt=new Array(123);for(let e=0;e<St.length;e++)Lt[St.charCodeAt(e)]=e;const Ut=e=>{if(e<0)return"-"+Ut(-e);let t=e>>>0,n=e/4294967296>>>0,r="";for(;n>0;)r=At[63&t]+r,t>>>=6,t|=(63&n)<<26,n>>>=6;let a="";do{a=At[63&t]+a,t>>>=6}while(t>0);return a+r};var Tt={ntob:Ut,bton:e=>{let t=0;for(let n=0;n<e.length;n++)t=64*t+Lt[e.charCodeAt(n)];return t}};const Nt=[0,0,"🏠",0],kt=(()=>{let e=Nt;const t=p([e]),n=t=>e=t;return{path:t=>e[t],paths:t,len:()=>t().length,setpath:n,same:t=>t===e,cd:e=>{let r=t();r[e[0]]!==e&&(r[e[0]]=e),r.splice(e[0]+1),t(r),n(e),location.hash=e[0]>0?Tt.ntob(e[3]):""},route:e=>{t([Nt,...e]),n(e[e.length-1])}}})(),xt=[];function Ot(){!function(e){for(const t of xt)t(e)}(document.location.hash.substr(1))}window.addEventListener("hashchange",Ot),setTimeout(Ot);const jt=new Map,It=new Map,Dt=new Map,Mt=(e,t,n)=>{if(!t)return e;let r=e.get(t);return n?r?r[n]:void 0:r},Rt=p([]),Pt=p([]),$t=p(0),Bt=p(0),Kt=p(0),qt=p(""),_t=(e,t)=>Mt(jt,e,t),Ht=(e,t)=>Mt(It,e,t),Ft=(e,t)=>Mt(Dt,e,t),Yt=((...e)=>{const t={},n={};return{create:e=>n[e]=new Promise((n=>t[e]=n)),complete:(e,n)=>t[e]?t[e](n):null,join:e=>n[e],joinall:()=>Promise.all(e.map((e=>n[e]))),select:()=>Promise.race(e.map((e=>n[e])))}})("users","chans");lt.recv((async e=>{switch(e.tag){case"Users":q("users",e.value),Yt.complete("users",e.value);break;case"Chans":q("chans",e.value),Yt.complete("chans",e.value);break;case"Chat":let t=Pt();if(t.includes(e.value.id))return;let n=window.scrollY+window.innerHeight===document.body.scrollHeight;await _("chats",e.value);let r=new Set(Ft().has(e.value.by)?[]:[e.value.by]),a=e.value.dir.filter((e=>!_t(e))),o=new Set(a);await Jt(r,o),e.value.nor=p(0),e.value.star=p(!1),Ht().set(e.value.id,e.value),t.push(e.value.id),Pt(t),n&&y();break;case"Chats":if(0===e.value.length)return;q("chats",e.value),Yt.complete("chats",e.value);break;case"ChatScan":let i=e.value;if(0===i.length)return;zt(i);break;case"ChanScan":e.value.length>0&&await Xt(e.value),Rt(e.value)}}));const Vt="/"+St;(e=>{xt.push(e)})((async e=>{if(!e||!Vt.includes(e[0]))return $t(0),Qt();if("/"==e[0]){let t=Tt.bton(e.slice(1));Bt(t),await Gt([t]),Qt();let n=Ht(t).dir;return await Xt(n),Wt(n)}let t=Tt.bton(e);$t(t),Qt(),await Xt([t]);let n=_t(t).dir;await Xt(n),Wt([...n,t])}));const zt=async e=>{await Gt(e);let t=e[0],n=new Set,r=new Set;e.forEach((e=>{let t=Ht(e);t.nor=p(t.nor),t.star=p(!1),"string"==typeof t.timestamp&&(t.timestamp=new Date(t.timestamp)),Ft().has(t.by)||n.add(t.by),t.dir.forEach((e=>{_t().has(e)||r.add(e)}))})),await Jt(n,r),Pt(e.reverse().concat(Pt())),$t()&&(document.title=_t($t(),"fullname")),window.scrollY<100&&setTimeout((()=>document.getElementById(Tt.ntob(t)).scrollIntoView()))},Gt=async e=>{if(0===(e=e.filter((e=>!Ht().has(e)))).length)return;let{value:t,missed:n}=await H("chats",e);if(console.log("[chats] gets",{value:t,missed:n}),g(t,Ht()),n.length>0){let e=await Yt.create("chats",lt.send(J.Chats(n)));g(e,Ht())}},Jt=async(e,t)=>{let n=await H("users",Array.from(e)),r=await H("chans",Array.from(t));g(n.value,Ft()),g(r.value,_t()),n.missed.length>0&&Yt.create("users",lt.send(J.Users(n.missed))),r.missed.length>0&&Yt.create("chans",lt.send(J.Chans(r.missed)));let[a,o]=await Yt.joinall();a&&g(a,Ft()),o&&g(o,_t())},Wt=e=>{let t=e.map(((e,t)=>{let n=_t(e)||{};return[t+1,n.mom,n.name,e]}));kt.route(t)},Xt=async e=>{if(0===(e=e.filter((e=>!_t().has(e)))).length)return;let{value:t,missed:n}=await H("chans",e);if(console.log("[chans] gets",{value:t,missed:n}),g(t,_t()),n.length>0){let e=await Yt.create("chans",lt.send(J.Chans(n)));g(e,_t())}},Zt=(e,t,n)=>{let r=J.ChatScan({filter:Bt()>0?G.Id(Bt()):$t()>0?G.Chanid($t()):G.None(!0),kw:"",ub:e,lb:t,limit:n});lt.send(r)};async function Qt(e=30){Pt([]),Kt(0),Zt(99999,0,e)}const{request:en,select:tn,reload:nn}=(()=>{let e;const t=()=>(e=kt.path(3),"number"==typeof e?G.Chanid(e):G.None(!0)),n=(e="",n=99999,r=0,a=30)=>{let o=J.ChanScan({filter:t(),kw:e,ub:n,lb:r,limit:a});lt.send(o)},r=async(e=30)=>{let r=t(),a=await Y(r,e);console.log("[chans] scan",a),(async e=>{let t=e.map((e=>(_t().set(e.id,e),e.id)));Rt(t)})(a),n()};return{request:n,select:({id:e,mom:t,name:n})=>{kt.cd([kt.path(0)+1,t,n,e]),r()},reload:t=>{e!=t[3]&&(Rt([]),r())}}})(),rn=()=>{const e=document.createElement("div");e.contentEditable=!0,e.className="s-c",e.oninput=({target:{firstChild:t}})=>{var n,r,a,o;(n=function(){let t=e.textContent;t.length>50||en(t)},r=100,function(){var e=this,t=arguments,i=function(){o=null,a||n.apply(e,t)},s=a&&!o;clearTimeout(o),o=setTimeout(i,r),s&&n.apply(e,t)})()},e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};return Ct([Ct("div",{class:"s"},e),Ct("div",{class:"tbl"},Ct("table",null,Ct("tbody",null,Et(Rt,(e=>{let t=_t(e);return Ct("tr",{onclick:()=>tn(t)},Ct("td",null,"#"),Ct("td",null,t.name),Ct("td",null,t.fullname),Ct("td",null,Ct("button",{onclick:e=>(e=>e.stopPropagation())(e)},"JOIN")))}))))),Ct("div",{class:"grid"},Ct("div",{class:"container"},Ct("ol",{class:"bc"},Ct("li",null,Ct("a",{href:"#"},"#")," ",Ct("a",{href:"#"},"rust")),Ct("li",{class:"active relative drop-container"},Ct("a",null,"general"),Ct("div",{class:"drop"},Ct("ul",{class:"list"},Ct("li",null,Ct("a",{href:"#"},"security")),Ct("li",null,Ct("a",{href:"#"},"random")),Ct("li",null,Ct("a",{href:"#"},"backend")),Ct("li",null,Ct("a",{href:"#"},"compiler")),Ct("li",null,Ct("a",{href:"#"},"gamedev"))))))))])};var an;lt.onconfig=e=>{e.d?cn(ln):cn(sn)};const on=()=>(lt.recv((async e=>{switch(e.tag){case"Login":if(e.value.length<16)return void console.warn("login failed");let t=new Uint8Array(e.value.slice(16,20));_e.user={id:new DataView(t.buffer).getInt32(t,!1),name:(new TextDecoder).decode(new Uint8Array(e.value.slice(20)))},_e.salt=new Uint8Array(e.value.slice(0,16)),_e.sskey=await Ye(an,_e.salt);let n=await crypto.subtle.exportKey("raw",_e.sskey);K("u",_e.user),K("a",_e.salt.buffer),K("s",n),_("users",_e.user),ft.d=!0,cn(ln)}})),Ct("div",{class:"login"},Ct(v(cn),null))),sn=()=>Ct([Ct("h2",null,"Login"),Ct("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value;an=await Fe(t.password.value,n);let r={email:n,key:Array.from(new Uint8Array(an))};lt.send(J.Login(r)),console.log(r)}},Ct("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),Ct("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),Ct("button",{type:"submit"},"Login")),Ct("h2",null,"Register"),Ct("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value,r=t.name.value;an=await Fe(t.password.value,n);let a={email:n,name:r,key:Array.from(new Uint8Array(an))};lt.send(J.AddUser(a)),console.log(a)}},Ct("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),Ct("input",{type:"text",name:"name",placeholder:"name",required:!0,autocomplete:"true"}),Ct("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),Ct("button",{type:"submit"},"Register"))]),ln=()=>Ct([Ct("div",null,"You have logged in"),Ct("button",{onclick:async()=>{await lt.send(J.Logout(Array.from(_e.salt))),(async()=>{let e=await D.join();e&&e.transaction(["session"],"readwrite").objectStore("session").clear()})(),ft.d=!1,_e.user=void 0,_e.sskey=void 0,_e.salt=void 0,cn(sn)}},"Logout")]),cn=p((()=>null)),un="defaultParagraphSeparator",dn="formatBlock",fn=(e,t,n)=>e.addEventListener(t,n),pn=(e,t)=>e.appendChild(t),hn=e=>document.createElement(e),mn=e=>document.queryCommandState(e),gn=(e,t=null)=>document.execCommand(e,!1,t),yn={bold:{icon:"<b>B</b>",title:"Bold",state:()=>mn("bold"),result:()=>gn("bold")},italic:{icon:"<i>I</i>",title:"Italic",state:()=>mn("italic"),result:()=>gn("italic")},underline:{icon:"<u>U</u>",title:"Underline",state:()=>mn("underline"),result:()=>gn("underline")},strikethrough:{icon:"<strike>S</strike>",title:"Strike-through",state:()=>mn("strikeThrough"),result:()=>gn("strikeThrough")},heading1:{icon:"<b>H1</b>",title:"Heading 1",result:()=>gn(dn,"<h1>")},heading2:{icon:"<b>H2</b>",title:"Heading 2",result:()=>gn(dn,"<h2>")},quote:{icon:"&#8220;&#8221;",title:"Quote",result:()=>gn(dn,"<blockquote>")},olist:{icon:"1.",title:"Ordered List",result:()=>gn("insertOrderedList")},ulist:{icon:"&#8226;",title:"Unordered List",result:()=>gn("insertUnorderedList")},code:{icon:"&lt;&gt;",title:"Code",result:()=>gn(dn,"<pre>")},line:{icon:"&#8213;",title:"Horizontal Line",result:()=>gn("insertHorizontalRule")},link:{icon:"&#128279;",title:"Link",result:()=>{const e=window.prompt("Enter the link URL");e&&gn("createLink",e)}},image:{icon:"&#128247;",title:"Image",result:()=>{const e=window.prompt("Enter the image URL");e&&gn("insertImage",e)}}},wn={actionbar:"e-a",button:"e-b",content:"e-c",selected:"e-bs",topic:"e-t"},{send:vn,select:bn}=(()=>{const e=({id:e,txt:t},{topic:n})=>{if(!e||Kt()===e)return n.textContent="",qt(""),void Kt(0);n.innerHTML=t,n.textContent=n.textContent,qt(n.textContent),Kt(e)};return{send:({topic:t,content:n})=>{if(!_e.user||!_e.user.id)return void alert("you are not login!");if(!n.textContent.trim())return;let r=$t(),a=Kt()||Pt()[Pt().length-1],o="";if(a&&t.textContent===qt())r=Ht(a).chanid||r;else{if(o=t.textContent,0===o.trim().length)return alert("topic should not be empty"),!1;a=0}let i=n.innerHTML.trim(),s=_e.user.id;lt.send(J.AddChat({txt:i,by:s,re:a,fullname:o,chanid:r})),n.textContent="",e({},{topic:t})},select:e}})(),Cn=()=>{const e=(e=>{const t=e.actions?e.actions.map((e=>"string"==typeof e?yn[e]:yn[e.name]?{...yn[e.name],...e}:e)):Object.keys(yn).map((e=>yn[e])),n={...wn,...e.classes},r=e.defaultParagraphSeparator||"div",a=e.element.topic=hn("div");a.contentEditable=!0,a.className=n.topic,a.onkeydown=e=>{"Enter"===e.key&&(o.focus(),e.preventDefault())},pn(e.element,a);const o=e.element.content=hn("div");o.contentEditable=!0,o.className=n.content,o.onfocus=()=>{let t=window.scrollY+window.innerHeight===document.body.scrollHeight;e.element.classList.add("sticky"),t&&setTimeout((()=>y()))},o.onblur=()=>{setTimeout((()=>{e.element.contains(document.activeElement)||e.element.classList.remove("sticky")}))},o.oninput=({target:{firstChild:t}})=>{e.oninput(o.innerHTML)},o.onkeydown=t=>{"Enter"!==t.key||t.shiftKey||(e.onsend({topic:a,content:o}),t.preventDefault())},pn(e.element,o);const i=hn("div");return i.className=n.actionbar,pn(e.element,i),t.forEach((e=>{const t=hn("button");if(t.className=n.button,t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=()=>e.result()&&o.focus(),e.state){const r=()=>t.classList[e.state()?"add":"remove"](n.selected);fn(o,"keyup",r),fn(o,"mouseup",r),fn(t,"click",r)}pn(i,t)})),e.styleWithCSS&&gn("styleWithCSS"),gn(un,r),e.element})({element:Ct("div",{class:"e"}),oninput:e=>{},onsend:vn}),t=e=>{let{id:t,txt:a,by:o,chanid:s,re:l,star:c,nor:u}=e,d=Pt(),f=_t(s),p=[...f.dir,f.id].slice(kt.len()-1),h=d[d.indexOf(t)-1],m=Ht(h)||{},g=m.by!==o,y=!l||p.length>0&&m.chanid!==s;y&&0==p.length&&(p=[f.id]);let w=Tt.ntob(t);const v=()=>{n("#/"+w,w)};return Ct("div",{id:w,class:function(){return"c"+(()=>(c()?" star":"")+(y?" t":"")+(Kt()===t?" cur":"")).call(this)},onclick:t=>r(t,e)},y?Ct("div",{class:"tn"+(l?" re":" nw")},p.map((e=>{let t=Tt.ntob(e);return Ct([" / ",Ct("a",{href:function(){return"#"+("function"==typeof t?t.call(this):t)},onclick:e=>((e,t)=>{n("#"+t,t),e.preventDefault()})(e,t),innerHTML:_t(e,"fullname")})," "])}))):null,g||y?Ct("div",{class:"by"},Ft(o).name):null,Ct("div",{onclick:e=>e.stopPropagation()},(()=>{let e=u();if(1!==e||t!==Ht(Pt()[i+1]).re)return e>0?Ct([Ct("span",{class:"rep",onclick:v},e," 💬")," "]):void 0}),(e=>document.createRange().createContextualFragment(e))(a)))},n=(e,t)=>{let n=screen.width/2-300,r=screen.height/2-300;window.open(e,t,`toolbar=yes,location=yes,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=600,height=600,top=${r}, left=${n}`)},r=(e,t)=>{e.x<18&&e.offsetY<22&&a(t)},a=({id:e,star:t})=>{const n=Pt().filter((t=>t===e))[0],r=Ht(n);r.star?r.star(!t()):r.star=p(!1)},o=Ct("div",null);return setTimeout((function(){new IntersectionObserver((e=>{e[0].intersectionRatio<=0||setTimeout((()=>(async(e=30)=>{let t=Pt()[0];!t||t<=1||Zt(t,0,e)})()))}),{}).observe(o)})),Ct([o,Ct("div",null,Et(Pt,(e=>t(Ht(e))))),e])},En=()=>{},Sn=p(En);document.querySelector(".a").append(Ct([Ct("div",{class:"n"},Ct("div",null,Ct("ol",{class:"bc"},(()=>Et(kt.paths,(e=>Ct("li",null,Ct("a",{onclick:t=>(e=>{Sn()!==rn?e[0]===kt.len()-1?Sn(rn):kt.cd(e):kt.same(e)&&Sn(En),kt.setpath(e),Sn()===rn&&nn(e)})(e)},e[2]))))),".."),Ct("div",{class:"m"},Ct("a",{onclick:e=>{Sn()===on?Sn(En):Sn(on)}},"login"))),Ct(v(Sn),null)),Cn]))}();
