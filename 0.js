!function(){"use strict";const e=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},t=e(),n=["_t","_p","_e","_h","_r","_c","_s","_u","_n","_d","_m"];var a;let r=indexedDB.open("s",1);function i(e){var t=window.indexedDB.deleteDatabase(e);t.onerror=e=>{},t.onsuccess=()=>{}}r.onsuccess=()=>{(function(e){let t=e.objectStoreNames;if(t.length===n.length){for(const e of n)if(!t.contains(e))return void i("s")}else i("s")})(a=r.result),t.complete(a)},r.onerror=e=>{i("s"),location.reload()},r.onblocked=e=>{},r.onupgradeneeded=e=>{let t=(a=r.result).objectStoreNames;if(t.contains("_s")||a.createObjectStore("_s"),t.contains("_r")||a.createObjectStore("_r"),t.contains("_e")||a.createObjectStore("_e",{keyPath:"id"}),!t.contains("_t")){let e=a.createObjectStore("_t",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1})}if(t.contains("_p")||a.createObjectStore("_p",{keyPath:"id",autoIncrement:!0}).createIndex("room",["room","id"],{unique:!1}),!t.contains("_h")){let e=a.createObjectStore("_h",{keyPath:"id"});e.createIndex("mom",["mom","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1}),e.createIndex("chatid","chatid",{unique:!1})}t.contains("_c")||a.createObjectStore("_c",{keyPath:["chanid","chatid"]}),t.contains("_u")||a.createObjectStore("_u"),t.contains("_n")||a.createObjectStore("_n"),t.contains("_d")||a.createObjectStore("_d"),t.contains("_m")||a.createObjectStore("_m");for(const e of n)a.objectStoreNames.contains(e)||a.createObjectStore(e)};const s=(e,t)=>crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:t},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),l=e=>crypto.subtle.importKey("raw",e,{name:"ECDH",namedCurve:"P-256"},!0,[]),o=async()=>await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"]),c=async(e,t,n)=>await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),u=async(e,t,n)=>await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e);let d,f=[];function m(e){function t(n){if(0===arguments.length)return d&&!t.__o.has(d)&&(t.__o.add(d),d.u.push(t)),e;e=n;let a=d;return d=void 0,t.o=new Set(t.__o),t.o.forEach((e=>e.i=!1)),t.o.forEach((e=>{e.i||e()})),d=a,e}return t.$o=1,t.__o=new Set,t.t=f,t}function h(e){e.__c.forEach(h),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),p(e)}function p(e){e.u=[],e.__c=[],e.l=[]}let v={},y=[];function w(e){return this.t&&this.t[e.type](e)}v.h=(...e)=>{let t,n=a=>{if(null==a);else if("string"==typeof a)t?v.add(t,a):t=v.s?document.createElementNS("http://www.w3.org/2000/svg",a):document.createElement(a);else if(Array.isArray(a))t||(t=document.createDocumentFragment()),a.forEach(n);else if(a instanceof Node)t?v.add(t,a):t=a;else if("object"==typeof a)v.property(t,a,null,v.s);else if("function"==typeof a)if(t){let e=v.add(t,"");v.insert(t,a,e)}else t=a.apply(null,e.splice(1));else v.add(t,""+a)};return e.forEach(n),t},v.insert=(e,t,n,a,r)=>(e=n&&n.parentNode||e,r=r||a instanceof Node&&a,t===a||(a&&"string"!=typeof a||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?v.subscribe((()=>{a=v.insert(e,t.call({el:e,endMark:n}),n,a,r)})):(n?a&&(r||(r=a.o&&a.o.nextSibling||n.previousSibling),v.rm(e,r,n)):e.textContent="",a=null,t&&!0!==t&&(a=v.add(e,t,n))):(null!=a&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?v.add(e,t,n):e.textContent=t,a=t)),a),v.property=(e,t,n,a,r)=>{if(null!=t)if(!n||"attrs"===n&&(a=!0))for(n in t)v.property(e,t[n],n,a,r);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?v.subscribe((()=>{v.property(e,t.call({el:e,name:n}),n,a,r)})):r?e.style.setProperty(n,t):a||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:v.property(e,t,null,a,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,w):e.removeEventListener(t,w),(e.t||(e.t={}))[t]=n})(e,n,t)},v.add=(e,t,n)=>{let a=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:v.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:v.h(y,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),a},v.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},v.subscribe=function(e){return function(e,t){function n(){let a=d;return d&&d.__c.push(n),h(n),n.i=!0,d=n,t=e(t),d=a,t}function a(){return n.i?d&&n.u.forEach((e=>e())):t=n(),t}e.s=n,p(n),n(),a.$o=1}(e),()=>h(e.s)},v.cleanup=function(e){return d&&d.l.push(e),e},v.root=function(e){let t=d,n=()=>{};d=n,p(n);let a=e((()=>{h(n),d=void 0}));return d=t,a},v.sample=function(e){let t=d;d=void 0;let n=e();return d=t,n},v.hs=(...e)=>{let t=v.s;v.s=!0;let n=g(...e);return v.s=t,n};let g=(...e)=>v.h.apply(v.h,e);function b(e){let t=t=>void 0===t?e:e.get(t);return t.clear=e.clear.bind(e),t.delete=e.delete.bind(e),t.forEach=e.forEach.bind(e),t.get=e.get.bind(e),t.has=e.has.bind(e),t.set=e.set.bind(e),t.entries=e.entries.bind(e),t.size=()=>e.size,t}function k(){let e=m([]);return e.add=t=>e().indexOf(t)<0?(e().push(t),e(e())):e(),e.delete=t=>{let n=e(),a=n.indexOf(t);return!(a<0||(n.splice(a,1),e(n),0))},e.last=()=>e()[e().length-1],e.pop=()=>{let t=e().pop();return e(e()),t},e.append=t=>e(e().concat(t)),e.prepend=t=>e(t.concat(e())),e.len=()=>e().length,e.at=t=>e()[t],e.has=t=>e().includes(t),e.index=t=>e().indexOf(t),e}function C(e){return{id:e.id,by:e.by,chanid:e.chanid,dir:e.dir,isnew:!1,timestamp:new Date(e.timestamp),men:e.men,re:e.re,txt:m(e.txt),star:m(e.star),first:m(!1),firstre:m(!1),showby:m(!1),nor:m(e.nor)}}const S=(e,t,n=!1)=>e.reduce(((e,t)=>{if(!e.has(t.id)){let a=C(t);a.isnew=n,e.set(t.id,a)}return e}),t),E=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)?"online"in t&&e.get(t.id).online(t.online):e.set(t.id,{id:t.id,name:t.name,online:m(t.online),tz:m(""),st:m("")}),delete t.online,e)),t),x=(e,t)=>e.reduce(((e,t)=>{if(e.has(t.id)){let n=e.get(t.id);n.fullname(t.fullname),n.about(t.about),n.md(t.md)}else e.set(t.id,function(e){return{id:e.id,mom:e.mom,by:e.by,dir:e.dir,timestamp:new Date(e.timestamp),chatid:e.chatid,to:e.to,re:e.re,fullname:m(e.fullname),about:m(e.about),md:m(e.md)}}(t));return e}),t);async function _(e,n){let a=await t.join();if(!a)return;let r=a.transaction([e],"readwrite").objectStore(e);return new Promise((e=>{let t=r.put(n);t.onsuccess=t=>{e(t.target.result)},t.onerror=console.error}))}async function U(e,n){let a=await t.join();if(!a)return;let r=a.transaction([e],"readwrite").objectStore(e);n.forEach((e=>{"string"==typeof e.timestamp&&(e.timestamp=new Date(e.timestamp)),r.put(e).onerror=console.error}))}async function A(e,n,a){let r=await t.join();r&&r.transaction([e],"readwrite").objectStore(e).put(a,n)}var T={};function M(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(T,"__esModule",{value:!0});var D=function(){function e(e,t){void 0===e&&(e=0);var n=null==t?void 0:t.grow;this.grow=n&&isFinite(n)&&M(n)||n||0,this.buffer="number"==typeof e?new Uint8Array(M(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var a=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(a<=this.grow){var r=new Uint8Array(a);r.set(this.buffer),this.buffer=r}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var a=t,r=a>>3,i=128>>a%8,s=this.buffer[r];a<n;a++)e(!!(s&i),a),i=1===i?(s=this.buffer[++r],128):i>>1},e}(),L=T.default=D;function P(e,t,n=!1){var a;return(...r)=>{a&&clearTimeout(a),n&&!a&&e.apply(this,r),a=setTimeout((()=>{a=null,n||e.apply(this,r)}),t)}}function I(){document.execCommand("selectAll",!1,void 0),document.getSelection()?.collapseToEnd()}function O(){return document.getSelection().focusOffset}const j=e=>document.getElementById(e.toString());function N(){window.scrollTo(0,document.documentElement.scrollHeight)}const K=(e,t)=>{let n=0,a=0;for(;n<e.length;)a>=t.length&&(a=0),e.set([e[n]^t[a]],n),n++,a++},$=(e,t)=>V(F(e,t),64,24),z=e=>{let{a:t}=R(e);return R(t)},F=(e,t)=>(K(e,t),q(e,t)),R=e=>{let{a:t,k:n}=B(e);return K(t,n),{a:t,k:n}},B=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},q=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},H=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},V=(e,t=64,n=8)=>{return F(e,crypto.getRandomValues(new Uint8Array((a=n,r=t,a=Math.ceil(a),Math.floor(Math.random()*(Math.floor(r)-a)+a)))));var a,r},W=e=>(e=>"hsl("+e%360+",100%,30%)")((e=>{var t=0;if(0==e.length)return t;for(var n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t),t&=t;return t})(e+"#"));function Y(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&e.length<70}function X(e){return e.length<2||e.length>30?10:/^[0-9a-z_]+$/.test(e)?0:10}function G(){return window.scrollY+window.innerHeight===document.documentElement.scrollHeight}function Z(){return Intl.DateTimeFormat().resolvedOptions().timeZone}function J(e){if(!/^[a-z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1}function Q(e){if(!/^[a-z0-9\_]+$/.test(e.key))return e.preventDefault(),!1}function ee(e){e.target.value=e.target.value.toLowerCase().replace(/\s/g,"")}function te(e,t){return e.length<6?12:t&&e==t?14:void 0}function ne(e,t){return!!t&&e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}async function ae(e,n){let a=await t.join();if(!a)return;let r=a.transaction([n],"readonly").objectStore(n);return new Promise((t=>{let n=r.get(e);n.onerror=console.error,n.onsuccess=()=>t(n.result)}))}async function re(e,n){let a=await t.join();if(!a)return{value:[],missed:n};if(0===n.length)return{value:[],missed:[]};performance.now();let r=[],i=new Set,s=a.transaction([e],"readonly").objectStore(e),l=0;return new Promise((e=>{n.forEach((t=>{let a=s.get(t);a.onerror=console.error,a.onsuccess=()=>{if(a.result?r.push(a.result):i.add(t),++l===n.length){let t={value:r,missed:Array.from(i)};e(t)}}}))}))}async function ie(e,n){let a=await t.join();a&&a.transaction(["_s"],"readwrite").objectStore("_s").put(n,e)}function se(e){return ae(e,"_s")}const le=new Map,oe=(e,t,n)=>{let a=le.get(e)||[];n?a=[t]:a.push(t),le.set(e,a)},ce=(e,t)=>le.get(e)?.forEach((e=>e(t))),ue={},de=e=>(e&&(Object.assign(ue,e),ce("config",ue)),ue),fe=m(void 0),me={id:m(0),name:m(""),chans:k(),salt:new Uint8Array};async function he(){let e=await se("a");if(!e||e.byteLength<54)return;let t=new Uint8Array(e,0,16),n=new Uint8Array(e,16,32);16===t.length&&(me.salt=t),32===n.length&&(me.sskey=await crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"]));let a=new Uint8Array(e,48,4),r=new Uint8Array(e,52),i=new DataView(a.buffer).getInt32(48,!1),s=(new TextDecoder).decode(r);i&&s&&(me.id(i),me.name(s));let l=await se("c");l&&l instanceof Array&&me.chans(l);var o=new Uint8Array(20);return o.set(t),o.set(a,16),setTimeout(N),o}async function pe(e,t){let n=new TextEncoder,a=await ye(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",a)}async function ve(e,t){return await ye((new TextEncoder).encode(e),t)}async function ye(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function we(e){let t=new Uint8Array(e.slice(16,20)),n=new Uint8Array(e.slice(20)),a=new DataView(t.buffer).getInt32(0,!1),r=(new TextDecoder).decode(n);me.id(a),me.name(r),me.salt=new Uint8Array(e.slice(0,16)),me.sskey=await ye(fe(),me.salt),fe(void 0);let i=new Uint8Array(await crypto.subtle.exportKey("raw",me.sskey)),s=me.salt.length,l=new Uint8Array(s+i.length+t.length+n.length);return l.set(me.salt),l.set(i,s),l.set(t,s+i.length),l.set(n,s+i.length+t.length),ie("a",l.buffer),{id:a,name:r,tz:Z()}}var ge,be;!function(e){e.Shin=e=>({tag:"Shin",value:e}),e.Shan=e=>({tag:"Shan",value:e}),e.Tree=e=>({tag:"Tree",value:e}),e.NewChat=e=>({tag:"NewChat",value:e}),e.NewUser=e=>({tag:"NewUser",value:e}),e.Login=e=>({tag:"Login",value:e}),e.Logout=e=>({tag:"Logout",value:e}),e.Users=e=>({tag:"Users",value:e}),e.Chans=e=>({tag:"Chans",value:e}),e.Chats=e=>({tag:"Chats",value:e}),e.MuteChan=e=>({tag:"MuteChan",value:e}),e.UnmuteChan=e=>({tag:"UnmuteChan",value:e}),e.AddMems=e=>({tag:"AddMems",value:e}),e.DelChat=e=>({tag:"DelChat",value:e}),e.DelChan=e=>({tag:"DelChan",value:e}),e.EditChat=e=>({tag:"EditChat",value:e}),e.EditChan=e=>({tag:"EditChan",value:e}),e.Mems=e=>({tag:"Mems",value:e}),e.FindUsers=e=>({tag:"FindUsers",value:e}),e.FindMems=e=>({tag:"FindMems",value:e}),e.PushSubs=e=>({tag:"PushSubs",value:e}),e.Ons=e=>({tag:"Ons",value:e}),e.Unpack=e=>({tag:"Unpack",value:e}),e.Tz=e=>({tag:"Tz",value:e}),e.Profile={tag:"Profile"},e.EditProfile=e=>({tag:"EditProfile",value:e}),e.Pwd=e=>({tag:"Pwd",value:e}),e.Email=e=>({tag:"Email",value:e}),e.Au=e=>({tag:"Au",value:e}),e.Signup=e=>({tag:"Signup",value:e}),e.Fp=e=>({tag:"Fp",value:e}),e.EditStatus=e=>({tag:"EditStatus",value:e}),e.Status=e=>({tag:"Status",value:e}),e.ChatThread=e=>({tag:"ChatThread",value:e}),e.ChatList=e=>({tag:"ChatList",value:e}),e.Star=e=>({tag:"Star",value:e}),e.Sdp=e=>({tag:"Sdp",value:e})}(ge||(ge={})),function(e){e.Shin=e=>({tag:"Shin",value:e}),e.Shan=e=>({tag:"Shan",value:e}),e.Tree=e=>({tag:"Tree",value:e}),e.Treeid=e=>({tag:"Treeid",value:e}),e.Chats=e=>({tag:"Chats",value:e}),e.Chans=e=>({tag:"Chans",value:e}),e.Users=e=>({tag:"Users",value:e}),e.Chat=e=>({tag:"Chat",value:e}),e.Login=e=>({tag:"Login",value:e}),e.MuteChan=e=>({tag:"MuteChan",value:e}),e.UnmuteChan=e=>({tag:"UnmuteChan",value:e}),e.DelChan=e=>({tag:"DelChan",value:e}),e.Update=e=>({tag:"Update",value:e}),e.Updates=e=>({tag:"Updates",value:e}),e.ChanUpdates=e=>({tag:"ChanUpdates",value:e}),e.MemUpdates=e=>({tag:"MemUpdates",value:e}),e.On=e=>({tag:"On",value:e}),e.Ons=e=>({tag:"Ons",value:e}),e.Mems=e=>({tag:"Mems",value:e}),e.Err=e=>({tag:"Err",value:e}),e.NewChan=e=>({tag:"NewChan",value:e}),e.FindUsers=e=>({tag:"FindUsers",value:e}),e.FindMems=e=>({tag:"FindMems",value:e}),e.Logout=e=>({tag:"Logout",value:e}),e.AddMems=e=>({tag:"AddMems",value:e}),e.Unpack=e=>({tag:"Unpack",value:e}),e.Profile=e=>({tag:"Profile",value:e}),e.Pwd=e=>({tag:"Pwd",value:e}),e.Name=e=>({tag:"Name",value:e}),e.Signup=e=>({tag:"Signup",value:e}),e.Typing=e=>({tag:"Typing",value:e}),e.Status=e=>({tag:"Status",value:e}),e.ChatThread=e=>({tag:"ChatThread",value:e}),e.ChatList=e=>({tag:"ChatList",value:e}),e.Sdp=e=>({tag:"Sdp",value:e})}(be||(be={}));const ke=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),Ce=(e,t)=>{const{view:{buffer:n},pos:a}=e,r=n.byteLength;if(r-a>t)return e;const i=Math.max(2*r,r+t),s=new Uint8Array(i);return s.set(new Uint8Array(n)),ke(s.buffer,a,e.littleEndian)},Se=(e,t)=>{e=Ce(e,1);const{view:n,pos:a}=e;return n.setUint8(a,t),e.pos+=1,e},Ee=(e,t)=>{e=Ce(e,4);const{view:n,pos:a,littleEndian:r}=e;return n.setUint32(a,t,r),e.pos+=4,e},xe=(e,t)=>{e=Ce(e,2);const{view:n,pos:a,littleEndian:r}=e;return n.setUint16(a,t,r),e.pos+=2,e};function _e(e,t){const{view:n,pos:a,littleEndian:r}=e;return n.setUint32(r?a:a+4,t,r),n.setUint32(r?a+4:a,0,r),e.pos+=8,e}const Ue=(e,t)=>{e=Ce(e,4);const{view:n,pos:a,littleEndian:r}=e;return n.setInt32(a,t,r),e.pos+=4,e},Ae=new TextEncoder,Te="encodeInto"in Ae?(e,t)=>Ae.encodeInto(e,t).written:(e,t)=>{const n=Ae.encode(e);return t.set(n),n.length},Me=(e,t)=>{e=Ce(e,3*t.length+8);const n=Te(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=_e(e,n)).pos+=n,e},De=(e,t)=>Se(e,t?1:0),Le=e=>(t,n)=>n.reduce(e,((e,t)=>_e(Ce(e,8),t))(t,n.length)),Pe=e=>(t,n)=>null===n?Se(t,0):e(Se(t,1),n),Ie=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},Oe=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=2,n.getUint16(t,a)},je=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getUint32(t,a)},Ne=e=>{const{view:t,pos:n,littleEndian:a}=e;return e.pos+=8,t.getUint32(a?n:n+4,a)},Ke=e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=4,n.getInt32(t,a)},$e=e=>1===Ie(e),ze=e=>t=>1===Ie(t)?e(t):null,Fe=e=>t=>{const n=Ne(t),a=new Array;for(let r=0;r<n;r++)a.push(e(t));return a},Re=new TextDecoder,Be=e=>{const t=Ne(e),{pos:n,view:{buffer:a}}=e,r=Re.decode(new Uint8Array(a,n,t));return e.pos+=t,r},qe=Le(Ue),He=Pe(Me),Ve=Pe(qe),We=Pe(Ue),Ye=Pe(De),Xe=Pe(((e,{id:t,lo:n})=>Ue(Ue(e,t),n))),Ge=Le(Me),Ze=Pe(Ge),Je=Le(Se),Qe=Pe(((e,t)=>{e=Ce(e,8);const{view:n,pos:a,littleEndian:r}=e;return n.setFloat64(a,t,r),e.pos+=8,e})),et=Pe(Je),tt=Pe(xe),nt=(e,{id:t,txt:n,by:a,chanid:r,dir:i,timestamp:s,men:l,re:o,nor:c,star:u})=>Ye(We(We(Ve(Me(qe(Ue(Ue(Me(Ue(e,t),n),a),r),i),s),l),o),c),u),at=(Le(nt),Le(((e,{id:t,fullname:n,mom:a,by:r,dir:i,md:s,timestamp:l,chatid:o,about:c,to:u,re:d})=>We(Ve(He(Ue(Me(xe(qe(Ue(Ue(Me(Ue(e,t),n),a),r),i),s),l),o),c),u),d))),(e,{id:t,name:n,online:a})=>De(Me(Ue(e,t),n),a)),rt=Le(at),it=(Pe(((e,{data:t,chans:n})=>qe(Je(e,t),n))),(e,{id:t,action:n,chatid:a,txt:r})=>He(Ue(xe(Ue(e,t),n),a),r)),st=(Le(it),Le(((e,{id:t,action:n,chanid:a,name:r,about:i,md:s})=>tt(He(He(Ue(xe(Ue(e,t),n),a),r),i),s))),Le(((e,{id:t,action:n,chanid:a,by:r})=>Ue(Ue(xe(Ue(e,t),n),a),r))),Le(((e,{chanid:t,users:n})=>rt(Ue(e,t),n))),(e,{email:t,fullname:n,about:a})=>He(He(He(e,t),n),a)),lt=(e,{i:t,ub:n,lb:a,kw:r})=>He(We(We(Ue(e,t),n),a),r),ot=(e,{fr:t,to:n,offer:a,sd:r,ca:i})=>Ge(Je(Ye(We(We(e,t),n),a),r),i),ct=(e,{txt:t})=>Me(e,t),ut=(e,{st:t,tz:n})=>He(He(e,t),n),dt=(e,t)=>{switch(t.tag){case"Shin":return((e,{chanid:t,kw:n,lu:a,cu:r,mu:i,ub:s,lb:l})=>We(We(We(We(Xe(He(We(e,t),n),a),r),i),s),l))(Ee(e,0),t.value);case"Shan":return((e,{chanid:t,kw:n,cu:a,mu:r,ub:i,lb:s})=>We(We(We(We(He(Ue(e,t),n),a),r),i),s))(Ee(e,1),t.value);case"Tree":return((e,{kw:t,reload:n})=>Ye(He(e,t),n))(Ee(e,2),t.value);case"NewChat":return((e,{txt:t,chanid:n,re:a,chname:r,men:i,to:s,emails:l})=>Ze(Ve(Ve(He(We(Ue(Me(e,t),n),a),r),i),s),l))(Ee(e,3),t.value);case"NewUser":return((e,{name:t,key:n,tz:a,tgid:r,tgname:i,tgfn:s,tgln:l})=>He(He(He(Qe(He(Je(Me(e,t),n),a),r),i),s),l))(Ee(e,4),t.value);case"Login":return((e,{name:t,key:n,tz:a})=>He(Je(Me(e,t),n),a))(Ee(e,5),t.value);case"Logout":return Je(Ee(e,6),t.value);case"Users":return qe(Ee(e,7),t.value);case"Chans":return qe(Ee(e,8),t.value);case"Chats":return qe(Ee(e,9),t.value);case"MuteChan":return Ue(Ee(e,10),t.value);case"UnmuteChan":return Ue(Ee(e,11),t.value);case"AddMems":return((e,{chanid:t,userids:n,emails:a})=>Ze(Ve(Ue(e,t),n),a))(Ee(e,12),t.value);case"DelChat":return Ue(Ee(e,13),t.value);case"DelChan":return Ue(Ee(e,14),t.value);case"EditChat":return((e,{id:t,txt:n})=>Me(Ue(e,t),n))(Ee(e,15),t.value);case"EditChan":return((e,{id:t,name:n,about:a,md:r})=>tt(He(He(Ue(e,t),n),a),r))(Ee(e,16),t.value);case"Mems":return qe(Ee(e,17),t.value);case"FindUsers":return Me(Ee(e,18),t.value);case"FindMems":return((e,{chanid:t,kw:n})=>Me(Ue(e,t),n))(Ee(e,19),t.value);case"PushSubs":return((e,{endpoint:t,auth:n,p256dh:a})=>Me(Me(Me(e,t),n),a))(Ee(e,20),t.value);case"Ons":return qe(Ee(e,21),t.value);case"Unpack":return Me(Ee(e,22),t.value);case"Tz":return Me(Ee(e,23),t.value);case"Profile":return Ee(e,24);case"EditProfile":return st(Ee(e,25),t.value);case"Pwd":return((e,{key:t,okey:n})=>et(Je(e,t),n))(Ee(e,26),t.value);case"Email":return Me(Ee(e,27),t.value);case"Au":return Me(Ee(e,28),t.value);case"Signup":return Me(Ee(e,29),t.value);case"Fp":return Me(Ee(e,30),t.value);case"EditStatus":return ut(Ee(e,31),t.value);case"Status":return Ue(Ee(e,32),t.value);case"ChatThread":return lt(Ee(e,33),t.value);case"ChatList":return lt(Ee(e,34),t.value);case"Star":return Ue(Ee(e,35),t.value);case"Sdp":return ot(Ee(e,36),t.value)}},ft=Fe(Ke),mt=ze(Be),ht=ze(ft),pt=ze(Ke),vt=ze($e),yt=(ze((e=>({id:Ke(e),lo:Ke(e)}))),Fe(Be)),wt=(ze(yt),Fe(Ie)),gt=(ze((e=>{const{pos:t,view:n,littleEndian:a}=e;return e.pos+=8,n.getFloat64(t,a)})),ze(wt)),bt=ze(Oe),kt=e=>({id:Ke(e),txt:Be(e),by:Ke(e),chanid:Ke(e),dir:ft(e),timestamp:Be(e),men:ht(e),re:pt(e),nor:pt(e),star:vt(e)}),Ct=Fe(kt),St=Fe((e=>({id:Ke(e),fullname:Be(e),mom:Ke(e),by:Ke(e),dir:ft(e),md:Oe(e),timestamp:Be(e),chatid:Ke(e),about:mt(e),to:ht(e),re:pt(e)}))),Et=e=>({id:Ke(e),name:Be(e),online:$e(e)}),xt=Fe(Et),_t=ze((e=>({data:wt(e),chans:ft(e)}))),Ut=e=>({id:Ke(e),action:Oe(e),chatid:Ke(e),txt:mt(e)}),At=Fe(Ut),Tt=Fe((e=>({id:Ke(e),action:Oe(e),chanid:Ke(e),name:mt(e),about:mt(e),md:bt(e)}))),Mt=Fe((e=>({id:Ke(e),action:Oe(e),chanid:Ke(e),by:Ke(e)}))),Dt=Fe((e=>({chanid:Ke(e),users:xt(e)}))),Lt=e=>({email:mt(e),fullname:mt(e),about:mt(e)}),Pt=e=>({fr:pt(e),to:pt(e),offer:vt(e),sd:wt(e),ca:yt(e)}),It=e=>({txt:Be(e)}),Ot=e=>({st:mt(e),tz:mt(e)}),jt=e=>{switch(je(e)){case 0:return be.Shin((e=>({chats:Ct(e),chans:St(e),users:xt(e)}))(e));case 1:return be.Shan(ft(e));case 2:return be.Tree(St(e));case 3:return be.Treeid(ft(e));case 4:return be.Chats(Ct(e));case 5:return be.Chans(St(e));case 6:return be.Users(xt(e));case 7:return be.Chat(kt(e));case 8:return be.Login(_t(e));case 9:return be.MuteChan(pt(e));case 10:return be.UnmuteChan(pt(e));case 11:return be.DelChan(Ke(e));case 12:return be.Update(Ut(e));case 13:return be.Updates(At(e));case 14:return be.ChanUpdates(Tt(e));case 15:return be.MemUpdates(Mt(e));case 16:return be.On(Et(e));case 17:return be.Ons(ft(e));case 18:return be.Mems(Dt(e));case 19:return be.Err(Oe(e));case 20:return be.NewChan(Ke(e));case 21:return be.FindUsers(xt(e));case 22:return be.FindMems(xt(e));case 23:return be.Logout($e(e));case 24:return be.AddMems($e(e));case 25:return be.Unpack(mt(e));case 26:return be.Profile(Lt(e));case 27:return be.Pwd(gt(e));case 28:return be.Name(mt(e));case 29:return be.Signup(Oe(e));case 30:return be.Typing((e=>({by:pt(e),dir:ft(e),key:mt(e),keyCode:bt(e),anchor:Oe(e),focus:Oe(e),txt:mt(e),chname:mt(e),re:pt(e)}))(e));case 31:return be.Status(Ot(e));case 32:return be.ChatThread(ft(e));case 33:return be.ChatList(ft(e));case 34:return be.Sdp(Pt(e))}throw new Error("bad variant index for Response")};let Nt=ke(new ArrayBuffer(512));const Kt=(e,t)=>(Nt.pos=0,Nt=t(Nt,e),new Uint8Array(Nt.view.buffer).slice(0,Nt.pos)),$t=(e,t)=>t(ke(e)),zt=e=>$t(e.buffer,jt),Ft=e=>Kt(e,dt),Rt=e=>Kt(e,ct),Bt=e=>$t(e.buffer,It),qt=e=>new Zlib.RawInflate(e).decompress(),Ht=e=>new Zlib.RawDeflate(e).compress();async function Vt(e,t){let n=new Uint8Array(e),a=n.length,{z:r,c:i,d:s}=de();if(s){let e=n.subarray(0,12);n=new Uint8Array(await u(n.subarray(12),me.sskey,e)),K(n,e)}if(i){let e=n.subarray(0,12);n=new Uint8Array(await u(n.subarray(12),t,e)),K(n,e)}return r&&(n=qt(n)),(100*a/n.length).toFixed(2),function(e){return zt(e)}(n)}const Wt=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),Yt=Wt?Wt.groups?.ip:"mx.hyze.io:9898",Xt=e();let Gt,Zt,Jt;performance.now();let Qt=!1,en=500,tn=0,nn=e=>{},an={recv:e=>nn=e,send:async function(e){await Xt.join(),Gt.send(await async function(e,t){let n=Ft(e);((e,t)=>{e.length||e.byteLength})(n);let{z:a,c:r,d:i}=de();if(a&&(n=Ht(n)),r){const e=crypto.getRandomValues(new Uint8Array(12));K(n,e),n=H(e,new Uint8Array(await c(n,t,e)))}if(i){const e=crypto.getRandomValues(new Uint8Array(12));K(n,e),n=H(e,new Uint8Array(await c(n,me.sskey,e)))}return performance.now(),n}(e,Jt))}};function rn(){var e,t;Qt=!0,tn++,en+=(e=0,t=tn<16?200:3e3,e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),setTimeout(sn,en)}async function sn(){const e=await async function(){return await(async(e,t)=>{let[n,a]=await Promise.all([e(),t()]);return a?F(n,a):V(n,64,24)})((async()=>{Zt=await o();let e=await crypto.subtle.exportKey("raw",Zt.publicKey);return new Uint8Array(e)}),he)}();Gt=new WebSocket(`wss://${Yt}`),Gt.binaryType="arraybuffer",Gt.onopen=async()=>{Gt.send(e)},Gt.onmessage=ln,Gt.onerror=console.error,Gt.onclose=rn}async function ln({data:e}){let t=new Uint8Array(e),n=(de((e=>{const t=new L(e);return{z:t.get(0),c:t.get(1),d:t.get(2)}})(t)),await l(t.slice(1)));Jt=await s(Zt.privateKey,n),Gt.onmessage=on,Xt.complete(),Qt&&ce("reconnected"),Qt=!1}async function on({data:e}){nn(await Vt(e,Jt))}sn();function cn(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),a=new Uint8Array(n.length);for(let e=0;e<n.length;++e)a[e]=n.charCodeAt(e);return a}async function un(){let e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(t){let e=JSON.parse(JSON.stringify(t)),n=await se("s");if(n instanceof ArrayBuffer&&(new TextDecoder).decode(n)==e.keys.auth)return;ie("s",(new TextEncoder).encode(e.keys.auth).buffer),ce("subs",e)}else navigator.serviceWorker.getRegistration().then((e=>{e?.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:cn("BIm2PpzmeMy3pe_VkzyP8Yq-iqG8ay0qLBGcJZNXnq5lOKu1fAyY9xQ2PK2KQjzWulmKu8IzBLmut276h4tIw5k")}).then((e=>{}),(e=>{}))}))}async function dn(e,n,a){let r=await t.join();if(!r)return;let i=r.transaction(["_r"],"readwrite").objectStore("_r"),s=i.get(e);s.onerror=console.error,s.onsuccess=async()=>{if(s.result){if(a)return i.put([s.result[0],s.result[1],a],e).onerror=console.error;n[0]<s.result[0]&&(n[0]=s.result[0]),n[1]>s.result[0]&&(n[1]=s.result[1])}i.put(n,e).onerror=console.error}}function fn(e){return ae(e,"_r")}async function mn(){let e=await t.join();e&&n.forEach((t=>e.transaction([t],"readwrite").objectStore(t).clear()))}async function hn(...e){let n=await t.join();n&&(await pn(...e),function(e){let t=n.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);t.delete(n).onerror=console.error}))}(e),function(e){let t=n.transaction(["_t"],"readwrite").objectStore("_t"),a=t.index("chanid");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);a.openCursor(n).onsuccess=e=>{var n=e.target.result;n&&(t.delete(n.primaryKey).onerror=console.error,n.continue())}}))}(e.filter((e=>e>0))))}async function pn(...e){return async function(e,...n){let a=await t.join();if(!a)return;let r=a.transaction([e],"readwrite").objectStore(e);n.forEach((e=>r.delete(e).onerror=console.error))}("_r",...e)}"serviceWorker"in navigator&&(navigator.serviceWorker.register("sw.js").then((()=>{})),navigator.serviceWorker.addEventListener("message",(function(e){e.data.reload&&location.reload()}),!1));const vn="0VMZYpdgCGL3iKAzDHwocTt97e1hasO2mJNjExq4PvR6XyWSFbIn-5B_8fUukQlr",yn=vn.split(""),wn=new Array(123);for(let e=0;e<vn.length;e++)wn[vn.charCodeAt(e)]=e;const gn=e=>{if(e<0)return`-${gn(-e)}`;let t=e>>>0,n=e/4294967296>>>0,a="";for(;n>0;)a=yn[63&t]+a,t>>>=6,t|=(63&n)<<26,n>>>=6;let r="";do{r=yn[63&t]+r,t>>>=6}while(t>0);return r+a};var bn={ntob:gn,bton:e=>{let t=0;for(let n=0;n<e.length;n++)t=64*t+wn[e.charCodeAt(n)];return t}};const kn={i:0,mom:null,fullname:"⛩",id:0},Cn=(()=>{const e=m(kn),t=m([kn]),n=n=>{let a=t();a[n.i]!==n&&(a[n.i]=n),a.splice(n.i+1),t(a),e(n),location.hash=n.i>0?bn.ntob(n.id):""};return{path:()=>e(),i:()=>e().i,id:()=>e().id,paths:t,len:()=>t().length,same:t=>t===e(),cd:n,update:n=>{t([kn,...n]),e(n[n.length-1]||kn)},ishome:()=>e()===kn,home:()=>n(kn)}})();async function Sn(e,n,a,r,i,s,l="prev"){let o=await t.join();if(!o)return[];performance.now();let c=[],u=o.transaction([e],"readonly").objectStore(e),{store:d,bound:f}=n?n(u,a,i,s):{store:u,bound:null},m=0;return new Promise((e=>{d.openCursor(f,l).onsuccess=t=>{var n=t.target.result;if(n){if(c.push(n.value),r&&++m===r)return e(c);n.continue()}else e(c)}}))}async function En(e,t,n=30,a=!0){let r={value:e};return(await Sn("_c",_n,r,n,t,a,"prev")).map((e=>e.chatid))}function xn(e,t,n,a){let r=n?IDBKeyRange.upperBound(n,a):null;if(!t)return{store:e,bound:r};let i=n||Number.MAX_VALUE,s=e.index("room");return r=IDBKeyRange.bound([t.value],[t.value,i],!1,a),{store:s,bound:r}}function _n(e,t,n,a){let r=n?IDBKeyRange.upperBound(n,a):null;if(!t)return{store:e,bound:r};let i=n||Number.MAX_VALUE;return r=IDBKeyRange.bound([t.value],[t.value,i],!1,a),{store:e,bound:r}}const Un=(()=>{let e={},t={};return{create:(n,a)=>t[n]=new Promise((t=>e[n]=t)),complete:(t,n)=>e[t]?e[t](n):null,join:e=>t[e],joinall:(...e)=>Promise.all(e.map((e=>t[e]))),select:(...e)=>Promise.race(e.map((e=>t[e])))}})(),An=30,Tn=k(),Mn=k(),Dn=m(0),Ln=m(0),Pn=m(0),In=m(0),On=m(""),jn=m(""),Nn=m(null),Kn=m(!1),$n=m(!1),zn=b(new Map),Fn=b(new Map),Rn=b(new Map),Bn={id:0,childids:k(),childs:b(new Map),open:()=>!0},qn=b(new Map([[0,Bn]])),Hn=m([]),Vn=k(),Wn=k(),Yn=k(),Xn=k(),Gn=m(0),Zn=m(null),Jn=m(!1),Qn=m(""),ea=m(!1),ta=k(),na=k(),aa=k(),ra=m(!0),ia=m(!1),sa=m(!1),la=m(0),oa=m(0),ca=m(0),ua=m(null),da=m(location.hash.substr(1)),fa=m(0),ma=k(),ha=b(new Map),pa=k(),va=k();let ya={cb:null};const wa=()=>j("tp"),ga=()=>j("pm"),ba=()=>j("mb"),ka=()=>!(In()||Dn()||ea()||Jn()),Ca=()=>Mn.last()??0;function Sa(){if(!j("cs"))return;let e=window.innerHeight-j("cs").offsetHeight-(me.id()?96:64)-(ea()&&Jn()?56:ea()?32:Jn()?24:0);j("cs").childElementCount>2&&(e-=5),j("os").style.height=e>0?e+"px":"0"}window.onresize=Sa;const Ea=async(e,t)=>{await xa(e);let n=e[0],a=new Set,r=new Set,i="re"===t?new Set:new Set(Mn());switch(e=e.filter((e=>{let t=Fn(e);if(!t)return!1;Rn.has(t.by)||a.add(t.by),t.men&&t.men.forEach((e=>{Rn.has(e)||a.add(e)})),t.dir.forEach((e=>{zn.has(e)||r.add(e)}));let n=i.has(e);return i.add(e),!n})),await Ua(a,r),e.reverse(),t){case"re":Mn(e);break;case"pre":Mn.append(e);break;default:Mn.prepend(e)}(function(){let e=[];for(let t=0;t<Mn.len();t++){let n=Fn(Mn.at(t-1)??0),a=Mn.at(t),r=Fn(a);r.first(!1),r.showby(r.by!==n?.by),r.firstre(null!==r.re&&r.re!==n?.re&&r.re!=n?.id),ne(r.timestamp,n?.timestamp)?r.chanid!=n?.chanid?(e.push(m([a])),r.first(!0)):e[e.length-1]().push(a):(e.push(m(r.timestamp)),e.push(m([a])),r.first(!0))}va(e)})(),Sa(),n&&j(bn.ntob(n)+"_")?.scrollIntoView()},xa=async e=>{let t=(e=await _a(e)).map((e=>Fn(e)?.re)).filter((e=>e&&e>0&&!Fn.has(e)));_a(Array.from(new Set(t)))},_a=async e=>{if(0===(e=e.filter((e=>!Fn.has(e)))).length)return e;let{value:t,missed:n}=await re("_t",e);if(S(t,Fn()),n.length>0){let e=await Un.create("chats",an.send(ge.Chats(n)));S(e,Fn(),!0)}return e},Ua=async(e,t)=>{let n=await re("_e",Array.from(e)),a=await re("_h",Array.from(t));n.value.length&&an.send(ge.Ons(n.value.filter((e=>e.id!=me.id())).map((e=>e.id)))),E(n.value,Rn()),x(a.value,zn()),n.missed.length>0&&Un.create("users",an.send(ge.Users(n.missed))),a.missed.length>0&&Un.create("chans",an.send(ge.Chans(a.missed)));let[r,i]=await Un.joinall("users","chans");r&&E(r,Rn()),i&&x(i,zn())},Aa=async e=>{let t=Nn()||null,n=Dn();performance.now();let a=await fn(n)||[];if(a[2]&&e===a[1])return void Kn(!0);if(Kn(!1),!t){let t=await En(n,e,An);if(a[2]||t.length===An)return void await Ea(t)}let r=await((e=null,t=null,n=null)=>{let a=ge.Shin({chanid:Dn(),kw:e,ub:t,lb:n,lu:null,cu:null,mu:null});return Un.create("chatscan",an.send(a))})(t,e);r.length>0&&await Ea(r)};async function Ta(e=null){ya.cb=null,Kn(!1),Pn(0);let t=Dn();performance.now();let n,a=await fn(t)||[],r=e?null:a[0]||null,i=await En(t,n,An);await Ea(i,"re"),ya.cb=Aa;let s={id:await ae(t,"_u")||0,lo:a[1]||0},l=await ae(t,"_d")||null,o=await ae(t,"_m")||null,c=await Ma(s,l,o,e,n,r)||[];await Ea(c,c.length!==An&&0!==i.length&&r?"pre":"re")}const Ma=(e=null,t=null,n=null,a=null,r=null,i=null)=>{let s=ge.Shin({chanid:Dn(),kw:a,ub:r,lb:i,lu:e,cu:t,mu:n});return Un.create("chatscan",an.send(s))},Da=(e=null)=>{Nn(e),Ta(e)};async function La(e){ya.cb=null;let t=await Un.create("thread",an.send(ge.ChatThread({i:e,kw:null,ub:null,lb:null})));await Ea(t,"re"),ya.cb=t=>async function(e,t){let n=await Un.create("thread",an.send(ge.ChatThread({i:e,kw:null,ub:t,lb:null})));return Ea(n)}(e,t)}async function Pa(e){ya.cb=null;let t=await Un.create("list",an.send(ge.ChatList({i:e,kw:null,ub:null,lb:null})));await Ea(t,"re"),ya.cb=t=>async function(e,t){let n=await Un.create("list",an.send(ge.ChatList({i:e,kw:null,ub:t,lb:null})));return Ea(n)}(e,t)}const Ia=e=>{let t=e.map(((e,t)=>{let{mom:n,fullname:a}=zn(e);return{i:t+1,mom:n,fullname:a,id:e}}));Cn.update(t)},Oa=async e=>{if(0===(e=e.filter((e=>!zn.has(e)))).length)return;let{value:t,missed:n}=await re("_h",e);if(x(t,zn()),n.length>0){let e=await Un.create("chans",an.send(ge.Chans(n)));x(e,zn())}};async function ja(e=null,t=null){if(0===Bn.childids.len()||e){performance.now();let n=t?[]:await async function(){let e=await Sn("_h",(e=>({store:e.index("chatid"),bound:null})));return x(e,zn()),e.map((e=>e.id))}();n.length<1&&(n=await async function(e=null,t=null){return t&&jn(t),Un.create("scantree",an.send(ge.Tree({kw:t,reload:e})))}(e,t)),Ka(n)}}const Na=async(e,t=null,n=null)=>{performance.now(),ja(null,t);let a=await ae(e,"_d")||null,r=await ae(e,"_m")||null,i=await((e,t=null,n=null,a=null,r=null,i=null)=>{a&&jn(a);let s=ge.Shan({chanid:e,kw:a,ub:r,lb:i,cu:t,mu:n});return Un.create("chanscan",an.send(s))})(e,a,r,t,n);n?0===i.length||Tn.append(i):(0!==i.length||t||ce("nochan"),Tn(i));let s=$a(e);s&&(za(Tn(),s.childs()),s.childids(Tn()))};function Ka(e,t=0){const n=e.filter((e=>zn(e)?.mom==t));let a=$a(t);a&&((Dn()==t||Dn()&&zn(Dn())&&zn(Dn())?.dir.includes(t))&&a.open(!0),za(n,a.childs()),a.childids(n));for(const t of n)Ka(e,t)}function $a(e){let t=e&&zn(e)?[0,...zn(e)?.dir??[],e]:[0],n=qn();var a,r;for(r=0;r<t.length;r++){let e=t[r];n.has(e)&&(a=n.get(e),n=a.childs())}return a}function za(e,t){return e.reduce(((e,t)=>(e.has(t)||e.set(t,{id:t,childids:k(),childs:b(new Map),open:m(!1)}),e)),t)}const Fa=(e=null)=>Na(Cn.id(),e);const Ra=async({id:e,mom:t,fullname:n})=>{e!==Dn()&&Cn.cd({i:Cn.i()+1,mom:t,fullname:n,id:e})},Ba=async e=>{an.send(ge.MuteChan(e))},qa=async e=>{an.send(ge.UnmuteChan(e))};async function Ha(e){Tn.delete(e),zn.delete(e);let n=await ae(e,"_h");return n&&await async function({id:e,dir:n}){let a=await t.join();if(!a)return;let r=[0,...n,e];!function(e){e.forEach((async e=>{pn(e)}))}(r),function(e){let t=a.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);t.delete(n).onerror=console.error}))}(r)}(n),n}async function Va(e){let t=e.filter((e=>!Rn.has(e)));if(t.length){let{value:e,missed:n}=await re("_e",t);if(E(e,Rn()),n.length>0){let e=await Un.create("users",an.send(ge.Users(n)));e&&E(e,Rn())}an.send(ge.Ons(t.filter((e=>e!=me.id()))))}}async function Wa(e){if(!e)return void Hn([]);let t=zn(e)?.md()??1?[...zn(e)?.dir??[],e]:[e],{value:n,missed:a}=await re("_n",t),r=[];if(a.length){let e=await Un.create("memlist",an.send(ge.Mems(a)));for(const t of e){E(t.users,Rn()),U("_e",t.users);let e=t.users.map((e=>e.id));A("_n",t.chanid,e),r=[...r,...e]}}let i=Array.from(new Set([...n.flat(),...r]));await Va(i),i.sort((e=>Rn(e)?.online()?-1:0)),Hn(i)}async function Ya(e){let t=await Un.create("findmems",an.send(ge.FindMems({chanid:In()||Dn(),kw:e})));Xn(t);let n=t.find((t=>t.name===e));if(n)Gn(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));Gn(n?t.indexOf(n):0)}return t.length}function Xa(){const e=me.id();let t=Rn(e);t?t.online(!0):Rn.set(e,{id:e,name:me.name(),online:m(!0),tz:m(Z()),st:m("")})}const Ga=e=>{In()!==e?In(e):In(0),Wa(In()||Dn()),Pn(0)};oe("reconnected",(()=>{Ta(),Na(Cn.id())})),oe("config",(async({d:e})=>{e?(Xa(),un()):me.id()&&(In(0),Rn(me.id())&&Rn(me.id())?.online(!1),me.id(0),me.name(""),me.chans([]),delete me.sskey,me.salt=new Uint8Array,await mn(),Bn.childids([]),Cn.ishome()?(Ta(),ja()):Cn.home())})),oe("subs",(function(e){an.send(ge.PushSubs({endpoint:e.endpoint,auth:e.keys.auth,p256dh:e.keys.p256dh}))}));const Za=m(null),Ja=m(!1);function Qa(e){Za(e),Ja(!0)}function er(){Ja(!1)}const tr=()=>{switch(ca()){case 1:return"please login first";case 2:return"invalid login name or password";case 3:return"email existed";case 4:return"username existed";case 5:return"please select a topic";case 6:return"topic is empty";case 7:return"invalid email address";case 8:return"error adding people";case 9:return"error signing up";case 10:return"invalid name";case 11:return"invalid input";case 12:return"password too short";case 13:return"invalid password";case 14:return"new password is the same with old password";case 15:return"peer offline";case 16:return"You are behind a NAT or firewall, can not create a direct connection to peer"}};function nr(...e){return e.includes(ca())}let ar;const rr=e=>{ca(e),clearTimeout(ar),ar=setTimeout((()=>ca(0)),5e3)},ir=e=>{ua(e),clearTimeout(ar),ar=setTimeout((()=>ua(null)),5e3)};async function sr(e,t,n){zn.clear(),Fn.clear(),Rn.clear(),Hn([]),await mn();const a=crypto.getRandomValues(new Uint8Array(12)),r=await ve(n,a);let i=await pe(t,e),s={name:e,key:H(a,new Uint8Array(await c(i,r,a))),tz:Z()};fe(i),an.send(ge.Login(s))}async function lr(e,t,n,a=null){const r=crypto.getRandomValues(new Uint8Array(12)),i=await ve(t,r);let s=a?new Uint8Array(await pe(a,e)):null,l=await pe(n,e),o=H(r,new Uint8Array(await c(l,i,r)));return fe(l),Un.create("pwd",an.send(ge.Pwd({key:o,okey:s})))}function or(e,...t){let n=e(...t);return!n||rr(n)}async function cr(e){return an.send(ge.Au(e)),ir("a secret 6-digits otp code has been sent to your registered email"),await Un.create("enterotp",function(){let e=[...Array(6)].map((()=>g("input",{class:"ot",type:"tel",autocomplete:"chrome-off"}))),t=e[0];t.addEventListener("input",n),setTimeout((()=>t.focus()));for(let t=0;t<e.length;t++){let a=e[t];a.addEventListener("keypress",(function(n){n.keyCode>47&&n.keyCode<58&&(a.value=n.key,t!==e.length-1&&e[t+1].focus()),n.preventDefault()})),a.addEventListener("keydown",(function(n){"Backspace"===n.key&&(a.value="",0!==t&&e[t-1].focus())})),a.addEventListener("keyup",(function(t){if(16===t.keyCode||9==t.keyCode||224==t.keyCode||18==t.keyCode||17==t.keyCode)return;t.target.value.length>1&&n(t);let a=e.map((e=>e.value)).join("");a.length===e.length&&Un.complete("enterotp",a)}))}function n(e){let t=e.data||e.target.value;t&&1!==t.length&&a(e.target,t)}function a(e,t){e.focus(),e.value=t[0],t=t.substring(1),e.nextElementSibling&&t.length&&a(e.nextElementSibling,t)}Qa(g("div",{class:"pi"},g("div",{class:"su otp"},g("div",{class:"head"},"Enter OTP code"),g("div",{class:"sub"},"Please enter the 6-digits code sent to your email"),g("div",{id:"otp"},e))))}())}const ur=new Map;function dr(){Qa(g("div",{class:"pi"},g("div",{class:"su"},g("div",{class:"head"},"Sign up"),g("div",{class:"sub"},"We will send a sign up invitation to your email"),g("form",{onSubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();if(Y(n)){let e=await Un.create("signup",an.send(ge.Signup(n)));if(e)return rr(e);ir(`an invite code has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),er()}else rr(7)}},(()=>nr(3,7)&&g("div",{class:"erm"},tr())),g("input",{type:"text",name:"m",placeholder:"Your email address",onKeyPress:J,onKeyUp:ee,required:!0,autocomplete:"on",class:()=>nr(3,7)?"er":""}),g("div",{class:"bn"},g("button",{type:"submit"},"Sign up"))))))}function fr(e,t){const n=m("Log in Telegram");let a={};Qa(g("div",{class:"pi"},g("div",{class:"su"},g("div",{class:"head"},"Sign up"),g("div",{class:"sub"},e),g("form",{onSubmit:function(e){e.preventDefault();let{n:n,p:r}=e.target,i=n.value.trim();or(X,i)&&or(te,r.value)&&async function(e,t,n,a,r){await mn();const i=crypto.getRandomValues(new Uint8Array(12)),s=await ve(a,i);let l=await pe(n,t),o={name:t,key:H(i,new Uint8Array(await c(l,s,i))),tz:Z(),tgid:r.id||null,tgname:r.username||null,tgfn:r.first_name||null,tgln:r.last_name||null};fe(l),an.send(ge.NewUser(o))}(0,i,r.value,t,a)}},(()=>nr(4,10,12)&&g("div",{class:"erm"},tr())),g("input",{id:"username",type:"text",name:"n",placeholder:"Username",onKeyPress:Q,onKeyUp:ee,required:!0,autocomplete:"on",class:()=>nr(4,10)?"er":""}),g("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>nr(12)?"er":""}),g("script",{async:!0,src:"https://telegram.org/js/telegram-widget.js?15"}),g("div",null,g("button",{onClick:function(e){e.preventDefault(),Telegram.Login.auth({bot_id:"1850607378",request_access:!0},(e=>{e&&(j("username").value=e.username,n("Log in as "+e.first_name),a=e)}))}},n)),g("div",{class:"bn"},g("button",{type:"submit"},"Sign up"))))))}function mr(){Qa(g("div",{class:"pi"},g("div",{class:"su"},g("div",{class:"head"},"Log in"),g("div",{class:"sub"}),g("form",{onSubmit:async function(e){e.preventDefault();let{m:t,p:n}=e.target,a=t.value.trim();if(Y(a))return async function(e,t){let n=ur.has(e)?ur.get(e):await Un.create("name",an.send(ge.Email(e)));if(ur.set(e,n),!n)return rr(2);sr(n,t,await cr(n))}(a,n.value);if(or(X,a)){let e=await cr(a);sr(a,n.value,e)}}},(()=>nr(7,10)&&g("div",{class:"erm"},tr())),g("input",{type:"text",name:"m",placeholder:"Username or email",onKeyPress:J,onKeyUp:ee,required:!0,autocomplete:"on",class:()=>nr(7,10)?"er":""}),g("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on"}),g("div",{class:"lf fp"},g("a",{onClick:hr},"Forgot password")),g("div",{class:"bn"},g("button",{type:"submit"},"Log in"))))))}function hr(){Qa(g("div",{class:"pi"},g("div",{class:"su"},g("div",{class:"head"},"Forgot password"),g("div",{class:"sub"},"We will send a password reset link to your email"),g("form",{onSubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();Y(n)?(Un.create("forgotpwd",an.send(ge.Fp(n))),ir(`a password reset link has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),er()):rr(7)}},(()=>nr(7)&&g("div",{class:"erm"},tr())),g("input",{type:"text",name:"m",placeholder:"Your email address",onKeyPress:J,onKeyUp:ee,required:!0,autocomplete:"on",class:()=>nr(7)?"er":""}),g("div",{class:"bn"},g("button",{type:"submit"},"Submit"))))))}const pr=[];function vr(){!function(e){for(const t of pr)t(e)}(document.location.hash.substr(1))}window.addEventListener("hashchange",vr),setTimeout(vr);let yr=[];async function wr(){const e=await o(),t=await crypto.subtle.exportKey("raw",e.publicKey);return{keypair:e,pub:new Uint8Array(t)}}async function gr(e){let t=Un.create("ice"),n=await br(e),a=await n.createOffer();await n.setLocalDescription(a);let r=Ht((new TextEncoder).encode(n.localDescription?.sdp)),{keypair:i,pub:o}=await wr();r=$(r,o),await t;let c=await Un.create("offer",an.send(ge.Sdp({fr:null,to:e,sd:r,ca:yr,offer:!0}))),{a:u,k:d}=z(new Uint8Array(c.sd)),f=await l(d);n.sharedkey=await s(i.privateKey,f);let m=(new TextDecoder).decode(qt(u));n.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:m}));for(const e of c.ca){const t=new RTCIceCandidate({candidate:e,sdpMid:"0",sdpMLineIndex:0});await n.addIceCandidate(t)}}async function br(e){await Va([e]);let t=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});ha.has(e)||ma.add(e),ha.set(e,t),t.onicecandidate=e=>{e.candidate?yr.push(e.candidate.candidate):Un.complete("ice",yr)},t.onconnectionstatechange=()=>{t.connectionState};let n=t.createDataChannel("p",{negotiated:!0,id:1});return n.binaryType="arraybuffer",n.onopen=e=>{},n.onmessage=async({data:n})=>{let a=G(),r=new Uint8Array(n),i=r.subarray(0,12);r=new Uint8Array(await u(r.subarray(12),t.sharedkey,i)),K(r,i);let s={id:0,txt:Bt(qt(r)).txt,by:e,ts:new Date,room:e,showby:!1};pa.last()?.by!=e&&(s.showby=!0),s.id=await _("_p",s),fa()==e&&pa.add(s),a&&setTimeout(N),Sa()},n.onclose=t=>{var n,a;setTimeout((()=>{if(Rn(e)?.online())return gr(e)}),(n=1e3,a=5e3,Math.random()*(a-n)+n))},n.onerror=e=>{},t.send=async e=>{let a=Ht(Rt(e));const r=crypto.getRandomValues(new Uint8Array(12));K(a,r),a=H(r,new Uint8Array(await c(a,t.sharedkey,r))),n.send(a)},t.open=()=>"open"===n.readyState,t}async function kr(e){let t=await async function(e,t,n,a=!0){let r={value:e};return await Sn("_p",xn,r,n,t,a,"prev")}(e);pa(t.reverse())}async function Cr(e){if(Mn.has(e.id))return;let t=!zn(e.chanid),n=G();await _("_t",e),U("_c",(Dn()?e.dir:[0,...e.dir]).map((t=>(dn(t,[e.id,e.id]),{chanid:t,chatid:e.id}))));let a=new Set(Rn.has(e.by)?[]:[e.by]);e.men&&e.men.forEach((e=>{Rn.has(e)||a.add(e)}));let r=e.dir.filter((e=>!zn(e))),i=new Set(r);await Ua(a,i),e.re&&Sr(e.re),function(e){let t=Fn(Ca()),n=C(e);n.isnew=!0,Fn.set(n.id,n),Mn.add(n.id);let a=va();if(n.showby(n.by!==t?.by),n.firstre(null!==n.re&&n.re!==t?.re&&n.re!=t?.id),ne(n.timestamp,t?.timestamp))if(n.chanid!=t?.chanid)a.push(m([n.id])),va(a),n.first(!0);else{let e=va.last()??k(),t=e();t.push(n.id),e(t)}else a.push(m(n.timestamp)),a.push(m([n.id])),va(a),n.first(!0)}(e),t&&ja(!0),n&&N(),"ontouchstart"in document.documentElement||Sa(),e.dir.forEach((async e=>{let t=zn(e);t&&(t.chatid=t.id);let n=await ae(e,"_h");n&&(n.chatid=n.id,await _("_h",n))}))}(e=>{pr.push(e)})((async e=>{da(e),fa(0);let t=ma();if(me.id()>0&&(t=[...t,me.id()]),await Va(t),"%"===e[0])return location.hash="#"+bn.ntob(Number(e.slice(1)));if("$"===e[0]){let[t,n,a]=e.slice(1).split("/");if(n.length<50)return location.hash="#",er();let r=await Un.create("unpack",an.send(ge.Unpack(n)));if(!r)return location.hash="#",er();let i=await Un.create("name",an.send(ge.Email(r)));switch(t){case"i":if(!i)return fr(r,a),oe("login",(e=>e?location.hash="#":null));break;case"f":if(i&&(i==me.name()||!me.id()))return function(e,t,n){Qa(g("div",{class:"pi"},g("div",{class:"su"},g("div",{class:"head"},"Reset password"),g("div",{class:"sub"},t),g("form",{onSubmit:async function(t){t.preventDefault();let{p:a}=t.target;if(or(te,a.value)){let t=await lr(e,n,a.value);if(t)return rr(t);ir("password updated"),er(),location.hash="#"}}},(()=>nr(12)&&g("div",{class:"erm"},tr())),g("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>nr(12)?"er":""}),g("div",{class:"bn"},g("button",{type:"submit"},"Submit"))))))}(i,r,a)}return location.hash="#",er()}if("/"===e[0]){let t=bn.bton(e.slice(1));return Ln(t),Mn([]),La(t),Sa(),void await ja()}if("&"===e[0]){let t=bn.bton(e.slice(1));return t==me.id()?location.hash="#":(Dn(0),Ln(0),Wa(0),In(0),Ia([]),Mn([]),await Va([t]),fa(t),await kr(t),await ja(),!ha.has(t)&&Rn(t)?.online()&&gr(t),void setTimeout((()=>{Sa(),N()}),100))}let n=["!","@","*"].indexOf(e[0]);if(n>-1)return Dn(0),In(0),Ln(0),Mn([]),Pa(n),Sa(),void await ja();if(!e||!vn.includes(e[0]))return Dn(0),Ln(0),Wa(0),In(0),Ia([]),await ja(),Ta(),void(document.title="hyze - micro chat for team");let a=bn.bton(e);if(await ja(),Dn(a),In(0),Ln(0),Ta(),!zn(a))return;let r=zn(a)?.dir??[];Ia([...r,a]),Wa(a),document.title=zn(Dn())?.fullname()+" - hyze"}));const Sr=async e=>{const t=Fn(e);t&&t.nor(t.nor()+1);const n=await ae(e,"_t");n&&(n.nor=t?.nor()??null,await _("_t",n))};async function Er(e){(function(e){va().forEach((t=>{if(t()instanceof Array){let n=t(),a=n.indexOf(e);if(a<0)return;n.splice(a,1),t(n);let r=Fn(n[a-1]),i=Fn(n[a]);i?.first(!(a>0)||i.chanid!=r?.chanid),i?.showby(i.by!==r?.by),i?.firstre(null!==i.re&&i.re!==r?.re&&i.re!=r?.id)}}))})(e),Mn.delete(e),Fn.delete(e);let n=await ae(e,"_t");return n&&await async function({id:e,dir:n}){let a=await t.join();if(!a)return;let r=[0,...n];!function(e,t){t.forEach((async t=>{let n=await fn(t);n&&n.includes(e)&&pn(t)}))}(e,r),function(e,t){let n=a.transaction(["_c"],"readwrite").objectStore("_c");t.forEach((t=>{let a=IDBKeyRange.only([t,e]);n.delete(a).onerror=console.error}))}(e,r),function(...e){let t=a.transaction(["_t"],"readwrite").objectStore("_t");e.forEach((e=>{t.delete(e).onerror=console.error}))}(e)}(n),Sa(),n}async function xr(e,{action:t,chatid:n,txt:a}){switch(t){case 1:Fn(n)?.txt(a);let t=await ae(n,"_t");t&&(t.txt=a??"",await _("_t",t),t.dir.forEach((t=>e.add(t))));break;case 2:let r=await Er(n);r&&r.dir.forEach((t=>e.add(t)))}}function _r(e,t,n){const{root:a,subscribe:r,sample:i,cleanup:s}=v;null==n&&(n=!t.$t);let l=v.h([]),o=v.add(l,""),c=new Map,u=new Map,d=new Set;function f(e,r){if(null==e)return;let i=u.get(e);return 1===r?(d.delete(e),i||(i=n?a((n=>(c.set(e,n),t(e.$v||e)))):t(e.$v||e),11===i.nodeType&&(i=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let a=Array.from(t);return{nodeType:111,t:a[0],o:a[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(a[t++])}return e}}})(i)||i),u.set(e,i))):-1===r&&d.add(e),((e,t)=>111===e.nodeType?1/t<0?t?v.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(i,r)}function m(e){let t=c.get(e);t&&(t(),c.delete(e)),u.delete(e)}return s(r((t=>{let n=e();return i((()=>{d.clear();let e=Array.from(function(e,t,n,a,r){let i,s,l=new Map,o=new Map;for(i=0;i<t.length;i++)l.set(t[i],i);for(i=0;i<n.length;i++)o.set(n[i],i);for(i=s=0;i!==t.length||s!==n.length;){var c=t[i],u=n[s];if(null===c)i++;else if(n.length<=s)e.removeChild(a(t[i],-1)),i++;else if(t.length<=i)e.insertBefore(a(u,1),a(t[i],0)||r),s++;else if(c===u)i++,s++;else{var d=o.get(c),f=l.get(u);void 0===d?(e.removeChild(a(t[i],-1)),i++):void 0===f?(e.insertBefore(a(u,1),a(t[i],0)||r),s++):(e.insertBefore(a(t[f],1),a(t[i],0)||r),t[f]=null,f>i+1&&i++,s++)}}return n}(o.parentNode,t||[],n,f,o));return d.forEach(m),e}))}))),s((function(){c.forEach((e=>e())),c.clear(),u.clear(),d.clear()})),l}function Ur({id:e},t){if(!e||Pn()===e)return Pn(0);t.focus(),Pn(e)}an.recv((async({tag:e,value:t})=>{switch(e){case"Err":rr(t);break;case"Unpack":Un.complete("unpack",t);break;case"AddMems":Un.complete("addmems",t);break;case"Logout":de({d:!1});break;case"NewChan":In(t),N();break;case"Shin":let e=t;S(e.chats,Fn(),!0),E(e.users,Rn()),x(e.chans,zn()),U("_t",e.chats),U("_h",e.chans),U("_e",e.users),async function(e){let t=Dn();if(0===e.length)return Kn(!0),dn(t,[],!0),void Un.complete("chatscan",e);Kn(!1),dn(t,[e[0],e[e.length-1]]),U("_c",e.map((e=>({chanid:t,chatid:e})))),Un.complete("chatscan",e)}(e.chats.map((e=>e.id)));break;case"Update":{let e=t,n=new Set([Dn()]);xr(n,e),n.forEach((t=>A("_u",t,e.id)));break}case"Updates":let n=t;n.length&&async function(e){let t=new Set([Dn()]);for(const n of e)xr(t,n);t.forEach((t=>A("_u",t,e[e.length-1].id)))}(n);break;case"ChanUpdates":let a=t;a.length&&async function(e){let t=new Set([Dn()]);for(const{action:n,chanid:a,name:r,about:i,md:s}of e)switch(n){case 1:{let e=zn(a);e&&(null!==r&&e.fullname(r),null!==i&&e.about(i),null!==s&&e.md(s));let n=await ae(a,"_h");n&&(null!==r&&(n.fullname=r),null!==i&&(n.about=i),null!==s&&(n.md=s),await _("_h",n),n.dir.forEach((e=>t.add(e))));break}case 2:let e=await Ha(a);e&&e.dir.forEach((e=>t.add(e)))}t.forEach((t=>A("_d",t,e[e.length-1].id)))}(a);break;case"MemUpdates":let r=t;r.length&&async function(e){let t=new Set([Dn()]),n=new Map;for(const{action:t,chanid:a,by:r}of e)switch(t){case 1:n.has(a)?n.get(a).adds.push(r):n.set(a,{adds:[r],rms:[]});break;case 0:n.has(a)?n.get(a).rms.push(r):n.set(a,{adds:[],rms:[r]})}for(let[e,{adds:a,rms:r}]of n.entries()){let n=await ae(e,"_n");n&&(n=n.filter((e=>r.indexOf(e)<0)),A("_n",e,Array.from(new Set([...a,...n])))),t.add(e)}Wa(In()||Dn()),t.forEach((t=>A("_m",t,e[e.length-1].id)))}(r);break;case"Login":if(!t)return rr(2),fe(void 0),void ce("login",!1);await async function({data:e,chans:t}){var n;_("_e",await we(e)),(n={d:!0})&&(Object.assign(ue,n),ce("config",ue)),me.chans(t),ie("c",t)}(t),Xa(),ce("login",!0),er(),In(0),Bn.childids([]),Ta(),ja();break;case"Pwd":if(!t)return fe(void 0),void Un.complete("pwd",13);me.id()&&await we(t),Un.complete("pwd");break;case"Users":U("_e",t),Un.complete("users",t);break;case"Chans":U("_h",t),Un.complete("chans",t);break;case"Chat":Cr(t);break;case"Chats":let i=t;U("_t",i),Un.complete("chats",i);break;case"Shan":{let e=t;e.length>0?($n(!1),await Oa(e)):$n(!0),Un.complete("chanscan",e);break}case"Tree":let o=t;o.length>0&&(U("_h",o),x(o,zn())),Un.complete("scantree",o.map((e=>e.id)));break;case"Treeid":let c=t;c.length>0&&await Oa(c),Un.complete("scantree",t);break;case"MuteChan":{if(!t)return;let e=t,n=me.chans();if(n.includes(e))return;n.push(e),me.chans(n),await ie("c",n),await hn(0,e,...zn(e)?.dir??[]),Ta(),Na(Cn.id());break}case"UnmuteChan":{if(!t)return;let e=t,n=me.chans();if(!n.includes(e))return;const a=n.indexOf(e);a>-1&&n.splice(a,1),me.chans(n),await ie("c",n),await hn(0,e,...zn(e)?.dir??[]),Ta(),Na(Cn.id());break}case"DelChan":Ha(t);break;case"Mems":Un.complete("memlist",t);break;case"FindUsers":{let e=t;E(e,Rn()),U("_e",e),Un.complete("findusers",e);break}case"FindMems":{let e=t;E(e,Rn()),U("_e",e),Un.complete("findmems",e);break}case"On":{let{id:e,online:n}=t;if(!e)return;Rn(e)?.online(n);break}case"Ons":t.forEach((e=>Rn(e)?.online(!0)));break;case"Profile":Un.complete("profile",t);break;case"Name":Un.complete("name",t);break;case"Signup":Un.complete("signup",t);break;case"ChatThread":Un.complete("thread",t);break;case"ChatList":Un.complete("list",t);break;case"Status":Un.complete("status",t);break;case"Sdp":let u=t;u.offer?async function({fr:e,sd:t,ca:n}){let a=Un.create("ice"),r=await br(e),{a:i,k:o}=z(new Uint8Array(t)),{keypair:c,pub:u}=await wr(),d=await l(o);r.sharedkey=await s(c.privateKey,d);let f=(new TextDecoder).decode(qt(i));await r.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:f}));let m=await r.createAnswer();await r.setLocalDescription(m);for(const e of n){const t=new RTCIceCandidate({candidate:e,sdpMid:"0",sdpMLineIndex:0});await r.addIceCandidate(t)}let h=Ht((new TextEncoder).encode(r.localDescription?.sdp)),p=$(h,u);await a,an.send(ge.Sdp({fr:null,to:e,sd:p,ca:yr,offer:null}))}(u):Un.complete("offer",u)}}));const Ar=(e,t)=>{let n=j(e+"_")?.querySelector(".ct");if("true"===n.contentEditable)return n.contentEditable="false",n.classList.remove("ce"),n.innerHTML=t.txt(),void(n.onclick=()=>!1);n.spellcheck=!1,n.contentEditable="true",n.classList.add("ce"),n.focus(),n.onclick=e=>{"true"===n.contentEditable&&e.stopPropagation()},n.onkeydown=e=>{if("Tab"===e.key)return document.execCommand("insertHTML",!1,"&#09"),e.preventDefault();if("Escape"===e.key)return n.contentEditable="false",n.classList.remove("ce"),void(n.innerHTML=t.txt());if("Enter"===e.key){let i=n.innerHTML.trim();e.shiftKey||(e.preventDefault(),n.contentEditable="false",n.classList.remove("ce"),i!==t.txt()&&(a=t.id,r=i,an.send(ge.EditChat({id:a,txt:r}))))}var a,r}},Tr=(e,t)=>{const n=e=>{e.preventDefault(),e.stopPropagation();let n=G();Ur(t,ba()),Pn()===t.id?In(t.chanid):In(0),n&&setTimeout(N)};return g(Array.prototype,null,g("div",{class:"ts"},(a=t.timestamp,(r=(new Date).getTime()-a.getTime())<6e4?Math.round(r/1e3)+"s":r<36e5?Math.round(r/6e4)+"m":a.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{hour:"numeric",minute:"2-digit"}))),g("div",{class:"pm pr",title:"reply",onTouchEnd:n,onClick:n},g("i",null,"→"),g("div",{class:"pu"},g("div",null,"reply"))),g("div",{class:"pm",onClick:e=>e.stopPropagation()},g("i",{class:"i"},"..."),g("div",{class:"pu"},g("div",{onClick:()=>(async e=>{e.star(!e.star()),an.send(ge.Star(e.id));const t=await ae(e.id,"_t");t&&(t.star=e.star(),await _("_t",t))})(t)},"⭐ ",t.star()?"unstar":"star"),g("div",{onClick:()=>Ar(e,t)},"✏️ edit"),g("div",{onClick:()=>Mr(t)},"🗑️ trash"))));var a,r},Mr=({id:e,txt:t})=>{confirm('Do you want to delete this chat? \n"'+t()+'"')&&function(e){an.send(ge.DelChat(e)),Er(e)}(e)};var Dr="5cfd843",Lr="0.0.357";const Pr="formatBlock",Ir=(e,t)=>e.appendChild(t),Or=e=>document.createElement(e),jr=e=>document.queryCommandState(e),Nr=(e,t)=>document.execCommand(e,!1,t),Kr=[{icon:"<b>B</b>",title:"Bold",state:()=>jr("bold"),result:()=>Nr("bold")},{icon:"<i>I</i>",title:"Italic",state:()=>jr("italic"),result:()=>Nr("italic")},{icon:"<u>U</u>",title:"Underline",state:()=>jr("underline"),result:()=>Nr("underline")},{icon:"<strike>S</strike>",title:"Strike-through",state:()=>jr("strikeThrough"),result:()=>Nr("strikeThrough")},{icon:"&#8220&#8221;",title:"Quote",result:()=>Nr(Pr,"<blockquote>")},{icon:"&lt;&gt;",title:"Code",result:()=>Nr(Pr,"<pre>")},{icon:"&#128279;",title:"Link",class:" lk",result:()=>{const e=window.prompt("Enter the link URL");e&&Nr("createLink",e)}},{icon:"🌁",title:"Image",class:" im",result:()=>{const e=window.prompt("Enter the image URL");e&&Nr("insertImage",e)}},{icon:"⏎",title:"Enter to send",class:" en se",result:e=>(ra()?ra(!1):ra(!0),ra()?e.classList.add("se"):e.classList.remove("se"),!0)}],$r="e-b",zr="e-bs",Fr=g("div",{class:"e-a"});Kr.forEach((e=>{const t=Or("button");var n;t.className=$r+" eb",e.class&&(t.className+=e.class),t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=()=>e.result(t)&&ba().focus(),e.state&&("click",n=()=>t.classList[e.state()?"add":"remove"](zr),t.addEventListener("click",n)),Ir(Fr,t)}));const Rr=Or("button");function Br(){if(!me.id())return mr();let e=G();Rr.classList.add("se"),ea(!0),e&&setTimeout(N),Sa(),"ontouchstart"in document.documentElement||ga().focus()}Rr.className=$r+" md",Rr.innerHTML="👤",Rr.title="Private message",Rr.setAttribute("type","button"),Rr.onclick=()=>ea()?(Rr.classList.remove("se"),ea(!1),void Sa()):Br();const qr=Or("button");async function Hr({name:e}){let{fullname:t,about:n}=await Un.create("profile",an.send(ge.Profile));Qa(g("div",{class:"pi"},g("div",{class:"su"},g("div",{class:"head"},"Profile"),g("div",{class:"sub"},e),g("form",{onSubmit:e=>function(e){e.preventDefault();let{n:a}=e.target,r=a.value.trim()==t?null:a.value.trim(),i=j("ab")?.textContent?.trim()??null;i=i==(n||"")?null:i;let s=function(e,t){return e&&e.length<2?10:t&&t.length>1e3?11:0}(r,i);0===s?(function(e,t,n=null){an.send(ge.EditProfile({fullname:e,about:t,email:n}))}(r,i),er()):rr(s)}(e)},(()=>nr(10,11)&&g("div",{class:"erm"},tr())),g("input",{value:t??"",type:"text",name:"n",placeholder:"Full name",required:!0,class:()=>nr(10)?"er":""}),g("div",{id:"ab",class:"ab",contentEditable:!0},n),g("div",{class:"bn"},g("button",{type:"submit"},"Save"))))))}qr.className="ntb",qr.innerHTML="✏️ New Topic",qr.title="New topic",qr.setAttribute("type","button"),qr.onclick=()=>{if(!me.id())return mr();let e=G();var t,n;Jn()?Jn(!1):Jn(!0),e&&Jn()&&setTimeout(N),t=Jn(),Jn(t),Sa(),t?qr.classList.add("se"):qr.classList.remove("se"),"ontouchstart"in document.documentElement||(t&&wa().focus(),n&&(wa().innerText=n,Qn(n)))},Ir(Fr,qr),Ir(Fr,Rr),Nr("defaultParagraphSeparator","div");const Vr=async(e,t)=>{if(me.id()){if(e.stopPropagation(),!Rn(t)?.tz()){let{st:e,tz:n}=await async function(e){return Un.create("status",an.send(ge.Status(e)))}(t);me.id()==t&&(n=Z()),Rn(t).tz(n??""),Rn(t).st(e??"")}Qa(g("div",{class:"pi"},g("div",{class:"ui"},g("div",{class:"un"},g("i",{class:()=>"do"+(Rn(t)?.online()?" on":"")}),g("b",{style:()=>Rn(t)?.online()?"color:"+W(Rn(t)?.name):""},Rn(t)?.name)),t!==me.id()?g("div",{style:"font-size:12px"},Rn(t)?.st()):g("div",{class:"st",contentEditable:!0,onBlur:function(e){const{textContent:n}=e.target;if(n&&n.length>50)return rr(11);const a=Z(),r=n&&n.trim().length?n:null;Rn(t).tz(a),Rn(t).st(r??""),function(e){an.send(ge.EditStatus(e))}({tz:a,st:r})}},Rn(t)?.st)),g("hr",null),(()=>{return Rn(t)?.tz()?g("div",{class:"sub"},g("i",null,"🕑")," Local time ",(e=Rn(t)?.tz(),(new Date).toLocaleTimeString(Intl.DateTimeFormat().resolvedOptions().locale,{timeZone:e,hour:"numeric",minute:"2-digit"}))):null;var e}),t!==me.id()?g(Array.prototype,null,g("div",{class:"bt"},g("i",{class:"fl"},"💬")," ",g("a",{onClick:()=>function(e){er(),Br(),ta([e]),Pn(0)}(t)},"Send private message")),g("div",{class:"bt"},g("i",null,"@")," ",g("a",{onClick:()=>function(e){if(er(),!me.id())return mr();ba().innerHTML+=`@${Rn(e)?.name}`,ba().focus(),I(),aa.add(e)}(t)},"Mention ",g("b",null,Rn(t)?.name))),Rn(t)?.online()&&g("div",{class:"bt"},g("i",{class:"fl"},"↔"),g("a",{onClick:()=>{er(),location.hash="#&"+bn.ntob(t)}},"Send direct p2p message"))):g(Array.prototype,null,g("div",{class:"bt",onClick:()=>Hr(Rn(t))},g("i",null,"✏️")," ",g("a",null,"Edit profile")),g("div",{class:"bt",onClick:()=>function({name:e}){Qa(g("div",{class:"pi"},g("div",{class:"su"},g("div",{class:"head"},"Change Password"),g("div",{class:"sub"},e),g("form",{onSubmit:async function(t){t.preventDefault();let{o:n,p:a}=t.target;if(or(te,a.value,n.value)){let t=await cr(e),r=await lr(e,t,a.value,n.value);if(r)return rr(r);ir("password updated"),er()}}},(()=>nr(12,13,14)&&g("div",{class:"erm"},tr())),g("input",{type:"password",name:"o",placeholder:"Old password",required:!0,autocomplete:"true",class:()=>nr(13)?"er":""}),g("input",{type:"password",name:"p",placeholder:"New password",required:!0,autocomplete:"true",class:()=>nr(12,14)?"er":""}),g("div",{class:"bn"},g("button",{type:"submit"},"Submit"))))))}(Rn(t))},g("i",null,"🔒")," ",g("a",null,"Change password")),g("div",{class:"bt",onClick:()=>async function(){In(0),Hn([]),Rn(me.id())?.online(!1),zn.clear(),Fn.clear(),await an.send(ge.Logout(me.salt)),await mn(),de({d:!1}),er(),ce("logout")}()},g("i",null,"🚪")," ",g("a",null,"Sign out")),g("div",{class:"v"},Lr," ",Dr))))}};const Wr=m(0),Yr=m(0);let Xr=!1;const Gr=(e,t)=>{if(e.shiftKey)return((e,t)=>{let n=screen.width/2-300,a=screen.height/2-300;window.open(e,t,`toolbar=yes,location=yes,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=600,height=600,top=${a},left=${n}`)})("#"+bn.ntob(t),t.toString()),e.preventDefault();Ga(t),e.stopPropagation()};let Zr={keyword:"",caretpos:0,mouselock:!1},Jr=m(!1);const Qr=e=>{Zr.caretpos=O();let t=e.textContent,n=t.indexOf(" ",Zr.caretpos);-1==n&&(n=t.length);var a=/[\S]+$/.exec(t.slice(0,n));return a?a[0]:""},ei=({id:e,name:t})=>{Xn([]),Gn(0);let n=Zn();if(n.spellcheck=!1,n===ba()){let a=Zr.keyword?"@"+t:t;n.textContent=Zr.keyword?((e,t)=>{let n=e.textContent,a=n.indexOf(" ",Zr.caretpos);-1==a&&(a=n.length);var r=n.slice(0,a).replace(/\S+$/,t);return Zr.caretpos=r.length,r+n.slice(a)})(n,a):n.textContent+a,n.focus(),Zr.keyword?function(e,t){var n=document.createRange(),a=window.getSelection();n.setStart(e.childNodes[0],t),n.collapse(!0),a?.removeAllRanges(),a?.addRange(n)}(n,Zr.caretpos):I(),Jr(!1),e&&aa.add(e)}else e?ta.add(e):na.add(Zr.keyword),n.textContent="",ga().focus()},ti=g("div",{id:"uls",class:()=>"uls"+(Zn()===ba()&&ea()?" ms":"")},g("ul",null,_r(Xn,(e=>g("li",{id:e.id.toString(),tabIndex:-1,class:()=>Xn.at(Gn())===e?"se":"",onClick:()=>ei(e),onMouseOver:()=>Zr.mouselock||Gn(Xn.index(e))},e.id?g("i",{class:()=>"dot"+(Rn(e.id)?.online()?" on":"")}):null,e.name)))));function ni(e){return!(!Xn.len()||("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(ei(Xn.at(Gn())),e.preventDefault(),0):27==e.keyCode?(Xn([]),Gn(),Jr(!1),0):(38==e.keyCode&&(0===Gn()?Gn(Xn.len()-1):Gn(Gn()-1),j(Xn.at(Gn()).id)?.focus(),e.preventDefault(),Zr.mouselock=!0,setTimeout((()=>Zr.mouselock=!1),300)),40==e.keyCode&&(Gn()===Xn.len()-1?Gn(0):Gn(Gn()+1),j(Xn.at(Gn()).id)?.focus(),e.preventDefault(),Zr.mouselock=!0,setTimeout((()=>Zr.mouselock=!1),300)),e.target.focus(),0)))}const ai=P((e=>{Zr.keyword=Qr(e.target).toLowerCase(),Zr.keyword.startsWith("@")?(Zr.keyword=Zr.keyword.replace(/[@'";:,.\/?\\-]/,""),Zr.keyword.length>50||Ya(Zr.keyword)):Jr(!1)}),100),ri=g(Array.prototype,null,g("style",null,(()=>`.e-c[contenteditable]:empty::before { content: '${function(){let e,t=`Send a ${ea()?"private ":""}message `;return In()?e=zn(In()):Dn()&&(e=zn(Dn())),e?t+(Jn()?`on new topic ${Qn()?`"${Qn()}" `:""}in "${e.fullname()}"`:`in "${e.fullname()}"`):Jn()?t+"on new topic "+(Qn()?`"${Qn()}"`:""):t+"..."}()}'; }`)),(()=>Zn()===ba()&&Jr()&&Xn.len()>0&&ti),g("div",{id:"mb",class:"e-c",onKeyDown:function(e){if(Zn(ba()),"@"===e.key&&Jr(!0),!ni(e)&&"Enter"===e.key){if(e.preventDefault(),ra()&&!e.shiftKey)return void async function(e,t){if(!me.id())return rr(1);if(e.innerHTML.length>120)return rr(11);if(t.innerHTML.length>4e3)return rr(11);if(!t.innerHTML.trim())return;if(fa()){if(!Rn(fa())?.online())return rr(15);if(!ha(fa()).open())return rr(16);let e={txt:t.innerHTML.trim()};ha(fa()).send(e);let n={id:0,txt:e.txt,by:me.id(),ts:new Date,room:fa(),showby:!1};return pa.last()?.by!=me.id()&&(n.showby=!0),n.id=await _("_p",n),pa.add(n),t.textContent="",void Sa()}let n=In()||Dn(),a=Pn()||Ln()||null,r=null;if(e.textContent!==On()&&(r=e.textContent,!r?.trim().length))return rr(6);if(!(n||ea()||r&&r.trim().length))return rr(5);let i=t.innerHTML.trim(),s=null,l=null,o=null;ea()&&(ta.len()>0&&(s=ta.add(me.id()).sort(((e,t)=>e-t))),na.len()>0&&(l=na())),aa.len()>0&&(o=aa().filter((e=>i.indexOf("@"+Rn(e)?.name)>-1))),an.send(ge.NewChat({txt:i,chanid:n,re:a,chname:r,men:o,to:s,emails:l})),Jn(!1),ea(!1),e.textContent="",t.textContent="",Qn(""),On(""),Ur({},t)}(wa(),ba());e.target.textContent+="\n\n",I()}},onInput:function(e){ba().spellcheck=!1,Jr()&&ai(e)},onFocus:function(){if(0!==Mn.len())return ka()?(In(Fn(Ca()).chanid),void Wa(In())):In()||ea()||Jn()?void 0:(In(Fn(Ca()).chanid),void Wa(In()))},contentEditable:!0}));const ii=g("div",{class:()=>"em sel"+(ea()?" sh":""),onClick:()=>ga().focus()},_r(na,(e=>g("div",{class:"tg ie"},e,g("i",{onClick:()=>na.delete(e)},"✕")))),_r(ta,(e=>g("div",{class:()=>Rn(e)?.online()?"tg on":"tg"},Rn(e)?.name,g("i",{onClick:()=>ta.delete(e)},"✕")))),g("div",{class:"wp"},g("div",{id:"pm",class:"e-m"+(na.len()+ta.len()===0?" to":""),onKeyDown:function(e){if(!ni(e)){if(8!=e.keyCode||ga().textContent?.length||(ta.pop(),ga().focus()),32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1;"Enter"!==e.key&&"Tab"!==e.key||(ba().focus(),e.preventDefault())}},onInput:function(e){Zn(ga()),si(e)},contentEditable:!0}),(()=>Zn()===ga()&&ea()&&Xn.len()>0&&ti)));const si=P((async e=>{if(Zr.keyword=Qr(e.target).toLowerCase(),Zr.keyword.length>50)return;let t=await Ya(Zr.keyword),n=zn(In()||Dn()),a=void 0!==n&&(n.md()??0)<2;!t&&Y(Zr.keyword)&&a&&Xn([{id:0,name:`✉️ Invite ${Zr.keyword}`,online:!1}])}),100);const li=g("div",{id:"tp",class:()=>"e-t"+(Jn()?" sh":""),onKeyUp:function(e){Qn(e.target.textContent),"Enter"===e.key&&(ba().focus(),e.preventDefault())},onKeyDown:function(e){e.target.spellcheck=!1,"Enter"===e.key&&e.preventDefault()},contentEditable:!0});const oi=g("div",{class:()=>me.id()?ka()?"e ds":"e":"e hd"},(()=>Pn()>0&&g("div",{class:"re",style:()=>"color:"+W(Pn())},g("i",null,"→"),g("b",null,Rn(Fn(Pn()).by)?.name),g("a",{href:"#/"+bn.ntob(Pn())},Fn(Pn())?.txt))),(()=>{if(!me.id())return null;if(Ca()&&Fn(Ca())&&In()==Fn(Ca())?.chanid)return null;let e=zn(In());if(!e)return null;G()&&setTimeout(N,50);const t=()=>[...e.dir.slice(Cn.len()-2),e.id];return t().length>0&&g("div",{class:"dr",style:()=>"background:"+W(e.id)},_r(t,(e=>g("span",null,g("a",{href:"#"+bn.ntob(e)},zn(e)?.fullname)))))})," ",li," ",ii," ",ri," ",Fr),ci=g("div",null,g("div",{class:"tn"},g("div",{class:"dr",style:()=>"background:"+W(Rn(fa())?.name)},g("span",null,g("a",null,"↔ ",Rn(fa())?.name)))),_r(pa,(({by:e,txt:t,showby:n})=>Rn(e)?g("div",{class:"c",style:()=>"border-color:"+W(Rn(fa())?.name)},(()=>n&&g("div",null,g("a",{class:()=>"by"+(Rn(e)?.online()?" on":""),style:()=>Rn(e)?.online()?"color:"+W(Rn(e)?.name):"",onClick:t=>Vr(t,e)},Rn(e)?.name))),g("div",null,t)):g("div",null)))),ui=g("div",{id:"mod",class:"mod",onClick:()=>er()},g("div",{class:"pop",onClick:e=>e.stopPropagation()},Za)),di=[["","All messages"],["!","Private messages"],["@","Mentions"],["*","Stars"]];let fi="",mi=0,hi=!1;const pi=()=>{const e=P((async e=>{fi=(e=>{mi=O();let t=e.textContent,n=t.indexOf(" ",mi);-1==n&&(n=t.length);var a=/[\S]+$/.exec(t.slice(0,n));return a?a[0]:""})(e.target).toLowerCase(),fi&&fi.length>50||!await async function(e){let t=await Un.create("findusers",an.send(ge.FindUsers(e)));Yn(t);let n=t.find((t=>t.name===e));if(n)Gn(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));Gn(n?t.indexOf(n):0)}return t.length}(fi)&&Y(fi)&&Yn([{id:0,name:`✉️ Invite ${fi}`,online:!1}])}),100),t=g("div",{class:"am",contentEditable:!0,onKeyDown:function(e){Zn(t),function(e){return!(!Yn.len()||("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(n(Yn.at(Gn())),e.preventDefault(),0):27==e.keyCode?(Yn([]),Gn(),0):(38==e.keyCode&&(0===Gn()?Gn(Yn.len()-1):Gn(Gn()-1),j(Yn.at(Gn()).id)?.focus(),e.preventDefault(),hi=!0,setTimeout((()=>hi=!1),300)),40==e.keyCode&&(Gn()===Yn.len()-1?Gn(0):Gn(Gn()+1),j(Yn.at(Gn()).id)?.focus(),e.preventDefault(),hi=!0,setTimeout((()=>hi=!1),300)),e.target.focus(),0)))}(e)||(8!=e.keyCode||t.textContent.length||(Vn.pop(),t.focus()),(32===e.keyCode||/^[a-zA-Z0-9\_@\.]+$/.test(e.key))&&"Enter"!==e.key&&"Tab"!==e.key||e.preventDefault())},onInput:e});function n({id:e}){Yn([]),Gn(0),e?Vn.add(e):Wn.add(fi),t.textContent="",t.spellcheck=!1,t.focus()}const a=g("div",{class:"uls adm"},g("ul",null,_r(Yn,(e=>g("li",{id:e.id.toString(),tabIndex:-1,class:()=>Yn.at(Gn())===e?"se":"",onClick:()=>n(e),onMouseOver:()=>{return t=Yn.index(e),void(hi||Gn(t));var t}},e.id?g("i",{class:()=>(Rn(e.id)?.online()," on")}):null," ",e.name))))),r=g("div",{class:"sel",onClick:()=>t.focus()},_r(Wn,(e=>g("div",{class:"tg ie"},e,g("i",{onClick:()=>Wn.delete(e)},"✕")))),_r(Vn,(e=>g("div",{class:()=>Rn(e)?.online()?"tg on":"tg"},Rn(e)?.name,g("i",{onClick:()=>Vn.delete(e)},"✕")))),t,(()=>Zn()===t&&Yn.len()>0&&a));return r.focus=()=>t.focus(),r},vi=()=>{const e=["Public","Internal"],t=()=>In()?zn(In()):zn(Dn()),n=()=>t()?.by===me.id();function a(){let e=Vn.len()+Wn.len();return e>0?" "+e+(e>1?" people":" person"):""}const r=({id:e,fullname:t})=>{const n=pi();Qa(g("div",{class:"pi"},g("div",{class:"amb"},g("div",{class:"head"},"Add people"),g("div",{class:"sub"},t),n,g("div",{class:"bn"},g("button",{onClick:()=>(async(e,t)=>{let n=Vn.len()?Vn():null,r=Wn.len()?Wn():null;(n||r)&&(await(async(e,t,n)=>{let a=await Un.create("addmems",an.send(ge.AddMems({chanid:e,userids:t,emails:n})));return Wa(e),a})(e,n,r)?(ir(`added${a()} to ${t()}`),er()):rr(8))})(e,t)},"Add",a))))),n.focus()},i=t=>{Qa(g("div",{class:"pi"},g("div",{class:"su et"},g("div",{class:"head"},"About"),g("div",{class:"sub"},t.fullname),g("form",{onSubmit:e=>function(e,{id:t,fullname:n,about:a,md:r}){e.preventDefault();let{n:i,m:s}=e.target,l=i.value.trim()==n()?null:i.value.trim(),o=s&&Number(s.value)!=r()?Number(s.value):null,c=j("ab")?.textContent?.trim()??null;c=c==(a()||"")?null:c;let u=function(e,t,n){return e&&0===e.length?10:n&&(n>2||n<0)||t&&t.length>1e3?11:0}(l,c,o);var d;0===u?(d={id:t,name:l,about:c,md:o},an.send(ge.EditChan(d)),er()):rr(u)}(e,t)},(()=>nr(10,11)&&g("div",{class:"erm"},tr())),g("input",{value:t.fullname,type:"text",name:"n",placeholder:"topic name",required:!0,class:()=>nr(10)?"er":""}),g("div",{id:"ab",class:"ab",contentEditable:!0},t.about),1==me.id()&&(t?.md()??!0)&&g("select",{name:"m"},e.map(((e,n)=>g("option",{selected:()=>t.md()==n,value:n},e)))),g("div",{class:"bn"},g("button",{type:"submit"},"Save"))))))};return g(Array.prototype,null,g("div",{class:"dn"},g("i",{onClick:()=>ce("rnclose")},"✕")),g("div",{class:"ub"},(()=>t()&&n()&&g("div",{title:"edit",onClick:()=>i(t()),class:"ed"},"✎")),g("div",{class:"head"},"About"),g("div",{class:"sub b"},(function(){return t()?.fullname})),g("div",{class:"sub"},(function(){return t()?.about}))),g("div",{class:"ub"},g("div",{class:"he"},"Settings"),g("div",{class:"sub"},(function(){return t()?[...e,"Private"][t().md()]:""}))),g("div",{class:"ft"},g("div",{class:"ub lf"},g("div",{class:"he"},"Members")),(()=>me.id()>0&&g("div",{class:"rt"},(()=>t()&&g("button",{title:"add members",onClick:()=>r(t())},"👤"))))),g("div",{class:"uls mem"},g("ul",null,_r(Hn,(e=>g("li",{id:e.toString(),tabIndex:-1,style:()=>Rn(e)?.online()?"color:"+W(Rn(e)?.name):"",onClick:t=>Vr(t,e)},e?g("i",{class:()=>"dot"+(Rn(e)?.online()?" on":"")}):null,Rn(e)?.name))))),(()=>t()&&n()&&g("div",{class:"ft dt"},g("div",{class:"ub lf"},g("div",{class:"he"},"Delete")),g("div",{class:"rt"},g("button",{title:"delete topic",onClick:e=>((e,t)=>{e.stopPropagation(),window.confirm("Do you want to delete this channel?\n"+t.fullname())&&(async e=>{an.send(ge.DelChan(e))})(t.id)})(e,t())},"🗑️")))))},yi=()=>{const e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=P((()=>{let t=e.textContent;t&&t.length>50||(Fa(t),Da(t))}),200),e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};let t=document.createElement("div");return setTimeout((function(){new IntersectionObserver((t=>{if(t[0].intersectionRatio<=0)return;let n=$a(Dn()).childids(),a=n[n.length-1];if(!a||$n()||n.length<An)return;let r=e.textContent||null;r&&r.length>50||setTimeout((()=>Na(Cn.id(),r,a)))}),{}).observe(t)})),g("div",{class:"cn"},g("div",{class:"s"},e),g("div",{class:"tbl"},g("table",null,g("tbody",null,_r($a(Dn()).childids,(e=>{let t=zn(e);return g("tr",{onClick:()=>Ra(t)},g("td",null,g("button",{onClick:t=>((e,t)=>{if(e.stopPropagation(),!me.id())return mr();me.chans.has(t)?qa(t):Ba(t)})(t,e)},(()=>me.chans.has(e)?"➕":"➖"))),g("td",null,t.fullname))})),t))))},wi=()=>null,gi=m(wi);oe("nochan",(()=>gi(wi))),oe("rnclose",Si),oe("lnclose",Ci);const bi=g("div",{class:"n"},g("div",null,g("ol",{class:"bc"},_r(Cn.paths,(e=>g("li",null,g("a",{onClick:()=>function(e){e.i===Cn.len()-1?gi()===yi?gi(wi):gi(yi):Cn.cd(e)}(e)},e.fullname))))),(()=>me.id()?g(Array.prototype,null,g("div",{onClick:Ci,class:"av mv"},g("i",null,"☰")),g("div",{onClick:Si,class:"av iv"},g("i",null,"ⓘ")),g("div",{onClick:e=>Vr(e,me.id()),class:"av"},g("i",null,"👨🏻‍💻"))):g(Array.prototype,null,g("div",{class:"u"},g("a",{onClick:dr},"sign up")),g("div",{class:"m"},g("a",{onClick:mr},"log in"))))),gi);function ki(){let e=localStorage.getItem("l");const t=null!==e&&"0"!==e&&window.innerWidth>650;ia(t);const n="1"==localStorage.getItem("r")&&window.innerWidth>650;sa(n),la(Ei()),oa(xi())}function Ci(){ia(!ia()),la(Ei()),localStorage.setItem("l",ia()?"1":"0")}function Si(){sa(!sa()),oa(xi()),localStorage.setItem("r",sa()?"1":"0")}function Ei(){return ia()?Number(localStorage.getItem("w")||185):0}function xi(){return sa()?Number(localStorage.getItem("e")||185):0}ki(),setTimeout(ki,100);const _i=g(Array.prototype,null,g("div",{class:"ma",style:()=>`left:${ia()&&window.innerWidth>650?la():0}px;right:${sa()&&window.innerWidth>650?oa():0}px`},bi,(()=>{const e=document.createElement("div");return setTimeout((function(){new IntersectionObserver((e=>{e[0].intersectionRatio<=0||ya.cb&&(!Mn.at(0)||Kn()||Mn.len()<An||setTimeout((()=>{if(!ya.cb)return;let e=Mn.at(0);!e||Kn()||Mn.len()<An||ya.cb(e)})))}),{}).observe(e)})),g(Array.prototype,null,g("div",{id:"os"}),g("div",{id:"cs"},e,_r(va,(e=>{let t=e();if(t instanceof Date)return g("div",{class:"date"},function(e){let t=new Date;return ne(e,t)?"Today":(t.setDate(t.getDate()-1),ne(e,t)?"Yesterday":e.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric"}))}(t));{const n=Fn(t[0]);return g("div",null,g("div",{class:"tn"},(()=>(e=>{let t=zn(e);if(!t)return null;const n=()=>[...t.dir.slice(Cn.len()-2),t.id];return n().length>0&&g("div",{class:"dr",style:()=>"background:"+W(e)},_r(n,(e=>g("span",null,g("a",{href:"#"+bn.ntob(e),onClick:t=>Gr(t,e)},zn(e)?.fullname)))))})(n.chanid)),g("div",{class:"ts"},n.timestamp.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))),_r(e,(e=>(e=>{let{id:t,txt:n,by:a,chanid:r,star:i,men:s,timestamp:l,showby:o,first:c,firstre:u,re:d,nor:f}=e,m=bn.ntob(t);return setTimeout((()=>{j("cs")?.addEventListener("touchstart",(()=>Xr=!1),{passive:!0}),j("cs")?.addEventListener("touchmove",(()=>Xr=!0),{passive:!0})})),g("div",{id:m+"_",class:()=>"c"+(Pn()===t||Yr()==t?" cur":"")+(In()>0&&In()!==r?" bl":"")+(e.isnew&&(e.isnew=!1,((new Date).getTime()-l.getTime())/1e3<600)?" nc":"")+(d||f()?" r":"")+(c()||u()&&d!=Ln()?" fr":""),onClick:()=>(e=>{"ontouchstart"in document.documentElement||Ga(e.chanid)})(e),onTouchEnd:()=>(e=>{Xr||Ga(e.chanid)})(e),onMouseOver:()=>Wr()!==t&&Wr(t),style:()=>"border-color:"+W(d||(f()?t:r))},(()=>u()&&d!=Ln()&&Fn(d)?g("div",{class:"re",style:()=>d||f()?"color:"+W(d||t):"",onMouseOver:()=>Yr()!==d&&Yr(d),onMouseOut:()=>Yr(0)},g("i",null,"→"),g("b",null,Rn(Fn(d).by)?.name)," ",g("a",{href:"#/"+bn.ntob(d),onClick:e=>e.stopPropagation()},Fn(d)?.txt)):null),(()=>o()||c()||u()?g("div",null,g("a",{class:()=>"by"+(Rn(a)?.online()?" on":""),style:()=>Rn(a)?.online()?"color:"+W(Rn(a)?.name):"",onClick:e=>Vr(e,a)},Rn(a)?.name)):null),g("div",{class:()=>i()?" star":"",style:()=>f()?"color:"+W(t):""},(()=>{let e=n();if(s&&s.length)for(const t of s){let n=Rn(t)?.name,a=me.id()==t?"j":Rn(t)?.online()?"k":"i",r=Rn(t)?.online()?`style="color:${W(n)}"`:"";e=e.replaceAll("@"+n,`<b onclick="b(${t})" class="${a}" ${r}>@${n}</b>`)}return g("div",{class:"ct",innerHTML:e})}),(()=>f()&&t!=Ln()?g("p",{class:"mr"},g("i",null,"→"),g("a",{href:"#/"+m,onClick:e=>e.stopPropagation()},f()+(f()?" replies":" reply"))):null)),(()=>Wr()===t&&me.id()?Tr(m,e):null))})(Fn(e)))))}})),(()=>Rn(fa())?ci:null)),oi)})()),(()=>ia()&&g("div",{class:"ln",style:`width:${la()}px`},(()=>{const e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=P((()=>{let t=e.textContent;t&&t.length>50||(Fa(t),Da(t))}),200),e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};const t=e=>g("ul",null,_r(e.childids,(n=>{let a=e.childs(n);return g(Array.prototype,null,g("li",{class:()=>function(e){return[me.chans.has(e)?"":"on",e==Dn()?"se":""].join(" ")}(n),onClick:()=>function(e,t){e.open(!e.open()),Ra(t)}(a,zn(n))},g("div",{class:"sb"},g("i",null,(()=>a.childids.len()?a.open()?"▼":"▶":""))),g("div",{class:"lb"},(()=>function(e){return zn(e)?.md&&zn(e)?.md()?"🔒":""}(n))," ",zn(n)?.fullname),g("div",{class:"dot",onClick:e=>((e,t)=>{if(e.stopPropagation(),!me.id())return mr();me.chans.has(t)?qa(t):Ba(t)})(e,n)})),(()=>a.open()&&a.childids.len()?t(a):null))})));return g(Array.prototype,null,g("div",{class:"dn n"},g("i",{onClick:()=>ce("lnclose")},"✕")),g("div",{class:"s"},e),me.id()?g("ul",{class:"hm"},(()=>di.map((e=>g("li",{class:(da()[0]||"")==e[0]?"se":"",onClick:()=>location.hash=e[0]},e[1]))))):null,_r(ma,(e=>g("div",null,g("div",{class:"tn"},g("div",{class:"dr",style:()=>"background:"+W(Rn(e)?.name)},g("span",null,g("a",{href:"#&"+bn.ntob(e)},"↔ ",Rn(e)?.name))))))),g("div",{class:"nt"},(()=>Bn.childids.len()?t(Bn):null)))})(),g("div",{onMouseDown:function(){document.onmousemove=e=>{la(e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("w",la().toString())}},class:"dw"}))),(()=>sa()&&g("div",{class:"rn",style:`width:${oa()}px`},vi(),g("div",{onMouseDown:function(){document.onmousemove=e=>{oa(document.documentElement.offsetWidth-e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("e",oa().toString())}},class:"de"}))),(()=>ca()>0&&g("div",{class:"err"},tr())),(()=>ua()&&g("div",{class:"inf"},ua())),(()=>Ja()&&ui));document.querySelector("body")?.append(_i)}();
