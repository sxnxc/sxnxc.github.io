!function(){"use strict";let e,t=[];function n(n){function r(t){if(0===arguments.length)return e&&!r.__o.has(e)&&(r.__o.add(e),e.u.push(r)),n;n=t;let a=e;return e=void 0,r.o=new Set(r.__o),r.o.forEach((e=>e.i=!1)),r.o.forEach((e=>{e.i||e()})),e=a,n}return r.$o=1,r.__o=new Set,r.t=t,r}function r(e){e.__c.forEach(r),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),a(e)}function a(e){e.u=[],e.__c=[],e.l=[]}let i=(e,t,n,r)=>{let a={};for(let o=1;o<t.length;o++){let s=t[o],l="number"==typeof s?n[s]:s,u=t[++o];if(1===u)r[0]=l;else if(3===u)r[1]=Object.assign(r[1]||{},l);else if(5===u)(r[1]=r[1]||{})[t[++o]]=l;else if(6===u){let e=t[++o],n=(r[1]=r[1]||{})[e],i=a[e];i||"function"!=typeof l&&"function"!=typeof n||(i=n&&[n]||[],r[1][e]=function(){let e="";for(var t=0;t<i.length;t++)e+="function"==typeof i[t]?i[t].call(this):i[t];return e}),i?i.push(l):r[1][e]+=l+""}else if(u){let t=()=>e.apply(null,i(e,l,n,["",null]));r.push("function"==typeof r[0]?t:t())}else r.push(l)}return r},o=function(e){let t,n,r=1,a="",i="",o=[0],s=e=>{1===r&&(e||(a=a.replace(/^\s*\n\s*|\s*\n\s*$/g,"")))?o.push(e||a,0):3===r&&(e||a)?(o.push(e||a,1),r=2):2===r&&"..."===a&&e?o.push(e,3):2===r&&a&&!e?o.push(!0,5,a):r>=5&&((a||!e&&5===r)&&(o.push(a,r,n),r=6),e&&(o.push(e,r,n),r=6)),a=""};for(let l=0;l<e.length;l++){l&&(1===r&&s(),s(l));for(let u=0;u<e[l].length;u++)t=e[l][u],1===r?"<"===t?(s(),o=[o],r=3):a+=t:4===r?"--"===a&&">"===t?(r=1,a=""):a=t+a[0]:i?t===i?i="":a+=t:'"'===t||"'"===t?i=t:">"===t?(s(),r=1):r&&("="===t?(r=5,n=a,a=""):"/"===t&&(r<5||">"===e[l][u+1])?(s(),3===r&&(o=o[0]),r=o,(o=o[0]).push(r,2),r=0):" "===t||"\t"===t||"\n"===t||"\r"===t?(s(),r=2):a+=t),3===r&&"!--"===a&&(r=4,o=o[0])}return s(),o},s=new Map,l=function(e){let t=s.get(this);return t||(t=new Map,s.set(this,t)),t=i(this,t.get(e)||(t.set(e,t=o(e)),t),arguments,[]),t.length>1?t:t[0]},u=function(){let e=l.apply(this,arguments);if(e)return Array.isArray(e)?this(e):"object"==typeof e?e:this([e])};function c(){let e=u.bind(this);return(this.wrap||e).apply(e,arguments)}let d={},f=[];function h(e){return this.t&&this.t[e.type](e)}d.h=(...e)=>{let t,n=r=>{if(null==r);else if("string"==typeof r)t?d.add(t,r):t=d.s?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);else if(Array.isArray(r))t||(t=document.createDocumentFragment()),r.forEach(n);else if(r instanceof Node)t?d.add(t,r):t=r;else if("object"==typeof r)d.property(t,r,null,d.s);else if("function"==typeof r)if(t){let e=d.add(t,"");d.insert(t,r,e)}else t=r.apply(null,e.splice(1));else d.add(t,""+r)};return e.forEach(n),t},d.insert=(e,t,n,r,a)=>(e=n&&n.parentNode||e,a=a||r instanceof Node&&r,t===r||(r&&"string"!=typeof r||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?d.subscribe((()=>{r=d.insert(e,t.call({el:e,endMark:n}),n,r,a)})):(n?r&&(a||(a=r.o&&r.o.nextSibling||n.previousSibling),d.rm(e,a,n)):e.textContent="",r=null,t&&!0!==t&&(r=d.add(e,t,n))):(null!=r&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?d.add(e,t,n):e.textContent=t,r=t)),r),d.property=(e,t,n,r,a)=>{if(null!=t)if(!n||"attrs"===n&&(r=!0))for(n in t)d.property(e,t[n],n,r,a);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?d.subscribe((()=>{d.property(e,t.call({el:e,name:n}),n,r,a)})):a?e.style.setProperty(n,t):r||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:d.property(e,t,null,r,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,h):e.removeEventListener(t,h),(e.t||(e.t={}))[t]=n})(e,n,t)},d.add=(e,t,n)=>{let r=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:d.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:d.h(f,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),r},d.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},d.subscribe=function(t){return function(t,n){function i(){let a=e;return e&&e.__c.push(i),r(i),i.i=!0,e=i,n=t(n),e=a,n}function o(){return i.i?e&&i.u.forEach((e=>e())):n=i(),n}t.s=i,a(i),i(),o.$o=1}(t),()=>r(t.s)},d.cleanup=function(t){return e&&e.l.push(t),t},d.root=function(t){let n=e,i=()=>{};e=i,a(i);let o=t((()=>{r(i),e=void 0}));return e=n,o},d.sample=function(t){let n=e;e=void 0;let r=t();return e=n,r},d.hs=(...e)=>{let t=d.s;d.s=!0;let n=p(...e);return d.s=t,n};let p=(...e)=>d.h.apply(d.h,e),m=(...e)=>c.apply(p,e);var v={};function w(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(v,"__esModule",{value:!0});var y=function(){function e(e,t){void 0===e&&(e=0);var n=null==t?void 0:t.grow;this.grow=n&&isFinite(n)&&w(n)||n||0,this.buffer="number"==typeof e?new Uint8Array(w(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var r=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(r<=this.grow){var a=new Uint8Array(r);a.set(this.buffer),this.buffer=a}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var r=t,a=r>>3,i=128>>r%8,o=this.buffer[a];r<n;r++)e(!!(o&i),r),i=1===i?(o=this.buffer[++a],128):i>>1},e}(),g=v.default=y;function b(e,t,n=!1){var r;return(...a)=>{clearTimeout(r),n&&!r&&e.apply(this,a),r=setTimeout((()=>{r=null,n||e.apply(this,a)}),t)}}function k(){document.execCommand("selectAll",!1,null),document.getSelection().collapseToEnd()}function C(){return document.getSelection().focusOffset}const S=e=>document.getElementById(e);const E=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)||e.set(t.id,t),e)),t),x=(e,t)=>e.reduce(((e,t)=>(e.has(t.id)?"online"in t&&e.get(t.id).online(t.online):e.set(t.id,{...t,online:n(t.online)}),delete t.online,e)),t),_=(e,t)=>e.reduce(((e,t)=>{if(e.has(t.id)){let n=e.get(t.id);n.fullname(t.fullname),n.about(t.about),n.md(t.md)}else e.set(t.id,{...t,fullname:n(t.fullname),about:n(t.about),md:n(t.md)});return e}),t);function T(){window.scrollTo(0,document.documentElement.scrollHeight)}const U=(e,t)=>{let n=0,r=0;for(;n<e.length;)r>=t.length&&(r=0),e.set([e[n]^t[r]],n),n++,r++},A=(e,t)=>N(D(e,t),64,24),M=e=>{let{a:t}=L(e);return L(t)},D=(e,t)=>(U(e,t),O(e,t)),L=e=>{let{a:t,k:n}=P(e);return U(t,n),{a:t,k:n}},P=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},O=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},j=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),I=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},N=(e,t=64,n=8)=>D(e,crypto.getRandomValues(new Uint8Array(j(n,t)))),K=e=>(e=>"hsl("+e%360+",100%,30%)")((e=>{var t=0;if(0==e.length)return t;for(var n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t),t&=t;return t})(e+"#"));function z(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&e.length<70}function F(e){return e.length<2||e.length>30?10:/^[0-9a-z_]+$/.test(e)?0:10}function R(){return window.scrollY+window.innerHeight===document.documentElement.scrollHeight}function B(){let e=Intl.DateTimeFormat().resolvedOptions().timeZone;return e&&e.length>0?e:null}function q(e){if(!/^[a-z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1}function $(e){if(!/^[a-z0-9\_]+$/.test(e.key))return e.preventDefault(),!1}function H(e){e.target.value=e.target.value.toLowerCase().replace(/\s/g,"")}function V(e,t=null){return e.length<6?12:t&&e==t?14:void 0}function W(e,t){return!!t&&(e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate())}const Y=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},G=Y(),X="s",Z=["_t","_p","_e","_h","_r","_c","_s","_u","_n","_d","_m"];let J,Q=indexedDB.open(X,1);function ee(e){var t=window.indexedDB.deleteDatabase(e);t.onerror=e=>{},t.onsuccess=e=>{}}Q.onsuccess=e=>{J=Q.result,function(e){let t=e.objectStoreNames;if(t.length!==Z.length)return void ee(X);for(const e of Z)if(!t.contains(e))return void ee(X)}(J),G.complete(J),Q.open?Q.open():Q.open=!0},Q.onerror=e=>{ee(X),location.reload()},Q.onblocked=e=>{},Q.onupgradeneeded=e=>{J=Q.result;let t=J.objectStoreNames;if(t.contains("_s")||J.createObjectStore("_s"),t.contains("_r")||J.createObjectStore("_r"),t.contains("_e")||J.createObjectStore("_e",{keyPath:"id"}),!t.contains("_t")){let e=J.createObjectStore("_t",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1})}if(!t.contains("_p")){J.createObjectStore("_p",{keyPath:"id",autoIncrement:!0}).createIndex("room",["room","id"],{unique:!1})}if(!t.contains("_h")){let e=J.createObjectStore("_h",{keyPath:"id"});e.createIndex("mom",["mom","id"],{unique:!1}),e.createIndex("dir","dir",{unique:!1}),e.createIndex("chatid","chatid",{unique:!1})}t.contains("_c")||J.createObjectStore("_c",{keyPath:["chanid","chatid"]}),t.contains("_u")||J.createObjectStore("_u"),t.contains("_n")||J.createObjectStore("_n"),t.contains("_d")||J.createObjectStore("_d"),t.contains("_m")||J.createObjectStore("_m");for(const e of Z)J.objectStoreNames.contains(e)||J.createObjectStore(e)};const te=async(e,t)=>{let n=await G.join();n&&n.transaction(["_s"],"readwrite").objectStore("_s").put(t,e)},ne=async()=>{let e=await G.join();e&&Z.forEach((t=>e.transaction([t],"readwrite").objectStore(t).clear()))},re=async(e,t)=>{let n=await G.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>{"string"==typeof e.timestamp&&(e.timestamp=new Date(e.timestamp)),r.put(e).onerror=console.error}))},ae=async(...e)=>{let t=await G.join();t&&(await he(...e),function(e){let n=t.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);n.delete(t).onerror=console.error}))}(e),function(e){let n=t.transaction(["_t"],"readwrite").objectStore("_t"),r=n.index("chanid");e.forEach((e=>{let t=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);r.openCursor(t).onsuccess=e=>{var t=e.target.result;t&&(n.delete(t.primaryKey).onerror=console.error,t.continue())}}))}(e.filter((e=>e>0))))},ie=async(e,t)=>{let n=await G.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);return new Promise((e=>{let n=r.put(t);n.onsuccess=t=>{e(t.target.result)},n.onerror=console.error}))},oe=async(e,t)=>{let n=await G.join();if(!n)return{value:[],missed:t};if(0===t.length)return{value:[],missed:[]};performance.now();let r=[],a=new Set,i=n.transaction([e],"readonly").objectStore(e),o=0;return new Promise((e=>{t.forEach((n=>{let s=i.get(n);s.onerror=console.error,s.onsuccess=i=>{if(s.result?r.push(s.result):a.add(n),++o===t.length){let t={value:r,missed:Array.from(a)};e(t)}}}))}))},se=async(e,t,n,r,a,i,o="prev")=>{let s=await G.join();if(!s)return;performance.now();let l=[],u=s.transaction([e],"readonly"),[c,d]=t?t(u.objectStore(e),n,a,i):[u.objectStore(e),null],f=0;return new Promise((e=>{c.openCursor(d,o).onsuccess=t=>{var n=t.target.result;if(n){if(l.push(n.value),r&&++f===r)return e(l);n.continue()}else e(l)}}))},le=(e,t,n,r)=>{let a=n?IDBKeyRange.upperBound(n,r):null;if(!t)return[e,a];let i=n||Number.MAX_VALUE;return e=e.index("room"),a=IDBKeyRange.bound([t.value],[t.value,i],!1,r),[e,a]},ue=(e,t,n,r)=>{let a=n?IDBKeyRange.upperBound(n,r):null;if(!t)return[e,a];let i=n||Number.MAX_VALUE;return a=IDBKeyRange.bound([t.value],[t.value,i],!1,r),[e,a]},ce=async(e,t,n=30,r=!0)=>{let a={value:e};return(await se("_c",ue,a,n,t,r,"prev")).map((e=>e.chatid))},de=async(e,t,n)=>{let r=await G.join();if(!r)return;let a=r.transaction(["_r"],"readwrite").objectStore("_r"),i=a.get(e);i.onerror=console.error,i.onsuccess=async r=>{if(i.result){if(n)return a.put([i.result[0],i.result[1],n],e).onerror=console.error;t[0]<i.result[0]&&(t[0]=i.result[0]),t[1]>i.result[0]&&(t[1]=i.result[1])}a.put(t,e).onerror=console.error}},fe=e=>me(e,"_r"),he=async(...e)=>we("_r",...e),pe=e=>me(e,"_s"),me=async(e,t)=>{let n=await G.join();if(!n)return;let r=n.transaction([t],"readonly").objectStore(t);return new Promise((t=>{let n=r.get(e);n.onerror=console.error,n.onsuccess=e=>t(n.result)}))},ve=async(e,t,n)=>{let r=await G.join();r&&r.transaction([e],"readwrite").objectStore(e).put(n,t)},we=async(e,...t)=>{let n=await G.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>r.delete(e).onerror=console.error))},ye=(e,t)=>crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:t},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),ge=e=>crypto.subtle.importKey("raw",e,{name:"ECDH",namedCurve:"P-256"},!0,[]),be=async()=>await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"]),ke=async(e,t,n)=>await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),Ce=async(e,t,n)=>await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e),Se=new Map,Ee=(e,t,n=!1)=>{let r=Se.get(e)||[];n?r=[t]:r.push(t),Se.set(e,r)},xe=(e,t)=>Se.has(e)?Se.get(e).forEach((e=>e(t))):void 0,_e={},Te=e=>(e&&(Object.assign(_e,e),xe("config",_e)),_e),Ue=n(void 0),Ae={id:n(0),name:n(null),chans:n([])};async function Me(){let e=await pe("a");if(!e||e.byteLength<54)return;let t=new Uint8Array(e,0,16),n=new Uint8Array(e,16,32);16===t.length&&(Ae.salt=t),32===n.length&&(Ae.sskey=await crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"]));let r=new Uint8Array(e,48,4),a=new Uint8Array(e,52),i=new DataView(r.buffer).getInt32(48,!1),o=(new TextDecoder).decode(a);i&&o&&(Ae.id(i),Ae.name(o));let s=await pe("c");s&&s instanceof Array&&Ae.chans(s);var l=new Uint8Array(20);return l.set(t),l.set(r,16),setTimeout(T),l}async function De(e,t){let n=new TextEncoder,r=await Pe(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",r)}async function Le(e,t){return await Pe((new TextEncoder).encode(e),t)}async function Pe(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function Oe(e){let t=new Uint8Array(e.slice(16,20)),n=new Uint8Array(e.slice(20)),r=new DataView(t.buffer).getInt32(0,!1),a=(new TextDecoder).decode(n);Ae.id(r),Ae.name(a),Ae.salt=new Uint8Array(e.slice(0,16)),Ae.sskey=await Pe(Ue(),Ae.salt),Ue(void 0);let i=new Uint8Array(await crypto.subtle.exportKey("raw",Ae.sskey)),o=Ae.salt.length,s=new Uint8Array(o+i.length+t.length+n.length);return s.set(Ae.salt),s.set(i,o),s.set(t,o+i.length),s.set(n,o+i.length+t.length),te("a",s.buffer),{id:r,name:a,tz:B()}}var je,Ie;!function(e){e.Shin=function(e){return{tag:"Shin",value:e}},e.Shan=function(e){return{tag:"Shan",value:e}},e.Tree=function(e){return{tag:"Tree",value:e}},e.NewChat=function(e){return{tag:"NewChat",value:e}},e.NewUser=function(e){return{tag:"NewUser",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.Logout=function(e){return{tag:"Logout",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.MuteChan=function(e){return{tag:"MuteChan",value:e}},e.UnmuteChan=function(e){return{tag:"UnmuteChan",value:e}},e.AddMems=function(e){return{tag:"AddMems",value:e}},e.DelChat=function(e){return{tag:"DelChat",value:e}},e.DelChan=function(e){return{tag:"DelChan",value:e}},e.EditChat=function(e){return{tag:"EditChat",value:e}},e.EditChan=function(e){return{tag:"EditChan",value:e}},e.Mems=function(e){return{tag:"Mems",value:e}},e.FindUsers=function(e){return{tag:"FindUsers",value:e}},e.FindMems=function(e){return{tag:"FindMems",value:e}},e.PushSubs=function(e){return{tag:"PushSubs",value:e}},e.Ons=function(e){return{tag:"Ons",value:e}},e.Unpack=function(e){return{tag:"Unpack",value:e}},e.Tz=function(e){return{tag:"Tz",value:e}},e.Profile={tag:"Profile"},e.EditProfile=function(e){return{tag:"EditProfile",value:e}},e.Pwd=function(e){return{tag:"Pwd",value:e}},e.Email=function(e){return{tag:"Email",value:e}},e.Au=function(e){return{tag:"Au",value:e}},e.Signup=function(e){return{tag:"Signup",value:e}},e.Fp=function(e){return{tag:"Fp",value:e}},e.EditStatus=function(e){return{tag:"EditStatus",value:e}},e.Status=function(e){return{tag:"Status",value:e}},e.ChatThread=function(e){return{tag:"ChatThread",value:e}},e.ChatList=function(e){return{tag:"ChatList",value:e}},e.Star=function(e){return{tag:"Star",value:e}},e.Sdp=function(e){return{tag:"Sdp",value:e}}}(je||(je={})),function(e){e.Shin=function(e){return{tag:"Shin",value:e}},e.Shan=function(e){return{tag:"Shan",value:e}},e.Tree=function(e){return{tag:"Tree",value:e}},e.Treeid=function(e){return{tag:"Treeid",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chat=function(e){return{tag:"Chat",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.MuteChan=function(e){return{tag:"MuteChan",value:e}},e.UnmuteChan=function(e){return{tag:"UnmuteChan",value:e}},e.DelChan=function(e){return{tag:"DelChan",value:e}},e.Update=function(e){return{tag:"Update",value:e}},e.Updates=function(e){return{tag:"Updates",value:e}},e.ChanUpdates=function(e){return{tag:"ChanUpdates",value:e}},e.MemUpdates=function(e){return{tag:"MemUpdates",value:e}},e.On=function(e){return{tag:"On",value:e}},e.Ons=function(e){return{tag:"Ons",value:e}},e.Mems=function(e){return{tag:"Mems",value:e}},e.Err=function(e){return{tag:"Err",value:e}},e.NewChan=function(e){return{tag:"NewChan",value:e}},e.FindUsers=function(e){return{tag:"FindUsers",value:e}},e.FindMems=function(e){return{tag:"FindMems",value:e}},e.Logout=function(e){return{tag:"Logout",value:e}},e.AddMems=function(e){return{tag:"AddMems",value:e}},e.Unpack=function(e){return{tag:"Unpack",value:e}},e.Profile=function(e){return{tag:"Profile",value:e}},e.Pwd=function(e){return{tag:"Pwd",value:e}},e.Name=function(e){return{tag:"Name",value:e}},e.Signup=function(e){return{tag:"Signup",value:e}},e.Typing=function(e){return{tag:"Typing",value:e}},e.Status=function(e){return{tag:"Status",value:e}},e.ChatThread=function(e){return{tag:"ChatThread",value:e}},e.ChatList=function(e){return{tag:"ChatList",value:e}},e.Sdp=function(e){return{tag:"Sdp",value:e}}}(Ie||(Ie={}));const Ne=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),Ke=(e,t)=>{const{view:{buffer:n},pos:r}=e,a=n.byteLength;if(a-r>t)return e;const i=Math.max(2*a,a+t),o=new Uint8Array(i);return o.set(new Uint8Array(n)),Ne(o.buffer,r,e.littleEndian)},ze=(e,t)=>{e=Ke(e,1);const{view:n,pos:r}=e;return n.setUint8(r,t),e.pos+=1,e},Fe=(e,t)=>{e=Ke(e,4);const{view:n,pos:r,littleEndian:a}=e;return n.setUint32(r,t,a),e.pos+=4,e},Re=(e,t)=>{e=Ke(e,2);const{view:n,pos:r,littleEndian:a}=e;return n.setUint16(r,t,a),e.pos+=2,e};function Be(e,t){const{view:n,pos:r,littleEndian:a}=e;return n.setUint32(a?r:r+4,t,a),n.setUint32(a?r+4:r,0,a),e.pos+=8,e}const qe=(e,t)=>{e=Ke(e,4);const{view:n,pos:r,littleEndian:a}=e;return n.setInt32(r,t,a),e.pos+=4,e},$e=new TextEncoder,He="encodeInto"in $e?(e,t)=>$e.encodeInto(e,t).written:(e,t)=>{const n=$e.encode(e);return t.set(n),n.length},Ve=(e,t)=>{e=Ke(e,3*t.length+8);const n=He(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=Be(e,n)).pos+=n,e},We=(e,t)=>ze(e,t?1:0),Ye=e=>(t,n)=>n.reduce(e,((e,t)=>Be(Ke(e,8),t))(t,n.length)),Ge=e=>(t,n)=>null===n?ze(t,0):e(ze(t,1),n),Xe=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},Ze=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=2,n.getUint16(t,r)},Je=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getUint32(t,r)},Qe=e=>{const{view:t,pos:n,littleEndian:r}=e;return e.pos+=8,t.getUint32(r?n:n+4,r)},et=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getInt32(t,r)},tt=e=>1===Xe(e),nt=e=>t=>1===Xe(t)?e(t):null,rt=e=>t=>{const n=Qe(t),r=new Array;for(let a=0;a<n;a++)r.push(e(t));return r},at=new TextDecoder,it=e=>{const t=Qe(e),{pos:n,view:{buffer:r}}=e,a=at.decode(new Uint8Array(r,n,t));return e.pos+=t,a};var ot=Ye(qe),st=Ge(Ve),lt=Ge(ot),ut=Ge(qe),ct=Ge(We),dt=Ge((function(e,t){var n=t.id,r=t.lo;return qe(qe(e,n),r)})),ft=Ye(Ve),ht=Ge(ft),pt=Ye(ze),mt=Ge(((e,t)=>{e=Ke(e,8);const{view:n,pos:r,littleEndian:a}=e;return n.setFloat64(r,t,a),e.pos+=8,e})),vt=Ge(pt),wt=Ge(Re),yt=function(e,t){var n=t.id,r=t.txt,a=t.by,i=t.chanid,o=t.dir,s=t.timestamp,l=t.men,u=t.re,c=t.nor,d=t.star;return ct(ut(ut(lt(Ve(ot(qe(qe(Ve(qe(e,n),r),a),i),o),s),l),u),c),d)},gt=(Ye(yt),Ye((function(e,t){var n=t.id,r=t.fullname,a=t.mom,i=t.by,o=t.dir,s=t.md,l=t.timestamp,u=t.chatid,c=t.about,d=t.to,f=t.re;return ut(lt(st(qe(Ve(Re(ot(qe(qe(Ve(qe(e,n),r),a),i),o),s),l),u),c),d),f)})),function(e,t){var n=t.id,r=t.name,a=t.online;return We(Ve(qe(e,n),r),a)}),bt=Ye(gt),kt=(Ge((function(e,t){var n=t.data,r=t.chans;return ot(pt(e,n),r)})),function(e,t){var n=t.id,r=t.action,a=t.chatid,i=t.txt;return st(qe(Re(qe(e,n),r),a),i)}),Ct=(Ye(kt),Ye((function(e,t){var n=t.id,r=t.action,a=t.chanid,i=t.name,o=t.about,s=t.md;return wt(st(st(qe(Re(qe(e,n),r),a),i),o),s)})),Ye((function(e,t){var n=t.id,r=t.action,a=t.chanid,i=t.by;return qe(qe(Re(qe(e,n),r),a),i)})),Ye((function(e,t){var n=t.chanid,r=t.users;return bt(qe(e,n),r)})),function(e,t){var n=t.email,r=t.fullname,a=t.about;return st(st(st(e,n),r),a)}),St=function(e,t){var n=t.i,r=t.ub,a=t.lb,i=t.kw;return st(ut(ut(qe(e,n),r),a),i)},Et=function(e,t){var n=t.fr,r=t.to,a=t.offer,i=t.sd,o=t.ca;return ft(pt(ct(ut(ut(e,n),r),a),i),o)},xt=function(e,t){var n=t.txt;return Ve(e,n)},_t=function(e,t){var n=t.st,r=t.tz;return st(st(e,n),r)},Tt=function(e,t){switch(t.tag){case"Shin":return function(e,t){var n=t.chanid,r=t.kw,a=t.lu,i=t.cu,o=t.mu,s=t.ub,l=t.lb;return ut(ut(ut(ut(dt(st(ut(e,n),r),a),i),o),s),l)}(Fe(e,0),t.value);case"Shan":return function(e,t){var n=t.chanid,r=t.kw,a=t.cu,i=t.mu,o=t.ub,s=t.lb;return ut(ut(ut(ut(st(qe(e,n),r),a),i),o),s)}(Fe(e,1),t.value);case"Tree":return function(e,t){var n=t.kw,r=t.reload;return ct(st(e,n),r)}(Fe(e,2),t.value);case"NewChat":return function(e,t){var n=t.txt,r=t.chanid,a=t.re,i=t.chname,o=t.men,s=t.to,l=t.emails;return ht(lt(lt(st(ut(qe(Ve(e,n),r),a),i),o),s),l)}(Fe(e,3),t.value);case"NewUser":return function(e,t){var n=t.name,r=t.key,a=t.tz,i=t.tgid,o=t.tgname,s=t.tgfn,l=t.tgln;return st(st(st(mt(st(pt(Ve(e,n),r),a),i),o),s),l)}(Fe(e,4),t.value);case"Login":return function(e,t){var n=t.name,r=t.key,a=t.tz;return st(pt(Ve(e,n),r),a)}(Fe(e,5),t.value);case"Logout":return pt(Fe(e,6),t.value);case"Users":return ot(Fe(e,7),t.value);case"Chans":return ot(Fe(e,8),t.value);case"Chats":return ot(Fe(e,9),t.value);case"MuteChan":return qe(Fe(e,10),t.value);case"UnmuteChan":return qe(Fe(e,11),t.value);case"AddMems":return function(e,t){var n=t.chanid,r=t.userids,a=t.emails;return ht(lt(qe(e,n),r),a)}(Fe(e,12),t.value);case"DelChat":return qe(Fe(e,13),t.value);case"DelChan":return qe(Fe(e,14),t.value);case"EditChat":return function(e,t){var n=t.id,r=t.txt;return Ve(qe(e,n),r)}(Fe(e,15),t.value);case"EditChan":return function(e,t){var n=t.id,r=t.name,a=t.about,i=t.md;return wt(st(st(qe(e,n),r),a),i)}(Fe(e,16),t.value);case"Mems":return ot(Fe(e,17),t.value);case"FindUsers":return Ve(Fe(e,18),t.value);case"FindMems":return function(e,t){var n=t.chanid,r=t.kw;return Ve(qe(e,n),r)}(Fe(e,19),t.value);case"PushSubs":return function(e,t){var n=t.endpoint,r=t.auth,a=t.p256dh;return Ve(Ve(Ve(e,n),r),a)}(Fe(e,20),t.value);case"Ons":return ot(Fe(e,21),t.value);case"Unpack":return Ve(Fe(e,22),t.value);case"Tz":return Ve(Fe(e,23),t.value);case"Profile":return Fe(e,24);case"EditProfile":return Ct(Fe(e,25),t.value);case"Pwd":return function(e,t){var n=t.key,r=t.okey;return vt(pt(e,n),r)}(Fe(e,26),t.value);case"Email":return Ve(Fe(e,27),t.value);case"Au":return Ve(Fe(e,28),t.value);case"Signup":return Ve(Fe(e,29),t.value);case"Fp":return Ve(Fe(e,30),t.value);case"EditStatus":return _t(Fe(e,31),t.value);case"Status":return qe(Fe(e,32),t.value);case"ChatThread":return St(Fe(e,33),t.value);case"ChatList":return St(Fe(e,34),t.value);case"Star":return qe(Fe(e,35),t.value);case"Sdp":return Et(Fe(e,36),t.value)}},Ut=rt(et),At=nt(it),Mt=nt(Ut),Dt=nt(et),Lt=nt(tt),Pt=(nt((function(e){return{id:et(e),lo:et(e)}})),rt(it)),Ot=(nt(Pt),rt(Xe)),jt=(nt((e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=8,n.getFloat64(t,r)})),nt(Ot)),It=nt(Ze),Nt=function(e){return{id:et(e),txt:it(e),by:et(e),chanid:et(e),dir:Ut(e),timestamp:it(e),men:Mt(e),re:Dt(e),nor:Dt(e),star:Lt(e)}},Kt=rt(Nt),zt=rt((function(e){return{id:et(e),fullname:it(e),mom:et(e),by:et(e),dir:Ut(e),md:Ze(e),timestamp:it(e),chatid:et(e),about:At(e),to:Mt(e),re:Dt(e)}})),Ft=function(e){return{id:et(e),name:it(e),online:tt(e)}},Rt=rt(Ft),Bt=nt((function(e){return{data:Ot(e),chans:Ut(e)}})),qt=function(e){return{id:et(e),action:Ze(e),chatid:et(e),txt:At(e)}},$t=rt(qt),Ht=rt((function(e){return{id:et(e),action:Ze(e),chanid:et(e),name:At(e),about:At(e),md:It(e)}})),Vt=rt((function(e){return{id:et(e),action:Ze(e),chanid:et(e),by:et(e)}})),Wt=rt((function(e){return{chanid:et(e),users:Rt(e)}})),Yt=function(e){return{email:At(e),fullname:At(e),about:At(e)}},Gt=function(e){return{fr:Dt(e),to:Dt(e),offer:Lt(e),sd:Ot(e),ca:Pt(e)}},Xt=function(e){return{txt:it(e)}},Zt=function(e){return{st:At(e),tz:At(e)}},Jt=function(e){switch(Je(e)){case 0:return Ie.Shin(function(e){return{chats:Kt(e),chans:zt(e),users:Rt(e)}}(e));case 1:return Ie.Shan(Ut(e));case 2:return Ie.Tree(zt(e));case 3:return Ie.Treeid(Ut(e));case 4:return Ie.Chats(Kt(e));case 5:return Ie.Chans(zt(e));case 6:return Ie.Users(Rt(e));case 7:return Ie.Chat(Nt(e));case 8:return Ie.Login(Bt(e));case 9:return Ie.MuteChan(Dt(e));case 10:return Ie.UnmuteChan(Dt(e));case 11:return Ie.DelChan(et(e));case 12:return Ie.Update(qt(e));case 13:return Ie.Updates($t(e));case 14:return Ie.ChanUpdates(Ht(e));case 15:return Ie.MemUpdates(Vt(e));case 16:return Ie.On(Ft(e));case 17:return Ie.Ons(Ut(e));case 18:return Ie.Mems(Wt(e));case 19:return Ie.Err(Ze(e));case 20:return Ie.NewChan(et(e));case 21:return Ie.FindUsers(Rt(e));case 22:return Ie.FindMems(Rt(e));case 23:return Ie.Logout(tt(e));case 24:return Ie.AddMems(tt(e));case 25:return Ie.Unpack(At(e));case 26:return Ie.Profile(Yt(e));case 27:return Ie.Pwd(jt(e));case 28:return Ie.Name(At(e));case 29:return Ie.Signup(Ze(e));case 30:return Ie.Typing(function(e){return{by:Dt(e),dir:Ut(e),key:At(e),keyCode:It(e),anchor:Ze(e),focus:Ze(e),txt:At(e),chname:At(e),re:Dt(e)}}(e));case 31:return Ie.Status(Zt(e));case 32:return Ie.ChatThread(Ut(e));case 33:return Ie.ChatList(Ut(e));case 34:return Ie.Sdp(Gt(e))}throw new Error("bad variant index for Response")},Qt=Ne(new ArrayBuffer(512)),en=function(e,t){return Qt.pos=0,Qt=t(Qt,e),new Uint8Array(Qt.view.buffer).slice(0,Qt.pos)},tn=function(e,t){return t(Ne(e))},nn=function(e){return tn(e.buffer,Jt)},rn=function(e){return en(e,Tt)},an=function(e){return en(e,xt)},on=function(e){return tn(e.buffer,Xt)};const sn=e=>new Zlib.RawInflate(e).decompress(),ln=e=>new Zlib.RawDeflate(e).compress();async function un(e,t){let n=new Uint8Array(e),r=n.length,{z:a,c:i,d:o}=Te();if(o){let e=n.subarray(0,12);n=new Uint8Array(await Ce(n.subarray(12),Ae.sskey,e)),U(n,e)}if(i){let e=n.subarray(0,12);n=new Uint8Array(await Ce(n.subarray(12),t,e)),U(n,e)}return a&&(n=sn(n)),(100*r/n.length).toFixed(2),function(e){return nn(e)}(n)}const cn=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),dn=cn?cn.groups.ip:"mx.hyze.io:9898",fn=Y();let hn,pn,mn,vn=!1,wn=500,yn=0,gn=()=>{},bn={recv:e=>gn=e,send:async function(e){await fn.join(),hn.send(await async function(e,t){((e,t)=>{e.length||e.byteLength})(e=rn(e));let{z:n,c:r,d:a}=Te();if(n&&(e=ln(e)),r){const n=crypto.getRandomValues(new Uint8Array(12));U(e,n),e=I(n,new Uint8Array(await ke(e,t,n)))}if(a){const t=crypto.getRandomValues(new Uint8Array(12));U(e,t),e=I(t,new Uint8Array(await ke(e,Ae.sskey,t)))}return performance.now(),e}(e,mn))}};function kn(){vn=!0,yn++,wn+=j(0,yn<16?200:3e3),setTimeout(Cn,wn)}async function Cn(){const e=await async function(){const e=async()=>{pn=await be();let e=await crypto.subtle.exportKey("raw",pn.publicKey);return new Uint8Array(e)};return await(async(e,t)=>{let[n,r]=await Promise.all([e(),t()]);return r?D(n,r):N(n,64,24)})(e,Me)}();performance.now(),hn=new WebSocket("wss://"+dn),hn.binaryType="arraybuffer",hn.onopen=async()=>{hn.send(e)},hn.onmessage=Sn,hn.onerror=console.error,hn.onclose=kn}async function Sn({data:e}){let t=new Uint8Array(e);Te((e=>{const t=new g(e);return{z:t.get(0),c:t.get(1),d:t.get(2)}})(t));let n=await ge(t.slice(1));mn=await ye(pn.privateKey,n),hn.onmessage=En,fn.complete(),vn&&xe("reconnected"),vn=!1}async function En({data:e}){gn(await un(e,mn))}Cn();function xn(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),r=new Uint8Array(n.length);for(let e=0;e<n.length;++e)r[e]=n.charCodeAt(e);return r}async function _n(){let e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(t){let e=JSON.parse(JSON.stringify(t)),n=await pe("s");if(n instanceof ArrayBuffer&&(new TextDecoder).decode(n)==e.keys.auth)return;te("s",(new TextEncoder).encode(e.keys.auth).buffer),xe("subs",e)}else navigator.serviceWorker.getRegistration().then((e=>{e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:xn("BIm2PpzmeMy3pe_VkzyP8Yq-iqG8ay0qLBGcJZNXnq5lOKu1fAyY9xQ2PK2KQjzWulmKu8IzBLmut276h4tIw5k")}).then((e=>{}),(e=>{}))}))}function Tn(e,t,n){const{root:r,subscribe:a,sample:i,cleanup:o}=d;null==n&&(n=!t.$t);let s=d.h([]),l=d.add(s,""),u=new Map,c=new Map,f=new Set;function h(e,a){if(null==e)return;let i=c.get(e);return 1===a?(f.delete(e),i||(i=n?r((n=>(u.set(e,n),t(e.$v||e)))):t(e.$v||e),11===i.nodeType&&(i=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let r=Array.from(t);return{nodeType:111,t:r[0],o:r[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(r[t++])}return e}}})(i)||i),c.set(e,i))):-1===a&&f.add(e),((e,t)=>111===e.nodeType?1/t<0?t?d.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(i,a)}function p(e){let t=u.get(e);t&&(t(),u.delete(e)),c.delete(e)}return o(a((t=>{let n=e();return i((()=>{f.clear();let e=Array.from(function(e,t,n,r,a){let i,o,s=new Map,l=new Map;for(i=0;i<t.length;i++)s.set(t[i],i);for(i=0;i<n.length;i++)l.set(n[i],i);for(i=o=0;i!==t.length||o!==n.length;){var u=t[i],c=n[o];if(null===u)i++;else if(n.length<=o)e.removeChild(r(t[i],-1)),i++;else if(t.length<=i)e.insertBefore(r(c,1),r(t[i],0)||a),o++;else if(u===c)i++,o++;else{var d=l.get(u),f=s.get(c);void 0===d?(e.removeChild(r(t[i],-1)),i++):void 0===f?(e.insertBefore(r(c,1),r(t[i],0)||a),o++):(e.insertBefore(r(t[f],1),r(t[i],0)||a),t[f]=null,f>i+1&&i++,o++)}}return n}(l.parentNode,t||[],n,h,l));return f.forEach(p),e}))}))),o((function(){u.forEach((e=>e())),u.clear(),c.clear(),f.clear()})),s}"serviceWorker"in navigator&&(navigator.serviceWorker.register("sw.js").then((()=>{})),navigator.serviceWorker.addEventListener("message",(function(e){e.data.reload&&location.reload()}),!1));const Un="0VMZYpdgCGL3iKAzDHwocTt97e1hasO2mJNjExq4PvR6XyWSFbIn-5B_8fUukQlr",An=Un.split(""),Mn=new Array(123);for(let e=0;e<Un.length;e++)Mn[Un.charCodeAt(e)]=e;const Dn=e=>{if(e<0)return"-"+Dn(-e);let t=e>>>0,n=e/4294967296>>>0,r="";for(;n>0;)r=An[63&t]+r,t>>>=6,t|=(63&n)<<26,n>>>=6;let a="";do{a=An[63&t]+a,t>>>=6}while(t>0);return a+r};var Ln={ntob:Dn,bton:e=>{let t=0;for(let n=0;n<e.length;n++)t=64*t+Mn[e.charCodeAt(n)];return t}};const Pn=[0,null,"⛩",0],On=(()=>{let e=n(Pn);const t=n([e]),r=t=>e(t),a=e=>{let n=t();n[e[0]]!==e&&(n[e[0]]=e),n.splice(e[0]+1),t(n),r(e),location.hash=e[0]>0?Ln.ntob(e[3]):""};return{path:t=>e()[t],paths:t,len:()=>t().length,setpath:r,same:t=>t===e(),cd:a,update:e=>{t([Pn,...e]),r(e[e.length-1]||Pn)},ishome:()=>e()===Pn,home:()=>a(Pn)}})(),jn=[];function In(){!function(e){for(const t of jn)t(e)}(document.location.hash.substr(1))}window.addEventListener("hashchange",In),setTimeout(In);const Nn=30,Kn=e=>(t,n)=>{if(void 0===t)return e;let r=e.get(t);return n?r?r[n]:void 0:r},zn=e=>{let t=n(e);return t.add=e=>t().indexOf(e)<0?t([...t(),e]):t(),t.delete=e=>{t().splice(t().indexOf(e),1),t(t())},t.last=()=>t()[t().length-1],t.pop=()=>{let e=t().pop();return t(t()),e},t},Fn=n([]),Rn=n([]),Bn=n(0),qn=n(0),$n=n(0),Hn=n(0),Vn=n(""),Wn=n(""),Yn=n(""),Gn=n(!1),Xn=n(!1),Zn=Kn(new Map),Jn=Kn(new Map),Qn=Kn(new Map),er={id:0,childids:n([]),childs:Kn(new Map),open:()=>{}},tr=Kn(new Map([[0,er]])),nr=n([]),rr=zn([]),ar=zn([]),ir=n([]),or=n([]),sr=n(0),lr=n(null),ur=n(!1),cr=n(""),dr=n(!1),fr=zn([]),hr=zn([]),pr=zn([]),mr=n(!0),vr=n(null),wr=n(!1),yr=n(!1);n(""),n("");const gr=n(0),br=n(0),kr=n(0),Cr=n(null),Sr=n(location.hash.substr(1)),Er=n(null),xr=zn([]),_r=Kn(new Map),Tr=zn([]),Ur=n(!1),Ar=()=>Rn().length>0?Rn()[Rn().length-1]:0,Mr=(()=>{const e={},t={};return{create:n=>t[n]=new Promise((t=>e[n]=t)),complete:(t,n)=>e[t]?e[t](n):null,join:e=>t[e],joinall:(...e)=>Promise.all(e.map((e=>t[e]))),select:(...e)=>Promise.race(e.map((e=>t[e])))}})(),Dr={content:null},Lr=()=>{switch(kr()){case 1:return"please login first";case 2:return"invalid login name or password";case 3:return"email existed";case 4:return"username existed";case 5:return"please select a topic";case 6:return"topic is empty";case 7:return"invalid email address";case 8:return"error adding people";case 9:return"error signing up";case 10:return"invalid name";case 11:return"invalid input";case 12:return"password too short";case 13:return"invalid password";case 14:return"new password is the same with old password";case 15:return"peer offline";case 16:return"You are behind a NAT or firewall, can not create a direct connection to peer"}};function Pr(...e){return e.includes(kr())}let Or;const jr=e=>{kr(e),clearTimeout(Or),Or=setTimeout((()=>kr(0)),5e3)},Ir=e=>{Cr(e),clearTimeout(Or),Or=setTimeout((()=>Cr(null)),5e3)};bn.recv((async e=>{let t=e.value;switch(e.tag){case"Err":jr(t);break;case"Unpack":Mr.complete("unpack",t);break;case"AddMems":Mr.complete("addmems",t);break;case"Logout":Te({d:!1});break;case"NewChan":Hn(t),T();break;case"Shin":if(!t)return;E(t.chats,Jn()),x(t.users,Qn()),_(t.chans,Zn()),re("_t",t.chats),re("_h",t.chans),re("_e",t.users),async function(e){let t=e||[],n=Bn();if(0===t.length)return Gn(!0),de(n,null,!0),void Mr.complete("chatscan",t);Gn(!1),de(n,[t[0],t[t.length-1]]);let r=t.map((e=>({chanid:n,chatid:e})));re("_c",r),Mr.complete("chatscan",t)}(t.chats.map((e=>e.id)));break;case"Update":{let e=new Set([Bn()]);aa(e,t),e.forEach((e=>ve("_u",e,t.id)));break}case"Updates":t&&t.length&&async function(e){let t=new Set([Bn()]);for(const n of e)aa(t,n);t.forEach((t=>ve("_u",t,e[e.length-1].id)))}(t);break;case"ChanUpdates":t&&t.length&&async function(e){let t=new Set([Bn()]);for(const{action:n,chanid:r,name:a,about:i,md:o}of e)switch(n){case 1:{let e=Zn(r);e&&(null!==a&&e.fullname(a),null!==i&&e.about(i),null!==o&&e.md(o)),e=await me(r,"_h"),e&&(null!==a&&(e.fullname=a),null!==i&&(e.about=i),null!==o&&(e.md=o),await ie("_h",e),e.dir.forEach((e=>t.add(e))));break}case 2:let e=await Qr(r);e&&e.dir.forEach((e=>t.add(e)))}t.forEach((t=>ve("_d",t,e[e.length-1].id)))}(t);break;case"MemUpdates":t&&t.length&&async function(e){let t=new Set([Bn()]),n=new Map;for(const{action:t,chanid:r,by:a}of e)switch(t){case 1:n.has(r)?n.get(r).adds.push(a):n.set(r,{adds:[a],rms:[]});break;case 0:n.has(r)?n.get(r).rms.push(a):n.set(r,{adds:[],rms:[a]})}for(let[e,{adds:r,rms:a}]of n.entries()){let n=await me(e,"_n");n&&(n=n.filter((e=>a.indexOf(e)<0)),ve("_n",e,Array.from(new Set([...r,...n])))),t.add(e)}oa(Hn()||Bn()),t.forEach((t=>ve("_m",t,e[e.length-1].id)))}(t);break;case"Login":if(!t)return jr(2),Ue(void 0),void xe("login",!1);await async function({data:e,chans:t}){const n=await Oe(e);ie("_e",n),Te({d:!0}),Ae.chans(t),te("c",t)}(t),ua(),xe("login",!0),Ur(!1),Hn(0),er.childids([]),na(),qr();break;case"Pwd":if(!t)return Ue(void 0),void Mr.complete("pwd",13);Ae.id()&&await Oe(t),Mr.complete("pwd");break;case"Users":re("_e",t),Mr.complete("users",t);break;case"Chans":re("_h",t),Mr.complete("chans",t);break;case"Chat":!async function(e){let t=Rn();if(t.includes(e.id))return;let r=!Zn(e.chanid),a=R();e.by==Ae.id()&&vr(e.id);await ie("_t",e);let i=(Bn()?e.dir:[0,...e.dir]).map((t=>(de(t,[e.id,e.id]),{chanid:t,chatid:e.id})));re("_c",i);let o=new Set(Qn().has(e.by)?[]:[e.by]);e.men&&e.men.forEach((e=>{Qn().has(e)||o.add(e)}));let s=e.dir.filter((e=>!Zn(e))),l=new Set(s);await Fr(o,l),e.re&&ga(e.re);let u=Jn(Ar())||{};e.nor=n(0),e.star=n(!1),e.txt=n(e.txt),e.showby=n(e.by!==u.by),e.first=n(e.chanid!==u.chanid),e.last=n(!1),e.firstre=n(e.re&&e.re!==u.re&&e.re!=u.id),e.lastre=n(!1),e.timestamp=new Date(e.timestamp),Jn().set(e.id,e),t.push(e.id),Rn(t),r&&qr(!0);a&&T();"ontouchstart"in document.documentElement||la();e.dir.forEach((async t=>{let n=Zn(t);n&&(n.chatid=e.id),n=await me(t,"_h"),n&&(n.chatid=e.id,await ie("_h",n))}))}(t);break;case"Chats":t.length>0&&re("_t",t),Mr.complete("chats",t);break;case"Shan":{let e=t;e.length>0?(Xn(!1),await Br(e)):Xn(!0),Mr.complete("chanscan",e);break}case"Tree":t.length>0&&(re("_h",t),_(t,Zn())),Mr.complete("scantree",t.map((e=>e.id)));break;case"Treeid":t.length>0&&await Br(t),Mr.complete("scantree",t);break;case"MuteChan":{let e=t;if(!e)return;let n=Ae.chans();if(n.includes(e))return;n.push(e),Ae.chans(n),await te("c",n),await ae(0,e,...Zn(e,"dir")),na(),$r(On.path(3));break}case"UnmuteChan":{let e=t,n=Ae.chans();if(!n.includes(e))return;const r=n.indexOf(e);r>-1&&n.splice(r,1),Ae.chans(n),await te("c",n),await ae(0,e,...Zn(e,"dir")),na(),$r(On.path(3));break}case"DelChan":Qr(t);break;case"Mems":Mr.complete("memlist",t);break;case"FindUsers":x(t,Qn()),re("_e",t),Mr.complete("findusers",t);break;case"FindMems":x(t,Qn()),re("_e",t),Mr.complete("findmems",t);break;case"On":{let{id:e,online:n}=t;if(!e)return;let r=Qn(e);r&&r.online(n);break}case"Ons":t.forEach((e=>Qn(e).online(!0)));break;case"Profile":Mr.complete("profile",t);break;case"Name":Mr.complete("name",t);break;case"Signup":Mr.complete("signup",t);break;case"ChatThread":Mr.complete("thread",t);break;case"ChatList":Mr.complete("list",t);break;case"Status":Mr.complete("status",t);break;case"Sdp":t.offer?async function({fr:e,sd:t,ca:n}){let r=Mr.create("ice"),a=await Ea(e),{a:i,k:o}=M(new Uint8Array(t)),{keypair:s,pub:l}=await Ca();o=await ge(o),a.sharedkey=await ye(s.privateKey,o);let u=(new TextDecoder).decode(sn(i));await a.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:u}));let c=await a.createAnswer();await a.setLocalDescription(c);for(const e of n){const t=new RTCIceCandidate({candidate:e,sdpMid:0,sdpMLineIndex:0});await a.addIceCandidate(t)}t=ln((new TextEncoder).encode(a.localDescription.sdp)),t=A(t,l),await r,bn.send(je.Sdp({fr:null,to:e,sd:t,ca:ka,offer:null}))}(t):Mr.complete("offer",t)}})),(e=>{jn.push(e)})((async e=>{Sr(e),Er(null);let t=xr();if(Ae.id()>0&&(t=[...t,Ae.id()]),await ra(t),"$"===e[0]){let[t,r,a]=e.slice(1).split("/");if(r.length<50)return location.hash="#",Ur(!1);let i=await Mr.create("unpack",bn.send(je.Unpack(r)));if(!i)return location.hash="#",Ur(!1);let o=await Mr.create("name",bn.send(je.Email(i)));switch(t){case"i":if(!o)return function(e,t){const r=n("Log in Telegram");let a={};function i(e){e.preventDefault();let{n:n,p:r}=e.target,i=n.value.trim();pa(F,i)&&pa(V,r.value)&&async function(e,t,n,r,a){await ne();const i=crypto.getRandomValues(new Uint8Array(12)),o=await Le(r,i);let s=await De(n,t),l=I(i,new Uint8Array(await ke(s,o,i))),u=B(),c={name:t,key:l,tz:u,tgid:a.id||null,tgname:a.username||null,tgfn:a.first_name||null,tgln:a.last_name||null};Ue(s),bn.send(je.NewUser(c))}(0,i,r.value,t,a)}function o(e){e.preventDefault(),window.Telegram.Login.auth({bot_id:"1850607378",request_access:!0},(e=>{e&&(S("username").value=e.username,r("Log in as "+e.first_name),a=e)}))}Dr.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Sign up"),p("div",{class:"sub"},e),p("form",{onsubmit:i},(()=>Pr(4,10,12)&&p("div",{class:"erm"},Lr())),p("input",{id:"username",type:"text",name:"n",placeholder:"Username",onkeypress:$,onkeyup:H,required:!0,autocomplete:"on",class:()=>Pr(4,10)&&"er"}),p("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>Pr(12)&&"er"}),p("script",{async:!0,src:"https://telegram.org/js/telegram-widget.js?15"}),p("div",null,p("button",{onclick:o},r)),p("div",{class:"bn"},p("button",{type:"submit"},"Sign up"))))),Ur(!0)}(i,a),Ee("login",(e=>e?location.hash="#":null));break;case"f":if(o&&(o==Ae.name()||!Ae.id()))return function(e,t,n){async function r(t){t.preventDefault();let{p:r}=t.target;if(pa(V,r.value)){let t=await ha(e,n,r.value);if(t)return jr(t);Ir("password updated"),Ur(!1),location.hash="#"}}Dr.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Reset password"),p("div",{class:"sub"},t),p("form",{onsubmit:r},(()=>Pr(12)&&p("div",{class:"erm"},Lr())),p("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on",class:()=>Pr(12)&&"er"}),p("div",{class:"bn"},p("button",{type:"submit"},"Submit"))))),Ur(!0)}(o,i,a)}return location.hash="#",Ur(!1)}if("/"===e[0]){let t=Ln.bton(e.slice(1));return qn(t),Rn([]),async function(e){ta.cb=null;let t=await Mr.create("thread",bn.send(je.ChatThread({i:e,kw:null,ub:null,lb:null})));await Nr(t,"re"),ta.cb=t=>async function(e,t){let n=await Mr.create("thread",bn.send(je.ChatThread({i:e,kw:null,ub:t,lb:null})));return Nr(n)}(e,t)}(t),la(),void await qr()}if("&"===e[0]){let t=Ln.bton(e.slice(1));return t==Ae.id()?location.hash="#":(Bn(0),qn(0),oa(0),Hn(0),Rr([]),Rn([]),await ra([t]),Er(t),await async function(e){let t=await(async(e,t,n,r=!0)=>{let a={value:e};return await se("_p",le,a,n,t,r,"prev")})(e);Tr(t.reverse())}(t),await qr(),!_r().has(t)&&Qn(t).online()&&Sa(t),void setTimeout((()=>la()||T()),100))}let r=["!","@","*"].indexOf(e[0]);if(r>-1)return Bn(0),Hn(0),qn(0),Rn([]),async function(e){ta.cb=null;let t=await Mr.create("list",bn.send(je.ChatList({i:e,kw:null,ub:null,lb:null})));await Nr(t,"re"),ta.cb=t=>async function(e,t){let n=await Mr.create("list",bn.send(je.ChatList({i:e,kw:null,ub:t,lb:null})));return Nr(n)}(e,t)}(r),la(),void await qr();if("%"===e[0])return location.hash="#"+Ln.ntob(Number(e.slice(1)));if(!e||!Un.includes(e[0]))return Bn(0),qn(0),oa(0),Hn(0),Rr([]),await qr(),na(),void(document.title="hyze - micro chat for team");let a=Ln.bton(e);if(await qr(),Bn(a),Hn(0),qn(0),na(),!Zn(a))return;let i=Zn(a).dir;Rr([...i,a]),oa(a),document.title=Zn(Bn()).fullname()+" - hyze"}));const Nr=async(e,t=null)=>{await Kr(e);let r=e[0],a=new Set,i=new Set,o=Rn(),s="re"===t?new Set:new Set(o);switch(e=e.filter((e=>{let t=Jn(e);if(!t)return!1;"function"!=typeof t.txt&&(t.txt=n(t.txt),t.star=n(t.star),t.first=n(!1),t.last=n(!1),t.firstre=n(!1),t.lastre=n(!1),t.showby=n(!1),t.nor=n(t.nor)),"string"==typeof t.timestamp&&(t.timestamp=new Date(t.timestamp)),Qn().has(t.by)||a.add(t.by),t.men&&t.men.forEach((e=>{Qn().has(e)||a.add(e)})),t.dir.forEach((e=>{Zn().has(e)||i.add(e)}));let r=s.has(e);return s.add(e),!r})),await Fr(a,i),e.reverse(),t){case"re":Rn(e);break;case"pre":Rn(o.concat(e));break;default:Rn(e.concat(o))}let l=Rn();for(let e=0;e<l.length;e++){let t=Jn(l[e-1])||{},n=Jn(l[e+1])||{},r=Jn(l[e]);r.showby(r.by!==t.by),r.first(r.chanid!==t.chanid),r.last(r.chanid!==n.chanid),r.firstre(r.re&&r.re!==t.re&&r.re!=t.id),r.lastre(r.re&&r.re!==n.re)}la(),r&&S(Ln.ntob(r)+"_").scrollIntoView()},Kr=async e=>{e=await zr(e),e=new Set(e.map((e=>Jn(e,"re"))).filter((e=>e>0&&!Jn().has(e)))),zr(Array.from(e))},zr=async e=>{if(0===(e=e.filter((e=>!Jn().has(e)))).length)return e;let{value:t,missed:n}=await oe("_t",e);if(E(t,Jn()),n.length>0){let e=await Mr.create("chats",bn.send(je.Chats(n)));E(e,Jn())}return e},Fr=async(e,t)=>{let n=await oe("_e",Array.from(e)),r=await oe("_h",Array.from(t));n.value.length&&bn.send(je.Ons(n.value.filter((e=>e.id!=Ae.id())).map((e=>e.id)))),x(n.value,Qn()),_(r.value,Zn()),n.missed.length>0&&Mr.create("users",bn.send(je.Users(n.missed))),r.missed.length>0&&Mr.create("chans",bn.send(je.Chans(r.missed)));let[a,i]=await Mr.joinall("users","chans");a&&x(a,Qn()),i&&_(i,Zn())},Rr=e=>{let t=e.map(((e,t)=>{let n=Zn(e)||{};return[t+1,n.mom,n.fullname,e]}));On.update(t)},Br=async e=>{if(0===(e=e.filter((e=>!Zn().has(e)))).length)return;let{value:t,missed:n}=await oe("_h",e);if(_(t,Zn()),n.length>0){let e=await Mr.create("chans",bn.send(je.Chans(n)));_(e,Zn())}};async function qr(e=null,t=null){if(0===er.childids().length||e){performance.now();let n=t?[]:await async function(){let e=await se("_h",(e=>[e.index("chatid"),null]));return _(e,Zn()),e.map((e=>e.id))}();n.length<1&&(n=await async function(e=null,t=null){t&&Wn(t);return Mr.create("scantree",bn.send(je.Tree({kw:t,reload:e})))}(e,t)),Hr(n)}}const $r=async(e,t=null,n=null)=>{performance.now(),qr(null,t);let r=await me(e,"_d")||null,a=await me(e,"_m")||null,i=await((e,t=null,n=null,r=null,a=null,i=null)=>{r&&Wn(r);let o=je.Shan({chanid:e,kw:r,ub:a,lb:i,cu:t,mu:n});return Mr.create("chanscan",bn.send(o))})(e,r,a,t,n);n?0===i.length||Fn(Fn().concat(i)):(0!==i.length||t||xe("nochan"),Fn(i));let o=Vr(e);o&&(Wr(Fn(),o.childs()),o.childids(Fn()))};function Hr(e,t=0){const n=e.filter((e=>Zn(e).mom==t));let r=Vr(t);r&&((Bn()==t||Bn()&&Zn(Bn())&&Zn(Bn()).dir.includes(t))&&r.open(!0),Wr(n,r.childs()),r.childids(n));for(const t of n)Hr(e,t)}function Vr(e){let t=e&&Zn(e)?[0,...Zn(e).dir,e]:[0],n=tr();var r,a;for(a=0;a<t.length;a++){let e=t[a];n.has(e)&&(r=n.get(e),n=r.childs())}return r}function Wr(e,t){return e.reduce(((e,t)=>(e.has(t)||e.set(t,{id:t,childids:n([]),childs:Kn(new Map),open:n(!1)}),e)),t)}const Yr=e=>$r(On.path(3),e),Gr=e=>{Yn(e),na(e)};const Xr=async({id:e,mom:t,name:n})=>{e!==Bn()&&On.cd([On.path(0)+1,t,n,e])},Zr=async e=>{bn.send(je.MuteChan(e))},Jr=async e=>{bn.send(je.UnmuteChan(e))};async function Qr(e){let t=Zn(e);t&&Zn().delete(e),t=await me(e,"_h"),t&&await(async({id:e,dir:t})=>{let n=await G.join();if(!n)return;let r=[0,...t,e];!function(e){e.forEach((async e=>{he(e)}))}(r),function(e){let t=n.transaction(["_c"],"readwrite").objectStore("_c");e.forEach((e=>{let n=IDBKeyRange.bound([e],[e,Number.MAX_VALUE]);t.delete(n).onerror=console.error}))}(r)})(t);let n=Fn(),r=n.indexOf(e);return r>-1&&(n.splice(r,1),Fn(n)),t}const ea=async e=>{let t=Yn()||null,n=Bn();performance.now();let r=await fe(n)||[];if(r[2]&&e===r[1])return void Gn(!0);if(Gn(!1),!t){let t=await ce(n,e,Nn);if(r[2]||t.length===Nn)return void await Nr(t)}let a=await((e=null,t=null,n=null)=>{let r=je.Shin({chanid:Bn(),kw:e,ub:t,lb:n,lu:null,cu:null,mu:null});return Mr.create("chatscan",bn.send(r))})(t,e);a.length>0&&await Nr(a)};let ta={cb:null};async function na(e=null){ta.cb=null,Gn(!1),$n(0);let t=Bn();performance.now();let n=await fe(t)||[],r=e?null:n[0]||null,a=await ce(t,null,Nn);await Nr(a,"re"),ta.cb=ea;let i={id:await me(t,"_u")||0,lo:n[1]||0},o=await me(t,"_d")||null,s=await me(t,"_m")||null,l=await((e=null,t=null,n=null,r=null,a=null,i=null)=>{let o=je.Shin({chanid:Bn(),kw:r,ub:a,lb:i,lu:e,cu:t,mu:n});return Mr.create("chatscan",bn.send(o))})(i,o,s,e,null,r)||[];await Nr(l,l.length!==Nn&&0!==a.length&&r?"pre":"re")}async function ra(e){let t=e.filter((e=>!Qn().has(e)));if(t.length){let{value:e,missed:n}=await oe("_e",t);if(x(e,Qn()),n.length>0){let e=await Mr.create("users",bn.send(je.Users(n)));e&&x(e,Qn())}bn.send(je.Ons(t.filter((e=>e!=Ae.id()))))}}async function aa(e,{action:t,chatid:n,txt:r}){switch(t){case 1:{let t=Jn(n);t&&t.txt(r),t=await me(n,"_t"),t&&(t.txt=r,await ie("_t",t),t.dir.forEach((t=>e.add(t))));break}case 2:let t=await ia(n);t&&t.dir.forEach((t=>e.add(t)))}}async function ia(e){let t=Jn(e);t&&Jn().delete(e),t=await me(e,"_t"),t&&await(async({id:e,dir:t})=>{let n=await G.join();if(!n)return;let r=[0,...t];!function(e,t){t.forEach((async t=>{let n=await fe(t);n&&n.includes(e)&&he(t)}))}(e,r),function(e,t){let r=n.transaction(["_c"],"readwrite").objectStore("_c");t.forEach((t=>{let n=IDBKeyRange.only([t,e]);r.delete(n).onerror=console.error}))}(e,r),function(...e){let t=n.transaction(["_t"],"readwrite").objectStore("_t");e.forEach((e=>{t.delete(e).onerror=console.error}))}(e)})(t);let n=Rn(),r=n.indexOf(e);return r>-1&&(n.splice(r,1),Rn(n)),la(),t}async function oa(e){if(!e)return nr([]);let t=Zn(e).md()<2?[...Zn(e).dir,e]:[e],{value:n,missed:r}=await oe("_n",t),a=[];if(r.length){let e=await Mr.create("memlist",bn.send(je.Mems(r)));for(const t of e){x(t.users,Qn()),re("_e",t.users);let e=t.users.map((e=>e.id));ve("_n",t.chanid,e),a=[...a,...e]}}let i=Array.from(new Set([...n.flat(),...a]));await ra(i),i.sort((e=>Qn(e).online()?-1:0)),nr(i)}async function sa(e){let t=await Mr.create("findmems",bn.send(je.FindMems({chanid:Hn()||Bn(),kw:e})));or(t);let n=t.find((t=>t.name===e));if(n)sr(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));sr(n?t.indexOf(n):0)}return t.length}function la(){if(!S("cs"))return;let e=window.innerHeight-S("cs").offsetHeight-(Ae.id()?96:64)-(dr()&&ur()?56:dr()?32:ur()?24:0),t=S("os");S("cs").childElementCount>2&&(e-=5),t.style.height=e>0?e+"px":"0"}function ua(){const e=Ae.id();let t=Qn(e);t?t.online(!0):Qn().set(e,{id:e,name:Ae.name(),tz:B(),online:n(!0)})}window.onresize=la,Ee("reconnected",(()=>{na(),$r(On.path(3))}));let ca=new Map;async function da(e){return bn.send(je.Au(e)),Ir("a secret 6-digits otp code has been sent to your registered email"),await Mr.create("enterotp",function(){let e=[...Array(6)].map((e=>p("input",{class:"ot",type:"tel",autocomplete:"chrome-off"}))),t=e[0];t.addEventListener("input",n),setTimeout((()=>t.focus()));for(let t=0;t<e.length;t++){let r=e[t];r.addEventListener("keypress",(function(n){n.keyCode>47&&n.keyCode<58&&(r.value=n.key,t!==e.length-1&&e[t+1].focus()),n.preventDefault()})),r.addEventListener("keydown",(function(n){"Backspace"===n.key&&(r.value="",0!==t&&e[t-1].focus())})),r.addEventListener("keyup",(function(t){if(16===t.keyCode||9==t.keyCode||224==t.keyCode||18==t.keyCode||17==t.keyCode)return;t.target.value.length>1&&n(t);let r=e.map((e=>e.value)).join("");r.length===e.length&&Mr.complete("enterotp",r)}))}function n(e){let t=e.data||e.target.value;t&&1!==t.length&&r(e.target,t)}function r(e,t){e.focus(),e.value=t[0],t=t.substring(1),e.nextElementSibling&&t.length&&r(e.nextElementSibling,t)}Dr.content=p("div",{class:"pi"},p("div",{class:"su otp"},p("div",{class:"head"},"Enter OTP code"),p("div",{class:"sub"},"Please enter the 6-digits code sent to your email"),p("div",{id:"otp"},e))),Ur(!0)}())}async function fa(e,t,n){Zn().clear(),Jn().clear(),Qn().clear(),nr([]),await ne();const r=crypto.getRandomValues(new Uint8Array(12)),a=await Le(n,r);let i=await De(t,e),o={name:e,key:I(r,new Uint8Array(await ke(i,a,r))),tz:B()};Ue(i),bn.send(je.Login(o))}async function ha(e,t,n,r=null){const a=crypto.getRandomValues(new Uint8Array(12)),i=await Le(t,a);let o=r?new Uint8Array(await De(r,e)):null,s=await De(n,e),l=I(a,new Uint8Array(await ke(s,i,a)));return Ue(s),Mr.create("pwd",bn.send(je.Pwd({key:l,okey:o})))}function pa(e,...t){let n=e(...t);return!n||jr(n)}function ma(){Dr.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Sign up"),p("div",{class:"sub"},"We will send a sign up invitation to your email"),p("form",{onsubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();if(z(n)){let e=await Mr.create("signup",bn.send(je.Signup(n)));if(e)return jr(e);Ir(`an invite code has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Ur(!1)}else jr(7)}},(()=>Pr(3,7)&&p("div",{class:"erm"},Lr())),p("input",{type:"text",name:"m",placeholder:"Your email address",onkeypress:q,onkeyup:H,required:!0,autocomplete:"on",class:()=>Pr(3,7)&&"er"}),p("div",{class:"bn"},p("button",{type:"submit"},"Sign up"))))),Ur(!0)}function va(){Dr.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Log in"),p("div",{class:"sub"}),p("form",{onsubmit:async function(e){e.preventDefault();let{m:t,p:n}=e.target,r=t.value.trim();if(z(r))return async function(e,t){let n=ca.has(e)?ca.get(e):await Mr.create("name",bn.send(je.Email(e)));if(ca.set(e,n),!n)return jr(2);fa(n,t,await da(n))}(r,n.value);if(pa(F,r)){let e=await da(r);fa(r,n.value,e)}}},(()=>Pr(7,10)&&p("div",{class:"erm"},Lr())),p("input",{type:"text",name:"m",placeholder:"Username or email",onkeypress:q,onkeyup:H,required:!0,autocomplete:"on",class:()=>Pr(7,10)&&"er"}),p("input",{type:"password",name:"p",placeholder:"Password",required:!0,autocomplete:"on"}),p("div",{class:"lf fp"},p("a",{onclick:wa},"Forgot password")),p("div",{class:"bn"},p("button",{type:"submit"},"Log in"))))),Ur(!0)}function wa(){Dr.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Forgot password"),p("div",{class:"sub"},"We will send a password reset link to your email"),p("form",{onsubmit:async function(e){e.preventDefault();let{m:t}=e.target,n=t.value.trim();z(n)?(Mr.create("forgotpwd",bn.send(je.Fp(n))),Ir(`a password reset link has been sent to ${n}, it should arrive shortly, you might have to check your spam folder`),Ur(!1)):jr(7)}},(()=>Pr(7)&&p("div",{class:"erm"},Lr())),p("input",{type:"text",name:"m",placeholder:"Your email address",onkeypress:q,onkeyup:H,required:!0,autocomplete:"on",class:()=>Pr(7)&&"er"}),p("div",{class:"bn"},p("button",{type:"submit"},"Submit"))))),Ur(!0)}Ee("config",(async({d:e})=>{e?(ua(),_n()):Ae.id()&&(Hn(0),Qn(Ae.id())&&Qn(Ae.id()).online(!1),Ae.id(0),Ae.name(null),Ae.chans([]),delete Ae.sskey,delete Ae.salt,await ne(),er.childids([]),On.ishome()?(na(),qr()):On.home())})),Ee("subs",(function(e){bn.send(je.PushSubs({endpoint:e.endpoint,auth:e.keys.auth,p256dh:e.keys.p256dh}))}));const ya=e=>{Hn()!==e?Hn(e):Hn(0),oa(Hn()||Bn()),$n(0)};const ga=async e=>{const t=Jn(e);t&&t.nor(t.nor()+1);const n=await me(e,"_t");n&&(n.nor=t.nor(),await ie("_t",n))};async function ba(e){return Mr.create("status",bn.send(je.Status(e)))}let ka=[];async function Ca(){const e=await be(),t=await crypto.subtle.exportKey("raw",e.publicKey);return{keypair:e,pub:new Uint8Array(t)}}async function Sa(e){let t=Mr.create("ice"),n=await Ea(e),r=await n.createOffer();await n.setLocalDescription(r);let a=ln((new TextEncoder).encode(n.localDescription.sdp)),{keypair:i,pub:o}=await Ca();a=A(a,o),await t;let s=await Mr.create("offer",bn.send(je.Sdp({fr:null,to:e,sd:a,ca:ka,offer:!0}))),{a:l,k:u}=M(new Uint8Array(s.sd));u=await ge(u),n.sharedkey=await ye(i.privateKey,u);let c=(new TextDecoder).decode(sn(l));n.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:c}));for(const e of s.ca){const t=new RTCIceCandidate({candidate:e,sdpMid:0,sdpMLineIndex:0});await n.addIceCandidate(t)}}async function Ea(e){await ra([e]);let t=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});_r().has(e)||xr.add(e),_r().set(e,t),t.onicecandidate=e=>{e.candidate?ka.push(e.candidate.candidate):Mr.complete("ice",ka)},t.onconnectionstatechange=e=>{};let n=t.createDataChannel("p",{negotiated:!0,id:1});return n.binaryType="arraybuffer",n.onopen=e=>{},n.onmessage=async({data:n})=>{let r=R(),a=new Uint8Array(n),i=a.subarray(0,12);a=new Uint8Array(await Ce(a.subarray(12),t.sharedkey,i)),U(a,i);let o=on(sn(a));o.by=e,o.ts=new Date,o.room=e,(Tr.last()||{}).by!=e&&(o.showby=!0),o.id=await ie("_p",o),Er()==e&&Tr.add(o),r&&setTimeout(T),la()},n.onclose=t=>{var n,r;setTimeout((()=>{if(Qn(e).online())return Sa(e)}),(n=1e3,r=5e3,Math.random()*(r-n)+n))},n.onerror=e=>{},t.send=async e=>{let r=ln(an(e));const a=crypto.getRandomValues(new Uint8Array(12));U(r,a),r=I(a,new Uint8Array(await ke(r,t.sharedkey,a))),n.send(r)},t.open=()=>"open"===n.readyState,t}function xa({id:e},t){if(!e||$n()===e)return $n(0);t.focus(),$n(e)}var _a=function(){var e=document.createElement("div");e.contentEditable="true",e.className="s-c",e.oninput=b((function(){var t=e.textContent;t&&t.length>50||(Yr(t),Gr(t))}),200),e.onkeydown=function(e){"Enter"!==e.key||e.shiftKey||e.preventDefault()};var t=document.createElement("div");return setTimeout((function(){new IntersectionObserver((function(t){if(!(t[0].intersectionRatio<=0)){var n=Vr(Bn()).childids(),r=n[n.length-1];if(!(!r||Xn()||n.length<Nn)){var a=e.textContent||null;a&&a.length>50||setTimeout((function(){return $r(On.path(3),a,r)}))}}}),{}).observe(t)})),p("div",{class:"cn"},p("div",{class:"s"},e),p("div",{class:"tbl"},p("table",null,p("tbody",null,(function(){return Tn(Vr(Bn()).childids,(function(e){var t=Zn(e);return p("tr",{onClick:function(){return Xr(t)}},p("td",null,p("button",{onClick:function(t){return function(e,t){if(e.stopPropagation(),!Ae.id())return va();Ae.chans().includes(t)?Jr(t):Zr(t)}(t,e)}},(function(){return Ae.chans().includes(e)?"➕":"➖"}))),p("td",null,t.fullname))}))}),t))))};function Ta(e,t,n,r){return new(n||(n=Promise))((function(a,i){function o(e){try{l(r.next(e))}catch(e){i(e)}}function s(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,s)}l((r=r.apply(e,t||[])).next())}))}function Ua(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function Aa(e,t){for(var n=0,r=t.length,a=e.length;n<r;n++,a++)e[a]=t[n];return e}const Ma="formatBlock",Da=(e,t)=>e.appendChild(t),La=e=>document.createElement(e),Pa=e=>document.queryCommandState(e),Oa=(e,t=null)=>document.execCommand(e,!1,t),ja=[{icon:"<b>B</b>",title:"Bold",state:()=>Pa("bold"),result:()=>Oa("bold")},{icon:"<i>I</i>",title:"Italic",state:()=>Pa("italic"),result:()=>Oa("italic")},{icon:"<u>U</u>",title:"Underline",state:()=>Pa("underline"),result:()=>Oa("underline")},{icon:"<strike>S</strike>",title:"Strike-through",state:()=>Pa("strikeThrough"),result:()=>Oa("strikeThrough")},{icon:"&#8220&#8221;",title:"Quote",result:()=>Oa(Ma,"<blockquote>")},{icon:"&lt;&gt;",title:"Code",result:()=>Oa(Ma,"<pre>")},{icon:"&#128279;",title:"Link",class:" lk",result:()=>{const e=window.prompt("Enter the link URL");e&&Oa("createLink",e)}},{icon:"🌁",title:"Image",class:" im",result:()=>{const e=window.prompt("Enter the image URL");e&&Oa("insertImage",e)}},{icon:"⏎",title:"Enter to send",class:" en se",result:e=>(mr()?mr(!1):mr(!0),mr()?e.classList.add("se"):e.classList.remove("se"),!0)}],Ia="e-b",Na="e-bs";let Ka="",za=0,Fa=!1,Ra=n(!1);const Ba=()=>S("tp"),qa=()=>S("pm"),$a=()=>S("mb"),Ha=e=>{za=C();let t=e.textContent,n=t.indexOf(" ",za);-1==n&&(n=t.length);var r=/[\S]+$/.exec(t.slice(0,n));return r?r[0]:""},Va=({id:e,name:t})=>{or([]),sr(0);let n=lr();if(n.spellcheck=!1,n===$a()){let r=Ka?"@"+t:t;n.textContent=Ka?((e,t)=>{let n=e.textContent,r=n.indexOf(" ",za);-1==r&&(r=n.length);var a=n.slice(0,r).replace(/\S+$/,t);return za=a.length,a+n.slice(r)})(n,r):n.textContent+r,n.focus(),Ka?function(e,t){var n=document.createRange(),r=window.getSelection();n.setStart(e.childNodes[0],t),n.collapse(!0),r.removeAllRanges(),r.addRange(n)}(n,za):k(),Ra(!1),e&&pr.add(e)}else e?fr.add(e):hr.add(Ka),n.textContent="",qa().focus()},Wa=()=>p("div",{id:"uls",class:function(){return"uls"+(()=>lr()===$a()&&dr()?" ms":"").call(this)}},p("ul",null,Tn(or,(e=>p("li",{id:e.id,tabIndex:"-1",class:()=>or()[sr()]===e?"se":"",onclick:()=>Va(e),onMouseOver:()=>Fa||sr(or().indexOf(e))},e.id?p("i",{class:function(){return"dot"+(()=>Qn(e.id).online()?" on":"").call(this)}}):null," ",e.name))))),Ya=()=>p("div",{class:function(){return"em sel"+(()=>dr()?" sh":"").call(this)},onclick:()=>qa().focus()},Tn(hr,(e=>p("div",{class:"tg ie"},e,p("i",{onclick:()=>hr.delete(e)},"✕")))),Tn(fr,(e=>p("div",{class:()=>Qn(e).online()?"tg on":"tg"},Qn(e).name,p("i",{onclick:()=>fr.delete(e)},"✕")))),p("div",{class:"wp"},p("div",{id:"pm",class:"e-m"+(hr().length+fr().length===0?" to":""),onkeydown:Ga,oninput:Ja,contentEditable:"true"}),(()=>lr()===qa()&&dr()&&or().length>0&&Wa)));function Ga(e){if(!Xa(e)){if(8!=e.keyCode||qa().textContent.length||(fr.pop(),qa().focus()),32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return e.preventDefault(),!1;"Enter"!==e.key&&"Tab"!==e.key||($a().focus(),e.preventDefault())}}function Xa(e){return!!or().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(Va(or()[sr()]),e.preventDefault(),!0):27==e.keyCode?(or([]),sr(),Ra(!1),!0):(38==e.keyCode&&(0===sr()?sr(or().length-1):sr(sr()-1),S(or()[sr()].id).focus(),e.preventDefault(),Fa=!0,setTimeout((()=>Fa=!1),300)),40==e.keyCode&&(sr()===or().length-1?sr(0):sr(sr()+1),S(or()[sr()].id).focus(),e.preventDefault(),Fa=!0,setTimeout((()=>Fa=!1),300)),e.target.focus(),!0))}const Za=b((async e=>{if(Ka=Ha(e.target).toLowerCase(),Ka.length>50)return;let t=await sa(Ka),n=Zn(Hn()||Bn()),r=n&&n.md()<2;!t&&z(Ka)&&r&&or([{id:0,name:"✉️ Invite "+Ka}])}),100);function Ja(e){lr(qa()),Za(e)}const Qa=()=>{if(!Ae.id())return null;if(Ar()&&Jn(Ar())&&Hn()==Jn(Ar()).chanid)return null;let e=Zn(Hn());if(!e)return null;R()&&setTimeout(T,50);const t=()=>[...e.dir.slice(On.len()-2),e.id];return t().length>0&&p("div",{class:"dr",style:()=>"background:"+K(e.id)},Tn(t,(e=>p("span",null,p("a",{href:"#"+Ln.ntob(e),innerHTML:Zn(e,"fullname")})))))},ei=()=>p("div",{id:"tp",class:function(){return"e-t"+(()=>ur()?" sh":"").call(this)},onkeyup:ni,onkeydown:ti,contentEditable:"true"}),ti=e=>{e.target.spellcheck=!1,"Enter"===e.key&&e.preventDefault()},ni=e=>{cr(e.target.textContent),"Enter"===e.key&&($a().focus(),e.preventDefault())},ri=()=>!(Hn()||Bn()||dr()||ur()),ai=()=>Ae.id()?ri()?" ds":"":" hd",ii=()=>p([p("style",null,".e-c[contenteditable]:empty::before { content: '",(()=>{let e,t=`Send a ${dr()?"private ":""}message `;return Hn()?e=Zn(Hn()):Bn()&&(e=Zn(Bn())),e?t+(ur()?`on new topic ${cr()?`"${cr()}" `:""}in "${e.fullname()}"`:`in "${e.fullname()}"`):ur()?t+"on new topic "+(cr()?`"${cr()}"`:""):t+"..."}),"'; }"),()=>lr()===$a()&&Ra()&&or().length>0&&Wa,p("div",{id:"mb",class:"e-c",onkeydown:si,oninput:li,onfocus:oi,contentEditable:"true"})]),oi=()=>{if(0!==Rn().length)return ri()?(Hn(Jn(Ar()).chanid),void oa(Hn())):Hn()||dr()||ur()?void 0:(Hn(Jn(Ar()).chanid),void oa(Hn()))},si=e=>{if(lr($a()),"@"===e.key&&Ra(!0),!Xa(e)&&"Enter"===e.key){if(e.preventDefault(),mr()&&!e.shiftKey)return void async function(e,t){if(!Ae.id())return jr(1);if(e.innerHTML.length>120)return jr(11);if(t.innerHTML.length>4e3)return jr(11);if(!t.innerHTML.trim())return;if(Er()){if(!Qn(Er()).online())return jr(15);if(!_r(Er()).open())return jr(16);let e={txt:t.innerHTML.trim()};return _r(Er()).send(e),e.by=Ae.id(),e.ts=new Date,e.room=Er(),(Tr.last()||{}).by!=Ae.id()&&(e.showby=!0),e.id=await ie("_p",e),Tr.add(e),t.textContent="",void la()}let n=Hn()||Bn(),r=$n()||qn()||null,a=null;if(e.textContent!==Vn()&&(a=e.textContent,!a.trim().length))return jr(6);if(!(n||dr()||a&&a.trim().length))return jr(5);let i=t.innerHTML.trim(),o=null,s=null,l=null;dr()&&(fr().length>0&&(o=fr.add(Ae.id()).sort(((e,t)=>e-t))),hr().length>0&&(s=hr())),pr().length>0&&(l=pr().filter((e=>i.indexOf("@"+Qn(e).name)>-1))),bn.send(je.NewChat({txt:i,chanid:n,re:r,chname:a,men:l,to:o,emails:s})),ur(!1),dr(!1),e.textContent="",t.textContent="",cr(""),Vn(""),xa({},t)}(Ba(),$a());e.target.textContent+="\n\n",k()}},li=e=>{$a().spellcheck=!1,Ra()&&ui(e)},ui=b((e=>{(Ka=Ha(e.target).toLowerCase(),Ka.startsWith("@"))?(Ka=Ka.replace(/[@'";:,.\/?\\-]/,""),Ka.length>50||sa(Ka)):Ra(!1)}),100),ci=p("div",{class:"e-a"});ja.forEach((e=>{const t=La("button");if(t.className=Ia+" eb",e.class&&(t.className+=e.class),t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=n=>e.result(t)&&$a().focus(),e.state){n="click",r=()=>t.classList[e.state()?"add":"remove"](Na),t.addEventListener(n,r)}var n,r;Da(ci,t)}));const di=La("button");di.className=Ia+" md",di.innerHTML="👤",di.title="Private message",di.setAttribute("type","button");const fi=()=>{if(!Ae.id())return va();let e=R();di.classList.add("se"),dr(!0),e&&setTimeout(T),la(),"ontouchstart"in document.documentElement||qa().focus()};di.onclick=()=>dr()?(di.classList.remove("se"),dr(!1),void la()):fi();const hi=La("button");hi.className="ntb",hi.innerHTML="✏️ New Topic",hi.title="New topic",hi.setAttribute("type","button"),hi.onclick=e=>{if(!Ae.id())return va();let t=R();ur()?ur(!1):ur(!0),t&&ur()&&setTimeout(T),function(e,t){if(ur(e),la(),e?hi.classList.add("se"):hi.classList.remove("se"),"ontouchstart"in document.documentElement)return;e&&Ba().focus();t&&(Ba().innerText=t,cr(t))}(ur())},Da(ci,hi),Da(ci,di),Oa("defaultParagraphSeparator","div");const pi=()=>p("div",{class:function(){return"e"+ai.call(this)}},(()=>$n()?p("div",{class:"re",style:()=>"color:"+K($n())},p("i",null,"→"),p("b",null,Qn(Jn($n()).by).name)," ",p("a",{href:"#/"+Ln.ntob($n())},Jn($n()).txt)):null),Qa,ei,Ya,ii,ci),mi=(e,t)=>{let n=S(e+"_").querySelector(".ct");if("true"===n.contentEditable)return n.contentEditable=!1,n.classList.remove("ce"),n.innerHTML=t.txt(),void(n.onclick=()=>!1);n.spellcheck=!1,n.contentEditable=!0,n.classList.add("ce"),n.focus(),n.onclick=e=>{"true"===n.contentEditable&&e.stopPropagation()},n.onkeydown=e=>{if("Tab"===e.key)return document.execCommand("insertHTML",!1,"&#09"),e.preventDefault();if("Escape"===e.key)return n.contentEditable=!1,n.classList.remove("ce"),void(n.innerHTML=t.txt());if("Enter"===e.key){let i=n.innerHTML.trim();e.shiftKey||(e.preventDefault(),n.contentEditable=!1,n.classList.remove("ce"),i!==t.txt()&&(r=t.id,a=i,bn.send(je.EditChat({id:r,txt:a}))))}var r,a}};var vi="6ec33f5",wi="0.0.329";function yi(e){e.id;var t=e.name;return Ta(this,void 0,void 0,(function(){function e(e){e.preventDefault();var t=e.target.n,n=t.value.trim()==r?null:t.value.trim(),i=S("ab").textContent.trim(),o=function(e,t){return e&&e.length<2?10:t&&t.length>1e3?11:0}(n,i=i==(a||"")?null:i);0===o?(!function(e,t,n=null){Mr.create("saveprofile",bn.send(je.EditProfile({fullname:e,about:t,email:n})))}(n,i),Ur(!1)):jr(o)}var n,r,a;return Ua(this,(function(i){switch(i.label){case 0:return[4,Mr.create("profile",bn.send(je.Profile))];case 1:return n=i.sent(),r=n.fullname,a=n.about,Dr.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Profile"),p("div",{class:"sub"},t),p("form",{onSubmit:function(t){return e(t)}},(function(){return Pr(10,11)&&p("div",{class:"erm"},Lr())}),p("input",{value:r,type:"text",name:"n",placeholder:"Full name",required:!0,class:function(){return Pr(10)&&"er"}}),p("div",{id:"ab",class:"ab",contentEditable:!0},a),p("div",{class:"bn"},p("button",{type:"submit"},"Save"))))),Ur(!0),[2]}}))}))}var gi,bi=function(e,t){return Ta(void 0,void 0,void 0,(function(){function r(e){var n=e.target.textContent;if(n&&n.length>50)return jr(11);var r=n&&n.trim().length?n:null,a=B(),i=Qn(t).otz!=a?a:null;Qn(t).tz(a),Qn(t).st(r),function(e){bn.send(je.EditStatus(e))}({st:r,tz:i})}var a,i,o;return Ua(this,(function(s){switch(s.label){case 0:return Ae.id()?(e.stopPropagation(),Qn(t).st?[3,2]:[4,ba(t)]):[2];case 1:a=s.sent(),i=a.st,o=a.tz,Ae.id()==t&&(Qn(t).otz=o,o=B()),Qn(t).st=n(i),Qn(t).tz=n(o),s.label=2;case 2:return Dr.content=p("div",{class:"pi"},p("div",{class:"ui"},p("div",{class:"un"},p("i",{class:function(){return"do"+(Qn(t).online()?" on":"")}}),p("b",{style:function(){return Qn(t).online()?"color:"+K(Qn(t).name):""}},Qn(t).name)),t!==Ae.id()?p("div",{style:"font-size:12px"},Qn(t).st):p("div",{class:"st",contentEditable:!0,onBlur:r},Qn(t).st)),p("hr",null),(function(){return Qn(t).tz()&&p("div",{class:"sub"},p("i",null,"🕑")," Local time ",function(e){return(new Date).toLocaleTimeString(Intl.DateTimeFormat().resolvedOptions().locale,{timeZone:e,hour:"numeric",minute:"2-digit"})}(Qn(t).tz()))}),t!==Ae.id()?p("div",null,p("div",{class:"bt"},p("i",{class:"fl"},"💬")," ",p("a",{onClick:function(){return function(e){Ur(!1),fi(),fr([e]),$n(0)}(t)}},"Send private message")),p("div",{class:"bt"},p("i",null,"@")," ",p("a",{onClick:function(){return function(e){if(Ur(!1),!Ae.id())return va();$a().innerHTML+="@"+Qn(e).name,$a().focus(),k($a()),pr.add(e)}(t)}},"Mention ",p("b",null,Qn(t).name))),Qn(t).online()&&p("div",{class:"bt"},p("i",{class:"fl"},"↔"),p("a",{onClick:function(){Ur(!1),location.hash="#&"+Ln.ntob(t)}},"Send direct p2p message"))):p("div",null,p("div",{class:"bt",onClick:function(){return yi(Qn(t))}},p("i",null,"✏️")," ",p("a",null,"Edit profile")),p("div",{class:"bt",onClick:function(){return function(e){var t=e.name;Dr.content=p("div",{class:"pi"},p("div",{class:"su"},p("div",{class:"head"},"Change Password"),p("div",{class:"sub"},t),p("form",{onSubmit:function(e){return Ta(this,void 0,void 0,(function(){var n,r,a,i,o;return Ua(this,(function(s){switch(s.label){case 0:return e.preventDefault(),n=e.target,r=n.o,pa(V,(a=n.p).value,r.value)?[4,da(t)]:[3,3];case 1:return i=s.sent(),[4,ha(t,i,a.value,r.value)];case 2:if(o=s.sent())return[2,jr(o)];Ir("password updated"),Ur(!1),s.label=3;case 3:return[2]}}))}))}},(function(){return Pr(12,13,14)&&p("div",{class:"erm"},Lr())}),p("input",{type:"password",name:"o",placeholder:"Old password",required:!0,autocomplete:"true",class:function(){return Pr(13)&&"er"}}),p("input",{type:"password",name:"p",placeholder:"New password",required:!0,autocomplete:"true",class:function(){return Pr(12,14)&&"er"}}),p("div",{class:"bn"},p("button",{type:"submit"},"Submit"))))),Ur(!0)}(Qn(t))}},p("i",null,"🔒")," ",p("a",null,"Change password")),p("div",{class:"bt",onClick:function(){return async function(){Hn(0),nr([]),Qn(Ae.id()).online(!1),Zn().clear(),Jn().clear(),await bn.send(je.Logout(Ae.salt)),await ne(),Te({d:!1}),Ur(!1),xe("logout")}()}},p("i",null,"🚪")," ",p("a",null,"Sign out")),p("div",{class:"v"},wi," ",vi))),Ur(!0),[2]}}))}))},ki=function(e,t){if(e.shiftKey)return function(e,t){var n=screen.width/2-300,r=screen.height/2-300;window.open(e,t,"toolbar=yes,location=yes,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=600,height=600,top="+r+",left="+n)}("#"+Ln.ntob(t),t),e.preventDefault();ya(t),e.stopPropagation()},Ci=function(){var e=n(0),t=n(0),r=!1,a=function(n){var a=n.id,o=n.txt,s=n.by,l=n.chanid,u=n.star,c=n.men,d=n.timestamp,f=n.showby,h=n.first,v=n.firstre,w=n.last,y=n.lastre,g=n.re,b=n.nor,k=Ln.ntob(a);function C(){return["ct"].join(" ")}return p("div",{id:k+"_",class:function(){return"c"+($n()===a||t()==a?" cur":"")+(Hn()>0&&Hn()!==l?" bl":"")+(((new Date).getTime()-d.getTime())/1e3<60?" nc":"")+(g||b()?" r":"")+(h()||v()&&g!=qn()?" fr":"")+(w()||y()&&g!=qn()?" lr":"")},onClick:function(e){return function(e,t){"ontouchstart"in document.documentElement||ya(t.chanid)}(0,n)},onTouchEnd:function(e){return function(e,t){r||ya(t.chanid)}(0,n)},onMouseOver:function(){return e()!==a&&e(a)},style:function(){return"border-color:"+K(g||(b()?a:l))}},(function(){return v()&&g!=qn()&&Jn(g)?p("div",{class:"re",style:function(){return g||b()?"color:"+K(g||a):""},onMouseOver:function(){return t()!==g&&t(g)},onMouseOut:function(){return t(0)}},p("i",null,"→"),p("b",null,Qn(Jn(g,"by"),"name")),p("a",{href:"#/"+Ln.ntob(g),onClick:function(e){return e.stopPropagation()}},Jn(g,"txt"))):null}),(function(){return f()||h()||v()?p("div",null,p("a",{class:function(){return"by"+(Qn(s).online()?" on":"")},style:function(){return Qn(s).online()?"color:"+K(Qn(s).name):""},onClick:function(e){return bi(e,s)}},Qn(s).name)):null}),p("div",{class:function(){return u()?" star":""},style:function(){return b()?"color:"+K(a):""}},(function(){var e=o();if(c&&c.length)for(var t=0,n=c;t<n.length;t++){var r=n[t],a=Qn(r).name,i=Ae.id()==r?"j":Qn(r).online()?"k":"i",s=Qn(r).online()?'style="color:'+K(a)+'"':"";e=e.replaceAll("@"+a,'<b onclick="b('+r+')" class="'+i+'" '+s+">@"+a+"</b>")}return m(gi||(gi=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}(["<div class="," innerHTML="," />"],["<div class="," innerHTML="," />"])),C,e)}),(function(){return b()&&a!=qn()?p("p",{class:"mr"},p("i",null,"→"),p("a",{href:"#/"+k,onClick:function(e){return e.stopPropagation()}},b()+(b()>1?" replies":" reply"))):null})),(function(){return e()===a&&Ae.id()?i(k,n):null}))},i=function(e,t){var n,r,a,i=function(e){e.preventDefault(),e.stopPropagation();var n=R();xa(t,$a()),$n()===t.id?Hn(t.chanid):Hn(0),n&&setTimeout(T)};return p("div",null,p("div",{class:"ts"},(n=t.timestamp,r=6e4,(a=new Date-n)<r?Math.round(a/1e3)+"s":a<36e5?Math.round(a/r)+"m":n.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{hour:"numeric",minute:"2-digit"}))),p("div",{class:"pm pr",title:"reply",onTouchEnd:i,onClick:i},p("i",null,"→"),p("div",{class:"pu"},p("div",null,"reply"))),p("div",{class:"pm",onClick:function(e){return e.stopPropagation()}},p("i",{class:"i"},"..."),p("div",{class:"pu"},p("div",{onClick:function(e){return(async e=>{e.star(!e.star()),bn.send(je.Star(e.id));const t=await me(e.id,"_t");t&&(t.star=e.star(),await ie("_t",t))})(t)}},"⭐ ",t.star()?"unstar":"star"),p("div",{onClick:function(n){return mi(e,t)}},"✏️ edit"),p("div",{onClick:function(e){return o(t)}},"🗑️ trash"))))},o=function(e){var t=e.id,n=e.txt;confirm('Do you want to delete this chat? \n"'+n()+'"')&&function(e){bn.send(je.DelChat(e)),ia(e)}(t)},s=document.createElement("div");return setTimeout((function(){new IntersectionObserver((function(e){e[0].intersectionRatio<=0||ta.cb&&(!Rn()[0]||Gn()||Rn().length<Nn||setTimeout((function(){if(ta.cb){var e=Rn()[0];!e||Gn()||Rn().length<Nn||ta.cb(e)}})))}),{}).observe(s)})),setTimeout((function(){S("cs").addEventListener("touchstart",(function(e){return r=!1}),{passive:!0}),S("cs").addEventListener("touchmove",(function(e){return r=!0}),{passive:!0})})),p("div",null,p("div",{id:"os"}),p("div",{id:"cs"},s,(function(){var e=[],t=0,r=null;return Rn().reduce((function(e,a){return W(Jn(a).timestamp,r)?Jn(a).chanid!=t?(t=Jn(a).chanid,e.push(n([a])),e):(e[e.length-1]().push(a),e):(r=Jn(a).timestamp,e.push(n(r)),t=Jn(a).chanid,e.push(n([a])),e)}),e),Tn(n(e),(function(e){var t=e();if(t instanceof Array){var n=Jn(e()[0]);return p("div",null,p("div",{class:"tn"},(function(){return function(e){var t=Zn(e);if(!t)return null;var n=function(){return Aa(Aa([],t.dir.slice(On.len()-2)),[t.id])};return n().length>0&&p("div",{class:"dr",style:function(){return"background:"+K(e)}},Tn(n,(function(e){return p("span",null,p("a",{href:"#"+Ln.ntob(e),onClick:function(t){return ki(t,e)}},Zn(e,"fullname")))})))}(n.chanid)}),p("div",{class:"ts"},n.timestamp.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))),Tn(e,(function(e){return Jn(e)&&a(Jn(e))})))}return p("div",{class:"date"},function(e){let t=new Date;return W(e,t)?"Today":(t.setDate(t.getDate()-1),W(e,t)?"Yesterday":e.toLocaleString(Intl.DateTimeFormat().resolvedOptions().locale,{month:"short",day:"numeric"}))}(t))}))}),(function(){return Qn(Er())?p("div",null,p("div",{class:"tn"},p("div",{class:"dr",style:function(){return"background:"+K(Qn(Er()).name)}},p("span",null,p("a",null,"↔ ",Qn(Er()).name)))),Tn(Tr,(function(e){var t=e.by,n=e.txt,r=e.showby;return Qn(t)?p("div",{class:"c",style:function(){return"border-color:"+K(Qn(Er()).name)}},(function(){return r?p("div",null,p("a",{class:function(){return"by"+(Qn(t).online()?" on":"")},style:function(){return Qn(t).online()?"color:"+K(Qn(t,"name")):""},onClick:function(e){return bi(e,t)}},Qn(t,"name"))):null}),p("div",null,n)):p("div",null)}))):null})),pi)};const Si=[["","All messages"],["!","Private messages"],["@","Mentions"],["*","Stars"]],Ei=()=>{const e=document.createElement("div");e.contentEditable=!0,e.className="s-c",e.oninput=b((t=>{let n=e.textContent;n.length>50||(Yr(n),Gr(n))}),200),e.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||e.preventDefault()};const t=e=>p("ul",null,Tn(e.childids,(n=>{let r=e.childs(n);return p([p("li",{class:()=>function(e){return[Ae.chans().includes(e)?"":"on",e==Bn()?"se":""].join(" ")}(n),onclick:()=>function(e,t){e.open(!e.open()),Xr(t)}(r,Zn(n))},p("div",{class:"sb"},p("i",null,(()=>r.childids().length?r.open()?"▼":"▶":""))),p("div",{class:"lb"},(()=>function(e){return Zn(e,"md")&&Zn(e,"md")()>1?"🔒":""}(n))," ",Zn(n,"fullname")),p("div",{class:"dot",onclick:e=>((e,t)=>{if(e.stopPropagation(),!Ae.id())return va();Ae.chans().includes(t)?Jr(t):Zr(t)})(e,n)})),()=>r.open()&&r.childids().length?t(r):null])})));return p([p("div",{class:"dn n"},p("i",{onclick:()=>xe("lnclose")},"✕")),p("div",{class:"s"},e),Ae.id()?p("ul",{class:"hm"},(()=>Si.map((e=>p("li",{class:(Sr()[0]||"")==e[0]&&"se",onclick:()=>location.hash=e[0]},e[1]))))):null,Tn(xr,(e=>p("div",null,p("div",{class:"tn"},p("div",{class:"dr",style:()=>"background:"+K(Qn(e,"name"))},p("span",null,p("a",{href:"#&"+Ln.ntob(e)},"↔ ",Qn(e,"name")))))))),p("div",{class:"nt"},(()=>er.childids().length?t(er):null))])};let xi="",_i=0,Ti=!1;const Ui=()=>{const e=b((async e=>{if(xi=(e=>{_i=C();let t=e.textContent,n=t.indexOf(" ",_i);-1==n&&(n=t.length);var r=/[\S]+$/.exec(t.slice(0,n));return r?r[0]:""})(e.target).toLowerCase(),xi&&xi.length>50)return;!await async function(e){let t=await Mr.create("findusers",bn.send(je.FindUsers(e)));ir(t);let n=t.find((t=>t.name===e));if(n)sr(t.indexOf(n));else{let n=t.find((t=>t.name.startsWith(e)));sr(n?t.indexOf(n):0)}return t.length}(xi)&&z(xi)&&ir([{id:0,name:"✉️ Invite "+xi}])}),100),t=p("div",{class:"am",contentEditable:"true",onkeydown:function(e){if(lr(t),r(e))return;8!=e.keyCode||t.textContent.length||(rr.pop(),t.focus());if(32!==e.keyCode&&!/^[a-zA-Z0-9\_@\.]+$/.test(e.key))return void e.preventDefault();"Enter"!==e.key&&"Tab"!==e.key||e.preventDefault()},oninput:e});function n({id:e,name:n}){ir([]),sr(0),e?rr.add(e):ar.add(xi),t.textContent="",t.spellcheck=!1,t.focus()}function r(e){return!!ir().length&&("Enter"===e.key||"Tab"===e.key||32===e.keyCode?(n(ir()[sr()]),e.preventDefault(),!0):27==e.keyCode?(ir([]),sr(),!0):(38==e.keyCode&&(0===sr()?sr(ir().length-1):sr(sr()-1),S(ir()[sr()].id).focus(),e.preventDefault(),Ti=!0,setTimeout((()=>Ti=!1),300)),40==e.keyCode&&(sr()===ir().length-1?sr(0):sr(sr()+1),S(ir()[sr()].id).focus(),e.preventDefault(),Ti=!0,setTimeout((()=>Ti=!1),300)),e.target.focus(),!0))}const a=()=>p("div",{class:"uls adm"},p("ul",null,Tn(ir,(e=>p("li",{id:e.id,tabIndex:"-1",class:()=>ir()[sr()]===e?"se":"",onclick:()=>n(e),onMouseOver:()=>function(e){Ti||sr(e)}(ir().indexOf(e))},e.id?p("i",{class:function(){return"dot"+(()=>Qn(e.id).online()?" on":"").call(this)}}):null," ",e.name))))),i=p("div",{class:"sel",onclick:()=>t.focus()},Tn(ar,(e=>p("div",{class:"tg ie"},e,p("i",{onclick:()=>ar.delete(e)},"✕")))),Tn(rr,(e=>p("div",{class:()=>Qn(e).online()?"tg on":"tg"},Qn(e).name,p("i",{onclick:()=>rr.delete(e)},"✕")))),t,(()=>lr()===t&&ir().length>0&&a));return i.focus=()=>t.focus(),i},Ai=()=>{const e=["Public","Internal"],t=()=>Hn()?Zn(Hn()):Bn()?Zn(Bn()):null;const n=(e,t)=>{e.stopPropagation(),window.confirm("Do you want to delete this channel?\n"+t.fullname())&&(async e=>{bn.send(je.DelChan(e))})(t.id)},r=()=>t().by===Ae.id(),a=async(e,t)=>{let n=rr().length?rr():null,r=ar().length?ar():null;(n||r)&&(await(async(e,t,n)=>{let r=await Mr.create("addmems",bn.send(je.AddMems({chanid:e,userids:t,emails:n})));return oa(e),r})(e,n,r)?(Ir(`added${i()} to ${t()}`),Ur(!1)):jr(8))};function i(){let e=rr().length+ar().length;return e>0?" "+e+(e>1?" people":" person"):""}function o(e,{id:t,fullname:n,about:r,md:a}){e.preventDefault();let{n:i,m:o}=e.target,s=i.value.trim()==n()?null:i.value.trim(),l=o&&o.value.trim()!=a()?o.value.trim():null,u=S("ab").textContent.trim();u=u==(r()||"")?null:u;let c=function(e,t,n){return e&&0===e.length?10:n&&(n>2||n<0)||t&&t.length>1e3?11:0}(s,u,l);0===c?(!function(e,t,n,r){Mr.create("editchan",bn.send(je.EditChan({id:e,name:t,about:n,md:r})))}(t,s,u,l),Ur(!1)):jr(c)}return p([p("div",{class:"dn"},p("i",{onclick:()=>xe("rnclose")},"✕")),p("div",{class:"ub"},(()=>t()&&r()&&p("div",{title:"edit",onclick:()=>{return n=t(),Dr.content=p("div",{class:"pi"},p("div",{class:"su et"},p("div",{class:"head"},"About"),p("div",{class:"sub"},n.fullname),p("form",{onsubmit:e=>o(e,n)},(()=>Pr(10,11)&&p("div",{class:"erm"},errmsg())),p("input",{value:n.fullname,type:"text",name:"n",placeholder:"topic name",required:!0,class:()=>Pr(10)&&"er"}),p("div",{id:"ab",class:"ab",contentEditable:"true"},n.about),1==Ae.id()&&n.md()<2?p("select",{name:"m"},e.map(((e,t)=>p("option",{selected:()=>n.md()==t,value:t},e)))):null,p("div",{class:"bn"},p("button",{type:"submit"},"Save"))))),void Ur(!0);var n},class:"ed"},"✎")),p("div",{class:"head"},"About"),p("div",{class:"sub b"},(function(){return t()?t().fullname:""})),p("div",{class:"sub"},(function(){return t()?t().about:""}))),p("div",{class:"ub"},p("div",{class:"he"},"Settings"),p("div",{class:"sub"},(function(){return t()?[...e,"Private"][t().md()]:""}))),p("div",{class:"ft"},p("div",{class:"ub lf"},p("div",{class:"he"},"Members")),(()=>Ae.id()>0&&p("div",{class:"rt"},(()=>t()&&p("button",{title:"add members",onclick:()=>(({id:e,fullname:t})=>{const n=Ui();Dr.content=p("div",{class:"pi"},p("div",{class:"amb"},p("div",{class:"head"},"Add people"),p("div",{class:"sub"},t),n,p("div",{class:"bn"},p("button",{onclick:()=>a(e,t)},"Add",i)))),Ur(!0),n.focus()})(t())},"👤"))))),p("div",{class:"uls mem"},p("ul",null,Tn(nr,(e=>p("li",{id:e,tabIndex:"-1",style:()=>Qn(e).online()?"color:"+K(Qn(e).name):"",onclick:t=>bi(t,e)},e?p("i",{class:function(){return"dot"+(()=>Qn(e).online()?" on":"").call(this)}}):null," ",Qn(e).name))))),()=>t()&&r()&&p("div",{class:"ft dt"},p("div",{class:"ub lf"},p("div",{class:"he"},"Delete")),p("div",{class:"rt"},p("button",{title:"delete topic",onclick:e=>n(e,t())},"🗑️")))])},Mi=()=>wr()?localStorage.getItem("w")||185:0,Di=()=>yr()?localStorage.getItem("e")||185:0;function Li(){const e="0"!==localStorage.getItem("l")&&window.innerWidth>650;wr(e);const t=1==localStorage.getItem("r")&&window.innerWidth>650;yr(t),gr(Mi()),br(Di())}function Pi(){wr(!wr()),gr(Mi()),localStorage.setItem("l",wr()?1:0)}function Oi(){yr(!yr()),br(Di()),localStorage.setItem("r",yr()?1:0)}Li(),setTimeout(Li,100);const ji=()=>null,Ii=n(ji);function Ni(){return p("div",{onmousedown:function(e){document.onmousemove=e=>{gr(e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("w",gr())}},class:"dw"})}function Ki(){return p("div",{onmousedown:function(e){document.onmousemove=e=>{br(document.documentElement.offsetWidth-e.clientX+2)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,localStorage.setItem("e",br())}},class:"de"})}document.querySelector("body").append((()=>{Ee("nochan",(()=>Ii(ji))),Ee("rnclose",Oi),Ee("lnclose",Pi);function e(){return wr()&&window.innerWidth>650?gr():0}function t(){return yr()&&window.innerWidth>650?br():0}return p([p("div",{class:"ma",style:function(){return"left:"+e.call(this)+"px;right:"+t.call(this)+"px"}},p("div",{class:"n"},p("div",null,p("ol",{class:"bc"},(()=>Tn(On.paths,(e=>p("li",null,p("a",{onclick:t=>(e=>{e[0]===On.len()-1?Ii()===_a?Ii(ji):Ii(_a):On.cd(e)})(e)},e[2])))))),(()=>Ae.id()?p([p("div",{onclick:Pi,class:"av mv"},p("i",null,"☰")),p("div",{onclick:Oi,class:"av iv"},p("i",null,"ⓘ")),p("div",{onclick:e=>bi(e,Ae.id()),class:"av"},p("i",null,"👨🏻‍💻"))]):p([p("div",{class:"u"},p("a",{onclick:ma},"sign up")),p("div",{class:"m"},p("a",{onclick:va},"log in"))]))),Ii),Ci),()=>wr()&&p("div",{class:"ln",style:function(){return"width:"+("function"==typeof gr?gr.call(this):gr)+"px"}},Ei,Ni),()=>yr()&&p("div",{class:"rn",style:function(){return"width:"+("function"==typeof br?br.call(this):br)+"px"}},Ai,Ki),()=>kr()>0&&p("div",{class:"err"},Lr()),()=>Cr()&&p("div",{class:"inf"},Cr()),()=>Ur()&&p("div",{id:"mod",class:"mod",onclick:()=>Ur(!1)},p("div",{class:"pop",onclick:e=>e.stopPropagation()},Dr.content))])})())}();
