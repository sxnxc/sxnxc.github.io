!function(){"use strict";const e=[];function t(t){let n={};return function(){const a=e.slice.call(arguments),s=a.map((e=>{if(o(e)||Array.isArray(e)){let t={};for(let n in e)t[n]=r(e[n]);return t}return r(e)})),i=JSON.stringify(s);let l=n[i];return void 0===l&&(l=t.apply(this,a),l&&11===l.nodeType&&(l=e.slice.call(l.childNodes)),n[i]=l),l}}let n=0;function r(e){return"function"==typeof e||e instanceof Node?(e.$m||(e.$m=++n),{$m:e.$m}):e}function o(e){if("object"!=typeof e||null===e)return!1;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function a(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var s,i,l=a((function(e,t){function n(e){var t=e>>3;return e%8!=0&&t++,t}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){void 0===e&&(e=0);var r=null==t?void 0:t.grow;this.grow=r&&isFinite(r)&&n(r)||r||0,this.buffer="number"==typeof e?new Uint8Array(n(e)):e}return e.prototype.get=function(e){var t=e>>3;return t<this.buffer.length&&!!(this.buffer[t]&128>>e%8)},e.prototype.set=function(e,t){void 0===t&&(t=!0);var n=e>>3;if(t){if(this.buffer.length<n+1){var r=Math.max(n+1,Math.min(2*this.buffer.length,this.grow));if(r<=this.grow){var o=new Uint8Array(r);o.set(this.buffer),this.buffer=o}}this.buffer[n]|=128>>e%8}else n<this.buffer.length&&(this.buffer[n]&=~(128>>e%8))},e.prototype.forEach=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=8*this.buffer.length);for(var r=t,o=r>>3,a=128>>r%8,s=this.buffer[o];r<n;r++)e(!!(s&a),r),a=1===a?(s=this.buffer[++o],128):a>>1},e}();t.default=r}(i={path:s,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&i.path)}},i.exports),i.exports));let c,u=[];function d(e){let t=c,n=()=>{};c=n,h(n);let r=e((()=>{p(n),c=void 0}));return c=t,r}function f(e){function t(n){if(0===arguments.length)return c&&!t.__o.has(c)&&(t.__o.add(c),c.u.push(t)),e;e=n;let r=c;return c=void 0,t.o=new Set(t.__o),t.o.forEach((e=>e.i=!1)),t.o.forEach((e=>{e.i||e()})),c=r,e}return t.$o=1,t.__o=new Set,t.t=u,t}function p(e){e.__c.forEach(p),e.u.forEach((t=>{t.__o.delete(e),t.o&&t.o.delete(e)})),e.l.forEach((e=>e())),h(e)}function h(e){e.u=[],e.__c=[],e.l=[]}const m=(e,t={})=>e.reduce(((e,t)=>(e[t.id]=t,e)),t),g=()=>window.scrollTo(0,document.body.scrollHeight),y=t((e=>t(((t,n)=>d((()=>e(t,n))))))),w=e=>(t,...n)=>()=>y(e())(t,n),v=e=>{if(!(e instanceof ArrayBuffer||e.length))return console.log(e);console.log("Length",e instanceof ArrayBuffer?new Uint8Array(e).length:e.length,"bytes"),console.log((Object(e).buffer instanceof ArrayBuffer?e:"string"==typeof e?new TextEncoder("utf-8").encode(e):new Uint8ClampedArray(e)).reduce(((e,t,n,r)=>e+(n%16==0?n.toString(16).padStart(6,0)+"  ":" ")+t.toString(16).padStart(2,0)+(n===r.length-1||n%16==15?" ".repeat(3*(15-n%16))+Array.from(r).splice(n-n%16,16).reduce(((e,t)=>e+(t>31&&t<127||t>159?String.fromCharCode(t):".")),"  ")+"\n":"")),""))},b=(e,t)=>{let n=0,r=0;for(;n<e.length;)r>=t.length&&(r=0),e.set([e[n]^t[r]],n),n++,r++},C=(e,t)=>(b(e,t),A(e,t)),E=e=>{let{a:t,k:n}=S(e);return b(t,n),{a:t,k:n}},S=e=>{let t=e[0],n=e.subarray(1,t+1);return{a:e.subarray(t+1),k:n}},A=(e,t)=>{let n=new Uint8Array(1+t.length+e.length);return n[0]=t.length,n.set(t,1),n.set(e,1+t.length),n},L=(e,t)=>(e=Math.ceil(e),Math.floor(Math.random()*(Math.floor(t)-e)+e)),U=(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},k=e=>(performance.now()-e).toFixed(2),T=(e,t=64,n=8)=>C(e,crypto.getRandomValues(new Uint8Array(L(n,t)))),N=()=>{let e,t=new Promise((t=>e=t));return{complete:t=>e(t),join:()=>t}},x=navigator.vendor.includes("Apple")?{transaction:()=>{}}:openDatabase("sonic","1.0","Test DB",1073741824);function O(e,t){}function j(e,t){console.log(e,t)}x.transaction((e=>{e.executeSql("CREATE TABLE IF NOT EXISTS users (\n            id integer NOT NULL PRIMARY KEY,\n            handle varchar(50) NOT NULL\n        )",[],O,j),e.executeSql("CREATE TABLE IF NOT EXISTS chans (\n            id integer NOT NULL PRIMARY KEY,\n            handle varchar(50) NOT NULL,\n            name varchar(150) NOT NULL,\n            mom integer NOT NULL,\n            by integer NOT NULL,\n            timestamp datetime NOT NULL DEFAULT CURRENT_TIMESTAMP\n        )",[],O,j),e.executeSql("CREATE TABLE IF NOT EXISTS chats (\n            id integer NOT NULL PRIMARY KEY,\n            txt text NOT NULL,\n            by integer NOT NULL,\n            re integer NOT NULL,\n            nor integer NOT NULL DEFAULT '0',\n            chanid integer NOT NULL,\n            timestamp datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            star boolean\n        )",[],O,j)}));const I=N(),R="sonic",D=["session","ranges","chats","users","chans"];let $,M=indexedDB.open(R,1);function P(e){console.warn("[db] deleting database",e);var t=window.indexedDB.deleteDatabase(e);t.onerror=t=>{console.error("[db] error deleting database",e,t)},t.onsuccess=t=>{console.warn("[db] deleted database",e)}}M.onsuccess=e=>{$=M.result,console.log("[db] open -",$.name,$.version,$.objectStoreNames),function(e){let t=e.objectStoreNames;for(const e of D)if(!t.contains(e))return console.warn("[db] db store missing",e),void P(R)}($),I.complete($),M.open?M.open():M.open=!0},M.onerror=e=>{console.error("[db] error",e.target.error),I.complete()},M.onblocked=e=>{console.log("[db] blocked",e)},M.onupgradeneeded=e=>{console.warn("[db] database upgrade needed from version",e.oldVersion,"->",e.newVersion),$=M.result;let t=$.objectStoreNames;if(console.log(t),!t.contains("session")){console.log("make session store");$.createObjectStore("session")}if(!t.contains("ranges")){console.log("make ranges store");$.createObjectStore("ranges")}if(!t.contains("chats")){console.log("make chats store");let e=$.createObjectStore("chats",{keyPath:"id"});e.createIndex("chanid",["chanid","id"],{unique:!1}),e.createIndex("re",["re","id"],{unique:!1}),e.createIndex("by",["by","id"],{unique:!1})}if(!t.contains("users")){console.log("make users store");$.createObjectStore("users",{keyPath:"id"})}if(!t.contains("chans")){console.log("make chans store"),$.createObjectStore("chans",{keyPath:"id"}).createIndex("mom","handle",{unique:!0})}for(const e of D)$.objectStoreNames.contains(e)||(console.warn(`[db] ${e} store missing, creating a dummy one`),$.createObjectStore(e));console.warn("[db] database upgrade complete")};const B=async(e,t)=>{let n=await I.join();n&&(v(t),n.transaction(["session"],"readwrite").objectStore("session").put(t,e))},_=async(e,t)=>{let n=await I.join();if(!n)return;let r=n.transaction([e],"readwrite").objectStore(e);t.forEach((e=>r.add(e))),x.transaction((n=>{t.forEach((t=>{let r=Object.keys(t),o=`INSERT OR REPLACE INTO ${e} (${r.join(",")}) VALUES (${Array(r.length).fill("?").join(",")})`;n.executeSql(o,Object.values(t).map((e=>"function"==typeof e?e():e)),O,j)}))}))},K=async(e,t)=>{let n=await I.join();n&&(console.log("add",e,t),n.transaction([e],"readwrite").objectStore(e).add(t),x.transaction((n=>{let r=Object.keys(t),o=`INSERT OR REPLACE INTO ${e} (${r.join(",")}) VALUES (${Array(r.length).fill("?").join(",")})`;n.executeSql(o,Object.values(t).map((e=>"function"==typeof e?e():e)),O,j)})))},H=async(e,t)=>{let n=await I.join();if(!n)return{value:[],missed:t};let r=performance.now(),o=[],a=new Set,s=n.transaction([e],"readonly").objectStore(e),i=0;return new Promise((n=>{t.forEach((l=>{let c=s.get(l);c.onsuccess=s=>{c.result?o.push(c.result):a.add(l),++i===t.length&&(console.log("[db]",`get ${e} in`,k(r),"ms"),n({value:o,missed:Array.from(a)}))}}))}))},q=([e,t])=>{e<1&&(e=1);let n=new Set;for(var r=e;r<=t;r++)n.add(r);return n},F=async(e,t,n,r=!1)=>{let o=await I.join();if(!o)return{missed:{length:t}};let a=performance.now(),s=[],i=n?q([n-t,n-1]):void 0,l=o.transaction(["chats"],"readonly").objectStore("chats"),c=n?IDBKeyRange.upperBound(n,r):null,u=n||99999;switch(e.tag){case"Id":l=l.index("re"),c=IDBKeyRange.bound([e.value],[e.value,u],!1,r);break;case"Chanid":l=l.index("chanid"),c=IDBKeyRange.bound([e.value],[e.value,u],!1,r);break;case"By":l=l.index("by"),c=IDBKeyRange.bound([e.value],[e.value,u],!1,r)}let d=0;return new Promise((r=>{l.openCursor(c,"prev").onsuccess=o=>{var l=o.target.result;if(l){if(s.push(l.value),i||(i=q([l.key-t+1,l.key])),i.delete(l.key),++d===t)return console.log("[db]","scan chats",e,n||"",t,"in",k(a),"ms"),r({value:s,missed:Array.from(i)});l.continue()}else console.log("[db]","scan chats",e,n||"",t,"in",k(a),"ms"),r({value:s,missed:Array.from(i||[])})}}))},Y=async(e,t)=>{let n=await I.join();if(!n)return;let r=n.transaction(["ranges"],"readwrite").objectStore("ranges"),o=r.get(e);o.onsuccess=async n=>{o.result?(o.result.push(t),r.put(G(o.result),e)):r.put([t],e)}},V=e=>z(e,"session"),z=async(e,t)=>{let n=await I.join();if(!n)return;let r=n.transaction([t],"readonly").objectStore(t);return new Promise((t=>{let n=r.get(e);n.onsuccess=e=>t(n.result)}))},G=e=>{var t,n=[];return e.sort(((e,t)=>e[0]-t[0]||e[1]-t[1])),e.forEach((e=>{!t||e[0]>t[1]+1?n.push(t=e):e[1]>t[1]&&(t[1]=e[1])})),n};var W,J,X;!function(e){e.None=function(e){return{tag:"None",value:e}},e.Id=function(e){return{tag:"Id",value:e}},e.Chanid=function(e){return{tag:"Chanid",value:e}},e.By=function(e){return{tag:"By",value:e}}}(W||(W={})),function(e){e.ChatScan=function(e){return{tag:"ChatScan",value:e}},e.ChanScan=function(e){return{tag:"ChanScan",value:e}},e.AddChat=function(e){return{tag:"AddChat",value:e}},e.AddUser=function(e){return{tag:"AddUser",value:e}},e.Login=function(e){return{tag:"Login",value:e}},e.Logout=function(e){return{tag:"Logout",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}}}(J||(J={})),function(e){e.User=function(e){return{tag:"User",value:e}},e.Chan=function(e){return{tag:"Chan",value:e}},e.Chat=function(e){return{tag:"Chat",value:e}},e.Users=function(e){return{tag:"Users",value:e}},e.Chans=function(e){return{tag:"Chans",value:e}},e.Chats=function(e){return{tag:"Chats",value:e}},e.Login=function(e){return{tag:"Login",value:e}}}(X||(X={}));const Z=(e,t=0,n=!0)=>({pos:t,littleEndian:n,view:new DataView(e)}),Q=(e,t)=>{const{view:{buffer:n},pos:r}=e,o=n.byteLength;if(o-r>t)return e;const a=Math.max(2*o,o+t),s=new Uint8Array(a);return s.set(new Uint8Array(n)),Z(s.buffer,r,e.littleEndian)},ee=(e,t)=>{e=Q(e,1);const{view:n,pos:r}=e;return n.setUint8(r,t),e.pos+=1,e},te=(e,t)=>{e=Q(e,4);const{view:n,pos:r,littleEndian:o}=e;return n.setUint32(r,t,o),e.pos+=4,e};function ne(e,t){const{view:n,pos:r,littleEndian:o}=e;return n.setUint32(o?r:r+4,t,o),n.setUint32(o?r+4:r,0,o),e.pos+=8,e}const re=(e,t)=>{e=Q(e,4);const{view:n,pos:r,littleEndian:o}=e;return n.setInt32(r,t,o),e.pos+=4,e},oe=new TextEncoder,ae="encodeInto"in oe?(e,t)=>oe.encodeInto(e,t).written:(e,t)=>{const n=oe.encode(e);return t.set(n),n.length},se=(e,t)=>{e=Q(e,3*t.length+8);const n=ae(t,new Uint8Array(e.view.buffer,e.pos+8));return(e=ne(e,n)).pos+=n,e},ie=(e,t)=>ee(e,t?1:0),le=e=>(t,n)=>n.reduce(e,((e,t)=>ne(Q(e,8),t))(t,n.length)),ce=e=>{const{pos:t,view:n}=e;return e.pos+=1,n.getUint8(t)},ue=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getUint32(t,r)},de=e=>{const{view:t,pos:n,littleEndian:r}=e;return e.pos+=8,t.getUint32(r?n:n+4,r)},fe=e=>{const{pos:t,view:n,littleEndian:r}=e;return e.pos+=4,n.getInt32(t,r)},pe=e=>1===ce(e),he=e=>t=>{const n=de(t),r=new Array;for(let o=0;o<n;o++)r.push(e(t));return r},me=new TextDecoder,ge=e=>{const t=de(e),{pos:n,view:{buffer:r}}=e,o=me.decode(new Uint8Array(r,n,t));return e.pos+=t,o};ye=se;var ye,we,ve=le(ee),be=le(re),Ce=(le((function(e,t){var n=t.id,r=t.handle;return se(re(e,n),r)})),se),Ee=function(e,t){var n=t.id,r=t.handle,o=t.name,a=t.mom,s=t.by,i=t.timestamp;return Ce(re(re(se(se(re(e,n),r),o),a),s),i)},Se=(le(Ee),function(e,t){var n=t.id,r=t.txt,o=t.by,a=t.re,s=t.nor,i=t.chanid,l=t.timestamp;return Ce(re(re(re(re(se(re(e,n),r),o),a),s),i),l)}),Ae=(le(Se),function(e,t){var n=t.filter,r=t.kw,o=t.ub,a=t.lb,s=t.limit;return((e,t)=>{e=Q(e,2);const{view:n,pos:r,littleEndian:o}=e;return n.setUint16(r,t,o),e.pos+=2,e})(re(re(se(function(e,t){switch(t.tag){case"None":return ie(te(e,0),t.value);case"Id":return re(te(e,1),t.value);case"Chanid":return re(te(e,2),t.value);case"By":return re(te(e,3),t.value)}}(e,n),r),o),a),s)}),Le=function(e,t){switch(t.tag){case"ChatScan":return Ae(te(e,0),t.value);case"ChanScan":return Ae(te(e,1),t.value);case"AddChat":return function(e,t){var n=t.txt,r=t.by,o=t.re,a=t.name,s=t.chanid;return re(se(re(re(se(e,n),r),o),a),s)}(te(e,2),t.value);case"AddUser":return function(e,t){var n=t.email,r=t.handle,o=t.key;return ve(se(se(e,n),r),o)}(te(e,3),t.value);case"Login":return function(e,t){var n=t.email,r=t.key;return ve(se(e,n),r)}(te(e,4),t.value);case"Logout":return ve(te(e,5),t.value);case"Users":return be(te(e,6),t.value);case"Chans":return be(te(e,7),t.value);case"Chats":return be(te(e,8),t.value)}},Ue=(we=ge,e=>1===ce(e)?we(e):null),ke=he(ce),Te=(he(fe),he((function(e){return{id:fe(e),handle:ge(e)}}))),Ne=ge,xe=function(e){return{id:fe(e),handle:ge(e),name:ge(e),mom:fe(e),by:fe(e),timestamp:Ne(e)}},Oe=he(xe),je=function(e){return{id:fe(e),txt:ge(e),by:fe(e),re:fe(e),nor:fe(e),chanid:fe(e),timestamp:Ne(e)}},Ie=he(je),Re=function(e){switch(ue(e)){case 0:return X.User(function(e){return{id:fe(e),handle:ge(e),email:ge(e),emailverified:pe(e),name:ge(e),key:ge(e),picture:Ue(e),timestamp:Ne(e)}}(e));case 1:return X.Chan(xe(e));case 2:return X.Chat(je(e));case 3:return X.Users(Te(e));case 4:return X.Chans(Oe(e));case 5:return X.Chats(Ie(e));case 6:return X.Login(ke(e))}throw new Error("bad variant index for Response")},De=Z(new ArrayBuffer(512)),$e=function(e,t){return De.pos=0,De=t(De,e),new Uint8Array(De.view.buffer).slice(0,De.pos)},Me=function(e,t){return t(Z(e))},Pe=function(e){return Me(e.buffer,Re)},Be=function(e){return $e(e,Le)};const _e=e=>new Zlib.Inflate(e).decompress(),Ke=e=>new Zlib.Deflate(e).compress(),He=async(e,t,n)=>(console.log("[sec] encrypting data"),await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e)),qe=async(e,t,n)=>(console.log("[sec] decrypting data"),await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e)),Fe={};async function Ye(){let e=await V("u");e&&(Fe.user=e);let t=await V("a");t&&(t=new Uint8Array(t),16===t.length&&(Fe.salt=t));let n=await V("s");return n&&(n=new Uint8Array(n),32===n.length&&(Fe.sskey=await crypto.subtle.importKey("raw",n,"AES-GCM",!1,["encrypt","decrypt"]))),console.log("[au]",Fe),Fe.salt}async function Ve(e,t){let n=new TextEncoder,r=await ze(n.encode(e),n.encode(t));return await crypto.subtle.exportKey("raw",r)}async function ze(e,t){let n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}const Ge=document.location.hash.substr(1).match(/^ip\/(?<ip>[\:\.\d]+)$/),We="wss://"+(Ge?Ge.groups.ip:"192.168.100.11:443");let Je,Xe,Ze,Qe,et,tt,nt,rt,ot,at,st,it=500,lt=0,ct={},ut=0,dt=1;console.group("[ws]","starting..."),function e(t){Je=performance.now(),Xe=new WebSocket(We),Xe.binaryType="arraybuffer",Xe.onopen=()=>{console.log(`[ws] open in ${k(Je)} ms`),console.groupEnd("[ws]"),console.group("[dc]","opening..."),t?ht():et&&yt()},Xe.onmessage=async e=>{console.log(`[ws] <- received answer in ${k(Je)} ms`);let t=new Uint8Array(e.data),{a:n,k:r}=E(t);var o,a,s;pt=(e=>{const t=new l(e);return{z:t.get(0),m:t.get(1),c:t.get(2),d:t.get(3)}})(n),console.log(pt),ct.onconfig&&ct.onconfig(pt),r=await(o=r,crypto.subtle.importKey("raw",o,{name:"ECDH",namedCurve:"P-256"},!0,[])),at=await(a=Qe.privateKey,s=r,crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:s},a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])),ot=new Uint8Array(await crypto.subtle.exportKey("raw",at));let i=JSON.parse((e=>(new TextDecoder).decode(_e(e)))(n.slice(1))),c=i.answer?i.answer:i;if(await tt.setRemoteDescription(new RTCSessionDescription(c)),!i.candidate)return;const u=new RTCIceCandidate({candidate:i.candidate,sdpMid:0,sdpMLineIndex:0});await tt.addIceCandidate(u)},Xe.onclose=t=>{lt++,it+=L(0,lt<16?200:3e3),console.warn("[ws] closed",t),console.groupEnd("[ws]"),console.groupEnd("[ws]"),console.groupCollapsed("[ws]",`retry ${lt} in ${(it/1e3).toFixed(2)} sec`),setTimeout((()=>{e(!0)}),it)},Xe.onerror=e=>{console.error("[ws] error",e)}}(),ht();const ft=N();var pt={};function ht(){nt=!1,function(){tt=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});let e=dt++;tt.onicecandidate=e=>{e.candidate},tt.onconnectionstatechange=t=>{switch(tt.connectionState){case"failed":case"disconnected":console.warn("[peer]",e,tt.connectionState,"restarting....")}},tt.oniceconnectionstatechange=t=>{switch(tt.iceConnectionState){case"disconnected":console.warn("[ice]",e,tt.connectionState,"restarting....")}}}(),st=tt.createDataChannel("cu",{}),st.binaryType="arraybuffer",ut=0,ct.send=mt,st.onopen=e=>{console.log(`[dc] open in ${k(Je)} ms`),console.groupEnd("[dc]"),ut=0,ft.complete(st)},st.onmessage=gt,st.onclose=e=>{console.warn("[dc] close",e)},st.onerror=e=>{console.error("[dc] error:",e)},async function(){const e=async()=>{let e=await tt.createOffer();return await tt.setLocalDescription(e),Ke((new TextEncoder).encode(tt.localDescription.sdp))},t=async()=>{if(rt)return rt;Qe=await(async()=>(console.log("[sec] generating key pairs"),await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"])))();let e=await crypto.subtle.exportKey("raw",Qe.publicKey);return rt=new Uint8Array(e),rt};et=await(async(e,t,n)=>{let[r,o,a]=await Promise.all([e(),t(),n()]);return a?C(C(r,o),a):T(C(r,o),64,24)})(e,t,Ye),console.log(`[dc] sdp in ${k(Je)} ms`),1===Xe.readyState&&yt()}()}async function mt(e){if(await ft.join(),ut++,console.groupEnd("[dc]"),console.group("[dc]","-> sending packet",ut,e),e=Be(e),v(e),pt.z&&(e=Ke(e)),pt.m&&(e=T(e,e.length),b(e,ot)),pt.c){const t=crypto.getRandomValues(new Uint8Array(12));b(e,t),e=U(t,new Uint8Array(await He(e,at,t)))}if(pt.d){const t=crypto.getRandomValues(new Uint8Array(12));b(e,t),e=U(t,new Uint8Array(await He(e,Fe.sskey,t)))}st.send(e),Ze=performance.now(),console.groupEnd("[dc]")}async function gt(e){let t=new Uint8Array(e.data),n=t.length;if(console.groupEnd("[dc]"),console.group("[dc]","<- received",n,"bytes in",k(Ze),"ms"),pt.d){let e=t.subarray(0,12);t=new Uint8Array(await qe(t.subarray(12),Fe.sskey,e)),b(t,e)}if(pt.c){let e=t.subarray(0,12);t=new Uint8Array(await qe(t.subarray(12),at,e)),b(t,e)}if(pt.m){b(t,ot);let{a:e}=E(t);t=new Uint8Array(e)}pt.z&&(t=_e(t));let r=(100*n/t.length).toFixed(2);console.log(`[dc] unpacked ${n} / ${t.length} bytes ${r}% in ${k(Ze)} ms`);let o=wt(t);ct.recv&&ct.recv(o),console.groupEnd("[dc]")}const yt=()=>{nt||(console.log("[ws] -> sending offer"),Xe.send(et),nt=!0)},wt=e=>{let t=Pe(e);return console.log(t),console.table(t.value),t};let vt={},bt=[];function Ct(e){return this.t&&this.t[e.type](e)}vt.h=(...e)=>{let t,n=r=>{if(null==r);else if("string"==typeof r)t?vt.add(t,r):t=vt.s?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);else if(Array.isArray(r))t||(t=document.createDocumentFragment()),r.forEach(n);else if(r instanceof Node)t?vt.add(t,r):t=r;else if("object"==typeof r)vt.property(t,r,null,vt.s);else if("function"==typeof r)if(t){let e=vt.add(t,"");vt.insert(t,r,e)}else t=r.apply(null,e.splice(1));else vt.add(t,""+r)};return e.forEach(n),t},vt.insert=(e,t,n,r,o)=>(e=n&&n.parentNode||e,o=o||r instanceof Node&&r,t===r||(r&&"string"!=typeof r||!("string"==typeof t||"number"==typeof t&&(t+=""))?"function"==typeof t?vt.subscribe((()=>{r=vt.insert(e,t.call({el:e,endMark:n}),n,r,o)})):(n?r&&(o||(o=r.o&&r.o.nextSibling||n.previousSibling),vt.rm(e,o,n)):e.textContent="",r=null,t&&!0!==t&&(r=vt.add(e,t,n))):(null!=r&&e.firstChild?n?(n.previousSibling||e.lastChild).data=t:e.firstChild.data=t:n?vt.add(e,t,n):e.textContent=t,r=t)),r),vt.property=(e,t,n,r,o)=>{if(null!=t)if(!n||"attrs"===n&&(r=!0))for(n in t)vt.property(e,t[n],n,r,o);else"o"!==n[0]||"n"!==n[1]||t.$o?"function"==typeof t?vt.subscribe((()=>{vt.property(e,t.call({el:e,name:n}),n,r,o)})):o?e.style.setProperty(n,t):r||"data-"===n.slice(0,5)||"aria-"===n.slice(0,5)?e.setAttribute(n,t):"style"===n?"string"==typeof t?e.style.cssText=t:vt.property(e,t,null,r,!0):("class"===n&&(n+="Name"),e[n]=t):((e,t,n)=>{t=t.slice(2).toLowerCase(),n?e.addEventListener(t,Ct):e.removeEventListener(t,Ct),(e.t||(e.t={}))[t]=n})(e,n,t)},vt.add=(e,t,n)=>{let r=(e=>{const{childNodes:t}=e;if(t&&11===e.nodeType)return t.length<2?t[0]:{o:vt.add(e,"",t[0])}})(t=(e=>"string"==typeof e?document.createTextNode(e):e instanceof Node?e:vt.h(bt,e))(t))||t;return e.insertBefore(t,n&&n.parentNode&&n),r},vt.rm=(e,t,n)=>{for(;t&&t!==n;){let n=t.nextSibling;e===t.parentNode&&e.removeChild(t),t=n}},vt.subscribe=function(e){return function(e,t){function n(){let r=c;return c&&c.__c.push(n),p(n),n.i=!0,c=n,t=e(t),c=r,t}function r(){return n.i?c&&n.u.forEach((e=>e())):t=n(),t}e.s=n,h(n),n(),r.$o=1}(e),()=>p(e.s)},vt.cleanup=function(e){return c&&c.l.push(e),e},vt.root=d,vt.sample=function(e){let t=c;c=void 0;let n=e();return c=t,n},vt.hs=(...e)=>{let t=vt.s;vt.s=!0;let n=Et(...e);return vt.s=t,n};let Et=(...e)=>vt.h.apply(vt.h,e);function St(e,t,n){const{root:r,subscribe:o,sample:a,cleanup:s}=vt;null==n&&(n=!t.$t);let i=vt.h([]),l=vt.add(i,""),c=new Map,u=new Map,d=new Set;function f(e,o){if(null==e)return;let a=u.get(e);return 1===o?(d.delete(e),a||(a=n?r((n=>(c.set(e,n),t(e.$v||e)))):t(e.$v||e),11===a.nodeType&&(a=(e=>{const{childNodes:t}=e,{length:n}=t;if(n<2)return t[0];let r=Array.from(t);return{nodeType:111,t:r[0],o:r[n-1],l(){if(t.length!==n){let t=0;for(;t<n;)e.appendChild(r[t++])}return e}}})(a)||a),u.set(e,a))):-1===o&&d.add(e),((e,t)=>111===e.nodeType?1/t<0?t?vt.rm(e.t.parentNode,e.t.nextSibling,e.o.nextSibling)||e.t:e.o:t?e.l():e.t:e)(a,o)}function p(e){let t=c.get(e);t&&(t(),c.delete(e)),u.delete(e)}return s(o((t=>{let n=e();return a((()=>{d.clear();let e=Array.from(function(e,t,n,r,o){let a,s,i=new Map,l=new Map;for(a=0;a<t.length;a++)i.set(t[a],a);for(a=0;a<n.length;a++)l.set(n[a],a);for(a=s=0;a!==t.length||s!==n.length;){var c=t[a],u=n[s];if(null===c)a++;else if(n.length<=s)e.removeChild(r(t[a],-1)),a++;else if(t.length<=a)e.insertBefore(r(u,1),r(t[a],0)||o),s++;else if(c===u)a++,s++;else{var d=l.get(c),f=i.get(u);void 0===d?(e.removeChild(r(t[a],-1)),a++):void 0===f?(e.insertBefore(r(u,1),r(t[a],0)||o),s++):(e.insertBefore(r(t[f],1),r(t[a],0)||o),t[f]=null,f>a+1&&a++,s++)}}return n}(l.parentNode,t||[],n,f,l));return d.forEach(p),e}))}))),s((function(){c.forEach((e=>e())),c.clear(),u.clear(),d.clear()})),i}const At="defaultParagraphSeparator",Lt="formatBlock",Ut=(e,t,n)=>e.addEventListener(t,n),kt=(e,t)=>e.appendChild(t),Tt=e=>document.createElement(e),Nt=e=>document.queryCommandState(e),xt=(e,t=null)=>document.execCommand(e,!1,t),Ot={bold:{icon:"<b>B</b>",title:"Bold",state:()=>Nt("bold"),result:()=>xt("bold")},italic:{icon:"<i>I</i>",title:"Italic",state:()=>Nt("italic"),result:()=>xt("italic")},underline:{icon:"<u>U</u>",title:"Underline",state:()=>Nt("underline"),result:()=>xt("underline")},strikethrough:{icon:"<strike>S</strike>",title:"Strike-through",state:()=>Nt("strikeThrough"),result:()=>xt("strikeThrough")},heading1:{icon:"<b>H1</b>",title:"Heading 1",result:()=>xt(Lt,"<h1>")},heading2:{icon:"<b>H2</b>",title:"Heading 2",result:()=>xt(Lt,"<h2>")},quote:{icon:"&#8220;&#8221;",title:"Quote",result:()=>xt(Lt,"<blockquote>")},olist:{icon:"1.",title:"Ordered List",result:()=>xt("insertOrderedList")},ulist:{icon:"&#8226;",title:"Unordered List",result:()=>xt("insertUnorderedList")},code:{icon:"&lt;&gt;",title:"Code",result:()=>xt(Lt,"<pre>")},line:{icon:"&#8213;",title:"Horizontal Line",result:()=>xt("insertHorizontalRule")},link:{icon:"&#128279;",title:"Link",result:()=>{const e=window.prompt("Enter the link URL");e&&xt("createLink",e)}},image:{icon:"&#128247;",title:"Image",result:()=>{const e=window.prompt("Enter the image URL");e&&xt("insertImage",e)}}},jt={actionbar:"ed-actionbar",button:"ed-button",content:"ed-content",selected:"ed-button-selected",topic:"ed-topic"},It=({chan_id:e,chat_id:t})=>{let n,r=f([]),o={},a={},s={},i=f(0),l="";e=Number(e),t=Number(t);const c=((...e)=>{const t={},n={};return{create:e=>n[e]=new Promise((n=>t[e]=n)),complete:(e,n)=>t[e](n),join:e=>n[e],joinall:()=>Promise.all(e.map((e=>n[e]))),select:()=>Promise.race(e.map((e=>n[e])))}})("users","chans");ct.recv=async e=>{switch(e.tag){case"Users":_("users",e.value),c.complete("users",e.value);break;case"Chans":_("chans",e.value),c.complete("chans",e.value);break;case"Chat":let t=r();if(t.includes(e.value.id))return;let n=window.scrollY+window.innerHeight===document.body.scrollHeight;await K("chats",e.value),Y("chats",[e.value.id,e.value.id]);let a=new Set([e.value.by]),s=new Set([e.value.chanid]);await p(a,s),e.value.nor=f(0),e.value.star=f(!1),o[e.value.id]=e.value,t.push(e.value.id),r(t),n&&g();break;case"Chats":let i=e.value;if(0==i.length)return;return await _("chats",i),Y("chats",[i[i.length-1].id,i[0].id]),u(i)}};const u=async t=>{let n=t[0].id,a=new Set,i=new Set,l=r(),c=t.map((e=>(e.nor=f(e.nor),e.star=f(!1),e.timestamp=new Date(e.timestamp),o[e.id]=e,a.add(e.by),i.add(e.chanid),e.id))).filter((e=>!l.includes(e))).reverse();l=d(l,c),await p(a,i),r(l),e&&(document.title=s[e].name),window.scrollY<100&&setTimeout((()=>document.getElementById(n).scrollIntoView()))},d=(e,t)=>0===e.length||e[e.length-1]<t[0]?e.concat(t):t[t.length-1]<e[0]?t.concat(e):e.concat(t).sort(((e,t)=>e-t)),p=async(e,t)=>{let n=await H("users",Array.from(e)),r=await H("chans",Array.from(t));m(n.value,a),m(r.value,s),n.missed.length>0&&c.create("users",ct.send(J.Users(n.missed))),r.missed.length>0&&c.create("chans",ct.send(J.Chans(r.missed)));let[o,i]=await c.joinall();o&&m(o,a),i&&m(i,s)},h=()=>e>0?W.Chanid(e):t>0?W.Id(t):W.None(!0),y=(e,t,n)=>{let r=J.ChatScan({filter:h(),kw:"",ub:e,lb:t,limit:n});ct.send(r)};(async(e=30)=>{let t=h(),{value:n,missed:r}=await F(t,e);if(console.log("[chats] first scan",{value:n,missed:r}),r.length>0)return r.length==e?y(99999,0,e):ct.send(J.Chats(r));let o=n[0]?n[0].id:0;o&&u(n),y(99999,o,e)})(),setTimeout((function(){new IntersectionObserver((e=>{e[0].intersectionRatio<=0||setTimeout((()=>(async(e=30)=>{let t=r()[0];if(!t||t<=1)return;let n=h(),{value:o,missed:a}=await F(n,e,t,!0);if(console.log("[chat] next scan",{value:o,missed:a}),a.length>0)return a.length==e?y(t,0,e):ct.send(J.Chats(a));u(o)})()))}),{}).observe(A)}));const w=(e=>{const t=e.actions?e.actions.map((e=>"string"==typeof e?Ot[e]:Ot[e.name]?{...Ot[e.name],...e}:e)):Object.keys(Ot).map((e=>Ot[e])),n={...jt,...e.classes},r=e.defaultParagraphSeparator||"div",o=e.element.topic=Tt("div");o.contentEditable=!0,o.className=n.topic,o.onkeydown=e=>{"Enter"===e.key&&(a.focus(),e.preventDefault())},kt(e.element,o);const a=e.element.content=Tt("div");a.contentEditable=!0,a.className=n.content,a.onfocus=()=>{let t=window.scrollY+window.innerHeight===document.body.scrollHeight;e.element.classList.add("sticky"),t&&setTimeout((()=>g()))},a.onblur=()=>{setTimeout((()=>{e.element.contains(document.activeElement)||e.element.classList.remove("sticky")}))},a.oninput=({target:{firstChild:t}})=>{e.oninput(a.innerHTML)},a.onkeydown=t=>{"Enter"!==t.key||t.shiftKey||(e.onsend(),t.preventDefault())},kt(e.element,a);const s=Tt("div");return s.className=n.actionbar,kt(e.element,s),t.forEach((e=>{const t=Tt("button");if(t.className=n.button,t.innerHTML=e.icon,t.title=e.title,t.setAttribute("type","button"),t.onclick=()=>e.result()&&a.focus(),e.state){const r=()=>t.classList[e.state()?"add":"remove"](n.selected);Ut(a,"keyup",r),Ut(a,"mouseup",r),Ut(t,"click",r)}kt(s,t)})),e.styleWithCSS&&xt("styleWithCSS"),xt(At,r),e.element})({element:Et("div",{class:"ed"}),oninput:e=>{},onsend:()=>{if(!Fe.user||!Fe.user.id)return void alert("you are not login!");if(!w.content.textContent.trim())return;let e=i()||n,{chanid:t}=o[e],r="";if(console.log(l),w.topic.textContent!==l){if(r=w.topic.textContent,0===r.trim().length)return void alert("topic should not be empty");e=0,t=s[t].mom}let a=w.content.innerHTML.trim(),c=Fe.user.id;ct.send(J.AddChat({txt:a,by:c,re:e,name:r,chanid:t})),w.content.textContent="",v({})}});w.content.innerHTML="";const v=({id:e,txt:t})=>{if(!e||i()===e)return w.topic.textContent="",l="",void i(0);w.topic.innerHTML=t,w.topic.textContent=w.topic.textContent,l=w.topic.textContent,i(e)},b=(t,l)=>{let{id:c,txt:u,by:d,chanid:f,re:p,star:h,nor:m}=t,g=o[n]||{},y=g.by!==d,w=g.chanid!==f;n=c;let v=s[f];const b=()=>{C("#reps/"+c,c)};return Et("div",{id:c,class:function(){return"chat"+(()=>(h()?" star":"")+(w?" topic":"")+(i()===c?" cur":"")).call(this)},onclick:e=>E(e,t)},w?Et("div",{class:"topic-name"+(p?" re":" new")+(e?" head":"")},Et("a",{href:function(){return"#chats/"+("function"==typeof f?f.call(this):f)},onclick:e=>(C("#chats/"+f,v.name),e.preventDefault(),!1),innerHTML:v.name})):null,y||w?Et("div",{class:"by"},a[d].handle):null,Et("div",{onclick:e=>e.stopPropagation()},(()=>{let e=m();if(1!==e||c!==o[r()[l+1]].re)return e>0?Et([Et("span",{class:"rep",onclick:b},e," 💬")," "]):void 0}),(e=>document.createRange().createContextualFragment(e))(u)))},C=(e,t)=>{let n=screen.width/2-300,r=screen.height/2-300;window.open(e,t,`toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=600,height=600,top=${r}, left=${n}`)},E=(e,t)=>{e.x<18&&e.offsetY<22&&S(t),e.x+28>e.target.offsetWidth&&e.offsetY<22&&v(t)},S=({id:e,star:t})=>{const n=r().filter((t=>t===e))[0],a=o[n];a.star?a.star(!t()):a.star=f(!1)},A=Et("div",{class:"sentinel"});return Et([A,Et("div",{class:"chans"},St(r,((e,t)=>b(o[e],t)))),w])};var Rt;ct.onconfig=e=>{e.d?Pt(Mt):Pt($t)};const Dt=()=>(ct.recv=async e=>{switch(e.tag){case"Login":if(e.value.length<16)return void console.warn("login failed");let t=new Uint8Array(e.value.slice(16,20));Fe.user={id:new DataView(t.buffer).getInt32(t,!1),handle:(new TextDecoder).decode(new Uint8Array(e.value.slice(20)))},Fe.salt=new Uint8Array(e.value.slice(0,16)),Fe.sskey=await ze(Rt,Fe.salt);let n=await crypto.subtle.exportKey("raw",Fe.sskey);B("u",Fe.user),B("a",Fe.salt.buffer),B("s",n),K("users",Fe.user),pt.d=!0,Pt(Mt)}},Et("div",{class:"login"},Et(w(Pt),null))),$t=()=>Et([Et("h2",null,"Login"),Et("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value;Rt=await Ve(t.password.value,n);let r={email:n,key:Array.from(new Uint8Array(Rt))};ct.send(J.Login(r)),console.log(r)}},Et("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),Et("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),Et("button",{type:"submit"},"Login")),Et("h2",null,"Register"),Et("form",{onsubmit:async function(e){e.preventDefault();let t=e.target,n=t.email.value,r=t.username.value;Rt=await Ve(t.password.value,n);let o={email:n,handle:r,key:Array.from(new Uint8Array(Rt))};ct.send(J.AddUser(o)),console.log(o)}},Et("input",{type:"text",name:"email",placeholder:"email",required:!0,autocomplete:"true"}),Et("input",{type:"text",name:"username",placeholder:"username",required:!0,autocomplete:"true"}),Et("input",{type:"password",name:"password",placeholder:"password",required:!0,autocomplete:"true"}),Et("button",{type:"submit"},"Register"))]),Mt=()=>Et([Et("div",null,"You have logged in"),Et("button",{onclick:async()=>{await ct.send(J.Logout(Array.from(Fe.salt))),(async()=>{let e=await I.join();e&&e.transaction(["session"],"readwrite").objectStore("session").clear()})(),pt.d=!1,Fe.user=void 0,Fe.sskey=void 0,Fe.salt=void 0,Pt($t)}},"Logout")]),Pt=f((()=>null));let Bt=[0,0,"🏠",0];const _t=f([Bt]),Kt={same:e=>e===Bt,setpath:e=>Bt=e},Ht=()=>{let e,t=f([]),n=f([]),r="",o=["handle","name"];Kt.expand=n=>{e!=n[3]&&(t([]),a())},ct.recv=e=>{switch(e.tag){case"Chans":return n(Object.keys(e.value[0]||{}).filter((e=>o.includes(e)))),t(e.value)}};const a=(t="",n=99999,r=0,o=30)=>{let a=J.ChanScan({filter:(e=Bt[3],"number"==typeof e?W.Chanid(e):W.None(!0)),kw:t,ub:n,lb:r,limit:o});ct.send(a)},s=({id:e,mom:t,handle:n})=>{let r=_t(),o=Bt[0];r[o+1]=[o+1,t,n,e],r.splice(o+2),_t(r),Kt.setpath(r[o+1]),Kt.cd(r[o])},i=document.createElement("div");return i.contentEditable=!0,i.className="search-content",i.onkeyup=e=>{var t,n,o,s;(t=function(){r!=i.textContent&&(r=i.textContent,console.log(r),a(r))},n=100,function(){var e=this,r=arguments,a=function(){s=null,o||t.apply(e,r)},i=o&&!s;clearTimeout(s),s=setTimeout(a,n),i&&t.apply(e,r)})(),"Enter"!==e.key||e.shiftKey||e.preventDefault()},Et([Et("div",{class:"search"},i),Et("div",{class:"table"},Et("table",null,Et("tbody",null,St(t,(e=>Et("tr",{onclick:()=>s(e)},Et("td",null,"# ",e.handle),Et("td",null,e.name),Et("td",{class:"btn"},Et("button",{onclick:()=>s(e)},"JOIN")))))))),Et("div",{class:"grid"},Et("div",{class:"container"},Et("ol",{class:"breadcrumb"},Et("li",null,Et("a",{href:"#"},"#")," ",Et("a",{href:"#"},"rust")),Et("li",{class:"active relative drop-container"},Et("a",null,"general"),Et("div",{class:"drop"},Et("ul",{class:"list"},Et("li",null,Et("a",{href:"#"},"security")),Et("li",null,Et("a",{href:"#"},"random")),Et("li",null,Et("a",{href:"#"},"backend")),Et("li",null,Et("a",{href:"#"},"compiler")),Et("li",null,Et("a",{href:"#"},"gamedev"))))))))])},qt=(e,t)=>({pattern:e,view:t}),Ft=[qt(/^$/,It),qt(/^chans$/,Ht),qt(/^login$/,Dt),qt(/^chats\/(?<chan_id>\d+)$/,It),qt(/^reps\/(?<chat_id>\d+)$/,It),qt(/^ip\/(?<ip>[\.\d]+)$/,It)],Yt=f("");const Vt=()=>Yt(document.location.hash.substr(1));window.addEventListener("hashchange",Vt),Vt();const zt=()=>{},Gt=f(zt);document.querySelector(".app").append((()=>{Kt.cd=e=>{Gt(zt)};const e=e=>{let t=_t();t.splice(e[0]+1),_t(t),Gt(zt),Kt.setpath(e)};return Et([Et("div",{id:"nav"},Et("ol",{class:"breadcrumb"},(()=>St(_t,(t=>Et("li",null,Et("a",{onclick:n=>(t=>{Kt.same(t)?(Gt()===zt?Gt(Ht):Gt(zt),Kt.expand(t)):e(t)})(t),class:"nav-item"},t[2]))))),".."),Et("div",{class:"nav-right"},Et("a",{class:"nav-item",onclick:e=>{Gt()===Dt?Gt(zt):Gt(Dt)}},"login"))),Et("div",{class:"container"},(()=>function(e){for(const{pattern:t,view:n}of Ft){const r=e.match(t);if(r)return n({...r.groups})}}(Yt()))),Et("div",{class:"modal"},Et(w(Gt),null))])})())}();
